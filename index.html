<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Taxi Ya ‚Äî Firebase + Pesta√±as</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0f15; --panel:#0f141d; --ink:#f5f7fb; --muted:#a9b4c2; --line:#1b2430;
  --accent:#ffd34d; --ok:#22c55e; --danger:#ef4444; --chip:#17202a; --card:#0d131b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0f15,#0b0f15 60%,#0a0f19);color:var(--ink);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial}
button,input,select{font-family:inherit}

/* Layout */
.app{min-height:100dvh;display:grid;grid-template-rows:auto 1fr}
.header{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--line);background:rgba(13,19,27,.7);backdrop-filter:blur(12px);position:sticky;top:0;z-index:20}
.brand{display:flex;align-items:center;gap:.6rem}
.brand .dot{width:.9rem;height:.9rem;border-radius:999px;background:var(--accent);box-shadow:0 0 16px rgba(255,211,77,.7)}
.brand b{letter-spacing:.5px}
.tabs{display:flex;gap:.35rem;flex-wrap:wrap}
.tab{padding:.45rem .75rem;border:1px solid var(--line);border-radius:999px;background:var(--chip);color:var(--ink);opacity:.85;cursor:pointer;transition:.2s}
.tab[aria-selected="true"]{background:var(--accent);color:#111;opacity:1;border-color:#e6b800}

.container{display:grid;grid-template-columns:360px 1fr;gap:1rem;padding:1rem;max-width:1300px;margin:0 auto}
.aside,.main{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden}
.panel-head{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--line);background:var(--card)}
.panel-body{padding:1rem}

/* Cards & chips */
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:1rem}
.row{display:flex;gap:.6rem;align-items:center}
.row.wrap{flex-wrap:wrap}
.chip{background:#121a24;border:1px solid var(--line);padding:.35rem .6rem;border-radius:999px;font-size:.85rem;color:var(--muted)}
.badge{padding:.3rem .5rem;border-radius:8px;border:1px solid var(--line);font-size:.78rem}
.badge.ok{background:rgba(34,197,94,.12);color:#86efac;border-color:rgba(34,197,94,.35)}
.badge.warn{background:rgba(255,211,77,.12);color:#fde68a;border-color:rgba(255,211,77,.35)}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--line);background:#12202e;color:var(--ink);padding:.6rem .9rem;border-radius:12px;cursor:pointer;transition:.2s;text-decoration:none}
.btn:hover{transform:translateY(-1px)}
.btn.primary{background:var(--accent);color:#111;border-color:#e6b800}
.btn.ghost{background:transparent}
.btn.danger{background:#2a0f12;border-color:#40161b;color:#fecaca}
.btn.block{display:flex;justify-content:center;width:100%}

/* Inputs */
.input{width:100%;background:#0e1620;border:1px solid var(--line);color:var(--ink);padding:.65rem .75rem;border-radius:12px}
.label{font-size:.9rem;color:var(--muted);margin-bottom:.35rem}
.field{display:grid;gap:.35rem}
.help{color:var(--muted);font-size:.86rem}

.grid{display:grid;gap:.75rem}
.grid.cols-2{grid-template-columns:1fr 1fr}

/* Map */
#map{width:100%;height:520px}

/* Mobile */
@media (max-width: 1080px){
  .container{grid-template-columns:1fr}
  .aside{order:2}
  .main{order:1}
}

/* Bottom nav on small screens */
@media (max-width: 680px){
  .tabs{position:fixed;bottom:10px;left:0;right:0;justify-content:center;z-index:40}
  .tab{background:#131c28;border-color:#223043}
}

.star{font-size:1.1rem;color:#fcd34d}
.star.off{opacity:.35;filter:grayscale(1)}
.trophy{filter:drop-shadow(0 6px 16px rgba(255,211,77,.35))}

.chatbox{display:grid;grid-template-rows:1fr auto;height:240px;background:#0d131b;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.chatlog{overflow:auto;padding:.6rem}
.msg{display:inline-block;background:#12202e;border:1px solid var(--line);padding:.5rem .65rem;border-radius:10px;margin:.25rem 0}
.msg.me{background:#1f2a37}
.chatinput{display:flex;gap:.5rem;padding:.6rem;border-top:1px solid var(--line)}

.err{color:#fecaca}
</style>
</head>
<body>
<div class="app" id="app">
  <header class="header">
    <div class="brand">
      <span class="dot"></span>
      <b>Taxi Ya</b>
      <span class="chip" id="statusChip">offline</span>
    </div>
    <nav class="tabs" id="tabs"></nav>
  </header>

  <div class="container">
    <aside class="aside">
      <div class="panel-head">
        <strong id="sideTitle">Cuenta</strong>
        <span class="badge ok" id="authBadge">No conectado</span>
      </div>
      <div class="panel-body" id="sideBody"><!-- lateral din√°mico --></div>
    </aside>

    <main class="main">
      <div class="panel-head"><strong id="mainTitle">Mapa</strong></div>
      <div class="panel-body">
        <div id="map"></div>
        <div class="grid cols-2" style="margin-top:.75rem">
          <div class="card">
            <div class="row wrap" style="justify-content:space-between">
              <div>
                <div class="label">Origen</div>
                <div id="origenTxt" class="chip">‚Äî</div>
              </div>
              <div>
                <div class="label">Destino</div>
                <div id="destinoTxt" class="chip">‚Äî</div>
              </div>
              <div>
                <div class="label">Distancia (km)</div>
                <div id="kmTxt" class="chip">0.00</div>
              </div>
              <div>
                <div class="label">Tarifa estimada</div>
                <div id="fareTxt" class="chip">$ 0</div>
              </div>
            </div>
            <div class="row" style="margin-top:.6rem;gap:.5rem;flex-wrap:wrap">
              <button class="btn" id="btnMiUbicacion">Usar mi ubicaci√≥n como ORIGEN</button>
              <button class="btn ghost" id="btnLimpiar">Limpiar</button>
              <button class="btn primary" id="btnSolicitar">Solicitar viaje</button>
            </div>
            <p class="help" id="actividad">Toca el mapa y eleg√≠ si es ORIGEN o DESTINO (se pregunta en cada toque).</p>
          </div>

          <div class="card">
            <div class="label">Chat del viaje</div>
            <div class="chatbox">
              <div id="chatlog" class="chatlog"></div>
              <div class="chatinput">
                <input id="chatInput" class="input" placeholder="Escribe un mensaje respetuoso‚Ä¶"/>
                <button class="btn" id="chatSend">Enviar</button>
              </div>
            </div>
            <div class="help">El chat se habilita al tener un viaje activo.</div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- ================= Firebase + App (M√≥dulos) ================= -->
<script type="module">
// ===== Firebase SDK (m√≥dulos via CDN) =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, addDoc, collection, serverTimestamp, onSnapshot, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// *** Config proporcionada ***
const firebaseConfig = {
  apiKey: "AIzaSyBu523IOGnIZGfAkdlLdVLcENwLgv5KU9o",
  authDomain: "taxi-ya-3be33.firebaseapp.com",
  projectId: "taxi-ya-3be33",
  storageBucket: "taxi-ya-3be33.firebasestorage.app",
  messagingSenderId: "31840475169",
  appId: "1:31840475169:web:1485e47b9ebea4a66c6b60",
  measurementId: "G-2RQRP1G2KB"
};

const appFB = initializeApp(firebaseConfig);
try{ getAnalytics(appFB); }catch(e){ /* analytics requiere https/permitidos, ignorar errores */ }
const auth = getAuth(appFB);
const db = getFirestore(appFB);

// ======= Estado y utilidades =======
const $ = (sel) => document.querySelector(sel);
const tabsEl = $('#tabs');
let map, origenMarker, destinoMarker, meMarker, activeReqUnsub=null, chatUnsub=null, listUnsub=null;
let state = {
  fbUser: null,
  profile: null, // {name, role, ratingSum, ratingCount}
  precios: { base: 800, porKm: 350, descuento: 0.10 },
  origen: null, destino: null,
  activeRequestId: null, // id en Firestore
};

const bannedWords = ['puta','puto','cagar','mierda','hdp','concha','pija','forro','insulto','boludo'];
function sanitizeMsg(text){
  let t = text.trim();
  for(const w of bannedWords){ t = t.replace(new RegExp('\b'+w+'\b','gi'), '***'); }
  return t;
}

function fmt(n){ return new Intl.NumberFormat('es-AR', {style:'currency', currency:'ARS', maximumFractionDigits:0}).format(n); }
function km(a,b){
  if(!a||!b) return 0;
  const R=6371; // km
  const dLat=(b.lat-a.lat)*Math.PI/180; const dLon=(b.lng-a.lng)*Math.PI/180;
  const la1=a.lat*Math.PI/180, la2=b.lat*Math.PI/180;
  const h=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(h));
}

// ======= Tabs =======
const TABS = [
  {id:'cuenta', label:'Cuenta'},
  {id:'pasajero', label:'Pasajero'},
  {id:'conductor', label:'Conductor'},
  {id:'perfil', label:'Perfil'},
  {id:'ajustes', label:'Ajustes'}
];
let currentTab = 'cuenta';

function renderTabs(){
  tabsEl.innerHTML = '';
  for(const t of TABS){
    const el = document.createElement('button');
    el.className = 'tab';
    el.textContent = t.label;
    el.setAttribute('aria-selected', t.id===currentTab);
    el.onclick = ()=>{ currentTab=t.id; renderSide(); };
    tabsEl.appendChild(el);
  }
}

function setStatusChip(){
  const sc = $('#statusChip');
  if(state.fbUser){ sc.textContent = state.profile? state.profile.role : 'conectado'; }
  else { sc.textContent = 'offline'; }
  sc.className = 'chip';
  $('#authBadge').textContent = state.fbUser? 'Conectado' : 'No conectado';
}

// ======= Lateral =======
function renderSide(){
  renderTabs(); setStatusChip();
  $('#sideTitle').textContent = ({
    cuenta:'Cuenta', pasajero:'Pasajero', conductor:'Conductor', perfil:'Perfil', ajustes:'Ajustes'
  })[currentTab];
  const body = $('#sideBody');
  body.innerHTML='';

  if(currentTab==='cuenta') return body.appendChild(cardCuenta());
  if(!state.fbUser){ body.innerHTML = `<div class="card"><b>Inicia sesi√≥n</b><p class="help">Para usar esta secci√≥n necesit√°s estar conectado.</p></div>`; return; }
  if(currentTab==='pasajero') return body.appendChild(cardPasajero());
  if(currentTab==='conductor') return body.appendChild(cardConductor());
  if(currentTab==='perfil') return body.appendChild(cardPerfil());
  if(currentTab==='ajustes') return body.appendChild(cardAjustes());
}

// ======= Componentes =======
function cardCuenta(){
  const el = document.createElement('div'); el.className='grid';
  if(!state.fbUser){
    el.innerHTML = `
    <div class="card">
      <h3 style="margin:0 0 .5rem 0">Registraci√≥n</h3>
      <div class="grid cols-2">
        <div class="field"><label class="label">Nombre</label><input id="regName" class="input" placeholder="Ana, Mauro‚Ä¶"></div>
        <div class="field"><label class="label">Rol</label>
          <select id="regRole" class="input"><option value="pasajero">Pasajero</option><option value="conductor">Conductor</option></select>
        </div>
      </div>
      <div class="grid cols-2">
        <div class="field"><label class="label">Email</label><input id="regEmail" type="email" class="input" placeholder="nombre@mail.com"></div>
        <div class="field"><label class="label">Contrase√±a</label><input id="regPass" type="password" class="input" placeholder="m√≠n. 6 caracteres"></div>
      </div>
      <div class="row" style="margin-top:.8rem;gap:.5rem;flex-wrap:wrap">
        <button class="btn primary" id="btnReg">Crear cuenta</button>
        <span class="help">¬øYa ten√©s cuenta? Inicia abajo.</span>
      </div>
      <div id="regErr" class="err"></div>
    </div>
    <div class="card">
      <h3 style="margin:0 0 .5rem 0">Iniciar sesi√≥n</h3>
      <div class="grid cols-2">
        <div class="field"><label class="label">Email</label><input id="inEmail" type="email" class="input"></div>
        <div class="field"><label class="label">Contrase√±a</label><input id="inPass" type="password" class="input"></div>
      </div>
      <div class="row" style="margin-top:.8rem;gap:.5rem;flex-wrap:wrap">
        <button class="btn" id="btnLogin">Entrar</button>
      </div>
      <div id="loginErr" class="err"></div>
    </div>`;
    setTimeout(()=>{
      $('#btnReg').onclick = async ()=>{
        const name=$('#regName').value.trim();
        const role=$('#regRole').value; const email=$('#regEmail').value.trim(); const pass=$('#regPass').value;
        $('#regErr').textContent='';
        try{
          const cred = await createUserWithEmailAndPassword(auth, email, pass);
          await updateProfile(cred.user, { displayName: name });
          await setDoc(doc(db,'users',cred.user.uid), {
            name, role, email, ratingSum:0, ratingCount:0, createdAt: serverTimestamp()
          });
        }catch(e){ $('#regErr').textContent = e.message; }
      };
      $('#btnLogin').onclick = async ()=>{
        $('#loginErr').textContent='';
        try{ await signInWithEmailAndPassword(auth, $('#inEmail').value.trim(), $('#inPass').value); }
        catch(e){ $('#loginErr').textContent = e.message; }
      };
    },0);
  } else {
    el.innerHTML = `
      <div class="card">
        <div class="row wrap" style="justify-content:space-between">
          <div>
            <div class="label">Usuario</div>
            <div class="chip">${state.profile?.name||state.fbUser.email}</div>
          </div>
          <div>
            <div class="label">Rol</div>
            <div class="chip">${state.profile?.role||'‚Äî'}</div>
          </div>
        </div>
        <div class="row" style="margin-top:.8rem;gap:.5rem;flex-wrap:wrap">
          <button class="btn danger" id="btnLogout">Cerrar sesi√≥n</button>
        </div>
      </div>
      <div class="card">
        <div class="label">Cambiar rol</div>
        <div class="row" style="gap:.5rem;flex-wrap:wrap">
          <select id="roleSel" class="input" style="max-width:220px"><option value="pasajero">Pasajero</option><option value="conductor">Conductor</option></select>
          <button class="btn" id="btnRole">Guardar</button>
        </div>
      </div>`;
    setTimeout(()=>{
      $('#btnLogout').onclick = ()=> signOut(auth);
      if(state.profile) $('#roleSel').value = state.profile.role;
      $('#btnRole').onclick = async ()=>{
        const r = $('#roleSel').value;
        await updateDoc(doc(db,'users',state.fbUser.uid), { role:r });
      };
    },0);
  }
  return el;
}

function cardPasajero(){
  const el = document.createElement('div'); el.className='grid';
  el.innerHTML = `
    <div class="card">
      <div class="label">C√≥mo elegir puntos</div>
      <p class="help">Toca el mapa y eleg√≠ si el toque es <b>ORIGEN</b> o <b>DESTINO</b>. Pod√©s usar tu ubicaci√≥n como origen.</p>
      <div class="row" style="gap:.5rem;flex-wrap:wrap">
        <button class="btn" id="btnUseMe">Usar mi ubicaci√≥n</button>
        <button class="btn ghost" id="btnClr">Limpiar</button>
      </div>
    </div>
    <div class="card">
      <div class="label">Solicitud</div>
      <p id="solicitudTxt" class="help">A√∫n no solicitaste un viaje.</p>
      <div class="row" style="gap:.5rem;flex-wrap:wrap">
        <button class="btn primary" id="btnReq">Solicitar viaje</button>
        <button class="btn ghost" id="btnCancelReq">Cancelar</button>
      </div>
    </div>`;
  setTimeout(()=>{
    $('#btnUseMe').onclick = miUbicacionComoOrigen;
    $('#btnClr').onclick = limpiar;
    $('#btnReq').onclick = solicitarViaje;
    $('#btnCancelReq').onclick = cancelarSolicitud;
  },0);
  return el;
}

function cardConductor(){
  const el = document.createElement('div'); el.className='grid';
  el.innerHTML = `
    <div class="card">
      <div class="label">Solicitudes pendientes</div>
      <div id="reqList" class="grid"></div>
    </div>
    <div class="card">
      <div class="label">Acciones del viaje</div>
      <div class="row" style="gap:.5rem;flex-wrap:wrap">
        <button class="btn" id="btnStart">Iniciar</button>
        <button class="btn" id="btnFinish">Finalizar</button>
      </div>
    </div>`;
  setTimeout(()=>{
    $('#btnStart').onclick = iniciarTrayecto;
    $('#btnFinish').onclick = finalizarTrayecto;
    suscribeListaPendientes();
  },0);
  return el;
}

function cardPerfil(){
  const p = state.profile || {ratingSum:0, ratingCount:0, role:'pasajero'};
  const avg = p.ratingCount? (p.ratingSum/p.ratingCount):0;
  const stars = [1,2,3,4,5].map(i=>`<span class="star ${avg>=i? '':'off'}">‚òÖ</span>`).join('');
  const totalStars = p.ratingSum;
  let trofeos = '';
  if(totalStars>=5000) trofeos += 'üèÜü•á'; else if(totalStars>=1000) trofeos += 'üèÜ';
  const el = document.createElement('div'); el.className='grid';
  el.innerHTML = `
    <div class="card">
      <div class="row wrap" style="gap:.75rem;align-items:flex-start">
        <img src="https://api.dicebear.com/9.x/initials/svg?seed=${encodeURIComponent(p.name||state.fbUser?.email||'U')}" alt="avatar" width="64" height="64" style="border-radius:12px;border:1px solid var(--line)"/>
        <div>
          <div style="font-weight:600">${p.name||'Usuario'}</div>
          <div class="chip">${state.fbUser?.email||''}</div>
          <div class="chip">Rol: ${p.role}</div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="label">Calificaci√≥n</div>
      <div class="row" style="gap:.35rem">${stars}</div>
      <div class="row" style="gap:.5rem;margin-top:.4rem">
        <div class="chip">${p.ratingCount} opiniones</div>
        <div class="chip">${avg.toFixed(2)} / 5.00</div>
        <div class="chip trophy">${trofeos||'‚Äî'}</div>
      </div>
    </div>`;
  return el;
}

function cardAjustes(){
  const pr = state.precios;
  const el = document.createElement('div'); el.className='grid';
  el.innerHTML = `
    <div class="card">
      <div class="label">Tarifas</div>
      <div class="grid cols-2">
        <div class="field"><label class="label">Base (ARS)</label><input id="pBase" class="input" type="number" value="${pr.base}"></div>
        <div class="field"><label class="label">Por km (ARS)</label><input id="pKm" class="input" type="number" value="${pr.porKm}"></div>
      </div>
      <div class="field"><label class="label">Descuento app (0‚Äì0.9)</label><input id="pDesc" class="input" type="number" step="0.01" value="${pr.descuento}"></div>
      <div class="row" style="margin-top:.6rem;gap:.5rem"><button class="btn" id="btnSaveTarifas">Guardar</button></div>
    </div>`;
  setTimeout(()=>{
    $('#btnSaveTarifas').onclick = ()=>{
      state.precios.base = Number($('#pBase').value||0);
      state.precios.porKm = Number($('#pKm').value||0);
      state.precios.descuento = Number($('#pDesc').value||0);
      updateInfo();
      alert('Tarifas actualizadas');
    };
  },0);
  return el;
}

// ======= Mapa =======
function initMap(){
  map = L.map('map', { zoomControl:true }).setView([-34.6037,-58.3816], 12); // CABA por defecto
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'¬© OpenStreetMap' }).addTo(map);
  map.on('click', (e)=>{
    if(!state.fbUser){ alert('Inicia sesi√≥n para usar el mapa.'); return; }
    const useAsOrigin = confirm('¬øUsar este punto como ORIGEN?
(Cancelar = DESTINO)');
    const p = { lat: e.latlng.lat, lng: e.latlng.lng };
    if(useAsOrigin){ setOrigen(p); } else { setDestino(p); }
  });
}
function setOrigen(p){
  if(origenMarker) map.removeLayer(origenMarker);
  origenMarker = L.marker([p.lat, p.lng], { draggable:true }).addTo(map).bindPopup('Origen');
  origenMarker.on('dragend',()=>{ const ll=origenMarker.getLatLng(); setOrigen({lat:ll.lat,lng:ll.lng}); });
  state.origen=p; updateInfo();
}
function setDestino(p){
  if(destinoMarker) map.removeLayer(destinoMarker);
  destinoMarker = L.marker([p.lat, p.lng], { draggable:true, icon: L.divIcon({className:'', html:'<div style="background:#1e293b;border:2px solid #334155;color:#fff;padding:2px 6px;border-radius:6px">üéØ</div>'}) }).addTo(map).bindPopup('Destino');
  destinoMarker.on('dragend',()=>{ const ll=destinoMarker.getLatLng(); setDestino({lat:ll.lat,lng:ll.lng}); });
  state.destino=p; updateInfo();
}
function miUbicacionComoOrigen(){
  if(!navigator.geolocation){ alert('Geolocalizaci√≥n no disponible'); return; }
  navigator.geolocation.getCurrentPosition((pos)=>{
    const p={lat:pos.coords.latitude,lng:pos.coords.longitude};
    if(meMarker) map.removeLayer(meMarker);
    meMarker = L.circleMarker([p.lat,p.lng], {radius:7, color:'#34d399'}).addTo(map).bindPopup('Mi ubicaci√≥n');
    map.setView([p.lat,p.lng], 14);
    setOrigen(p);
  }, ()=> alert('No se pudo obtener ubicaci√≥n'));
}
function limpiar(){
  if(origenMarker) map.removeLayer(origenMarker); origenMarker=null; state.origen=null;
  if(destinoMarker) map.removeLayer(destinoMarker); destinoMarker=null; state.destino=null;
  updateInfo();
}
function updateInfo(){
  const o = state.origen, d=state.destino; const dist = km(o,d);
  $('#origenTxt').textContent = o? `${o.lat.toFixed(4)}, ${o.lng.toFixed(4)}` : '‚Äî';
  $('#destinoTxt').textContent = d? `${d.lat.toFixed(4)}, ${d.lng.toFixed(4)}` : '‚Äî';
  $('#kmTxt').textContent = dist.toFixed(2);
  const bruto = state.precios.base + dist*state.precios.porKm; // simple
  const final = Math.max(0, Math.round(bruto*(1 - state.precios.descuento)));
  $('#fareTxt').textContent = fmt(final);
}

// ======= Firestore: Solicitudes/ Viaje =======
async function solicitarViaje(){
  if(!state.fbUser) return alert('Inicia sesi√≥n');
  const prof = state.profile; if(prof?.role!=='pasajero') return alert('Cambi√° a rol PASAJERO en Cuenta.');
  if(!state.origen || !state.destino) return alert('Eleg√≠ origen y destino');
  const dist = km(state.origen,state.destino);
  const precio = Math.max(0, Math.round((state.precios.base + dist*state.precios.porKm) * (1 - state.precios.descuento)));
  const docRef = await addDoc(collection(db,'requests'),{
    status:'buscando',
    pasajeroId: state.fbUser.uid,
    pasajeroNombre: state.profile?.name || state.fbUser.email,
    origen: state.origen, destino: state.destino,
    km: dist, precio,
    createdAt: serverTimestamp()
  });
  state.activeRequestId = docRef.id;
  watchActiveRequest(docRef.id);
}

async function cancelarSolicitud(){
  if(!state.activeRequestId) return;
  await updateDoc(doc(db,'requests',state.activeRequestId), { status:'cancelado' });
}

function watchActiveRequest(id){
  if(activeReqUnsub) activeReqUnsub();
  activeReqUnsub = onSnapshot(doc(db,'requests',id), (snap)=>{
    if(!snap.exists()) return;
    const r = snap.data();
    $('#actividad').textContent = `#${id.slice(0,6)} ‚Äî ${r.status.toUpperCase()} ‚Äî ${fmt(r.precio)} (${(r.km||0).toFixed(2)} km)`;
    if(r.status==='finalizado' || r.status==='cancelado'){
      // pedir calificaci√≥n
      setTimeout(async ()=>{
        const stars = Number(prompt('Califica de 1 a 5 estrellas','5'))||5;
        const uRef = doc(db,'users',state.fbUser.uid);
        const u = await getDoc(uRef);
        const sum=(u.data().ratingSum||0)+stars, cnt=(u.data().ratingCount||0)+1;
        await updateDoc(uRef,{ratingSum:sum,ratingCount:cnt});
        alert('¬°Gracias por calificar!');
      }, 50);
      state.activeRequestId=null;
      if(chatUnsub){ chatUnsub(); chatUnsub=null; }
    }else{
      ensureChatListener(id);
    }
  });
}

function ensureChatListener(reqId){
  if(chatUnsub) return; // ya escuchando
  const msgsRef = collection(db,'requests',reqId,'messages');
  chatUnsub = onSnapshot(query(msgsRef, orderBy('ts','asc'), limit(100)), (qs)=>{
    const log = $('#chatlog'); log.innerHTML='';
    qs.forEach(d=>{
      const m=d.data();
      const who = m.from === (state.profile?.role==='pasajero'?'pax':'drv') ? 'me':'';
      log.insertAdjacentHTML('beforeend', `<div class="msg ${who}"><b>${m.from==='pax'?'Pasajero':'Conductor'}:</b> ${m.text}</div>`);
    });
    log.scrollTop = log.scrollHeight;
  });
}

// enviar chat
$('#chatSend').addEventListener('click', async ()=>{
  if(!state.activeRequestId) return alert('Sin viaje activo');
  const input = $('#chatInput'); let text = (input.value||'').trim(); if(!text) return;
  const sanitized = sanitizeMsg(text); if(/^\*{3,}$/.test(sanitized)) return alert('Mensaje bloqueado');
  await addDoc(collection(db,'requests',state.activeRequestId,'messages'),{
    from: state.profile?.role==='pasajero'?'pax':'drv', text: sanitized, ts: serverTimestamp()
  });
  input.value='';
});

// Conductor: lista pendientes y acciones
function suscribeListaPendientes(){
  if(listUnsub) listUnsub();
  listUnsub = onSnapshot(query(collection(db,'requests'), where('status','==','buscando'), orderBy('createdAt','desc'), limit(20)), (qs)=>{
    const cont = $('#reqList'); if(!cont) return; cont.innerHTML='';
    qs.forEach(docu=>{
      const r = docu.data(); const id=docu.id;
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `
        <div class="row wrap" style="justify-content:space-between">
          <div>
            <div class="chip">#${id.slice(0,6)}</div>
            <div class="chip">Pasajero: ${r.pasajeroNombre}</div>
          </div>
          <div>
            <div class="chip">${(r.km||0).toFixed(2)} km</div>
            <div class="chip">${fmt(r.precio||0)}</div>
          </div>
        </div>
        <div class="row" style="margin-top:.5rem;gap:.5rem">
          <button class="btn primary" data-id="${id}">Aceptar</button>
        </div>`;
      cont.appendChild(card);
      card.querySelector('button').onclick = ()=> aceptarViaje(id);
    });
  });
}

async function aceptarViaje(id){
  if(!state.fbUser) return alert('Inicia sesi√≥n');
  if(state.profile?.role!=='conductor') return alert('Cambi√° a rol CONDUCTOR en Cuenta.');
  await updateDoc(doc(db,'requests',id), {
    status:'aceptado',
    conductorId: state.fbUser.uid,
    conductorNombre: state.profile?.name || state.fbUser.email
  });
  state.activeRequestId = id; watchActiveRequest(id);
}

async function iniciarTrayecto(){
  if(!state.activeRequestId) return alert('Sin viaje activo');
  await updateDoc(doc(db,'requests',state.activeRequestId), { status:'en_curso' });
}
async function finalizarTrayecto(){
  if(!state.activeRequestId) return alert('Sin viaje activo');
  await updateDoc(doc(db,'requests',state.activeRequestId), { status:'finalizado' });
}

// ======= Auth =======
onAuthStateChanged(auth, async (user)=>{
  state.fbUser = user;
  if(user){
    // cargar/crear perfil
    const uref = doc(db,'users',user.uid);
    const snap = await getDoc(uref);
    if(!snap.exists()){
      await setDoc(uref, { name: user.displayName||'', email:user.email||'', role:'pasajero', ratingSum:0, ratingCount:0, createdAt: serverTimestamp() });
      state.profile = { name:user.displayName||'', email:user.email||'', role:'pasajero', ratingSum:0, ratingCount:0 };
    }else{
      state.profile = snap.data();
    }
  } else {
    state.profile = null; state.activeRequestId=null;
    if(activeReqUnsub){ activeReqUnsub(); activeReqUnsub=null; }
    if(chatUnsub){ chatUnsub(); chatUnsub=null; }
    if(listUnsub){ listUnsub(); listUnsub=null; }
  }
  renderSide();
});

// ======= Eventos iniciales =======
function bootstrap(){
  renderTabs();
  initMap();
  $('#btnMiUbicacion').onclick = miUbicacionComoOrigen;
  $('#btnLimpiar').onclick = limpiar;
  $('#btnSolicitar').onclick = solicitarViaje;
}
bootstrap();
</script>
</body>
</html>
