<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Taxi Ya — Registro estable</title>

<!-- Leaflet (solo para probar mapa; puedes quitarlo si no lo usas) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0e1116; --panel:#111722; --ink:#f6f8fb; --muted:#93a6b7; --line:#243445;
  --accent:#00b3ff; --accent2:#ffd34d; --ok:#17c964; --danger:#ef4444;
  --radius:16px; --shadow:0 16px 40px rgba(0,0,0,.45);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Poppins,system-ui,Arial}
header{position:sticky;top:0;z-index:30;background:rgba(14,17,22,.8);backdrop-filter:blur(6px);padding:12px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
.brand{font-weight:800}
.badge{border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px;opacity:.9}

main{max-width:1100px;margin:16px auto;padding:0 12px;display:grid;gap:12px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
h2{margin:6px 0 10px;font-size:18px}
label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
input,select,button{font:inherit}
input,select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.02);color:var(--ink)}
input::placeholder{color:#8aa0b3}
button{border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
.btn{background:transparent;border:1px solid var(--line);color:var(--ink)} .btn:hover{filter:brightness(1.08)}
.btnp{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#082532} .btnp:hover{filter:brightness(1.03)}
.btnd{background:linear-gradient(180deg,#ff7a7a,var(--danger));color:#fff}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.row>*{flex:1 1 240px}
.small{font-size:12px}.muted{color:var(--muted)}
.pill{display:inline-block;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);font-size:13px}
.ok{color:#0d3a24;background:#123225;border-color:#256a4b}
.warn{color:#c58b22;background:#2a230f;border-color:#4a3d14}
.error{color:#ffb4b4;background:#2a0f12;border-color:#5d1d24}
.inline-card{display:flex;align-items:center;gap:10px;border:1px solid var(--line);border-radius:12px;padding:8px;background:rgba(255,255,255,.02)}
.avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
.hide{display:none!important}

/* Mapa (opcional para probar) */
.map{width:100%;height:55vh;min-height:300px;border-radius:16px;border:1px solid var(--line);overflow:hidden}
</style>
</head>
<body>
<header>
  <div class="brand">Taxi Ya</div>
  <div id="authPill" class="badge">Sin sesión</div>
</header>

<main>
  <!-- ACCESO -->
  <section id="panel-access" class="card">
    <h2>Acceso</h2>

    <div class="row" style="gap:6px;margin-bottom:8px">
      <button class="btnp" id="goLogin" type="button">Iniciar sesión</button>
      <button class="btn"  id="goRegister" type="button">Registrarme</button>
      <span id="msg" class="pill hide" role="status" aria-live="polite"></span>
    </div>

    <!-- LOGIN -->
    <form id="loginBox" novalidate>
      <div class="row">
        <div><label>Correo</label><input id="loginEmail" type="email" placeholder="tucorreo@dominio.com" autocomplete="username" required></div>
        <div><label>Contraseña</label><input id="loginPass" type="password" placeholder="••••••" autocomplete="current-password" required></div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btnp" id="btnSignIn" type="submit">Entrar</button>
        <button class="btn"  id="btnFast" type="button" title="Para pruebas rápidas">Entrar rápido (demo)</button>
        <button class="btn"  id="btnForgot" type="button">Olvidé mi contraseña</button>
      </div>
    </form>

    <!-- REGISTRO (foto opcional) -->
    <form id="registerBox" class="hide" novalidate>
      <div class="row">
        <div><label>Nombre</label><input id="regName" placeholder="Tu nombre y apellido" autocomplete="name" required></div>
        <div><label>Correo</label><input id="regEmail" type="email" placeholder="tucorreo@dominio.com" autocomplete="username" required></div>
      </div>
      <div class="row" style="margin-top:6px">
        <div><label>Contraseña</label><input id="regPass" type="password" placeholder="mín. 6" autocomplete="new-password" minlength="6" required></div>
        <div><label>Confirmar contraseña</label><input id="regPass2" type="password" placeholder="repetir" autocomplete="new-password" minlength="6" required></div>
      </div>
      <div class="row" style="margin-top:6px">
        <div><label>Foto de perfil (opcional)</label><input id="regPhoto" type="file" accept="image/*"></div>
        <div class="small muted" style="align-self:flex-end">* Si subís foto la comprimimos para evitar límites de tamaño.</div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btnp" id="btnSignUp" type="submit">Crear cuenta y entrar</button>
      </div>
    </form>
  </section>

  <!-- PERFIL / SALIR -->
  <section id="panel-settings" class="card hide">
    <h2>Mi cuenta</h2>
    <div class="inline-card">
      <img id="profileAvatar" class="avatar" alt="Avatar">
      <div class="small" id="profileInfo"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn"  id="btnMakeDriver" type="button">Aprobar como Conductor (demo)</button>
      <button class="btnd" id="btnSignOut"   type="button">Cerrar sesión</button>
    </div>
  </section>

  <!-- Mapa de prueba -->
  <section id="panel-map" class="card hide">
    <h2>Mapa (prueba)</h2>
    <div id="map" class="map"></div>
  </section>
</main>

<script type="module">
/* =============== Firebase (tu proyecto) =============== */
const firebaseConfig = {
  apiKey: "AIzaSyBu523IOGnIZGfAkdlLdVLcENwLgv5KU9o",
  authDomain: "taxi-ya-3be33.firebaseapp.com",
  projectId: "taxi-ya-3be33",
  storageBucket: "taxi-ya-3be33.appspot.com",
  messagingSenderId: "31840475169",
  appId: "1:31840475169:web:1485e47b9ebea4a66c6b60",
  measurementId: "G-2RQRP1G2KB"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
const usersCol = db.collection("users");

/* =============== Helpers =============== */
const $=s=>document.querySelector(s);
const normalizeEmail=e=>String(e||"").trim().toLowerCase();
function pill(el, text, cls){ el.textContent=text; el.className=`pill ${cls||''}`; el.classList.remove('hide'); }
function hidePill(){ $("#msg").classList.add("hide"); }
function setLoading(btn,is){ btn.disabled=is; btn.textContent=is? "Procesando..." : btn.dataset.label||btn.textContent; }
function mapErrors(e){
  const c=e?.code||"";
  if(c==="auth/email-already-in-use") return "Ese correo ya está registrado. Iniciá sesión.";
  if(c==="auth/invalid-email")       return "Correo inválido.";
  if(c==="auth/weak-password")       return "La contraseña es muy corta (mín. 6).";
  if(c==="auth/invalid-credential"||c==="auth/wrong-password") return "Correo o contraseña incorrectos.";
  if(c==="auth/user-not-found")      return "No existe una cuenta con ese correo.";
  return "Ocurrió un error. Intenta de nuevo.";
}

/* =============== Navegación simple =============== */
function go(panel){
  $("#panel-access").classList.toggle("hide", panel!=="access");
  $("#panel-settings").classList.toggle("hide", panel!=="settings");
  $("#panel-map").classList.toggle("hide", panel!=="map");
}
$("#goLogin").onclick = ()=>{ hidePill(); $("#loginBox").classList.remove("hide"); $("#registerBox").classList.add("hide"); $("#loginEmail").focus(); };
$("#goRegister").onclick = ()=>{ hidePill(); $("#registerBox").classList.remove("hide"); $("#loginBox").classList.add("hide"); $("#regName").focus(); };

/* =============== Compresión de imagen (opcional) =============== */
function compressImage(file, maxBytes=900*1024, maxW=512){
  return new Promise((resolve,reject)=>{
    const img=new Image(), rdr=new FileReader();
    rdr.onload=e=>{ img.src=e.target.result; };
    img.onload=()=>{
      const scale=Math.min(1, maxW/img.width);
      const w=Math.round(img.width*scale), h=Math.round(img.height*scale);
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      let q=0.92, out;
      do{ out=c.toDataURL('image/jpeg', q); q-=0.07; }while(out.length>maxBytes && q>0.35);
      resolve(out);
    };
    img.onerror=reject; rdr.readAsDataURL(file);
  });
}

/* =============== REGISTRO (estable, sin verificación) =============== */
$("#registerBox").addEventListener("submit", async (e)=>{
  e.preventDefault(); hidePill();
  const name = $("#regName").value.trim();
  const email = normalizeEmail($("#regEmail").value);
  const pass  = $("#regPass").value;
  const pass2 = $("#regPass2").value;
  const file  = $("#regPhoto").files[0];
  const btn   = $("#btnSignUp"); btn.dataset.label="Crear cuenta y entrar"; setLoading(btn,true);

  if(!name || !email || pass.length<6 || pass!==pass2){
    pill($("#msg"), "Completá todos los campos y verifica la contraseña.", "warn"); setLoading(btn,false); return;
  }

  try{
    let photoURL="";
    if(file){ photoURL = await compressImage(file); }

    const { user } = await auth.createUserWithEmailAndPassword(email, pass);
    await user.updateProfile({ displayName: name, photoURL });

    await usersCol.doc(user.uid).set({
      uid:user.uid, email:user.email, displayName:name,
      photoURL, role:"rider", approved:false, online:false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});

    pill($("#msg"), "¡Cuenta creada! Ya estás dentro.", "ok");
  }catch(e){
    pill($("#msg"), mapErrors(e), "error");
  }finally{
    setLoading(btn,false);
  }
});

/* =============== LOGIN =============== */
$("#loginBox").addEventListener("submit", async (e)=>{
  e.preventDefault(); hidePill();
  const email = normalizeEmail($("#loginEmail").value);
  const pass  = $("#loginPass").value;
  const btn   = $("#btnSignIn"); btn.dataset.label="Entrar"; setLoading(btn,true);
  try{
    await auth.signInWithEmailAndPassword(email, pass);
  }catch(e){
    pill($("#msg"), mapErrors(e), "error");
  }finally{
    setLoading(btn,false);
  }
});

/* =============== Entrar rápido (demo) =============== */
$("#btnFast").addEventListener("click", async ()=>{
  hidePill();
  const emailTyped = $("#loginEmail").value.trim() || `demo-${Date.now()}@demo.local`;
  const btn = $("#btnFast"); btn.dataset.label="Entrar rápido (demo)"; setLoading(btn,true);
  try{
    const cred = await auth.signInAnonymously();
    const u = cred.user;
    const displayName = emailTyped.split('@')[0];
    const photoURL = "https://i.pravatar.cc/100?u="+u.uid;
    await usersCol.doc(u.uid).set({
      uid:u.uid, emailTyped, displayName, photoURL,
      role:"rider", approved:false, online:false, demo:true,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
  }catch(_){
    pill($("#msg"), "No se pudo entrar en modo demo.", "error");
  }finally{ setLoading(btn,false); }
});

/* =============== Olvidé mi contraseña =============== */
$("#btnForgot").addEventListener("click", async ()=>{
  hidePill();
  const email = normalizeEmail($("#loginEmail").value);
  if(!email) return pill($("#msg"),"Escribí tu correo y volvés a intentar.","warn");
  try{ await auth.sendPasswordResetEmail(email); pill($("#msg"),"Te envié el enlace de restablecimiento.","ok"); }
  catch(e){ pill($("#msg"), mapErrors(e), "error"); }
});

/* =============== Perfil, salir, conductor demo =============== */
$("#btnSignOut").addEventListener("click", ()=> auth.signOut().catch(()=>{}));
$("#btnMakeDriver").addEventListener("click", async ()=>{
  if(!auth.currentUser) return;
  await usersCol.doc(auth.currentUser.uid).set({role:"driver",approved:true},{merge:true});
  pill($("#msg"),"Marcado como conductor (demo).","ok"); paintProfile();
});

/* =============== Estado de sesión =============== */
auth.onAuthStateChanged(async (u)=>{
  if(!u){
    $("#authPill").textContent="Sin sesión";
    go("access");
    return;
  }
  const ref=usersCol.doc(u.uid); const snap=await ref.get();
  if(!snap.exists){
    await ref.set({
      uid:u.uid,
      email: u.email || null,
      emailTyped: u.isAnonymous ? ($("#loginEmail").value.trim() || null) : null,
      displayName: u.displayName || (u.email ? u.email.split('@')[0] : 'Invitado'),
      photoURL: u.photoURL || "https://i.pravatar.cc/100?u="+u.uid,
      role:"rider", approved:false, online:false, demo: u.isAnonymous===true,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
  }
  const data=(await ref.get()).data();
  $("#authPill").textContent = `${data.displayName||'Usuario'} — ${(data.role||'rider')}${data.approved?' (KYC✓)':''}${data.demo?' (demo)':''}`;
  paintProfile(data);
  go("settings");
  initMapOnce();
});

/* =============== Perfil UI =============== */
function paintProfile(d){
  d=d||{};
  $("#profileAvatar").src = d.photoURL || "https://i.pravatar.cc/100?u=placeholder";
  $("#profileInfo").innerHTML = `
    Nombre: <b>${d.displayName||"—"}</b> · Correo: <b>${d.email||d.emailTyped||"—"}</b><br>
    Rol: <b>${d.role||'rider'}</b> · KYC: <b>${d.approved?'Aprobado':'No'}</b>${d.demo?' · Sesión demo':''}
  `;
}

/* =============== Mapa (opcional) =============== */
let map=null;
function initMapOnce(){
  if(map) return;
  $("#panel-map").classList.remove("hide");
  map = L.map('map',{zoomControl:false});
  L.control.zoom({position:'bottomright'}).addTo(map);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
    {maxZoom:19,subdomains:'abcd',attribution:'© OpenStreetMap © CARTO'}).addTo(map);
  map.setView([-31.5375,-68.5364],12);
}
</script>
</body>
</html>
