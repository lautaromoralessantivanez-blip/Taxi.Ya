<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Taxi Ya ‚Äî Firebase</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Routing Machine + OSRM -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0f15; --panel:#0f141d; --ink:#f5f7fb; --muted:#a9b4c2; --line:#1b2430;
  --accent:#ffd34d; --ok:#22c55e; --danger:#ef4444; --chip:#17202a; --card:#0d131b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0f15,#0b0f15 60%,#0a0f19);color:var(--ink);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial}
button,input,select{font-family:inherit}

/* AUTH GATE */
#gate{position:fixed;inset:0;display:grid;place-items:center;background:radial-gradient(1200px 800px at 50% -10%,#13202e 0%, #0b0f15 60%, #0a0f19 100%);z-index:100}
.gate-card{width:min(920px,92vw);background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:1rem}
.gate-title{display:flex;align-items:center;gap:.6rem;margin:.25rem 0 1rem}
.gate-title .dot{width:.9rem;height:.9rem;border-radius:999px;background:var(--accent);box-shadow:0 0 16px rgba(255,211,77,.7)}
.grid{display:grid;gap:.75rem}
.grid.cols-2{grid-template-columns:1fr 1fr}
.field{display:grid;gap:.35rem}
.label{font-size:.9rem;color:var(--muted)}
.input{width:100%;background:#0e1620;border:1px solid var(--line);color:var(--ink);padding:.65rem .75rem;border-radius:12px}
.btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--line);background:#12202e;color:var(--ink);padding:.6rem .9rem;border-radius:12px;cursor:pointer;transition:.2s;text-decoration:none}
.btn.primary{background:var(--accent);color:#111;border-color:#e6b800}
.btn:disabled{opacity:.6;cursor:not-allowed}
.err{color:#fecaca}

/* APP */
.app{min-height:100dvh;display:grid;grid-template-rows:auto 1fr}
.header{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--line);background:rgba(13,19,27,.7);backdrop-filter:blur(12px);position:sticky;top:0;z-index:20}
.brand{display:flex;align-items:center;gap:.6rem}
.brand .dot{width:.9rem;height:.9rem;border-radius:999px;background:var(--accent);box-shadow:0 0 16px rgba(255,211,77,.7)}
.brand b{letter-spacing:.5px}
.tabs{display:flex;gap:.35rem;flex-wrap:wrap}
.tab{padding:.45rem .75rem;border:1px solid var(--line);border-radius:999px;background:#17202a;color:var(--ink);opacity:.85;cursor:pointer;transition:.2s}
.tab[aria-selected="true"]{background:var(--accent);color:#111;opacity:1;border-color:#e6b800}

.container{display:grid;grid-template-columns:360px 1fr;gap:1rem;padding:1rem;max-width:1300px;margin:0 auto}
.aside,.main{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden}
.panel-head{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--line);background:var(--card)}
.panel-body{
  padding:1rem;
  display:flex; flex-direction:column; gap:.75rem;
  min-height:calc(100vh - 140px);
}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:1rem}
.row{display:flex;gap:.6rem;align-items:center}
.row.wrap{flex-wrap:wrap}
.chip{background:#121a24;border:1px solid var(--line);padding:.35rem .6rem;border-radius:999px;font-size:.85rem;color:var(--muted)}
.badge{padding:.3rem .5rem;border-radius:8px;border:1px solid var(--line);font-size:.78rem}
.badge.ok{background:rgba(34,197,94,.12);color:#86efac;border-color:rgba(34,197,94,.35)}
.help{color:var(--muted);font-size:.86rem}

/* BARRA DE ESTADO (NO SUPERPUESTA) */
.status-bar{
  order: 50; display:none; align-items:center; gap:.6rem;
  background:#0f172a; border:1px solid #243045; padding:.55rem .75rem;
  border-radius:10px; font-weight:600;
}

/* MAPA: siempre abajo */
.map-wrap{ order: 99; position:relative }
#map{ width:100%; height:70vh; min-height:460px }
.leaflet-container{ background:#0b0f15 }

/* Chat compacto (colapsable) */
.chat-mini{order:98}
.chat-mini summary{
  cursor:pointer; list-style:none; display:flex; align-items:center; gap:.5rem;
  background:#0f172a; border:1px solid #243045; padding:.55rem .75rem; border-radius:10px; font-weight:600;
}
.chat-mini .chatbox{display:grid;grid-template-rows:1fr auto;height:180px;background:#0d131b;border:1px solid var(--line);border-radius:12px;overflow:hidden;margin-top:.6rem}
.chatlog{overflow:auto;padding:.6rem}
.msg{display:inline-block;background:#12202e;border:1px solid var(--line);padding:.45rem .6rem;border-radius:10px;margin:.25rem 0;font-size:.92rem}
.msg.me{background:#1f2a37}

/* Autocomplete */
.ac-results{ position:relative; margin-top:.35rem }
.ac-results::before{ content:''; position:absolute; top:-8px; left:16px; width:0; height:0; border-left:8px solid transparent; border-right:8px solid transparent; border-bottom:8px solid #0e1620; opacity:.8 }
.ac-results > div{ background:#0e1620; border:1px solid var(--line); border-radius:12px; overflow:hidden }
.ac-item{ padding:.6rem .75rem; border-bottom:1px solid #1a2430; cursor:pointer }
.ac-item:last-child{ border-bottom:0 }
.ac-item:hover{ background:#142032 }
.ac-title{ font-weight:600 }
.ac-sub{ font-size:.85rem; color:var(--muted) }

/* Responsive */
@media (max-width:1080px){
  .container{grid-template-columns:1fr}
  .aside{order:2}
  .main{order:1}
}
@media (max-width:680px){
  .tabs{position:fixed;bottom:10px;left:0;right:0;justify-content:center;z-index:40}
  .tab{background:#131c28;border-color:#223043}
  #map{height:64vh;min-height:360px}
}
</style>
</head>
<body>

<!-- ==================== AUTH GATE ==================== -->
<div id="gate" aria-hidden="false">
  <div class="gate-card">
    <div class="gate-title"><span class="dot"></span><b>Taxi Ya</b> <span class="chip" style="margin-left:.5rem;background:#121a24;border:1px solid var(--line);padding:.2rem .5rem;border-radius:999px;color:#a9b4c2">Registraci√≥n</span></div>
    <div class="grid cols-2">
      <div class="card" style="background:#0d131b">
        <h3 style="margin:0 0 .5rem 0">Crear cuenta</h3>
        <div class="grid cols-2">
          <div class="field"><label class="label">Nombre</label><input id="regName" class="input" placeholder="Ana, Mauro‚Ä¶"></div>
          <div class="field"><label class="label">Email</label><input id="regEmail" type="email" class="input" placeholder="nombre@mail.com"></div>
        </div>
        <div class="grid cols-2">
          <div class="field"><label class="label">Contrase√±a</label><input id="regPass" type="password" class="input" placeholder="m√≠n. 6 caracteres"></div>
          <div class="field"><label class="label">Repetir contrase√±a</label><input id="regPass2" type="password" class="input" placeholder="repite la contrase√±a"></div>
        </div>
        <div class="row" style="margin-top:.8rem;gap:.5rem;flex-wrap:wrap">
          <button class="btn primary" id="btnReg">Registrarme</button>
        </div>
        <div id="regErr" class="err"></div>
      </div>
      <div class="card" style="background:#0d131b">
        <h3 style="margin:0 0 .5rem 0">Ya tengo cuenta</h3>
        <div class="grid cols-2">
          <div class="field"><label class="label">Email</label><input id="inEmail" type="email" class="input"></div>
          <div class="field"><label class="label">Contrase√±a</label><input id="inPass" type="password" class="input"></div>
        </div>
        <div class="row" style="margin-top:.8rem;gap:.5rem;flex-wrap:wrap">
          <button class="btn" id="btnLogin">Entrar</button>
        </div>
        <div id="loginErr" class="err"></div>
      </div>
    </div>
    <p class="help" style="margin-top:.5rem">Ingres√° para continuar al mapa.</p>
  </div>
</div>

<!-- ==================== APP ==================== -->
<div class="app" id="app" style="display:none">
  <header class="header">
    <div class="brand"><span class="dot"></span><b>Taxi Ya</b><span class="chip" id="statusChip">offline</span></div>
    <nav class="tabs" id="tabs"></nav>
  </header>

  <div class="container">
    <aside class="aside">
      <div class="panel-head">
        <strong id="sideTitle">Panel</strong>
        <span class="badge ok" id="authBadge">Conectado</span>
      </div>
      <div class="panel-body" id="sideBody"></div>
    </aside>

    <main class="main">
      <div class="panel-head"><strong id="mainTitle">Mapa</strong></div>
      <div class="panel-body">
        <!-- Controles -->
        <div class="card">
          <div class="row wrap" style="justify-content:space-between;gap:.75rem">
            <div class="row" style="gap:.5rem;flex-wrap:wrap">
              <!-- ====== BUSCADOR DE DIRECCIONES ====== -->
              <div class="field" style="width:min(520px,100%)">
                <label class="label">Buscar direcci√≥n</label>
                <input id="addrSearch" class="input" placeholder="Ej: Av. Corrientes 1234, CABA" autocomplete="off">
                <div id="addrResults" class="ac-results" style="display:none"></div>
              </div>

              <div class="row" style="gap:.5rem">
                <div class="label">Seleccionar en mapa:</div>
                <div class="seg" id="modeSeg" style="display:inline-flex;border:1px solid var(--line);border-radius:999px;overflow:hidden">
                  <button id="modeOrigen" aria-pressed="true" style="border:0;background:#0e1620;color:#fff;padding:.45rem .8rem;cursor:pointer">Origen</button>
                  <button id="modeDestino" aria-pressed="false" style="border:0;background:#0e1620;color:#fff;padding:.45rem .8rem;cursor:pointer">Destino</button>
                </div>
              </div>
            </div>

            <div class="row" style="gap:.5rem;flex-wrap:wrap">
              <button class="btn" id="btnMiUbicacion">Usar mi ubicaci√≥n</button>
              <button class="btn" id="btnLimpiar">Limpiar</button>
              <button class="btn primary" id="btnSolicitar">Solicitar viaje</button>
            </div>
          </div>
        </div>

        <!-- BARRA DE ESTADO -->
        <div id="statusBar" class="status-bar">
          <span id="statusText">BUSCANDO CONDUCTOR‚Ä¶</span>
          <span class="chip" id="searchTimer">00:00</span>
        </div>

        <!-- Info -->
        <div class="card">
          <div class="row wrap" style="justify-content:space-between">
            <div><div class="label">Origen</div><div id="origenTxt" class="chip">‚Äî</div></div>
            <div><div class="label">Destino</div><div id="destinoTxt" class="chip">‚Äî</div></div>
            <div><div class="label">Distancia (km)</div><div id="kmTxt" class="chip">0.00</div></div>
            <div><div class="label">Duraci√≥n (min)</div><div id="minTxt" class="chip">0</div></div>
            <div><div class="label">Tarifa estimada</div><div id="fareTxt" class="chip">$ 0</div></div>
            <div><div class="label">Surge</div><div id="surgeTxt" class="chip">x1.0</div></div>
          </div>
          <p class="help" id="actividad">Toca el mapa para fijar Origen/Destino.</p>
        </div>

        <!-- Mapa -->
        <div class="map-wrap"><div id="map"></div></div>

        <!-- Chat compacto (solo aceptado o en curso) -->
        <details id="chatMini" class="chat-mini" style="display:none">
          <summary>üí¨ Chat del viaje (opcional)</summary>
          <div class="chatbox">
            <div id="chatlog" class="chatlog"></div>
            <div class="chatinput" style="display:flex;gap:.5rem;padding:.6rem;border-top:1px solid var(--line)">
              <input id="chatInput" class="input" placeholder="Escribe un mensaje respetuoso‚Ä¶" />
              <button class="btn" id="chatSend">Enviar</button>
            </div>
          </div>
          <div class="help">El chat se habilita cuando el viaje fue aceptado o est√° en curso.</div>
        </details>
      </div>
    </main>
  </div>
</div>

<!-- ================= Firebase + App (M√≥dulos) ================= -->
<script type="module">
/* Firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, addDoc, collection, serverTimestamp, onSnapshot, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* Config */
const firebaseConfig = {
  apiKey: "AIzaSyBu523IOGnIZGfAkdlLdVLcENwLgv5KU9o",
  authDomain: "taxi-ya-3be33.firebaseapp.com",
  projectId: "taxi-ya-3be33",
  storageBucket: "taxi-ya-3be33.firebasestorage.app",
  messagingSenderId: "31840475169",
  appId: "1:31840475169:web:1485e47b9ebea4a66c6b60",
  measurementId: "G-2RQRP1G2KB"
};

const appFB = initializeApp(firebaseConfig);
try{ getAnalytics(appFB); }catch(e){}
const auth = getAuth(appFB);
const db = getFirestore(appFB);

const $ = s => document.querySelector(s);

/* ===== Estado ===== */
let map, origenMarker, destinoMarker, meMarker, routing, ro=null;
let driverMarker=null;            // marcador en vivo del conductor
let activeReqUnsub=null, chatUnsub=null, listUnsub=null, userUnsub=null, timerInt=null, driverUnsub=null;
let driverWatchId=null;           // watchPosition id (para conductor)
let uiTab = 'pasajero';
let selectMode = 'origen';
let state = {
  fbUser: null,
  profile: null,
  pointsLocked:false,
  // Pricing estilo Uber
  surge: 1.0,
  pricing: Object.freeze({
    base: 800,       // $
    perKm: 350,      // $/km
    perMin: 120,     // $/min
    serviceFee: 150, // $ fijo
    minimum: 1200    // $ m√≠nimo
  }),
  origen:null, destino:null,
  routeKm:0, routeMin:0,
  activeRequestId:null, activeRequest:null,
  requestCreatedAt:null
};

/* ===== Tabs ===== */
function tabsForState(){ return state.fbUser ? [
  {id:'pasajero', label:'Pasajero'},
  {id:'conductor', label:'Conductor'},
  {id:'perfil',    label:'Perfil'}
] : []; }
function renderTabs(){
  const nav = $('#tabs'); nav.innerHTML='';
  for(const t of tabsForState()){
    const el = document.createElement('button');
    el.className='tab'; el.textContent=t.label;
    el.setAttribute('aria-selected', uiTab===t.id);
    el.onclick = ()=>{ uiTab=t.id; onTabChange(); };
    nav.appendChild(el);
  }
  $('#statusChip').textContent = state.fbUser? (state.profile?.name || 'online') : 'offline';
}
function onTabChange(){ renderSide(); setTimeout(()=> map?.invalidateSize(), 120); }

/* ===== Lateral ===== */
function renderSide(){
  const body = $('#sideBody'); const title = $('#sideTitle');
  const titles = { pasajero:'Pasajero', conductor:'Conductor', perfil:'Perfil' };
  title.textContent = titles[uiTab]||'Panel';
  body.innerHTML='';

  if(uiTab==='pasajero') body.appendChild(cardPasajero());
  if(uiTab==='conductor') body.appendChild(cardConductor());
  if(uiTab==='perfil')    body.appendChild(cardPerfil());
}
function cardPasajero(){
  const el = document.createElement('div'); el.className='grid';
  el.innerHTML = `
    <div class="card">
      <div class="label">Solicitud</div>
      <p id="solicitudTxt" class="help">Eleg√≠ origen y destino en el mapa o busc√° la direcci√≥n, revis√° la tarifa y solicit√°.</p>
      <div class="row" style="gap:.5rem;flex-wrap:wrap">
        <button class="btn primary" id="btnReq">Solicitar viaje</button>
        <button class="btn" id="btnCancelReq">Cancelar</button>
      </div>
      <p class="help" style="margin-top:.4rem">Al solicitar, los puntos quedan <b>bloqueados</b> hasta cancelar.</p>
    </div>`;
  setTimeout(()=>{ $('#btnReq').onclick=solicitarViaje; $('#btnCancelReq').onclick=cancelarSolicitud; },0);
  return el;
}
function cardConductor(){
  const el = document.createElement('div'); el.className='grid';
  el.innerHTML = `
    <div class="card">
      <div class="label">Solicitudes pendientes</div>
      <div id="reqList" class="grid"></div>
    </div>
    <div class="card">
      <div class="label">Acciones del viaje</div>
      <div class="row" style="gap:.5rem;flex-wrap:wrap">
        <button class="btn" id="btnStart">Iniciar</button>
        <button class="btn" id="btnFinish">Finalizar</button>
        <button class="btn" id="btnShare">Compartir ubicaci√≥n</button>
        <button class="btn" id="btnStopShare">Detener ubicaci√≥n</button>
      </div>
      <p class="help">La ubicaci√≥n se comparte s√≥lo si hay viaje aceptado/en curso.</p>
    </div>`;
  setTimeout(()=>{
    $('#btnStart').onclick=iniciarTrayecto;
    $('#btnFinish').onclick=finalizarTrayecto;
    $('#btnShare').onclick=startDriverShare;
    $('#btnStopShare').onclick=stopDriverShare;
    suscribeListaPendientes();
  },0);
  return el;
}
function cardPerfil(){
  const p = state.profile || {ratingSum:0, ratingCount:0};
  const avg = p.ratingCount? (p.ratingSum/p.ratingCount):0;
  const stars = [1,2,3,4,5].map(i=>`<span style="color:#fcd34d;opacity:${avg>=i?1:.35}">‚òÖ</span>`).join('');
  const el = document.createElement('div'); el.className='grid';
  el.innerHTML = `
    <div class="card">
      <div class="row wrap" style="gap:.75rem;align-items:flex-start">
        <img loading="lazy" src="https://api.dicebear.com/9.x/initials/svg?seed=${encodeURIComponent(p.name||state.fbUser?.email||'U')}" alt="avatar" width="64" height="64" style="border-radius:12px;border:1px solid var(--line)"/>
        <div>
          <div style="font-weight:600">${p.name||'Usuario'}</div>
          <div class="chip">${state.fbUser?.email||''}</div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="label">Sesi√≥n</div>
      <div class="row" style="gap:.5rem;flex-wrap:wrap"><button class="btn" id="btnLogout">Cerrar sesi√≥n</button></div>
    </div>
    <div class="card">
      <div class="label">Calificaci√≥n</div>
      <div class="row" style="gap:.35rem">${stars}</div>
      <div class="row" style="gap:.5rem;margin-top:.4rem">
        <div class="chip">${p.ratingCount||0} opiniones</div>
        <div class="chip">${avg.toFixed(2)} / 5.00</div>
      </div>
    </div>`;
  setTimeout(()=>{ $('#btnLogout').onclick=()=>signOut(auth); },0);
  return el;
}

/* ===== Mapa + Routing ===== */
function initMap(){
  map = L.map('map',{ zoomControl:true, preferCanvas:true }).setView([-34.6037,-58.3816],12);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(map);
  setTimeout(()=> map.invalidateSize(), 200);
  window.addEventListener('resize', ()=> map.invalidateSize());
  const pb = document.querySelector('.main .panel-body');
  if(pb){ const ResizeObs = window.ResizeObserver || null; if(ResizeObs){ const ro = new ResizeObs(()=> map.invalidateSize()); ro.observe(pb); } }

  map.on('click',(e)=>{
    if(state.pointsLocked){ alert('Los puntos est√°n bloqueados hasta cancelar la solicitud.'); return; }
    const p = {lat:e.latlng.lat,lng:e.latlng.lng};
    if(selectMode==='origen'){ setOrigen(p,true); } else { setDestino(p,true); }
  });
}
function ensureRouting(){
  if(routing) return routing;
  routing = L.Routing.control({
    waypoints: [],
    router: L.Routing.osrmv1({ serviceUrl:'https://router.project-osrm.org/route/v1', profile:'driving' }),
    lineOptions:{ addWaypoints:false, extendToWaypoints:true, missingRouteTolerance:20 },
    show:false, collapsible:true, fitSelectedRoutes:true
  })
  .on('routesfound',(e)=>{
    const route=e.routes?.[0]; if(!route) return;
    const distKm=(route.summary.totalDistance||0)/1000;
    const durMin=Math.round((route.summary.totalTime||0)/60);
    state.routeKm = distKm; state.routeMin = durMin;
    $('#kmTxt').textContent=distKm.toFixed(2);
    $('#minTxt').textContent=durMin.toString();
    updateFareUI();
    try{ map.fitBounds(route.bounds,{padding:[30,30]}); }catch(_){}
    $('#actividad').textContent=`Ruta: ${distKm.toFixed(2)} km ‚Ä¢ ~${durMin} min`;
  })
  .on('routingerror',()=> updateInfoHaversine())
  .addTo(map);
  return routing;
}
function setOrigen(p,recalc=false){
  if(origenMarker) map.removeLayer(origenMarker);
  origenMarker=L.marker([p.lat,p.lng],{draggable:!state.pointsLocked}).addTo(map).bindPopup('Origen');
  origenMarker.on('dragstart',()=>{ if(state.pointsLocked) origenMarker.closePopup(); });
  origenMarker.on('dragend',()=>{ if(state.pointsLocked) return; const ll=origenMarker.getLatLng(); setOrigen({lat:ll.lat,lng:ll.lng},true); });
  state.origen=p; $('#origenTxt').textContent=`${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}`;
  if(recalc) recalcRoute();
}
function setDestino(p,recalc=false){
  if(destinoMarker) map.removeLayer(destinoMarker);
  destinoMarker=L.marker([p.lat,p.lng],{draggable:!state.pointsLocked}).addTo(map).bindPopup('Destino');
  destinoMarker.on('dragstart',()=>{ if(state.pointsLocked) destinoMarker.closePopup(); });
  destinoMarker.on('dragend',()=>{ if(state.pointsLocked) return; const ll=destinoMarker.getLatLng(); setDestino({lat:ll.lat,lng:ll.lng},true); });
  state.destino=p; $('#destinoTxt').textContent=`${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}`;
  if(recalc) recalcRoute();
}
function recalcRoute(){
  if(!(state.origen&&state.destino)){ updateInfoHaversine(); return; }
  const r=ensureRouting();
  r.setWaypoints([L.latLng(state.origen.lat,state.origen.lng), L.latLng(state.destino.lat,state.destino.lng)]);
}
function miUbicacionComoOrigen(){
  if(!navigator.geolocation){ alert('Geolocalizaci√≥n no disponible'); return; }
  navigator.geolocation.getCurrentPosition((pos)=>{
    if(state.pointsLocked){ alert('Bloqueado por viaje activo'); return; }
    const p={lat:pos.coords.latitude,lng:pos.coords.longitude};
    if(meMarker) map.removeLayer(meMarker);
    meMarker=L.circleMarker([p.lat,p.lng],{radius:7,color:'#34d399'}).addTo(map).bindPopup('Mi ubicaci√≥n');
    map.setView([p.lat,p.lng],14); setOrigen(p,true);
  },()=> alert('No se pudo obtener ubicaci√≥n'));
}
function limpiar(){
  if(state.pointsLocked){ alert('No se puede limpiar con un viaje activo. Cancel√° primero.'); return; }
  if(origenMarker) map.removeLayer(origenMarker); origenMarker=null; state.origen=null;
  if(destinoMarker) map.removeLayer(destinoMarker); destinoMarker=null; state.destino=null;
  if(routing){ routing.setWaypoints([]); }
  state.routeKm=0; state.routeMin=0;
  $('#origenTxt').textContent='‚Äî'; $('#destinoTxt').textContent='‚Äî';
  $('#kmTxt').textContent='0.00'; $('#minTxt').textContent='0'; $('#fareTxt').textContent=fmt(0);
  $('#actividad').textContent='Toca el mapa para fijar Origen/Destino.';
}

/* ===== Utilidades + Precio estilo Uber ===== */
function fmt(n){ return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n); }
function km(a,b){ if(!a||!b) return 0; const R=6371;
  const dLat=(b.lat-a.lat)*Math.PI/180, dLon=(b.lng-a.lng)*Math.PI/180;
  const la1=a.lat*Math.PI/180, la2=b.lat*Math.PI/180;
  const h=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(h));
}
function calcFare(distKm, durMin){
  const p=state.pricing;
  const bruto = p.base + (distKm*p.perKm) + (durMin*p.perMin) + p.serviceFee;
  const surged = bruto * (state.surge || 1.0);
  return Math.max(p.minimum, Math.round(surged));
}
function updateFareUI(){
  const fare = calcFare(state.routeKm||0, state.routeMin||0);
  $('#fareTxt').textContent = fmt(fare);
  $('#surgeTxt').textContent = `x${(state.surge||1).toFixed(1)}`;
}
function updateInfoHaversine(){
  const dist=km(state.origen,state.destino);
  state.routeKm = dist; // sin duraci√≥n real
  state.routeMin = Math.round((dist/25)*60); // heur√≠stica 25 km/h si no hay OSRM
  $('#kmTxt').textContent=dist.toFixed(2);
  $('#minTxt').textContent=String(state.routeMin);
  updateFareUI();
}

/* ===== Autocompletado de direcciones (Nominatim) ===== */
const addrInput = document.getElementById('addrSearch');
const addrBox   = document.getElementById('addrResults');
function debounce(fn, ms=350){ let t=null; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
async function geocodeSearch(q){
  const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=6&q=${encodeURIComponent(q)}`;
  const r = await fetch(url, { headers:{ 'Accept-Language':'es-AR,es;q=0.9' }});
  if(!r.ok) return [];
  return r.json();
}
function renderAddrResults(list){
  if(!list || !list.length){ addrBox.style.display='none'; addrBox.innerHTML=''; return; }
  addrBox.style.display='block';
  addrBox.innerHTML = `<div>${list.map(item=>{
    const title = item.display_name.split(',').slice(0,2).join(', ');
    const sub   = item.display_name.split(',').slice(2).join(', ').trim();
    return `<div class="ac-item" data-lat="${item.lat}" data-lon="${item.lon}" data-name="${encodeURIComponent(item.display_name)}">
      <div class="ac-title">${title}</div>
      <div class="ac-sub">${sub}</div>
    </div>`;
  }).join('')}</div>`;
  addrBox.querySelectorAll('.ac-item').forEach(node=>{
    node.addEventListener('click', ()=>{
      const lat = parseFloat(node.getAttribute('data-lat'));
      const lon = parseFloat(node.getAttribute('data-lon'));
      const name= decodeURIComponent(node.getAttribute('data-name'));
      addrInput.value = name;
      addrBox.style.display='none';
      const p = { lat, lng: lon };
      if(selectMode==='origen'){ setOrigen(p, true); } else { setDestino(p, true); }
      map.setView([lat,lon], 15);
    });
  });
}
addrInput?.addEventListener('input', debounce(async (e)=>{
  if(state.pointsLocked) return; // no permitir cambios si activo
  const q = (e.target.value||'').trim();
  if(q.length<3){ addrBox.style.display='none'; addrBox.innerHTML=''; return; }
  try{ renderAddrResults(await geocodeSearch(q)); }
  catch(_){ addrBox.style.display='none'; addrBox.innerHTML=''; }
}, 380));
document.addEventListener('click', (e)=>{
  if(!addrBox.contains(e.target) && e.target!==addrInput){
    addrBox.style.display='none';
  }
});

/* ===== Chat ===== */
const bannedWords=['puta','puto','cagar','mierda','hdp','concha','pija','forro','insulto','boludo'];
function sanitizeMsg(t){ let x=t.trim(); for(const w of bannedWords){ x=x.replace(new RegExp('\\b'+w+'\\b','gi'),'***'); } return x; }
function mySide(){ const r=state.activeRequest; if(!r||!state.fbUser) return 'pax';
  if(r.pasajeroId===state.fbUser.uid) return 'pax';
  if(r.conductorId===state.fbUser.uid) return 'drv';
  return 'pax';
}
$('#chatSend')?.addEventListener('click', async ()=>{
  if(!state.activeRequestId) return alert('Sin viaje activo');
  const input=$('#chatInput'); const text=(input.value||'').trim(); if(!text) return;
  const sanitized=sanitizeMsg(text); if(/^\*{3,}$/.test(sanitized)) return alert('Mensaje bloqueado');
  await addDoc(collection(db,'requests',state.activeRequestId,'messages'),{ from:mySide(), text:sanitized, ts:serverTimestamp() });
  input.value='';
});

/* ===== Firestore: Solicitudes ===== */
async function solicitarViaje(){
  if(!(state.origen&&state.destino)) return alert('Eleg√≠ origen y destino');
  const distKm = state.routeKm || km(state.origen,state.destino);
  const precio = calcFare(distKm, state.routeMin||0);
  const docRef=await addDoc(collection(db,'requests'),{
    status:'buscando',
    pasajeroId:state.fbUser.uid,
    pasajeroNombre:state.profile?.name||state.fbUser.email,
    origen:state.origen, destino:state.destino,
    km:distKm, min: state.routeMin||0, precio, surge: state.surge||1.0,
    createdAt:serverTimestamp()
  });
  state.activeRequestId=docRef.id;
  lockPoints(true);
  startSearchingUI(true); watchActiveRequest(docRef.id);
}
async function cancelarSolicitud(){
  if(!state.activeRequestId){ alert('Sin viaje activo'); return; }
  await updateDoc(doc(db,'requests',state.activeRequestId), { status:'cancelado' });
}
function suscribeListaPendientes(){
  if(listUnsub) listUnsub();
  listUnsub = onSnapshot(query(collection(db,'requests'), where('status','==','buscando'), orderBy('createdAt','desc'), limit(20)), qs=>{
    const cont=$('#reqList'); if(!cont) return; cont.innerHTML='';
    qs.forEach(docu=>{
      const r=docu.data(); const id=docu.id;
      const card=document.createElement('div'); card.className='card';
      card.innerHTML=`
        <div class="row wrap" style="justify-content:space-between">
          <div><div class="chip">#${id.slice(0,6)}</div><div class="chip">Pasajero: ${r.pasajeroNombre}</div></div>
          <div><div class="chip">${(r.km||0).toFixed(2)} km</div><div class="chip">${fmt(r.precio||0)}</div></div>
        </div>
        <div class="row" style="margin-top:.5rem;gap:.5rem"><button class="btn primary" data-id="${id}">Aceptar</button></div>`;
      card.querySelector('button').onclick=()=>aceptarViaje(id);
      cont.appendChild(card);
    });
  });
}
async function aceptarViaje(id){
  await updateDoc(doc(db,'requests',id),{ status:'aceptado', conductorId:state.fbUser.uid, conductorNombre: state.profile?.name||state.fbUser.email });
  state.activeRequestId=id; watchActiveRequest(id);
}
async function iniciarTrayecto(){ if(!state.activeRequestId) return alert('Sin viaje activo');
  await updateDoc(doc(db,'requests',state.activeRequestId),{status:'en_curso'});
}
async function finalizarTrayecto(){ if(!state.activeRequestId) return alert('Sin viaje activo');
  await updateDoc(doc(db,'requests',state.activeRequestId),{status:'finalizado'});
}

/* ===== Watch + barra de estado + chat + tracking ===== */
function watchActiveRequest(id){
  if(activeReqUnsub) activeReqUnsub();
  activeReqUnsub = onSnapshot(doc(db,'requests',id), (snap)=>{
    if(!snap.exists()) return;
    const r=snap.data(); state.activeRequest={id:snap.id,...r};
    $('#actividad').textContent=`#${id.slice(0,6)} ‚Äî ${r.status.toUpperCase()} ‚Äî ${fmt(r.precio)} (${(r.km||0).toFixed(2)} km, ${r.min||0} min)`;
    const bar=$('#statusBar'), txt=$('#statusText');
    if(r.status==='buscando'){ txt.textContent='BUSCANDO CONDUCTOR‚Ä¶'; startSearchingUI(true); showChat(false); stopDriverFollower(); }
    if(r.status==='aceptado'){ txt.textContent='CONDUCTOR ACEPT√ì ‚Äî EN CAMINO'; startSearchingUI(false); showChat(true); startDriverFollower(id); }
    if(r.status==='en_curso'){ txt.textContent='VIAJE EN CURSO'; startSearchingUI(false); showChat(true); startDriverFollower(id); }
    if(r.status==='finalizado' || r.status==='cancelado'){
      showChat(false);
      state.activeRequestId=null; state.activeRequest=null; lockPoints(false);
      startSearchingUI(false); stopDriverFollower();
      if(chatUnsub){ chatUnsub(); chatUnsub=null; }
      alert(r.status==='finalizado'?'¬°Viaje finalizado!':'Solicitud cancelada');
    }
    bar.style.display='flex';
    if(r.status!=='finalizado' && r.status!=='cancelado'){ ensureChatListener(id); }
  });
}
function ensureChatListener(reqId){
  if(chatUnsub) return;
  const msgsRef=collection(db,'requests',reqId,'messages');
  chatUnsub = onSnapshot(query(msgsRef, orderBy('ts','asc'), limit(100)), (qs)=>{
    const log=$('#chatlog'); if(!log) return; log.innerHTML='';
    const mine=mySide();
    qs.forEach(d=>{
      const m=d.data(); const who=(m.from===mine)?'me':'';
      log.insertAdjacentHTML('beforeend', `<div class="msg ${who}"><b>${m.from==='pax'?'Pasajero':'Conductor'}:</b> ${m.text}</div>`);
    });
    log.scrollTop=log.scrollHeight;
  });
}
function startSearchingUI(on){
  const timer=$('#searchTimer');
  if(on){
    if(!state.requestCreatedAt) state.requestCreatedAt=Date.now();
    if(timerInt) clearInterval(timerInt);
    timerInt=setInterval(()=>{
      const elapsed=Math.floor((Date.now()-state.requestCreatedAt)/1000);
      const mm=String(Math.floor(elapsed/60)).padStart(2,'0');
      const ss=String(elapsed%60).padStart(2,'0');
      timer.textContent=`${mm}:${ss}`;
    },500);
  }else{
    if(timerInt) clearInterval(timerInt);
    timerInt=null; state.requestCreatedAt=null;
    timer.textContent='00:00';
  }
}
function showChat(show){
  const d=$('#chatMini');
  if(!d) return;
  d.style.display = show ? 'block' : 'none';
}

/* ===== Bloqueo puntos ===== */
function lockPoints(lock){
  state.pointsLocked = lock;
  if(origenMarker){ try{ origenMarker.dragging[lock?'disable':'enable'](); }catch(_){ } }
  if(destinoMarker){ try{ destinoMarker.dragging[lock?'disable':'enable'](); }catch(_){ } }
}

/* ===== Seguimiento del conductor ===== */
/* Conductor: publicar ubicaci√≥n en requests/{id}/driver */
function startDriverShare(){
  const id = state.activeRequestId;
  const r  = state.activeRequest;
  if(!id || !r || (r.status!=='aceptado' && r.status!=='en_curso')) return alert('Necesit√°s un viaje aceptado/en curso.');
  if(!navigator.geolocation) return alert('Geolocalizaci√≥n no disponible');
  if(driverWatchId) return alert('Ya est√°s compartiendo tu ubicaci√≥n');

  driverWatchId = navigator.geolocation.watchPosition(async (pos)=>{
    const p={ lat:pos.coords.latitude, lng:pos.coords.longitude, ts: Date.now() };
    await setDoc(doc(db,'requests',id,'driver','pos'), p);
  }, (err)=>{ console.error(err); alert('No se pudo obtener ubicaci√≥n'); }, {
    enableHighAccuracy:true, maximumAge:2000, timeout:10000
  });
}
function stopDriverShare(){
  if(driverWatchId){ navigator.geolocation.clearWatch(driverWatchId); driverWatchId=null; }
}
/* Pasajero/Conductor: seguir el pin del conductor y dibujar ruta restante */
function startDriverFollower(requestId){
  stopDriverFollower();
  driverUnsub = onSnapshot(doc(db,'requests',requestId,'driver','pos'), (snap)=>{
    if(!snap.exists()) return;
    const p = snap.data();
    // marcador del conductor
    if(!driverMarker){
      driverMarker = L.marker([p.lat, p.lng], {icon: L.divIcon({className:'', html:'<div style="background:#111827;border:2px solid #94a3b8;color:#fff;padding:2px 6px;border-radius:6px">üöñ</div>'})})
        .addTo(map).bindPopup('Conductor');
    }else{
      driverMarker.setLatLng([p.lat, p.lng]);
    }
    // ruta restante (conductor -> destino)
    if(state.destino){
      const r = ensureRouting();
      r.setWaypoints([L.latLng(p.lat,p.lng), L.latLng(state.destino.lat,state.destino.lng)]);
    }
  });
}
function stopDriverFollower(){
  if(driverUnsub){ driverUnsub(); driverUnsub=null; }
  if(driverMarker){ map.removeLayer(driverMarker); driverMarker=null; }
}

/* ===== AUTH ===== */
onAuthStateChanged(auth, async (user)=>{
  state.fbUser=user;
  if(user){
    if(userUnsub) userUnsub();
    const uref=doc(db,'users',user.uid);
    userUnsub = onSnapshot(uref, async (snap)=>{
      if(!snap.exists()){
        await setDoc(uref,{name:user.displayName||'',email:user.email||'',ratingSum:0,ratingCount:0,createdAt:serverTimestamp()});
        state.profile={name:user.displayName||'',email:user.email||'',ratingSum:0,ratingCount:0};
      }else{ state.profile=snap.data(); }
      $('#gate').style.display='none'; $('#app').style.display='grid';
      if(!map) initMap(); setTimeout(()=> map.invalidateSize(), 200);
      renderTabs(); renderSide();
    });
  }else{
    $('#app').style.display='none'; $('#gate').style.display='grid';
    state.profile=null; state.activeRequestId=null; state.activeRequest=null; lockPoints(false);
    startSearchingUI(false); stopDriverFollower(); stopDriverShare();
    if(activeReqUnsub){ activeReqUnsub(); activeReqUnsub=null; }
    if(chatUnsub){ chatUnsub(); chatUnsub=null; }
    if(listUnsub){ listUnsub(); listUnsub=null; }
    if(userUnsub){ userUnsub(); userUnsub=null; }
  }
});

/* ===== Gate con validaciones ===== */
function isEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }
$('#btnReg').onclick = async ()=>{
  const name=$('#regName').value.trim();
  const email=$('#regEmail').value.trim();
  const pass=$('#regPass').value;
  const pass2=$('#regPass2').value;
  $('#regErr').textContent='';
  if(!name) return $('#regErr').textContent='Ingres√° tu nombre';
  if(!isEmail(email)) return $('#regErr').textContent='Email inv√°lido';
  if(pass.length<6) return $('#regErr').textContent='La contrase√±a debe tener al menos 6 caracteres';
  if(pass!==pass2) return $('#regErr').textContent='Las contrase√±as no coinciden';
  const btn=$('#btnReg'); btn.disabled=true; btn.textContent='Creando‚Ä¶';
  try{
    const cred=await createUserWithEmailAndPassword(auth,email,pass);
    await updateProfile(cred.user,{displayName:name});
    await setDoc(doc(db,'users',cred.user.uid),{name,email,ratingSum:0,ratingCount:0,createdAt:serverTimestamp()});
  }catch(e){ $('#regErr').textContent=e.message; btn.disabled=false; btn.textContent='Registrarme'; }
};
$('#btnLogin').onclick = async ()=>{
  const email=$('#inEmail').value.trim();
  const pass=$('#inPass').value;
  $('#loginErr').textContent='';
  if(!isEmail(email)) return $('#loginErr').textContent='Email inv√°lido';
  if(!pass) return $('#loginErr').textContent='Ingres√° tu contrase√±a';
  const btn=$('#btnLogin'); btn.disabled=true; btn.textContent='Entrando‚Ä¶';
  try{ await signInWithEmailAndPassword(auth,email,pass); }
  catch(e){ $('#loginErr').textContent=e.message; btn.disabled=false; btn.textContent='Entrar'; }
};

/* ===== Botones superiores ===== */
function bootstrapButtons(){
  $('#btnMiUbicacion').onclick=miUbicacionComoOrigen;
  $('#btnLimpiar').onclick=limpiar;
  $('#btnSolicitar').onclick=solicitarViaje;
  const bO=$('#modeOrigen'), bD=$('#modeDestino');
  bO.onclick=()=>{ if(state.pointsLocked) return alert('Bloqueado por viaje activo'); selectMode='origen'; bO.setAttribute('aria-pressed','true'); bD.setAttribute('aria-pressed','false'); };
  bD.onclick=()=>{ if(state.pointsLocked) return alert('Bloqueado por viaje activo'); selectMode='destino'; bD.setAttribute('aria-pressed','true'); bO.setAttribute('aria-pressed','false'); };
}
bootstrapButtons();
</script>
</body>
</html>
