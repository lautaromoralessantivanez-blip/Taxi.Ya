<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Taxi Ya — Firebase</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Routing Machine + OSRM -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0f15; --panel:#0f141d; --ink:#f5f7fb; --muted:#a9b4c2; --line:#1b2430;
  --accent:#ffd34d; --ok:#22c55e; --danger:#ef4444; --chip:#17202a; --card:#0d131b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0f15,#0b0f15 60%,#0a0f19);color:var(--ink);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial}
button,input,select{font-family:inherit}

/* ===== AUTH GATE ===== */
#gate{position:fixed;inset:0;display:grid;place-items:center;background:radial-gradient(1200px 800px at 50% -10%,#13202e 0%, #0b0f15 60%, #0a0f19 100%);z-index:100}
.gate-card{width:min(720px,92vw);background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:1rem}
.gate-title{display:flex;align-items:center;gap:.6rem;margin:.25rem 0 1rem}
.gate-title .dot{width:.9rem;height:.9rem;border-radius:999px;background:var(--accent);box-shadow:0 0 16px rgba(255,211,77,.7)}
.grid{display:grid;gap:.75rem}
.field{display:grid;gap:.35rem}
.label{font-size:.9rem;color:var(--muted)}
.input{width:100%;background:#0e1620;border:1px solid var(--line);color:var(--ink);padding:.65rem .75rem;border-radius:12px}
.btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--line);background:#12202e;color:var(--ink);padding:.6rem .9rem;border-radius:12px;cursor:pointer;transition:.2s;text-decoration:none}
.btn.primary{background:var(--accent);color:#111;border-color:#e6b800}
.link{color:#a7c7ff;cursor:pointer;text-decoration:underline}
.err{color:#fecaca}
.preview{width:72px;height:72px;border-radius:50%;border:1px solid var(--line);object-fit:cover;background:#0d131b}

/* ===== APP ===== */
.app{min-height:100dvh;display:grid;grid-template-rows:auto 1fr}
.header{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--line);background:rgba(13,19,27,.7);backdrop-filter:blur(12px);position:sticky;top:0;z-index:20}
.brand{display:flex;align-items:center;gap:.6rem}
.brand .dot{width:.9rem;height:.9rem;border-radius:999px;background:var(--accent);box-shadow:0 0 16px rgba(255,211,77,.7)}
.tabs{display:flex;gap:.35rem;flex-wrap:wrap}
.tab{padding:.45rem .75rem;border:1px solid var(--line);border-radius:999px;background:#17202a;color:var(--ink);opacity:.85;cursor:pointer;transition:.2s}
.tab[aria-selected="true"]{background:var(--accent);color:#111;opacity:1;border-color:#e6b800}

.container{display:grid;grid-template-columns:360px 1fr;gap:1rem;padding:1rem;max-width:1300px;margin:0 auto}
.aside,.main{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden}
.panel-head{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--line);background:var(--card)}
.panel-body{padding:1rem;display:flex;flex-direction:column;gap:.75rem;min-height:calc(100vh - 140px)}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:1rem}
.row{display:flex;gap:.6rem;align-items:center}
.row.wrap{flex-wrap:wrap}
.chip{background:#121a24;border:1px solid var(--line);padding:.35rem .6rem;border-radius:999px;font-size:.85rem;color:var(--muted)}
.badge{padding:.3rem .5rem;border-radius:8px;border:1px solid var(--line);font-size:.78rem}
.badge.ok{background:rgba(34,197,94,.12);color:#86efac;border-color:rgba(34,197,94,.35)}
.help{color:var(--muted);font-size:.86rem}

/* Estado */
.status-bar{order:50;display:none;align-items:center;gap:.6rem;background:#0f172a;border:1px solid #243045;padding:.55rem .75rem;border-radius:10px;font-weight:600}

/* Mapa siempre abajo */
.map-wrap{order:99;position:relative}
#map{width:100%;height:70vh;min-height:460px}
.leaflet-container{background:#0b0f15}

/* Chat compacto */
.chat-mini{order:98}
.chat-mini summary{cursor:pointer;list-style:none;display:flex;align-items:center;gap:.5rem;background:#0f172a;border:1px solid #243045;padding:.55rem .75rem;border-radius:10px;font-weight:600}
.chat-mini .chatbox{display:grid;grid-template-rows:1fr auto;height:180px;background:#0d131b;border:1px solid var(--line);border-radius:12px;overflow:hidden;margin-top:.6rem}
.chatlog{overflow:auto;padding:.6rem}
.msg{display:inline-block;background:#12202e;border:1px solid var(--line);padding:.45rem .6rem;border-radius:10px;margin:.25rem 0;font-size:.92rem}
.msg.me{background:#1f2a37}

/* Autocomplete */
.ac-results{position:relative;margin-top:.35rem}
.ac-results::before{content:'';position:absolute;top:-8px;left:16px;width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:8px solid #0e1620;opacity:.8}
.ac-results>div{background:#0e1620;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.ac-item{padding:.6rem .75rem;border-bottom:1px solid #1a2430;cursor:pointer}
.ac-item:last-child{border-bottom:0}
.ac-item:hover{background:#142032}
.ac-title{font-weight:600}
.ac-sub{font-size:.85rem;color:var(--muted)}

/* Responsive */
@media (max-width:1080px){.container{grid-template-columns:1fr}.aside{order:2}.main{order:1}}
@media (max-width:680px){
  .tabs{position:fixed;bottom:10px;left:0;right:0;justify-content:center;z-index:40}
  .tab{background:#131c28;border-color:#223043}
  #map{height:64vh;min-height:360px}
}
</style>
</head>
<body>

<!-- =========== AUTH: Login primero, registro debajo =========== -->
<div id="gate" aria-hidden="false">
  <div class="gate-card">
    <div class="gate-title">
      <span class="dot"></span><b>Taxi Ya</b>
      <span class="chip" style="margin-left:.5rem;background:#121a24;border:1px solid var(--line);padding:.2rem .5rem;border-radius:999px;color:#a9b4c2">Inicio de sesión</span>
    </div>

    <!-- LOGIN -->
    <div class="card" style="background:#0d131b">
      <div class="grid">
        <div class="field"><label class="label">Email (Gmail)</label><input id="inEmail" type="email" class="input" placeholder="tu@gmail.com"></div>
        <div class="field"><label class="label">Contraseña</label><input id="inPass" type="password" class="input" placeholder="••••••••"></div>
        <div class="row" style="gap:.6rem">
          <button class="btn primary" id="btnLogin">Entrar</button>
        </div>
        <div id="loginErr" class="err"></div>
      </div>
    </div>

    <!-- LINK a Registro -->
    <p class="help" style="margin:.5rem 0 0 0">
      ¿No tenés cuenta? <span id="showReg" class="link">Crear una</span>
    </p>

    <!-- REGISTRO (colapsado por defecto) -->
    <div id="regCard" class="card" style="display:none;margin-top:.6rem;background:#0d131b">
      <h3 style="margin:0 0 .5rem 0">Crear cuenta</h3>
      <div class="row" style="gap:1rem;align-items:flex-end;flex-wrap:wrap">
        <div class="field" style="align-items:center">
          <img id="regPreview" class="preview" src="" alt="foto"/>
          <label class="label" style="margin-top:.35rem">Foto de perfil</label>
          <input id="regPhoto" type="file" accept="image/*" class="input" style="padding:.45rem"/>
        </div>
        <div class="field" style="flex:1"><label class="label">Nombre</label><input id="regName" class="input" placeholder="Ana, Mauro…"></div>
      </div>
      <div class="grid">
        <div class="field"><label class="label">Email (Gmail)</label><input id="regEmail" type="email" class="input" placeholder="tu@gmail.com"></div>
        <div class="field"><label class="label">Contraseña</label><input id="regPass" type="password" class="input" placeholder="mín. 6 caracteres"></div>
        <div class="field"><label class="label">Repetir contraseña</label><input id="regPass2" type="password" class="input" placeholder="repite la contraseña"></div>
      </div>
      <div class="row" style="margin-top:.6rem;gap:.6rem">
        <button class="btn" id="btnCancelReg">Cancelar</button>
        <button class="btn primary" id="btnReg">Crear cuenta</button>
      </div>
      <div id="regErr" class="err"></div>
    </div>

    <p class="help" style="margin-top:.5rem">Iniciá sesión para continuar al mapa.</p>
  </div>
</div>

<!-- ==================== APP ==================== -->
<div class="app" id="app" style="display:none">
  <header class="header">
    <div class="brand"><span class="dot"></span><b>Taxi Ya</b><span class="chip" id="statusChip">offline</span></div>
    <nav class="tabs" id="tabs"></nav>
  </header>

  <div class="container">
    <aside class="aside">
      <div class="panel-head"><strong id="sideTitle">Panel</strong><span class="badge ok" id="authBadge">Conectado</span></div>
      <div class="panel-body" id="sideBody"></div>
    </aside>

    <main class="main">
      <div class="panel-head"><strong id="mainTitle">Mapa</strong></div>
      <div class="panel-body">

        <!-- Controles principales -->
        <div class="card">
          <div class="grid" style="gap:.9rem">
            <!-- Buscador -->
            <div class="field" style="width:min(520px,100%)">
              <label class="label">Buscar dirección</label>
              <input id="addrSearch" class="input" placeholder="Ej: Av. Corrientes 1234, CABA" autocomplete="off">
              <div id="addrResults" class="ac-results" style="display:none"></div>
            </div>

            <!-- Selector y acciones -->
            <div class="row wrap" style="justify-content:space-between;gap:.75rem">
              <div class="row" style="gap:.5rem">
                <div class="label">Seleccionar en mapa:</div>
                <div class="seg" id="modeSeg" style="display:inline-flex;border:1px solid var(--line);border-radius:999px;overflow:hidden">
                  <button id="modeOrigen" aria-pressed="true" style="border:0;background:#0e1620;color:#fff;padding:.45rem .8rem;cursor:pointer">Origen</button>
                  <button id="modeDestino" aria-pressed="false" style="border:0;background:#0e1620;color:#fff;padding:.45rem .8rem;cursor:pointer">Destino</button>
                </div>
              </div>
              <div class="row" style="gap:.5rem;flex-wrap:wrap;justify-content:flex-start">
                <button class="btn" id="btnMiUbicacion">Usar mi ubicación</button>
                <button class="btn" id="btnLimpiar">Limpiar</button>
                <button class="btn" id="btnCancelReqTop">Cancelar</button>
                <button class="btn primary" id="btnSolicitar">Solicitar viaje</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Barra de estado -->
        <div id="statusBar" class="status-bar">
          <span id="statusText">BUSCANDO CONDUCTOR…</span>
          <span class="chip" id="searchTimer">00:00</span>
        </div>

        <!-- Info -->
        <div class="card">
          <div class="row wrap" style="justify-content:space-between">
            <div><div class="label">Origen</div><div id="origenTxt" class="chip">—</div></div>
            <div><div class="label">Destino</div><div id="destinoTxt" class="chip">—</div></div>
            <div><div class="label">Distancia (km)</div><div id="kmTxt" class="chip">0.00</div></div>
            <div><div class="label">Duración (min)</div><div id="minTxt" class="chip">0</div></div>
            <div><div class="label">Tarifa estimada</div><div id="fareTxt" class="chip">$ 0</div></div>
            <div><div class="label">Surge</div><div id="surgeTxt" class="chip">x1.0</div></div>
          </div>
          <p class="help" id="actividad">Toca el mapa para fijar Origen/Destino.</p>
        </div>

        <!-- Mapa -->
        <div class="map-wrap"><div id="map"></div></div>

        <!-- Chat compacto -->
        <details id="chatMini" class="chat-mini" style="display:none">
          <summary>💬 Chat del viaje (opcional)</summary>
          <div class="chatbox">
            <div id="chatlog" class="chatlog"></div>
            <div class="chatinput" style="display:flex;gap:.5rem;padding:.6rem;border-top:1px solid var(--line)">
              <input id="chatInput" class="input" placeholder="Escribe un mensaje respetuoso…"/>
              <button class="btn" id="chatSend">Enviar</button>
            </div>
          </div>
          <div class="help">Visible en “aceptado / en curso”.</div>
        </details>

      </div>
    </main>
  </div>
</div>

<!-- ================= Firebase + App (Módulos) ================= -->
<script type="module">
/* Firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, addDoc, collection, serverTimestamp, onSnapshot, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

/* Config */
const firebaseConfig = {
  apiKey: "AIzaSyBu523IOGnIZGfAkdlLdVLcENwLgv5KU9o",
  authDomain: "taxi-ya-3be33.firebaseapp.com",
  projectId: "taxi-ya-3be33",
  storageBucket: "taxi-ya-3be33.firebasestorage.app",
  messagingSenderId: "31840475169",
  appId: "1:31840475169:web:1485e47b9ebea4a66c6b60",
  measurementId: "G-2RQRP1G2KB"
};

const appFB = initializeApp(firebaseConfig);
try{ getAnalytics(appFB); }catch(e){}
const auth = getAuth(appFB);
const db = getFirestore(appFB);
const storage = getStorage(appFB);

const $ = s => document.querySelector(s);

/* ===== Estado ===== */
let map, origenMarker, destinoMarker, meMarker, routing;
let driverMarker=null;
let activeReqUnsub=null, chatUnsub=null, listUnsub=null, userUnsub=null, timerInt=null, driverUnsub=null, earningsUnsub=null;
let driverWatchId=null, followMe=true;

let uiTab='pasajero', selectMode='origen';
let driverOnline=false, driverPaused=false, driverSessionStart=null, driverTimer=null, totalEarnings=0;

let state = {
  fbUser:null, profile:null, pointsLocked:false,
  surge:1.0,
  pricing:Object.freeze({ base:800, perKm:350, perMin:120, serviceFee:150, minimum:1200 }),
  origen:null, destino:null, routeKm:0, routeMin:0,
  activeRequestId:null, activeRequest:null, requestCreatedAt:null
};

/* ===== Tabs ===== */
function tabsForState(){ return state.fbUser?[
  {id:'pasajero',label:'Pasajero'},{id:'conductor',label:'Conductor'},{id:'perfil',label:'Perfil'}
]:[];}
function renderTabs(){ const nav=$('#tabs'); nav.innerHTML='';
  for(const t of tabsForState()){ const b=document.createElement('button');
    b.className='tab'; b.textContent=t.label; b.setAttribute('aria-selected',uiTab===t.id);
    b.onclick=()=>{ uiTab=t.id; onTabChange(); }; nav.appendChild(b);
  }
  $('#statusChip').textContent=state.fbUser?(state.profile?.name||'online'):'offline';
}
function onTabChange(){ renderSide(); setTimeout(()=> map?.invalidateSize(),120); }

/* ===== Lateral ===== */
function renderSide(){
  const body=$('#sideBody'); const title=$('#sideTitle');
  title.textContent={pasajero:'Pasajero',conductor:'Conductor',perfil:'Perfil'}[uiTab]||'Panel';
  body.innerHTML='';
  if(uiTab==='conductor') body.appendChild(cardConductor());
  if(uiTab==='perfil') body.appendChild(cardPerfil());
}
function cardConductor(){
  const el=document.createElement('div'); el.className='grid';
  el.innerHTML=`
  <div class="card">
    <div class="row wrap" style="justify-content:space-between">
      <div class="row" style="gap:.5rem">
        <span class="chip" id="drvStatus">Offline</span>
        <span class="chip">Conectado: <b id="drvTime">00:00:00</b></span>
        <span class="chip">Ganancias: <b id="drvEarn">$ 0</b></span>
      </div>
      <div class="row" style="gap:.5rem;flex-wrap:wrap">
        <button class="btn primary" id="btnDrvStart">Iniciar</button>
        <button class="btn" id="btnDrvPause" disabled>Pausar</button>
        <button class="btn" id="btnDrvFinish" disabled>Finalizar</button>
      </div>
    </div>
    <p class="help" style="margin-top:.4rem">“Iniciar” te pone disponible para recibir viajes; “Pausar” te saca de la cola; “Finalizar” cierra la sesión de conductor.</p>
  </div>
  <div class="card" id="drvQueueCard" style="display:none">
    <div class="label">Solicitudes entrantes</div>
    <div id="reqList" class="grid"></div>
  </div>`;
  setTimeout(()=>{
    $('#btnDrvStart').onclick=driverStart;
    $('#btnDrvPause').onclick=driverPauseToggle;
    $('#btnDrvFinish').onclick=driverFinish;
    updateDriverHeader();
    attachEarningsListener();
    if(driverOnline&&!driverPaused) suscribeListaPendientes(); else unsusbcribePendientes();
  },0);
  return el;
}
function cardPerfil(){
  const p=state.profile||{ratingSum:0,ratingCount:0};
  const avg=p.ratingCount?(p.ratingSum/p.ratingCount):0;
  const stars=[1,2,3,4,5].map(i=>`<span style="color:#fcd34d;opacity:${avg>=i?1:.35}">★</span>`).join('');
  const avatar = p.photoURL || `https://api.dicebear.com/9.x/initials/svg?seed=${encodeURIComponent(p.name||state.fbUser?.email||'U')}`;
  const el=document.createElement('div'); el.className='grid';
  el.innerHTML=`
  <div class="card">
    <div class="row wrap" style="gap:.75rem;align-items:flex-start">
      <img loading="lazy" src="${avatar}" alt="avatar" width="64" height="64" style="border-radius:12px;border:1px solid var(--line);object-fit:cover"/>
      <div>
        <div style="font-weight:600">${p.name||'Usuario'}</div>
        <div class="chip">${state.fbUser?.email||''}</div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="label">Sesión</div>
    <div class="row" style="gap:.5rem;flex-wrap:wrap"><button class="btn" id="btnLogout">Cerrar sesión</button></div>
  </div>
  <div class="card">
    <div class="label">Calificación</div>
    <div class="row" style="gap:.35rem">${stars}</div>
    <div class="row" style="gap:.5rem;margin-top:.4rem">
      <div class="chip">${p.ratingCount||0} opiniones</div>
      <div class="chip">${avg.toFixed(2)} / 5.00</div>
    </div>
  </div>`;
  setTimeout(()=> $('#btnLogout').onclick=()=>signOut(auth),0);
  return el;
}

/* ===== Driver controls ===== */
function updateDriverHeader(){
  $('#drvStatus')?.textContent=driverOnline?(driverPaused?'Pausado':'Online'):'Offline';
  $('#btnDrvStart')?.toggleAttribute('disabled',driverOnline&&!driverPaused);
  $('#btnDrvPause')?.toggleAttribute('disabled',!driverOnline);
  $('#btnDrvFinish')?.toggleAttribute('disabled',!driverOnline);
  $('#btnDrvPause')?.textContent=driverPaused?'Reanudar':'Pausar';
  $('#drvQueueCard')?.style.setProperty('display',(driverOnline&&!driverPaused)?'block':'none');
}
function driverStart(){
  if(driverOnline&&!driverPaused) return;
  driverOnline=true; driverPaused=false; driverSessionStart=driverSessionStart||Date.now();
  startDriverShare(); startDriverTimer(); updateDriverHeader(); suscribeListaPendientes();
}
function driverPauseToggle(){
  if(!driverOnline) return;
  driverPaused=!driverPaused;
  if(driverPaused){ unsusbcribePendientes(); stopDriverShare(); }
  else { suscribeListaPendientes(); startDriverShare(); }
  updateDriverHeader();
}
function driverFinish(){
  if(!driverOnline) return;
  driverOnline=false; driverPaused=false;
  stopDriverShare(); stopDriverTimer(); updateDriverHeader(); unsusbcribePendientes();
}
function startDriverTimer(){
  if(driverTimer) return;
  const tick=()=>{ const s=Math.floor((Date.now()-(driverSessionStart||Date.now()))/1000);
    const hh=String(Math.floor(s/3600)).padStart(2,'0');
    const mm=String(Math.floor((s%3600)/60)).padStart(2,'0');
    const ss=String(s%60).padStart(2,'0');
    $('#drvTime')?.textContent=`${hh}:${mm}:${ss}`;
  }; tick(); driverTimer=setInterval(tick,1000);
}
function stopDriverTimer(){ if(driverTimer){ clearInterval(driverTimer); driverTimer=null; } }

/* ===== Mapa + Routing ===== */
function initMap(){
  map=L.map('map',{zoomControl:true,preferCanvas:true}).setView([-34.6037,-58.3816],12);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);
  setTimeout(()=>map.invalidateSize(),200); window.addEventListener('resize',()=>map.invalidateSize());
  const pb=document.querySelector('.main .panel-body'); if('ResizeObserver'in window){ new ResizeObserver(()=>map.invalidateSize()).observe(pb); }
  map.on('click',e=>{
    if(state.pointsLocked){ alert('Los puntos están bloqueados hasta cancelar la solicitud.'); return; }
    const p={lat:e.latlng.lat,lng:e.latlng.lng};
    if(selectMode==='origen'){ setOrigen(p,true); } else { setDestino(p,true); }
  });
}
function ensureRouting(){
  if(routing) return routing;
  routing=L.Routing.control({
    waypoints:[], router:L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1',profile:'driving'}),
    lineOptions:{addWaypoints:false,extendToWaypoints:true,missingRouteTolerance:20}, show:false, collapsible:true, fitSelectedRoutes:true
  }).on('routesfound',e=>{
    const r=e.routes?.[0]; if(!r) return;
    const km=(r.summary.totalDistance||0)/1000; const min=Math.round((r.summary.totalTime||0)/60);
    state.routeKm=km; state.routeMin=min; $('#kmTxt').textContent=km.toFixed(2); $('#minTxt').textContent=String(min); updateFareUI();
    try{ map.fitBounds(r.bounds,{padding:[30,30]}); }catch(_){}
    $('#actividad').textContent=`Ruta: ${km.toFixed(2)} km • ~${min} min`;
  }).on('routingerror',()=>updateInfoHaversine()).addTo(map);
  return routing;
}
function setOrigen(p,recalc=false){
  if(origenMarker) map.removeLayer(origenMarker);
  origenMarker=L.marker([p.lat,p.lng],{draggable:!state.pointsLocked}).addTo(map).bindPopup('Origen');
  origenMarker.on('dragend',()=>{ if(state.pointsLocked) return; const ll=origenMarker.getLatLng(); setOrigen({lat:ll.lat,lng:ll.lng},true); });
  state.origen=p; $('#origenTxt').textContent=`${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}`; if(recalc) recalcRoute();
}
function setDestino(p,recalc=false){
  if(destinoMarker) map.removeLayer(destinoMarker);
  destinoMarker=L.marker([p.lat,p.lng],{draggable:!state.pointsLocked}).addTo(map).bindPopup('Destino');
  destinoMarker.on('dragend',()=>{ if(state.pointsLocked) return; const ll=destinoMarker.getLatLng(); setDestino({lat:ll.lat,lng:ll.lng},true); });
  state.destino=p; $('#destinoTxt').textContent=`${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}`; if(recalc) recalcRoute();
}
function recalcRoute(){ if(!(state.origen&&state.destino)){ updateInfoHaversine(); return; }
  ensureRouting().setWaypoints([L.latLng(state.origen.lat,state.origen.lng),L.latLng(state.destino.lat,state.destino.lng)]);
}
function miUbicacionComoOrigen(){
  if(!navigator.geolocation){ alert('Geolocalización no disponible'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    if(state.pointsLocked){ alert('Bloqueado por viaje activo'); return; }
    const p={lat:pos.coords.latitude,lng:pos.coords.longitude};
    if(meMarker) map.removeLayer(meMarker);
    meMarker=L.circleMarker([p.lat,p.lng],{radius:7,color:'#34d399'}).addTo(map).bindPopup('Mi ubicación');
    map.setView([p.lat,p.lng],14); setOrigen(p,true);
  },()=>alert('No se pudo obtener ubicación'));
}
function limpiar(){
  if(state.pointsLocked){ alert('No se puede limpiar con un viaje activo. Cancelá primero.'); return; }
  if(origenMarker) map.removeLayer(origenMarker); origenMarker=null; state.origen=null;
  if(destinoMarker) map.removeLayer(destinoMarker); destinoMarker=null; state.destino=null;
  if(routing){ routing.setWaypoints([]); } state.routeKm=0; state.routeMin=0;
  $('#origenTxt').textContent='—'; $('#destinoTxt').textContent='—'; $('#kmTxt').textContent='0.00'; $('#minTxt').textContent='0'; $('#fareTxt').textContent=fmt(0);
  $('#actividad').textContent='Toca el mapa para fijar Origen/Destino.';
}

/* ===== Utils + Pricing ===== */
function fmt(n){ return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n); }
function km(a,b){ if(!a||!b) return 0; const R=6371, dLat=(b.lat-a.lat)*Math.PI/180, dLon=(b.lng-a.lng)*Math.PI/180, la1=a.lat*Math.PI/180, la2=b.lat*Math.PI/180;
  const h=Math.sin(dLat/2)**2+Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(h));
}
function calcFare(distKm,durMin){ const p=state.pricing; const bruto=p.base+(distKm*p.perKm)+(durMin*p.perMin)+p.serviceFee; const surged=bruto*(state.surge||1.0); return Math.max(p.minimum,Math.round(surged)); }
function updateFareUI(){ const fare=calcFare(state.routeKm||0,state.routeMin||0); $('#fareTxt').textContent=fmt(fare); $('#surgeTxt').textContent=`x${(state.surge||1).toFixed(1)}`; }
function updateInfoHaversine(){ const d=km(state.origen,state.destino); state.routeKm=d; state.routeMin=Math.round((d/25)*60); $('#kmTxt').textContent=d.toFixed(2); $('#minTxt').textContent=String(state.routeMin); updateFareUI(); }

/* ===== Autocomplete (Nominatim) ===== */
const addrInput=$('#addrSearch'), addrBox=$('#addrResults');
function debounce(fn,ms=350){let t=null;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}
async function geocodeSearch(q){ const url=`https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=6&q=${encodeURIComponent(q)}`; const r=await fetch(url,{headers:{'Accept-Language':'es-AR,es;q=0.9'}}); return r.ok?r.json():[]; }
function renderAddrResults(list){
  if(!list?.length){ addrBox.style.display='none'; addrBox.innerHTML=''; return; }
  addrBox.style.display='block';
  addrBox.innerHTML=`<div>${list.map(i=>{const t=i.display_name.split(',').slice(0,2).join(', '), s=i.display_name.split(',').slice(2).join(', ').trim();
    return `<div class="ac-item" data-lat="${i.lat}" data-lon="${i.lon}" data-name="${encodeURIComponent(i.display_name)}"><div class="ac-title">${t}</div><div class="ac-sub">${s}</div></div>`;
  }).join('')}</div>`;
  addrBox.querySelectorAll('.ac-item').forEach(n=>n.addEventListener('click',()=>{
    const lat=parseFloat(n.getAttribute('data-lat')), lon=parseFloat(n.getAttribute('data-lon')), name=decodeURIComponent(n.getAttribute('data-name'));
    addrInput.value=name; addrBox.style.display='none'; const p={lat,lng:lon}; if(selectMode==='origen'){ setOrigen(p,true); } else { setDestino(p,true); } map.setView([lat,lon],15);
  }));
}
addrInput?.addEventListener('input',debounce(async e=>{
  if(state.pointsLocked) return; const q=(e.target.value||'').trim(); if(q.length<3){ addrBox.style.display='none'; addrBox.innerHTML=''; return; }
  try{ renderAddrResults(await geocodeSearch(q)); }catch(_){ addrBox.style.display='none'; addrBox.innerHTML=''; }
},380));
document.addEventListener('click',e=>{ if(!addrBox.contains(e.target)&&e.target!==addrInput){ addrBox.style.display='none'; }});

/* ===== Chat ===== */
const bannedWords=['puta','puto','cagar','mierda','hdp','concha','pija','forro','insulto','boludo'];
function sanitizeMsg(t){ let x=t.trim(); for(const w of bannedWords){ x=x.replace(new RegExp('\\b'+w+'\\b','gi'),'***'); } return x; }
function mySide(){ const r=state.activeRequest; if(!r||!state.fbUser) return 'pax'; if(r.pasajeroId===state.fbUser.uid) return 'pax'; if(r.conductorId===state.fbUser.uid) return 'drv'; return 'pax'; }
$('#chatSend')?.addEventListener('click',async()=>{
  if(!state.activeRequestId) return alert('Sin viaje activo'); const input=$('#chatInput'); const text=(input.value||'').trim(); if(!text) return;
  const s=sanitizeMsg(text); if(/^\*{3,}$/.test(s)) return alert('Mensaje bloqueado'); await addDoc(collection(db,'requests',state.activeRequestId,'messages'),{from:mySide(),text:s,ts:serverTimestamp()}); input.value='';
});

/* ===== Firestore: Solicitudes ===== */
async function solicitarViaje(){
  if(!(state.origen&&state.destino)) return alert('Elegí origen y destino');
  const distKm=state.routeKm||km(state.origen,state.destino), precio=calcFare(distKm,state.routeMin||0);
  const ref=await addDoc(collection(db,'requests'),{status:'buscando',pasajeroId:state.fbUser.uid,pasajeroNombre:state.profile?.name||state.fbUser.email,pasajeroFoto:state.profile?.photoURL||'',origen:state.origen,destino:state.destino,km:distKm,min:state.routeMin||0,precio,surge:state.surge||1.0,createdAt:serverTimestamp()});
  state.activeRequestId=ref.id; lockPoints(true); startSearchingUI(true); watchActiveRequest(ref.id);
}
async function cancelarSolicitud(){ if(!state.activeRequestId) return alert('Sin viaje activo'); await updateDoc(doc(db,'requests',state.activeRequestId),{status:'cancelado'}); }
function suscribeListaPendientes(){
  if(listUnsub) listUnsub();
  listUnsub=onSnapshot(query(collection(db,'requests'),where('status','==','buscando'),orderBy('createdAt','desc'),limit(20)), async (qs)=>{
    const cont=$('#reqList'); if(!cont) return; cont.innerHTML='';
    for(const docu of qs.docs){
      const r=docu.data(); const id=docu.id;
      let rating=0,count=0,name=r.pasajeroNombre||'Pasajero',avatar=r.pasajeroFoto||'';
      try{ const u=await getDoc(doc(db,'users',r.pasajeroId)); if(u.exists()){ const d=u.data(); rating=d.ratingCount?(d.ratingSum||0)/d.ratingCount:0; count=d.ratingCount||0; name=d.name||name; avatar=d.photoURL||avatar; } }catch(_){}
      const stars=[1,2,3,4,5].map(i=>`<span style="color:#fcd34d;opacity:${rating>=i?1:.35}">★</span>`).join('');
      const avatarSrc = avatar || `https://api.dicebear.com/9.x/initials/svg?seed=${encodeURIComponent(name)}`;
      const card=document.createElement('div'); card.className='card';
      card.innerHTML=`
        <div class="row wrap" style="justify-content:space-between;gap:.6rem">
          <div class="row" style="gap:.6rem">
            <img src="${avatarSrc}" alt="avatar" width="40" height="40" style="border-radius:8px;border:1px solid var(--line);object-fit:cover"/>
            <div>
              <div style="font-weight:600">${name}</div>
              <div style="font-size:.85rem;color:#a9b4c2">${stars} <span class="chip" style="margin-left:.4rem">${count} ops</span></div>
            </div>
          </div>
          <div class="row" style="gap:.5rem">
            <div class="chip">${(r.km||0).toFixed(2)} km</div>
            <div class="chip">${r.min||0} min</div>
            <div class="chip">${fmt(r.precio||0)}</div>
          </div>
        </div>
        <div class="row" style="gap:.4rem;margin-top:.5rem">
          <div class="chip">Origen: ${r.origen?.lat?.toFixed(4)||'-'}, ${r.origen?.lng?.toFixed(4)||'-'}</div>
          <div class="chip">Destino: ${r.destino?.lat?.toFixed(4)||'-'}, ${r.destino?.lng?.toFixed(4)||'-'}</div>
        </div>
        <div class="row" style="margin-top:.6rem;gap:.5rem"><button class="btn primary" data-id="${id}">Aceptar</button></div>`;
      card.querySelector('button').onclick=()=>aceptarViaje(id);
      cont.appendChild(card);
    }
  });
}
function unsusbcribePendientes(){ if(listUnsub){ listUnsub(); listUnsub=null; } }
async function aceptarViaje(id){ if(!driverOnline||driverPaused) return alert('Tenés que estar Online.'); await updateDoc(doc(db,'requests',id),{status:'aceptado',conductorId:state.fbUser.uid,conductorNombre:state.profile?.name||state.fbUser.email}); state.activeRequestId=id; watchActiveRequest(id); }
async function iniciarTrayecto(){ if(!state.activeRequestId) return alert('Sin viaje activo'); await updateDoc(doc(db,'requests',state.activeRequestId),{status:'en_curso'}); }
async function finalizarTrayecto(){ if(!state.activeRequestId) return alert('Sin viaje activo'); await updateDoc(doc(db,'requests',state.activeRequestId),{status:'finalizado'}); }

/* ===== Watch + estado + chat + tracking ===== */
function watchActiveRequest(id){
  if(activeReqUnsub) activeReqUnsub();
  activeReqUnsub=onSnapshot(doc(db,'requests',id),(snap)=>{
    if(!snap.exists()) return;
    const r=snap.data(); state.activeRequest={id:snap.id,...r};
    $('#actividad').textContent=`#${id.slice(0,6)} — ${r.status.toUpperCase()} — ${fmt(r.precio)} (${(r.km||0).toFixed(2)} km, ${r.min||0} min)`;
    const bar=$('#statusBar'), txt=$('#statusText');
    if(r.status==='buscando'){ txt.textContent='BUSCANDO CONDUCTOR…'; startSearchingUI(true); showChat(false); stopDriverFollower(); }
    if(r.status==='aceptado'){ txt.textContent='CONDUCTOR ACEPTÓ — EN CAMINO'; startSearchingUI(false); showChat(true); startDriverFollower(id); }
    if(r.status==='en_curso'){ txt.textContent='VIAJE EN CURSO'; startSearchingUI(false); showChat(true); startDriverFollower(id); }
    if(r.status==='finalizado'||r.status==='cancelado'){
      showChat(false); state.activeRequestId=null; state.activeRequest=null; lockPoints(false);
      startSearchingUI(false); stopDriverFollower(); if(chatUnsub){ chatUnsub(); chatUnsub=null; }
      alert(r.status==='finalizado'?'¡Viaje finalizado!':'Solicitud cancelada');
    }
    bar.style.display='flex';
    if(r.status!=='finalizado'&&r.status!=='cancelado'){ ensureChatListener(id); }
  });
}
function ensureChatListener(reqId){
  if(chatUnsub) return;
  chatUnsub=onSnapshot(query(collection(db,'requests',reqId,'messages'),orderBy('ts','asc'),limit(100)),qs=>{
    const log=$('#chatlog'); if(!log) return; log.innerHTML=''; const mine=mySide();
    qs.forEach(d=>{ const m=d.data(); const who=(m.from===mine)?'me':''; log.insertAdjacentHTML('beforeend',`<div class="msg ${who}"><b>${m.from==='pax'?'Pasajero':'Conductor'}:</b> ${m.text}</div>`); });
    log.scrollTop=log.scrollHeight;
  });
}
function startSearchingUI(on){
  const t=$('#searchTimer');
  if(on){ if(!state.requestCreatedAt) state.requestCreatedAt=Date.now(); if(timerInt) clearInterval(timerInt);
    timerInt=setInterval(()=>{ const s=Math.floor((Date.now()-state.requestCreatedAt)/1000);
      const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); t.textContent=`${mm}:${ss}`; },500);
  }else{ if(timerInt) clearInterval(timerInt); timerInt=null; state.requestCreatedAt=null; t.textContent='00:00'; }
}
function showChat(show){ const d=$('#chatMini'); if(d) d.style.display=show?'block':'none'; }

/* ===== Bloqueo puntos ===== */
function lockPoints(lock){
  state.pointsLocked=lock;
  try{ if(origenMarker) origenMarker.dragging[lock?'disable':'enable'](); if(destinoMarker) destinoMarker.dragging[lock?'disable':'enable'](); }catch(_){}
}

/* ===== Seguimiento del conductor ===== */
function startDriverShare(){
  if(!navigator.geolocation) return alert('Geolocalización no disponible');
  if(driverWatchId) return;
  driverWatchId=navigator.geolocation.watchPosition(async pos=>{
    const p={lat:pos.coords.latitude,lng:pos.coords.longitude,ts:Date.now()};
    if(!state.activeRequestId){
      if(!driverMarker){ driverMarker=L.marker([p.lat,p.lng],{icon:L.divIcon({className:'',html:'<div style="background:#111827;border:2px solid #94a3b8;color:#fff;padding:2px 6px;border-radius:6px">🚖</div>'})}).addTo(map).bindPopup('Conductor'); }
      else driverMarker.setLatLng([p.lat,p.lng]);
      if(followMe) map.setView([p.lat,p.lng],map.getZoom());
      return;
    }
    await setDoc(doc(db,'requests',state.activeRequestId,'driver','pos'),p);
    if(!driverMarker){ driverMarker=L.marker([p.lat,p.lng],{icon:L.divIcon({className:'',html:'<div style="background:#111827;border:2px solid #94a3b8;color:#fff;padding:2px 6px;border-radius:6px">🚖</div>'})}).addTo(map).bindPopup('Conductor'); }
    else driverMarker.setLatLng([p.lat,p.lng]);
    if(followMe) map.setView([p.lat,p.lng],map.getZoom());
    const r=state.activeRequest;
    if(r){
      if(r.status==='aceptado'&&r.origen){ ensureRouting().setWaypoints([L.latLng(p.lat,p.lng),L.latLng(r.origen.lat,r.origen.lng)]); }
      if(r.status==='en_curso'&&r.destino){ ensureRouting().setWaypoints([L.latLng(p.lat,p.lng),L.latLng(r.destino.lat,r.destino.lng)]); }
    }
  },err=>console.error(err),{enableHighAccuracy:true,maximumAge:2000,timeout:10000});
}
function stopDriverShare(){ if(driverWatchId){ navigator.geolocation.clearWatch(driverWatchId); driverWatchId=null; } }
function startDriverFollower(requestId){
  stopDriverFollower();
  driverUnsub=onSnapshot(doc(db,'requests',requestId,'driver','pos'),snap=>{
    if(!snap.exists()) return; const p=snap.data();
    if(!driverMarker){ driverMarker=L.marker([p.lat,p.lng],{icon:L.divIcon({className:'',html:'<div style="background:#111827;border:2px solid #94a3b8;color:#fff;padding:2px 6px;border-radius:6px">🚖</div>'})}).addTo(map).bindPopup('Conductor'); }
    else driverMarker.setLatLng([p.lat,p.lng]);
    if(followMe) map.setView([p.lat,p.lng],map.getZoom());
  });
}
function stopDriverFollower(){ if(driverUnsub){ driverUnsub(); driverUnsub=null; } if(driverMarker){ map.removeLayer(driverMarker); driverMarker=null; } }

/* ===== Ganancias del conductor ===== */
function attachEarningsListener(){
  if(earningsUnsub) earningsUnsub();
  if(!state.fbUser) return;
  earningsUnsub=onSnapshot(query(collection(db,'requests'),where('conductorId','==',state.fbUser.uid),where('status','==','finalizado')),qs=>{
    let sum=0; qs.forEach(d=> sum+=Number(d.data().precio||0)); totalEarnings=sum; $('#drvEarn')?.textContent=fmt(sum);
  });
}

/* ===== AUTH ===== */
onAuthStateChanged(auth,async(user)=>{
  state.fbUser=user;
  if(user){
    if(userUnsub) userUnsub();
    const uref=doc(db,'users',user.uid);
    userUnsub=onSnapshot(uref,async snap=>{
      if(!snap.exists()){
        await setDoc(uref,{name:user.displayName||'',email:user.email||'',photoURL:user.photoURL||'',ratingSum:0,ratingCount:0,createdAt:serverTimestamp()});
        state.profile={name:user.displayName||'',email:user.email||'',photoURL:user.photoURL||'',ratingSum:0,ratingCount:0};
      }else{ state.profile=snap.data(); }
      $('#gate').style.display='none'; $('#app').style.display='grid';
      if(!map) initMap(); setTimeout(()=>map.invalidateSize(),200);
      renderTabs(); renderSide();
    });
  }else{
    $('#app').style.display='none'; $('#gate').style.display='grid';
    state.profile=null; state.activeRequestId=null; state.activeRequest=null; lockPoints(false);
    startSearchingUI(false); stopDriverFollower(); stopDriverShare(); stopDriverTimer();
    driverOnline=false; driverPaused=false; updateDriverHeader();
    if(activeReqUnsub){ activeReqUnsub(); activeReqUnsub=null; }
    if(chatUnsub){ chatUnsub(); chatUnsub=null; }
    if(listUnsub){ listUnsub(); listUnsub=null; }
    if(earningsUnsub){ earningsUnsub(); earningsUnsub=null; }
    if(userUnsub){ userUnsub(); userUnsub=null; }
  }
});

/* ===== LOGIN + REGISTRO (con foto) ===== */
function isEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }
$('#showReg').onclick=()=>{ $('#regCard').style.display='block'; };
$('#btnCancelReg').onclick=()=>{ $('#regCard').style.display='none'; };
$('#regPhoto').addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f){ $('#regPreview').src=''; return; }
  const r=new FileReader(); r.onload=()=> $('#regPreview').src=r.result; r.readAsDataURL(f);
});
$('#btnLogin').onclick=async()=>{
  const email=$('#inEmail').value.trim(), pass=$('#inPass').value;
  $('#loginErr').textContent='';
  if(!isEmail(email)) return $('#loginErr').textContent='Email inválido';
  if(!pass) return $('#loginErr').textContent='Ingresá tu contraseña';
  const btn=$('#btnLogin'); btn.disabled=true; btn.textContent='Entrando…';
  try{ await signInWithEmailAndPassword(auth,email,pass); }catch(e){ $('#loginErr').textContent=e.message; btn.disabled=false; btn.textContent='Entrar'; }
};
$('#btnReg').onclick=async()=>{
  const name=$('#regName').value.trim(), email=$('#regEmail').value.trim(), pass=$('#regPass').value, pass2=$('#regPass2').value, file=$('#regPhoto').files?.[0]||null;
  $('#regErr').textContent='';
  if(!name) return $('#regErr').textContent='Ingresá tu nombre';
  if(!isEmail(email)) return $('#regErr').textContent='Email inválido';
  if(pass.length<6) return $('#regErr').textContent='La contraseña debe tener al menos 6 caracteres';
  if(pass!==pass2) return $('#regErr').textContent='Las contraseñas no coinciden';
  const btn=$('#btnReg'); btn.disabled=true; btn.textContent='Creando…';
  try{
    const cred=await createUserWithEmailAndPassword(auth,email,pass);
    let photoURL='';
    if(file){
      const path=`avatars/${cred.user.uid}.jpg`;
      await uploadBytes(sRef(storage,path),file);
      photoURL=await getDownloadURL(sRef(storage,path));
    }
    await updateProfile(cred.user,{displayName:name,photoURL:photoURL||null});
    await setDoc(doc(db,'users',cred.user.uid),{name,email,photoURL:photoURL||'',ratingSum:0,ratingCount:0,createdAt:serverTimestamp()});
  }catch(e){ $('#regErr').textContent=e.message; btn.disabled=false; btn.textContent='Crear cuenta'; }
};

/* ===== Botones superiores ===== */
function bootstrapButtons(){
  $('#btnMiUbicacion').onclick=miUbicacionComoOrigen;
  $('#btnLimpiar').onclick=limpiar;
  $('#btnSolicitar').onclick=solicitarViaje;
  $('#btnCancelReqTop').onclick=cancelarSolicitud;
  const bO=$('#modeOrigen'), bD=$('#modeDestino');
  bO.onclick=()=>{ if(state.pointsLocked) return alert('Bloqueado por viaje activo'); selectMode='origen'; bO.setAttribute('aria-pressed','true'); bD.setAttribute('aria-pressed','false'); };
  bD.onclick=()=>{ if(state.pointsLocked) return alert('Bloqueado por viaje activo'); selectMode='destino'; bD.setAttribute('aria-pressed','true'); bO.setAttribute('aria-pressed','false'); };
}
bootstrapButtons();
</script>
</body>
</html>
