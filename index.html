<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Taxi Ya — demo login libre</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0f15; --panel:#0f141d; --ink:#f5f7fb; --muted:#a9b4c2; --line:#1b2430;
  --accent:#ffd34d; --ok:#22c55e; --danger:#ef4444; --chip:#17202a; --card:#0d131b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0f15,#0b0f15 60%,#0a0f19);color:var(--ink);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial}
button,input,select{font-family:inherit}

/* Layout */
.app{min-height:100dvh;display:grid;grid-template-rows:auto 1fr}
.header{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--line);background:rgba(13,19,27,.7);backdrop-filter:blur(12px);position:sticky;top:0;z-index:20}
.brand{display:flex;align-items:center;gap:.6rem}
.brand .dot{width:.9rem;height:.9rem;border-radius:999px;background:var(--accent);box-shadow:0 0 16px rgba(255,211,77,.7)}
.brand b{letter-spacing:.5px}
.tabs{display:flex;gap:.35rem;flex-wrap:wrap}
.tab{padding:.45rem .75rem;border:1px solid var(--line);border-radius:999px;background:var(--chip);color:var(--ink);opacity:.85;cursor:pointer;transition:.2s}
.tab[aria-selected="true"]{background:var(--accent);color:#111;opacity:1;border-color:#e6b800}

.container{display:grid;grid-template-columns:340px 1fr;gap:1rem;padding:1rem;max-width:1200px;margin:0 auto}
.aside,.main{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden}
.panel-head{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--line);background:var(--card)}
.panel-body{padding:1rem}

/* Cards & chips */
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:1rem}
.row{display:flex;gap:.6rem;align-items:center}
.row.wrap{flex-wrap:wrap}
.chip{background:#121a24;border:1px solid var(--line);padding:.35rem .6rem;border-radius:999px;font-size:.85rem;color:var(--muted)}
.badge{padding:.3rem .5rem;border-radius:8px;border:1px solid var(--line);font-size:.78rem}
.badge.ok{background:rgba(34,197,94,.12);color:#86efac;border-color:rgba(34,197,94,.35)}
.badge.warn{background:rgba(255,211,77,.12);color:#fde68a;border-color:rgba(255,211,77,.35)}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--line);background:#12202e;color:var(--ink);padding:.6rem .9rem;border-radius:12px;cursor:pointer;transition:.2s;text-decoration:none}
.btn:hover{transform:translateY(-1px)}
.btn.primary{background:var(--accent);color:#111;border-color:#e6b800}
.btn.ghost{background:transparent}
.btn.danger{background:#2a0f12;border-color:#40161b;color:#fecaca}
.btn.block{display:flex;justify-content:center;width:100%}

/* Inputs */
.input{width:100%;background:#0e1620;border:1px solid var(--line);color:var(--ink);padding:.65rem .75rem;border-radius:12px}
.label{font-size:.9rem;color:var(--muted);margin-bottom:.35rem}
.field{display:grid;gap:.35rem}

.grid{display:grid;gap:.75rem}
.grid.cols-2{grid-template-columns:1fr 1fr}

/* Map */
#map{width:100%;height:520px}

/* Mobile */
@media (max-width: 980px){
  .container{grid-template-columns:1fr}
  .aside{order:2}
  .main{order:1}
}

/* Bottom nav on small screens */
@media (max-width: 680px){
  .tabs{position:fixed;bottom:10px;left:0;right:0;justify-content:center;z-index:40}
  .tab{background:#131c28;border-color:#223043}
}

.star{font-size:1.1rem;color:#fcd34d}
.star.off{opacity:.35;filter:grayscale(1)}
.trophy{filter:drop-shadow(0 6px 16px rgba(255,211,77,.35))}

.chatbox{display:grid;grid-template-rows:1fr auto;height:240px;background:#0d131b;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.chatlog{overflow:auto;padding:.6rem}
.msg{display:inline-block;background:#12202e;border:1px solid var(--line);padding:.5rem .65rem;border-radius:10px;margin:.25rem 0}
.msg.me{background:#1f2a37}
.chatinput{display:flex;gap:.5rem;padding:.6rem;border-top:1px solid var(--line)}
</style>
</head>
<body>
<div class="app" id="app">
  <header class="header">
    <div class="brand">
      <span class="dot"></span>
      <b>Taxi Ya</b>
      <span class="chip" id="statusChip">offline</span>
    </div>
    <nav class="tabs" id="tabs"></nav>
  </header>

  <div class="container">
    <aside class="aside">
      <div class="panel-head">
        <strong id="sideTitle">Inicio</strong>
        <span class="badge warn">Demo libre</span>
      </div>
      <div class="panel-body" id="sideBody">
        <!-- contenido lateral dinámico -->
      </div>
    </aside>

    <main class="main">
      <div class="panel-head"><strong id="mainTitle">Mapa</strong></div>
      <div class="panel-body">
        <div id="map"></div>
        <div class="grid cols-2" style="margin-top:.75rem">
          <div class="card">
            <div class="row wrap" style="justify-content:space-between">
              <div>
                <div class="label">Origen</div>
                <div id="origenTxt" class="chip">—</div>
              </div>
              <div>
                <div class="label">Destino</div>
                <div id="destinoTxt" class="chip">—</div>
              </div>
              <div>
                <div class="label">Distancia (km)</div>
                <div id="kmTxt" class="chip">0.00</div>
              </div>
              <div>
                <div class="label">Tarifa estimada</div>
                <div id="fareTxt" class="chip">$ 0</div>
              </div>
            </div>
            <div class="row" style="margin-top:.6rem;gap:.5rem;flex-wrap:wrap">
              <button class="btn" id="btnMiUbicacion">Usar mi ubicación como ORIGEN</button>
              <button class="btn ghost" id="btnLimpiar">Limpiar</button>
              <button class="btn primary" id="btnSolicitar">Solicitar viaje</button>
            </div>
          </div>

          <div class="card">
            <div class="label">Actividad</div>
            <div id="actividad" style="font-size:.95rem;color:var(--muted)">Toca en el mapa para elegir ORIGEN o DESTINO (te preguntamos qué es en cada toque).</div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
// ======= Estado y utilidades =======
const $ = (sel) => document.querySelector(sel);
const tabsEl = $('#tabs');
let map, origenMarker, destinoMarker, meMarker;
let state = {
  user: null,
  viajes: [], // historial simple
  activo: null, // viaje activo {id, pasajero, conductor, origen, destino, precio, estado}
  pendingForDriver: null, // solicitud visible para el conductor en modo demo
  precios: { base: 800, porKm: 350, porMin: 0, descuento: 0.10 }, // 10% más barato que apps grandes ;)
  ratings: {} // uid -> {sum, count}
};

const bannedWords = ['puta','puto','cagar','mierda','hdp','concha','pija','forro','insulto'];
function sanitizeMsg(text){
  let t = text.trim();
  for(const w of bannedWords){
    const re = new RegExp('\\b'+w+'\\b','gi');
    t = t.replace(re, '***');
  }
  return t;
}

function save(){ localStorage.setItem('taxiya_state', JSON.stringify(state)); }
function load(){ try{ const s = JSON.parse(localStorage.getItem('taxiya_state')); if(s) state = Object.assign(state, s); }catch(e){} }
load();

function uid(){ return Math.random().toString(36).slice(2,10); }

function fmt(n){ return new Intl.NumberFormat('es-AR', {style:'currency', currency:'ARS', maximumFractionDigits:0}).format(n); }
function km(a,b){
  if(!a||!b) return 0;
  const R=6371; // km
  const dLat=(b.lat-a.lat)*Math.PI/180; const dLon=(b.lng-a.lng)*Math.PI/180;
  const la1=a.lat*Math.PI/180, la2=b.lat*Math.PI/180;
  const h=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(h));
}

// ======= UI: Tabs =======
const TABS = [
  {id:'inicio', label:'Inicio'},
  {id:'pasajero', label:'Pasajero'},
  {id:'conductor', label:'Conductor'},
  {id:'perfil', label:'Perfil'}
];
let currentTab = 'inicio';

function renderTabs(){
  tabsEl.innerHTML = '';
  for(const t of TABS){
    const el = document.createElement('button');
    el.className = 'tab';
    el.textContent = t.label;
    el.setAttribute('aria-selected', t.id===currentTab);
    el.onclick = ()=>{ currentTab=t.id; renderSide(); };
    tabsEl.appendChild(el);
  }
}

function setStatusChip(){
  $('#statusChip').textContent = state.user ? `${state.user.rol}` : 'offline';
  $('#statusChip').className = 'chip';
}

// ======= Lateral según tab =======
function renderSide(){
  renderTabs();
  setStatusChip();
  const title = $('#sideTitle');
  const body = $('#sideBody');
  title.textContent = ({
    inicio:'Inicio', pasajero:'Pasajero', conductor:'Conductor', perfil:'Perfil'
  })[currentTab];
  body.innerHTML='';

  if(!state.user){
    body.appendChild(loginCard());
    return;
  }

  if(currentTab==='inicio') body.appendChild(cardInicio());
  if(currentTab==='pasajero') body.appendChild(cardPasajero());
  if(currentTab==='conductor') body.appendChild(cardConductor());
  if(currentTab==='perfil') body.appendChild(cardPerfil());
}

// ======= Componentes =======
function loginCard(){
  const wrap = document.createElement('div');
  wrap.className='grid';
  wrap.innerHTML = `
    <div class="card">
      <h3 style="margin:0 0 .25rem 0">Entrar (demo libre)</h3>
      <p style="margin:.2rem 0 .8rem 0;color:var(--muted)">No se valida correo. Tus datos quedan solo en este dispositivo.</p>
      <div class="field"><label class="label">Nombre</label><input id="inNombre" class="input" placeholder="Ana, Mauro…"/></div>
      <div class="field"><label class="label">Correo (opcional)</label><input id="inEmail" class="input" placeholder="nombre@mail.com"/></div>
      <div class="field"><label class="label">Rol</label>
        <select id="inRol" class="input">
          <option value="pasajero">Pasajero</option>
          <option value="conductor">Conductor</option>
        </select>
      </div>
      <div class="row" style="margin-top:.8rem;justify-content:space-between">
        <button class="btn primary" id="btnEntrar">Entrar ahora</button>
        <button class="btn ghost" id="btnAutofill">Autocompletar</button>
      </div>
    </div>`;
  setTimeout(()=>{
    $('#btnAutofill').onclick = ()=>{
      $('#inNombre').value = 'Usuario Demo';
      $('#inEmail').value = 'demo@example.com';
    };
    $('#btnEntrar').onclick = ()=>{
      const nombre = $('#inNombre').value.trim()||'Invitado';
      const email = $('#inEmail').value.trim()||'';
      const rol = $('#inRol').value;
      state.user = { id: uid(), nombre, email, rol, foto:"", rating: {sum:0, count:0} };
      save(); renderSide();
    };
  },0);
  return wrap;
}

function cardInicio(){
  const el = document.createElement('div');
  el.className='grid';
  el.innerHTML = `
    <div class="card">
      <div class="row wrap" style="justify-content:space-between">
        <div>
          <div class="label">Sesión</div>
          <div class="chip">${state.user?.nombre || ''} (${state.user?.rol})</div>
        </div>
        <div>
          <div class="label">Viajes</div>
          <div class="chip">${state.viajes.length}</div>
        </div>
        <div>
          <div class="label">Estado</div>
          <div class="badge warn">modo demo</div>
        </div>
      </div>
      <div class="row" style="margin-top:.8rem;gap:.5rem;flex-wrap:wrap">
        <button class="btn" onclick="currentTab='pasajero'; renderSide()">Ir a Pasajero</button>
        <button class="btn" onclick="currentTab='conductor'; renderSide()">Ir a Conductor</button>
        <button class="btn danger" onclick="logout()">Cerrar sesión</button>
      </div>
    </div>
  `;
  return el;
}

function cardPasajero(){
  const el = document.createElement('div'); el.className='grid';
  el.innerHTML = `
    <div class="card">
      <div class="label">Cómo elegir puntos</div>
      <p style="margin:.3rem 0;color:var(--muted)">Toca el mapa y elige si ese toque es <b>ORIGEN</b> o <b>DESTINO</b>. Podés usar tu ubicación como origen.</p>
      <div class="row" style="gap:.5rem;flex-wrap:wrap">
        <button class="btn" onclick="miUbicacionComoOrigen()">Usar mi ubicación</button>
        <button class="btn ghost" onclick="limpiar()">Limpiar</button>
      </div>
    </div>
    <div class="card">
      <div class="label">Solicitud</div>
      <p id="solicitudTxt" style="margin:.3rem 0;color:var(--muted)">Aún no solicitaste un viaje.</p>
      <div class="row" style="gap:.5rem;flex-wrap:wrap">
        <button class="btn primary" onclick="solicitarViaje()">Solicitar viaje</button>
        <button class="btn ghost" onclick="cancelarSolicitud()">Cancelar</button>
      </div>
    </div>
    <div class="card">
      <div class="label">Chat con el conductor</div>
      <div class="chatbox">
        <div id="chatlogPax" class="chatlog"></div>
        <div class="chatinput">
          <input id="chatInPax" class="input" placeholder="Escribe un mensaje respetuoso…"/>
          <button class="btn" onclick="enviarChat('pax')">Enviar</button>
        </div>
      </div>
    </div>`;
  return el;
}

function cardConductor(){
  const el = document.createElement('div'); el.className='grid';
  const req = state.pendingForDriver;
  el.innerHTML = `
    <div class="card">
      <div class="label">Solicitudes</div>
      ${ req ? `
        <div class="row wrap" style="justify-content:space-between">
          <div>
            <div class="chip">Pasajero: ${req.pasajero.nombre}</div>
            <div class="chip">Precio: ${fmt(req.precio)}</div>
          </div>
          <div>
            <div class="chip">Dist: ${req.km.toFixed(2)} km</div>
            <div class="chip">Estado: ${req.estado}</div>
          </div>
        </div>
        <div class="row" style="margin-top:.6rem;gap:.5rem;flex-wrap:wrap">
          <button class="btn primary" onclick="aceptarViaje()">Aceptar</button>
          <button class="btn ghost" onclick="rechazarViaje()">Rechazar</button>
        </div>
      ` : `<p style="margin:.3rem 0;color:var(--muted)">Sin solicitudes. Cuando el pasajero pida, aparecerá aquí.</p>`}
    </div>
    <div class="card">
      <div class="label">Acciones</div>
      <div class="row" style="gap:.5rem;flex-wrap:wrap">
        <button class="btn" onclick="iniciarTrayecto()">Iniciar</button>
        <button class="btn" onclick="finalizarTrayecto()">Finalizar</button>
      </div>
    </div>
    <div class="card">
      <div class="label">Chat con el pasajero</div>
      <div class="chatbox">
        <div id="chatlogDrv" class="chatlog"></div>
        <div class="chatinput">
          <input id="chatInDrv" class="input" placeholder="Escribe un mensaje respetuoso…"/>
          <button class="btn" onclick="enviarChat('drv')">Enviar</button>
        </div>
      </div>
    </div>`;
  return el;
}

function cardPerfil(){
  const u = state.user;
  const avg = u.rating.count? (u.rating.sum/u.rating.count):0;
  const stars = [1,2,3,4,5].map(i=>`<span class="star ${avg>=i? '':'off'}">★</span>`).join('');
  const totalStars = u.rating.sum; // acumulado para trofeos
  let trofeos = '';
  if(totalStars>=5000) trofeos += '🏆🥇';
  else if(totalStars>=1000) trofeos += '🏆';
  const el = document.createElement('div'); el.className='grid';
  el.innerHTML = `
    <div class="card">
      <div class="row wrap" style="gap:.75rem;align-items:flex-start">
        <img src="https://api.dicebear.com/9.x/initials/svg?seed=${encodeURIComponent(u.nombre)}" alt="avatar" width="64" height="64" style="border-radius:12px;border:1px solid var(--line)"/>
        <div>
          <div style="font-weight:600">${u.nombre}</div>
          <div class="chip">${u.email||'sin email'}</div>
          <div class="chip">Rol: ${u.rol}</div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="label">Calificación</div>
      <div class="row" style="gap:.35rem">${stars}</div>
      <div class="row" style="gap:.5rem;margin-top:.4rem">
        <div class="chip">${u.rating.count} opiniones</div>
        <div class="chip">${avg.toFixed(2)} / 5.00</div>
        <div class="chip trophy">${trofeos||'—'}</div>
      </div>
    </div>
    <div class="card">
      <div class="label">Cuenta</div>
      <div class="row" style="gap:.5rem;flex-wrap:wrap">
        <button class="btn danger" onclick="logout()">Cerrar sesión</button>
        <button class="btn ghost" onclick="borrarTodo()">Borrar datos locales</button>
      </div>
    </div>`;
  return el;
}

function logout(){ state.user=null; save(); renderSide(); }
function borrarTodo(){ localStorage.removeItem('taxiya_state'); location.reload(); }

// ======= Mapa y selección =======
function initMap(){
  map = L.map('map', { zoomControl:true }).setView([-34.6037,-58.3816], 12); // CABA por defecto
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'© OpenStreetMap' }).addTo(map);

  map.on('click', (e)=>{
    if(!state.user){ alert('Inicia sesión (demo) para usar el mapa.'); return; }
    const useAsOrigin = confirm('¿Usar este punto como ORIGEN?\n(Cancelar = DESTINO)');
    const p = { lat: e.latlng.lat, lng: e.latlng.lng };
    if(useAsOrigin){ setOrigen(p); }
    else { setDestino(p); }
  });
}

function setOrigen(p){
  if(origenMarker) map.removeLayer(origenMarker);
  origenMarker = L.marker([p.lat, p.lng], { draggable:true }).addTo(map).bindPopup('Origen');
  origenMarker.on('dragend',()=>{ const ll=origenMarker.getLatLng(); setOrigen({lat:ll.lat,lng:ll.lng}); });
  state.origen=p; updateInfo();
}
function setDestino(p){
  if(destinoMarker) map.removeLayer(destinoMarker);
  destinoMarker = L.marker([p.lat, p.lng], { draggable:true, icon: L.divIcon({className:'', html:'<div style="background:#1e293b;border:2px solid #334155;color:#fff;padding:2px 6px;border-radius:6px">🎯</div>'}) }).addTo(map).bindPopup('Destino');
  destinoMarker.on('dragend',()=>{ const ll=destinoMarker.getLatLng(); setDestino({lat:ll.lat,lng:ll.lng}); });
  state.destino=p; updateInfo();
}

function miUbicacionComoOrigen(){
  if(!navigator.geolocation){ alert('Geolocalización no disponible'); return; }
  navigator.geolocation.getCurrentPosition((pos)=>{
    const p={lat:pos.coords.latitude,lng:pos.coords.longitude};
    if(meMarker) map.removeLayer(meMarker);
    meMarker = L.circleMarker([p.lat,p.lng], {radius:7, color:'#34d399'}).addTo(map).bindPopup('Mi ubicación');
    map.setView([p.lat,p.lng], 14);
    setOrigen(p);
  }, ()=> alert('No se pudo obtener ubicación'));
}

function limpiar(){
  if(origenMarker) map.removeLayer(origenMarker); origenMarker=null; state.origen=null;
  if(destinoMarker) map.removeLayer(destinoMarker); destinoMarker=null; state.destino=null;
  updateInfo();
}

function updateInfo(){
  const o = state.origen, d=state.destino;
  $('#origenTxt').textContent = o? `${o.lat.toFixed(4)}, ${o.lng.toFixed(4)}` : '—';
  $('#destinoTxt').textContent = d? `${d.lat.toFixed(4)}, ${d.lng.toFixed(4)}` : '—';
  const dist = km(o,d);
  $('#kmTxt').textContent = dist.toFixed(2);
  const bruto = state.precios.base + dist*state.precios.porKm; // simple
  const final = Math.max(0, Math.round(bruto*(1 - state.precios.descuento)));
  $('#fareTxt').textContent = fmt(final);
  save();
}

// ======= Flujo de viaje (demo local) =======
function solicitarViaje(){
  if(!state.user || state.user.rol!=='pasajero'){ alert('Inicia como pasajero.'); return; }
  if(!state.origen || !state.destino){ alert('Elige origen y destino primero.'); return; }
  const dist = km(state.origen, state.destino);
  const precio = Math.max(0, Math.round((state.precios.base + dist*state.precios.porKm) * (1 - state.precios.descuento)));
  const v = { id: uid(), pasajero: state.user, conductor: null, origen: state.origen, destino: state.destino, km: dist, precio, estado:'buscando', chat: [] };
  state.activo = v;
  state.pendingForDriver = v; // visible al panel Conductor
  $('#actividad').textContent = 'Solicitud enviada. Esperando conductor…';
  $('#solicitudTxt').textContent = `Solicitud #${v.id} por ${fmt(precio)} — ${dist.toFixed(2)} km (estado: buscando)`;
  save(); renderSide();
}

function cancelarSolicitud(){
  if(state.activo && state.activo.estado==='buscando'){
    state.activo = null; state.pendingForDriver=null; save(); renderSide();
    $('#actividad').textContent='Solicitud cancelada.';
  }
}

function aceptarViaje(){
  if(!state.user || state.user.rol!=='conductor'){ alert('Inicia como conductor.'); return; }
  const req = state.pendingForDriver; if(!req){ alert('No hay solicitud.'); return; }
  req.conductor = state.user; req.estado='aceptado';
  state.activo = req; state.pendingForDriver=null; save(); renderSide();
  $('#actividad').textContent = `Conductor asignado: ${state.user.nombre}.`;
}
function rechazarViaje(){ state.pendingForDriver=null; save(); renderSide(); }

function iniciarTrayecto(){
  if(!state.activo){ alert('No hay viaje activo.'); return; }
  state.activo.estado='en curso'; save(); renderSide();
  $('#actividad').textContent='En viaje…';
}

function finalizarTrayecto(){
  if(!state.activo){ alert('No hay viaje activo.'); return; }
  state.activo.estado='finalizado';
  state.viajes.push(state.activo);
  const pax = state.activo.pasajero; const drv = state.activo.conductor || {id:'demo', nombre:'Conductor Demo'};
  // pedir estrellas
  setTimeout(()=>{
    const rp = Number(prompt(`Pasajero: califica al conductor de 1 a 5 estrellas`, '5'))||5;
    const rd = Number(prompt(`Conductor: califica al pasajero de 1 a 5 estrellas`, '5'))||5;
    // acumular en cada perfil si existen
    if(drv.id===state.user?.id){ // si el conductor es el usuario actual y calificó al pasajero
      // sumar al pasajero (en esta demo simple sumamos al propio usuario si es pasajero)
    }
    if(state.user){
      state.user.rating.sum += (state.user.rol==='conductor'? rp : rd);
      state.user.rating.count += 1;
    }
    alert('¡Gracias! Viaje finalizado.');
    state.activo=null; save(); renderSide();
  }, 50);
}

// ======= Chat (demo local compartido) =======
function renderChat(){
  const v = state.activo; const logP = $('#chatlogPax'); const logD = $('#chatlogDrv');
  if(!logP||!logD) return;
  const msgs = v?.chat || [];
  logP.innerHTML=''; logD.innerHTML='';
  for(const m of msgs){
    const bubble = (who)=> `<div class="msg ${who}"><b>${m.from==='pax'?'Pasajero':'Conductor'}:</b> ${m.text}</div>`;
    logP.insertAdjacentHTML('beforeend', bubble(m.from==='pax'?'me':''));
    logD.insertAdjacentHTML('beforeend', bubble(m.from==='drv'?'me':''));
  }
  logP.scrollTop = logP.scrollHeight; logD.scrollTop = logD.scrollHeight;
}

function enviarChat(from){
  if(!state.activo){ alert('No hay viaje activo.'); return; }
  const input = from==='pax'? $('#chatInPax') : $('#chatInDrv');
  let text = (input.value||'').trim(); if(!text) return;
  const sanitized = sanitizeMsg(text);
  // bloquear si todo quedó en *** (insulto puro)
  if(/^\*{3,}$/.test(sanitized)){ alert('Mensaje bloqueado por lenguaje inapropiado.'); return; }
  state.activo.chat.push({ id: uid(), ts: Date.now(), from, text: sanitized });
  input.value=''; save(); renderChat();
}

// ======= Eventos y bootstrap =======
window.addEventListener('DOMContentLoaded', ()=>{
  initMap();
  $('#btnMiUbicacion').onclick = miUbicacionComoOrigen;
  $('#btnLimpiar').onclick = limpiar;
  $('#btnSolicitar').onclick = solicitarViaje;
  renderSide();
  // refrescar chat cada 800ms (demo)
  setInterval(renderChat, 800);
});
</script>
</body>
</html>
