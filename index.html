<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Taxi Ya ‚Äî Firebase</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Routing Machine + OSRM -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0f15; --panel:#0f141d; --ink:#f5f7fb; --muted:#a9b4c2; --line:#1b2430;
  --accent:#ffd34d; --ok:#22c55e; --danger:#ef4444; --chip:#17202a; --card:#0d131b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0f15,#0b0f15 60%,#0a0f19);color:var(--ink);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial}
button,input,select{font-family:inherit}

/* ===== AUTH GATE ===== */
#gate{position:fixed;inset:0;display:grid;place-items:center;background:radial-gradient(1200px 800px at 50% -10%,#13202e 0%, #0b0f15 60%, #0a0f19 100%);z-index:100}
.gate-card{width:min(720px,92vw);background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:1rem}
.gate-title{display:flex;align-items:center;gap:.6rem;margin:.25rem 0 1rem}
.gate-title .dot{width:.9rem;height:.9rem;border-radius:999px;background:var(--accent);box-shadow:0 0 16px rgba(255,211,77,.7)}
.grid{display:grid;gap:.75rem}
.field{display:grid;gap:.35rem}
.label{font-size:.9rem;color:var(--muted)}
.input, select.input{width:100%;background:#0e1620;border:1px solid var(--line);color:var(--ink);padding:.65rem .75rem;border-radius:12px}
.btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--line);background:#12202e;color:var(--ink);padding:.6rem .9rem;border-radius:12px;cursor:pointer;transition:.2s;text-decoration:none}
.btn.primary{background:var(--accent);color:#111;border-color:#e6b800}
.link{color:#a7c7ff;cursor:pointer;text-decoration:underline}
.err{color:#fecaca}
.preview{width:72px;height:72px;border-radius:50%;border:1px solid var(--line);object-fit:cover;background:#0d131b}

/* ===== APP ===== */
.app{min-height:100dvh;display:grid;grid-template-rows:auto 1fr}
.header{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--line);background:rgba(13,19,27,.7);backdrop-filter:blur(12px);position:sticky;top:0;z-index:20}
.brand{display:flex;align-items:center;gap:.6rem}
.brand .dot{width:.9rem;height:.9rem;border-radius:999px;background:var(--accent);box-shadow:0 0 16px rgba(255,211,77,.7)}
.tabs{display:flex;gap:.35rem;flex-wrap:wrap}
.tab{padding:.45rem .75rem;border:1px solid var(--line);border-radius:999px;background:#17202a;color:#fff;opacity:.85;cursor:pointer;transition:.2s}
.tab[aria-selected="true"]{background:var(--accent);color:#111;opacity:1;border-color:#e6b800}

/* ===== Layouts por rol ===== */
.container{display:grid;gap:1rem;padding:1rem;max-width:1300px;margin:0 auto}
.aside,.main{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden}
.panel-head{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--line);background:var(--card)}
.panel-body{padding:1rem;display:flex;flex-direction:column;gap:.75rem;min-height:calc(100vh - 140px)}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:1rem}
.row{display:flex;gap:.6rem;align-items:center}
.row.wrap{flex-wrap:wrap}
.chip{background:#121a24;border:1px solid var(--line);padding:.35rem .6rem;border-radius:999px;font-size:.85rem;color:var(--muted)}
.badge{padding:.3rem .5rem;border-radius:8px;border:1px solid var(--line);font-size:.78rem}
.badge.ok{background:rgba(34,197,94,.12);color:#86efac;border-color:rgba(34,197,94,.35)}
.help{color:var(--muted);font-size:.86rem}

/* Estado */
.status-bar{order:50;display:none;align-items:center;gap:.6rem;background:#0f172a;border:1px solid #243045;padding:.55rem .75rem;border-radius:10px;font-weight:600}

/* Mapa */
.map-wrap{order:99;position:relative}
#map{width:100%;height:70vh;min-height:460px}
.leaflet-container{background:#0b0f15}

/* Overlay de solicitudes en el mapa (Conductor) */
.req-overlay{position:absolute;right:14px;top:14px;width:min(380px,92vw);max-height:60vh;overflow:auto;background:#0e1620;border:1px solid var(--line);border-radius:14px;padding:.75rem;box-shadow:0 6px 24px rgba(0,0,0,.35);display:none}
.req-title{font-weight:700;margin:.25rem 0 .5rem 0}
.req-item{display:grid;grid-template-columns:48px 1fr auto;gap:.6rem;align-items:center;border:1px solid var(--line);background:#0d131b;border-radius:12px;padding:.6rem;margin:.5rem 0}
.req-item .avatar{width:48px;height:48px;border-radius:10px;border:1px solid var(--line);object-fit:cover}
.req-item .meta{font-size:.85rem;color:#a9b4c2}
.req-actions{display:flex;gap:.4rem}
.req-pay{font-size:.78rem;border:1px dashed #334155;padding:.15rem .4rem;border-radius:8px;color:#a9b4c2}
.req-compact{display:grid;gap:.5rem}
.req-compact .head{display:flex;align-items:center;gap:.6rem}
.req-compact .head img{width:42px;height:42px;border-radius:10px;border:1px solid var(--line);object-fit:cover}

/* Chat compacto */
.chat-mini{order:98}
.chat-mini summary{cursor:pointer;list-style:none;display:flex;align-items:center;gap:.5rem;background:#0f172a;border:1px solid #243045;padding:.55rem .75rem;border-radius:10px;font-weight:600}
.chat-mini .chatbox{display:grid;grid-template-rows:1fr auto;height:180px;background:#0d131b;border:1px solid var(--line);border-radius:12px;overflow:hidden;margin-top:.6rem}
.chatlog{overflow:auto;padding:.6rem}
.msg{display:inline-block;background:#12202e;border:1px solid var(--line);padding:.45rem .6rem;border-radius:10px;margin:.25rem 0;font-size:.92rem}
.msg.me{background:#1f2a37}

/* Autocomplete */
.ac-results{position:relative;margin-top:.35rem}
.ac-results::before{content:'';position:absolute;top:-8px;left:16px;width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:8px solid #0e1620;opacity:.8}
.ac-results>div{background:#0e1620;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.ac-item{padding:.6rem .75rem;border-bottom:1px solid #1a2430;cursor:pointer}
.ac-item:last-child{border-bottom:0}
.ac-item:hover{background:#142032}
.ac-title{font-weight:600}
.ac-sub{font-size:.85rem;color:#a9b4c2}

/* ===== Variantes por rol ===== */
.container.layout-passenger{grid-template-columns:1fr}
.container.layout-passenger #aside{display:none}
.container.layout-passenger .main{display:block}

.container.layout-driver{grid-template-columns:1fr}
.container.layout-driver #aside{display:block; order:1}
.container.layout-driver .main{display:block; order:2} /* mapa abajo */

.container.layout-profile{grid-template-columns:1fr}
.container.layout-profile #aside{display:block}
.container.layout-profile .main{display:none} /* sin mapa en Perfil */

/* === FIX: conductor sin hueco y mapa m√°s arriba === */
.container.layout-driver #aside .panel-body{min-height:auto;padding-bottom:.5rem;}
.container.layout-driver #aside{margin-bottom:.75rem;}
.container.layout-driver .main .panel-body{padding-top:.25rem;}

/* Responsive */
@media (max-width:680px){
  .tabs{position:fixed;bottom:10px;left:0;right:0;justify-content:center;z-index:40}
  .tab{background:#131c28;border-color:#223043}
  #map{height:64vh;min-height:360px}
}
</style>
</head>
<body>

<!-- =========== AUTH =========== -->
<div id="gate" aria-hidden="false">
  <div class="gate-card">
    <div class="gate-title">
      <span class="dot"></span><b>Taxi Ya</b>
      <span class="chip" style="margin-left:.5rem;background:#121a24;border:1px solid var(--line);padding:.2rem .5rem;border-radius:999px;color:#a7b4c2">Inicio de sesi√≥n</span>
    </div>

    <div id="envWarn" class="err" style="display:none;margin-bottom:.75rem">
      ‚ö†Ô∏è Abr√≠ el sitio con <b>http://localhost</b> (no <code>file://</code>).
    </div>

    <!-- LOGIN -->
    <div class="card" style="background:#0d131b">
      <div class="grid">
        <div class="field"><label class="label">Email</label><input id="inEmail" type="email" class="input" placeholder="tu@email.com" autocomplete="email"></div>
        <div class="field"><label class="label">Contrase√±a</label><input id="inPass" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
        <div class="row" style="gap:.6rem">
          <button class="btn primary" id="btnLogin" type="button">Entrar</button>
        </div>
        <div id="loginErr" class="err"></div>
      </div>
    </div>

    <p class="help" style="margin:.5rem 0 0 0">
      ¬øNo ten√©s cuenta? <span id="showReg" class="link">Crear una</span>
    </p>

    <!-- REGISTRO -->
    <div id="regCard" class="card" style="display:none;margin-top:.6rem;background:#0d131b">
      <h3 style="margin:0 0 .5rem 0">Crear cuenta</h3>
      <div class="row" style="gap:1rem;align-items:flex-end;flex-wrap:wrap">
        <div class="field" style="align-items:center">
          <img id="regPreview" class="preview" src="" alt="foto"/>
          <label class="label" style="margin-top:.35rem">Foto de perfil (opcional)</label>
          <input id="regPhoto" type="file" accept="image/*" class="input" style="padding:.45rem"/>
        </div>
        <div class="field" style="flex:1"><label class="label">Nombre</label><input id="regName" class="input" placeholder="Ana, Mauro‚Ä¶"></div>
      </div>
      <div class="grid">
        <div class="field"><label class="label">Email</label><input id="regEmail" type="email" class="input" placeholder="tu@email.com" autocomplete="email"></div>
        <div class="field"><label class="label">Contrase√±a</label><input id="regPass" type="password" class="input" placeholder="m√≠n. 6 caracteres" autocomplete="new-password"></div>
        <div class="field"><label class="label">Repetir contrase√±a</label><input id="regPass2" type="password" class="input" placeholder="repite la contrase√±a" autocomplete="new-password"></div>
      </div>
      <div class="row" style="margin-top:.6rem;gap:.6rem">
        <button class="btn" id="btnCancelReg" type="button">Cancelar</button>
        <button class="btn primary" id="btnReg" type="button">Crear cuenta</button>
      </div>
      <div id="regErr" class="err"></div>
    </div>

    <p class="help" style="margin-top:.5rem">Inici√° sesi√≥n para continuar al mapa.</p>
    <div id="fatal" class="err" style="display:none;margin-top:10px"></div>
  </div>
</div>

<!-- ==================== APP ==================== -->
<div class="app" id="app" style="display:none">
  <header class="header">
    <div class="brand"><span class="dot"></span><b>Taxi Ya</b><span class="chip" id="statusChip">offline</span></div>
    <nav class="tabs" id="tabs"></nav>
  </header>

  <div class="container layout-passenger" id="container">
    <aside class="aside" id="aside">
      <div class="panel-head"><strong id="sideTitle">Panel</strong><span class="badge ok" id="authBadge">Conectado</span></div>
      <div class="panel-body" id="sideBody"></div>
    </aside>

    <main class="main">
      <div class="panel-head"><strong id="mainTitle">Mapa</strong></div>
      <div class="panel-body">

        <!-- Controles PASAJERO -->
        <div class="card" id="controlsCard">
          <div class="grid" style="gap:.9rem">
            <div class="field" style="width:min(520px,100%)">
              <label class="label">Buscar direcci√≥n</label>
              <input id="addrSearch" class="input" placeholder="Ej: Av. Corrientes 1234, CABA" autocomplete="off">
              <div id="addrResults" class="ac-results" style="display:none"></div>
            </div>

            <div class="row wrap" style="justify-content:space-between;gap:.75rem">
              <div class="row" style="gap:.5rem">
                <div class="label">Seleccionar en mapa:</div>
                <div class="seg" id="modeSeg" style="display:inline-flex;border:1px solid var(--line);border-radius:999px;overflow:hidden">
                  <button id="modeOrigen" type="button" aria-pressed="true" style="border:0;background:#0e1620;color:#fff;padding:.45rem .8rem;cursor:pointer">Origen</button>
                  <button id="modeDestino" type="button" aria-pressed="false" style="border:0;background:#0e1620;color:#fff;padding:.45rem .8rem;cursor:pointer">Destino</button>
                </div>
              </div>

              <div class="row" style="gap:.5rem;flex-wrap:wrap;justify-content:flex-start">
                <div class="field">
                  <label class="label">M√©todo de pago</label>
                  <select id="payMethod" class="input" style="min-width:160px">
                    <option value="efectivo" selected>Efectivo</option>
                    <option value="mp">Mercado Pago</option>
                  </select>
                </div>
                <button class="btn" id="btnMiUbicacion" type="button">Usar mi ubicaci√≥n</button>
                <button class="btn" id="btnLimpiar" type="button">Limpiar</button>
                <button class="btn" id="btnCancelReqTop" type="button">Cancelar</button>
                <button class="btn primary" id="btnSolicitar" type="button">Solicitar viaje</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Info PASAJERO -->
        <div class="card" id="infoCard">
          <div class="row wrap" style="justify-content:space-between">
            <div><div class="label">Origen</div><div id="origenTxt" class="chip">‚Äî</div></div>
            <div><div class="label">Destino</div><div id="destinoTxt" class="chip">‚Äî</div></div>
            <div><div class="label">Distancia (km)</div><div id="kmTxt" class="chip">0.00</div></div>
            <div><div class="label">Duraci√≥n (min)</div><div id="minTxt" class="chip">0</div></div>
            <div><div class="label">Tarifa estimada</div><div id="fareTxt" class="chip">$ 0</div></div>
            <div><div class="label">Surge</div><div id="surgeTxt" class="chip">x1.0</div></div>
          </div>
          <p class="help" id="actividad">Toc√° el mapa para fijar Origen/Destino.</p>
        </div>

        <!-- Barra de estado -->
        <div id="statusBar" class="status-bar">
          <span id="statusText">BUSCANDO CONDUCTOR‚Ä¶</span>
          <span class="chip" id="searchTimer">00:00</span>
        </div>

        <!-- Mapa -->
        <div class="map-wrap">
          <div id="map"></div>
          <!-- Overlay de solicitudes para CONDUCTOR -->
          <div id="reqOverlay" class="req-overlay"></div>
        </div>

        <!-- Chat compacto -->
        <details id="chatMini" class="chat-mini" style="display:none">
          <summary>üí¨ Chat del viaje (opcional)</summary>
          <div class="chatbox">
            <div id="chatlog" class="chatlog"></div>
            <div class="chatinput" style="display:flex;gap:.5rem;padding:.6rem;border-top:1px solid var(--line)">
              <input id="chatInput" class="input" placeholder="Escrib√≠ un mensaje respetuoso‚Ä¶"/>
              <button class="btn" id="chatSend" type="button">Enviar</button>
            </div>
          </div>
          <div class="help">Visible en ‚Äúaceptado / en curso‚Äù.</div>
        </details>

      </div>
    </main>
  </div>
</div>

<!-- ===== AVISO ENTORNO ===== -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  var warn = document.getElementById('envWarn');
  if(!warn) return;
  warn.style.display = (location.protocol!=='http:' && location.protocol!=='https:') ? 'block' : 'none';
});
window.addEventListener('error', function(e){
  var f = document.getElementById('fatal');
  if(f){ f.style.display='block'; f.textContent='Error de carga: ' + (e.message || 'desconocido') + '. Mir√° la consola.'; }
});
</script>

<!-- ================= Firebase + App (M√≥dulos) ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth, setPersistence, browserLocalPersistence, browserSessionPersistence, inMemoryPersistence,
  onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc, updateDoc, addDoc, collection,
  serverTimestamp, onSnapshot, query, where, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

/* -------- Config -------- */
const firebaseConfig = {
  apiKey: "AIzaSyBu523IOGnIZGfAkdlLdVLcENwLgv5KU9o",
  authDomain: "taxi-ya-3be33.firebaseapp.com",
  projectId: "taxi-ya-3be33",
  storageBucket: "taxi-ya-3be33.firebasestorage.app",
  messagingSenderId: "31840475169",
  appId: "1:31840475169:web:1485e47b9ebea4a66c6b60",
  measurementId: "G-2RQRP1G2KB"
};

/* -------- Helpers -------- */
const $ = (sel)=>document.querySelector(sel);
const setText=(el,v)=>{ if(el) el.textContent=v; };
const fmt=(n)=> new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n);
function km(a,b){
  if(!a||!b) return 0;
  const R=6371, dLat=(b.lat-a.lat)*Math.PI/180, dLon=(b.lng-a.lng)*Math.PI/180;
  const la1=a.lat*Math.PI/180, la2=b.lat*Math.PI/180;
  const h=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(h));
}
const bannedWords=['puta','puto','cagar','mierda','hdp','concha','pija','forro','insulto','boludo'];
const mapAuthError=(err)=>{ const c=String(err?.code||''); const M={'auth/invalid-email':'Email inv√°lido.','auth/missing-email':'Ingres√° tu email.','auth/missing-password':'Ingres√° tu contrase√±a.','auth/weak-password':'La contrase√±a es muy d√©bil (m√≠nimo 6 caracteres).','auth/email-already-in-use':'Ese email ya est√° registrado.','auth/user-not-found':'Usuario no encontrado.','auth/wrong-password':'Contrase√±a incorrecta.','auth/too-many-requests':'Demasiados intentos.','auth/network-request-failed':'Fallo de red.','auth/operation-not-allowed':'Habilit√° Email/Password.','auth/unauthorized-domain':'Dominio no autorizado (agreg√° localhost).'}; return M[c] || err?.message || 'Error desconocido'; };
async function setupPersistence(){ try{ await setPersistence(auth,browserLocalPersistence);}catch(_){ try{await setPersistence(auth,browserSessionPersistence);}catch(_2){await setPersistence(auth,inMemoryPersistence);} } }

/* -------- Estado global -------- */
let appFB, auth, db, storage;
let map, origenMarker, destinoMarker, meMarker, routing, driverMarker;
let activeReqUnsub=null, chatUnsub=null, listUnsub=null, userUnsub=null, timerInt=null, driverUnsub=null, earningsUnsub=null;
let driverWatchId=null, followMe=true;
let uiTab='pasajero', selectMode='origen';
let driverOnline=false, driverPaused=false, driverSessionStart=null, driverTimer=null;

const state = {
  fbUser:null, profile:null, pointsLocked:false,
  surge:1.0,
  pricing:Object.freeze({ base:800, perKm:350, perMin:120, serviceFee:150, minimum:1200 }),
  origen:null, destino:null, routeKm:0, routeMin:0,
  activeRequestId:null, activeRequest:null, requestCreatedAt:null
};

/* -------- Firebase init -------- */
try{
  appFB = initializeApp(firebaseConfig);
  auth = getAuth(appFB);
  db = getFirestore(appFB);
  storage = getStorage(appFB);
}catch(e){
  const fatal=$('#fatal'); if(fatal){ fatal.style.display='block'; fatal.textContent='No se pudo inicializar Firebase: '+(e.message||e); }
}

/* =================== UI por ROL =================== */
function setContainerMode(mode){
  const c=$('#container');
  c.classList.remove('layout-passenger','layout-driver','layout-profile');
  c.classList.add(mode);
}
function updateRoleUI(){
  const controlsCard=$('#controlsCard'), infoCard=$('#infoCard');
  const statusBar=$('#statusBar'), chatMini=$('#chatMini');
  const overlay=$('#reqOverlay');

  if(uiTab==='pasajero'){
    setContainerMode('layout-passenger');
    if(controlsCard) controlsCard.style.display='block';
    if(infoCard) infoCard.style.display='block';
    if(overlay) overlay.style.display='none';
  }else if(uiTab==='conductor'){
    setContainerMode('layout-driver');
    if(controlsCard) controlsCard.style.display='none';
    if(infoCard) infoCard.style.display='none';
    if(overlay) overlay.style.display = driverOnline ? 'block' : 'none';
  }else{ // perfil
    setContainerMode('layout-profile');
    if(controlsCard) controlsCard.style.display='none';
    if(infoCard) infoCard.style.display='none';
    if(statusBar) statusBar.style.display='none';
    if(chatMini) chatMini.style.display='none';
    if(overlay) overlay.style.display='none';
  }
  setTimeout(()=>{ if(map) map.invalidateSize(); },120);
}

/* -------- Tabs y Panel -------- */
function tabsForState(){
  if(!state.fbUser) return [];
  return [{id:'pasajero',label:'Pasajero'},{id:'conductor',label:'Conductor'},{id:'perfil',label:'Perfil'}];
}
function renderTabs(){
  const nav=$('#tabs'); if(!nav) return; nav.innerHTML='';
  for(const t of tabsForState()){
    const b=document.createElement('button');
    b.className='tab';
    b.textContent=t.label;
    b.setAttribute('aria-selected', uiTab===t.id ? 'true':'false');
    b.onclick=function(){ uiTab=t.id; onTabChange(); };
    nav.appendChild(b);
  }
  const sc=$('#statusChip'); if(sc) sc.textContent=state.fbUser ? ((state.profile && state.profile.name) || 'online') : 'offline';
}
function onTabChange(){
  if(uiTab!=='conductor') unsubscribePendientes();
  renderSide();
  updateRoleUI();
}
function renderSide(){
  const body=$('#sideBody'); const title=$('#sideTitle');
  title.textContent = (uiTab==='conductor'?'Conductor':(uiTab==='perfil'?'Perfil':'Pasajero'));
  body.innerHTML='';
  if(uiTab==='conductor') body.appendChild(cardConductor());
  if(uiTab==='perfil') body.appendChild(cardPerfil());
}

/* -------- Side: Conductor -------- */
function cardConductor(){
  const el=document.createElement('div'); el.className='grid';
  el.innerHTML=[
  '<div class="card">',
    '<div class="row wrap" style="justify-content:space-between">',
      '<div class="row" style="gap:.5rem">',
        '<span class="chip" id="drvStatus">Offline</span>',
        '<span class="chip">Conectado: <b id="drvTime">00:00:00</b></span>',
        '<span class="chip">Ganancias: <b id="drvEarn">$ 0</b></span>',
      '</div>',
      '<div class="row" style="gap:.5rem;flex-wrap:wrap">',
        '<button class="btn primary" id="btnDrvStart" type="button">Iniciar</button>',
        '<button class="btn" id="btnDrvPause" type="button" disabled>Pausar</button>',
        '<button class="btn" id="btnDrvFinish" type="button" disabled>Finalizar</button>',
      '</div>',
    '</div>',
    '<p class="help" style="margin-top:.4rem">‚ÄúIniciar‚Äù te pone disponible; ‚ÄúPausar‚Äù te saca de la cola; ‚ÄúFinalizar‚Äù cierra la sesi√≥n. Las solicitudes aparecen sobre el mapa.</p>',
  '</div>'
  ].join('');
  setTimeout(function(){
    updateDriverHeader();
    attachEarningsListener();
    if(driverOnline && !driverPaused) subscribePendientes(); else unsubscribePendientes();
    updateRoleUI();
  },0);
  return el;
}

/* -------- Side: Perfil (subsecciones) -------- */
function cardPerfil(){
  const p=state.profile||{ratingSum:0,ratingCount:0};
  const avg=p.ratingCount?(p.ratingSum/p.ratingCount):0;
  let stars=''; for(let i=1;i<=5;i++) stars+= '<span style="color:#fcd34d;opacity:'+(avg>=i?1:.35)+'">‚òÖ</span>';
  const avatar = (p.photoURL && p.photoURL.length)? p.photoURL : ('https://api.dicebear.com/9.x/initials/svg?seed=' + encodeURIComponent(p.name|| (state.fbUser?state.fbUser.email:'U')));
  const el=document.createElement('div'); el.className='grid';

  el.innerHTML=[
    '<section class="card">',
      '<h3 style="margin:.1rem 0 1rem 0">Cuenta</h3>',
      '<div class="row wrap" style="gap:.75rem;align-items:flex-start">',
        '<img loading="lazy" src="',avatar,'" alt="avatar" width="64" height="64" style="border-radius:12px;border:1px solid var(--line);object-fit:cover"/>',
        '<div>',
          '<div style="font-weight:600">', (p.name||'Usuario') ,'</div>',
          '<div class="chip">', (state.fbUser?state.fbUser.email:'') ,'</div>',
        '</div>',
      '</div>',
    '</section>',
    '<section class="card">',
      '<h3 style="margin:.1rem 0 1rem 0">Sesi√≥n</h3>',
      '<div class="row" style="gap:.5rem;flex-wrap:wrap">',
        '<button class="btn" id="btnLogout" type="button">Cerrar sesi√≥n</button>',
      '</div>',
    '</section>',
    '<section class="card">',
      '<h3 style="margin:.1rem 0 1rem 0">Preferencias</h3>',
      '<div class="row wrap" style="gap:.5rem">',
        '<span class="chip">Tema: Oscuro</span>',
        '<span class="chip">Idioma: ES</span>',
        '<span class="chip">Notificaciones: On</span>',
      '</div>',
      '<p class="help" style="margin-top:.35rem">Ejemplo visual. Pod√©s persistirlo en Firestore despu√©s.</p>',
    '</section>',
    '<section class="card">',
      '<h3 style="margin:.1rem 0 1rem 0">Calificaci√≥n</h3>',
      '<div class="row" style="gap:.35rem">',stars,'</div>',
      '<div class="row" style="gap:.5rem;margin-top:.4rem">',
        '<div class="chip">',(p.ratingCount||0),' opiniones</div>',
        '<div class="chip">',avg.toFixed(2),' / 5.00</div>',
      '</div>',
    '</section>'
  ].join('');

  setTimeout(()=>{ const b=$('#btnLogout'); if(b){ b.addEventListener('click', ()=>signOut(auth)); } },0);
  return el;
}

/* -------- Conductor: estado/controles -------- */
function updateDriverHeader(){
  const st=$('#drvStatus'); if(st) st.textContent = driverOnline ? (driverPaused?'Pausado':'Online') : 'Offline';
  const bStart=$('#btnDrvStart'), bPause=$('#btnDrvPause'), bFin=$('#btnDrvFinish');
  if(bStart){ bStart.disabled = (driverOnline && !driverPaused); }
  if(bPause){ bPause.disabled = !driverOnline; bPause.textContent = driverPaused?'Reanudar':'Pausar'; }
  if(bFin){ bFin.disabled = !driverOnline; }
}
function driverStart(){ if(driverOnline && !driverPaused) return; driverOnline=true; driverPaused=false; if(!driverSessionStart) driverSessionStart=Date.now(); startDriverShare(); startDriverTimer(); updateDriverHeader(); subscribePendientes(); updateRoleUI(); }
function driverPauseToggle(){ if(!driverOnline) return; driverPaused=!driverPaused; if(driverPaused){ unsubscribePendientes(); stopDriverShare(); } else { subscribePendientes(); startDriverShare(); } updateDriverHeader(); updateRoleUI(); }
function driverFinish(){ if(!driverOnline) return; driverOnline=false; driverPaused=false; stopDriverShare(); stopDriverTimer(); updateDriverHeader(); unsubscribePendientes(); updateRoleUI(); }
function startDriverTimer(){ if(driverTimer) return; function tick(){ const s=Math.floor((Date.now()- (driverSessionStart||Date.now()))/1000); const hh=String(Math.floor(s/3600)).padStart(2,'0'); const mm=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); const el=$('#drvTime'); if(el) el.textContent=hh+':'+mm+':'+ss; } tick(); driverTimer=setInterval(tick,1000); }
function stopDriverTimer(){ if(driverTimer){ clearInterval(driverTimer); driverTimer=null; } }

/* -------- Mapa + ruteo -------- */
function initMap(){
  map=L.map('map',{zoomControl:true,preferCanvas:true}).setView([-34.6037,-58.3816],12);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(map);
  setTimeout(()=>{ if(map) map.invalidateSize(); },200);
  window.addEventListener('resize', ()=>{ if(map) map.invalidateSize(); });
  const pb=document.querySelector('.main .panel-body');
  if(window.ResizeObserver){ new ResizeObserver(()=>{ if(map) map.invalidateSize(); }).observe(pb); }
  map.on('click', function(e){
    if(state.pointsLocked || uiTab!=='pasajero'){ return; }
    const p={lat:e.latlng.lat,lng:e.latlng.lng};
    if(selectMode==='origen'){ setOrigen(p,true); } else { setDestino(p,true); }
  });
}
function ensureRouting(){
  if(routing) return routing;
  routing=L.Routing.control({
    waypoints:[],
    router:L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1',profile:'driving'}),
    lineOptions:{addWaypoints:false,extendToWaypoints:true,missingRouteTolerance:20},
    show:false, collapsible:true, fitSelectedRoutes:true
  }).on('routesfound',function(e){
    const r=e.routes && e.routes[0]; if(!r) return;
    const kmv=(r.summary.totalDistance||0)/1000; const minv=Math.round((r.summary.totalTime||0)/60);
    state.routeKm=kmv; state.routeMin=minv;
    setText($('#kmTxt'), kmv.toFixed(2));
    setText($('#minTxt'), String(minv));
    updateFareUI();
    try{ map.fitBounds(r.bounds,{padding:[30,30]}); }catch(_){}
    const act=$('#actividad'); if(act) act.textContent='Ruta: '+kmv.toFixed(2)+' km ‚Ä¢ ~'+minv+' min';
  }).on('routingerror',function(){ updateInfoHaversine(); }).addTo(map);
  return routing;
}
function setOrigen(p,recalc){ if(origenMarker) map.removeLayer(origenMarker); origenMarker=L.marker([p.lat,p.lng],{draggable:!state.pointsLocked}).addTo(map).bindPopup('Origen'); origenMarker.on('dragend',function(){ if(state.pointsLocked) return; const ll=origenMarker.getLatLng(); setOrigen({lat:ll.lat,lng:ll.lng},true); }); state.origen=p; setText($('#origenTxt'), p.lat.toFixed(4)+', '+p.lng.toFixed(4)); if(recalc) recalcRoute(); }
function setDestino(p,recalc){ if(destinoMarker) map.removeLayer(destinoMarker); destinoMarker=L.marker([p.lat,p.lng],{draggable:!state.pointsLocked}).addTo(map).bindPopup('Destino'); destinoMarker.on('dragend',function(){ if(state.pointsLocked) return; const ll=destinoMarker.getLatLng(); setDestino({lat:ll.lat,lng:ll.lng},true); }); state.destino=p; setText($('#destinoTxt'), p.lat.toFixed(4)+', '+p.lng.toFixed(4)); if(recalc) recalcRoute(); }
function recalcRoute(){ if(!(state.origen&&state.destino)){ updateInfoHaversine(); return; } ensureRouting().setWaypoints([L.latLng(state.origen.lat,state.origen.lng),L.latLng(state.destino.lat,state.destino.lng)]); }
function miUbicacionComoOrigen(){
  if(!navigator.geolocation){ alert('Geolocalizaci√≥n no disponible'); return; }
  navigator.geolocation.getCurrentPosition(function(pos){
    if(state.pointsLocked || uiTab!=='pasajero'){ return; }
    const p={lat:pos.coords.latitude,lng:pos.coords.longitude};
    if(meMarker) map.removeLayer(meMarker);
    meMarker=L.circleMarker([p.lat,p.lng],{radius:7,color:'#34d399'}).addTo(map).bindPopup('Mi ubicaci√≥n');
    map.setView([p.lat,p.lng],14); setOrigen(p,true);
  },function(){ alert('No se pudo obtener ubicaci√≥n'); });
}
function limpiar(){
  if(state.pointsLocked){ alert('No se puede limpiar con un viaje activo. Cancel√° primero.'); return; }
  if(origenMarker) map.removeLayer(origenMarker); origenMarker=null; state.origen=null;
  if(destinoMarker) map.removeLayer(destinoMarker); destinoMarker=null; state.destino=null;
  if(routing){ routing.setWaypoints([]); } state.routeKm=0; state.routeMin=0;
  setText($('#origenTxt'),'‚Äî'); setText($('#destinoTxt'),'‚Äî'); setText($('#kmTxt'),'0.00'); setText($('#minTxt'),'0'); setText($('#fareTxt'), fmt(0));
  const a=$('#actividad'); if(a) a.textContent='Toc√° el mapa para fijar Origen/Destino.';
}
function calcFare(distKm,durMin){ const p=state.pricing; const bruto=p.base+(distKm*p.perKm)+(durMin*p.perMin)+p.serviceFee; const surged=bruto*(state.surge||1.0); return Math.max(p.minimum,Math.round(surged)); }
function updateFareUI(){ setText($('#fareTxt'), fmt(calcFare(state.routeKm||0,state.routeMin||0))); setText($('#surgeTxt'),'x'+(state.surge||1).toFixed(1)); }
function updateInfoHaversine(){ const d=km(state.origen,state.destino); state.routeKm=d; state.routeMin=Math.round((d/25)*60); setText($('#kmTxt'), d.toFixed(2)); setText($('#minTxt'), String(state.routeMin)); updateFareUI(); }

/* -------- Autocomplete -------- */
const addrInput=document.getElementById('addrSearch'), addrBox=document.getElementById('addrResults');
function debounce(fn,ms){ let t=null; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a),ms||350); }; }
async function geocodeSearch(q){ const url='https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=6&q='+encodeURIComponent(q); const r=await fetch(url,{headers:{'Accept-Language':'es-AR,es;q=0.9'}}); return r.ok? r.json() : []; }
function renderAddrResults(list){
  if(!(list && list.length)){ addrBox.style.display='none'; addrBox.innerHTML=''; return; }
  let html='<div>';
  for(const it of list){
    const parts=it.display_name.split(','), t=parts.slice(0,2).join(', '), s=parts.slice(2).join(', ').trim();
    html+=`<div class="ac-item" data-lat="${it.lat}" data-lon="${it.lon}" data-name="${encodeURIComponent(it.display_name)}"><div class="ac-title">${t}</div><div class="ac-sub">${s}</div></div>`;
  }
  html+='</div>'; addrBox.innerHTML=html; addrBox.style.display='block';
  addrBox.querySelectorAll('.ac-item').forEach(node=>{
    node.addEventListener('click', function(){
      const lat=parseFloat(this.getAttribute('data-lat')), lon=parseFloat(this.getAttribute('data-lon')), name=decodeURIComponent(this.getAttribute('data-name'));
      addrInput.value=name; addrBox.style.display='none'; const p={lat:lat,lng:lon};
      if(selectMode==='origen'){ setOrigen(p,true); } else { setDestino(p,true); }
      map.setView([lat,lon],15);
    });
  });
}
if(addrInput){
  addrInput.addEventListener('input', debounce(async function(e){
    if(state.pointsLocked) return;
    const q=(e.target.value||'').trim();
    if(q.length<3){ addrBox.style.display='none'; addrBox.innerHTML=''; return; }
    try{ renderAddrResults(await geocodeSearch(q)); }catch(_){ addrBox.style.display='none'; addrBox.innerHTML=''; }
  },380));
}
document.addEventListener('click', function(e){ if(addrBox && addrBox.style.display!=='none' && !addrBox.contains(e.target) && e.target!==addrInput){ addrBox.style.display='none'; }});

/* -------- Chat + Request watch -------- */
function sanitizeMsg(t){ let x=(t||'').trim(); for(const w of bannedWords){ x=x.replace(new RegExp('\\b'+w+'\\b','gi'),'***'); } return x; }
function mySide(){ const r=state.activeRequest; if(!r||!state.fbUser) return 'pax'; if(r.pasajeroId===state.fbUser.uid) return 'pax'; if(r.conductorId===state.fbUser.uid) return 'drv'; return 'pax'; }
async function sendChat(){
  if(!state.activeRequestId) { alert('Sin viaje activo'); return; }
  const input=$('#chatInput'); const text=(input && input.value)||''; if(!text.trim()) return;
  const s=sanitizeMsg(text); if(/^\*{3,}$/.test(s)) { alert('Mensaje bloqueado'); return; }
  await addDoc(collection(db,'requests',state.activeRequestId,'messages'),{from:mySide(),text:s,ts:serverTimestamp()});
  if(input) input.value='';
}
function showTripChat(show){ const d=document.getElementById('chatMini'); if(d) d.style.display = show ? 'block' : 'none'; }
function setSearchingUI(on){
  const t=document.getElementById('searchTimer'); if(!t) return;
  if(on){ if(!state.requestCreatedAt) state.requestCreatedAt=Date.now(); if(timerInt) clearInterval(timerInt);
    timerInt=setInterval(function(){ const s=Math.floor((Date.now()-state.requestCreatedAt)/1000); const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); t.textContent=mm+':'+ss; },500);
  }else{ if(timerInt) clearInterval(timerInt); timerInt=null; state.requestCreatedAt=null; t.textContent='00:00'; }
}
function watchActiveRequest(id){
  if(activeReqUnsub) activeReqUnsub();
  activeReqUnsub=onSnapshot(doc(db,'requests',id), function(snap){
    if(!snap.exists()) return;
    const r=snap.data(); state.activeRequest={id:snap.id, ...r};
    const act=$('#actividad'); if(act) act.textContent='#'+id.slice(0,6)+' ‚Äî '+r.status.toUpperCase()+' ‚Äî '+fmt(r.precio)+' ('+(r.km||0).toFixed(2)+' km, '+(r.min||0)+' min)';
    const bar=$('#statusBar'), txt=$('#statusText');
    if(bar){ bar.style.display='flex'; }
    const overlay=$('#reqOverlay');

    if(r.status==='buscando'){ if(txt) txt.textContent='BUSCANDO CONDUCTOR‚Ä¶'; setSearchingUI(true); showTripChat(false); stopDriverFollower(); }
    if(r.status==='aceptado'){ if(txt) txt.textContent='CONDUCTOR ACEPT√ì ‚Äî EN CAMINO'; setSearchingUI(false); showTripChat(true); startDriverFollower(id); if(overlay) overlay.innerHTML = renderActiveOverlayHtml(r); }
    if(r.status==='en_curso'){ if(txt) txt.textContent='VIAJE EN CURSO'; setSearchingUI(false); showTripChat(true); startDriverFollower(id); if(overlay) overlay.innerHTML = renderActiveOverlayHtml(r); }
    if(r.status==='finalizado' || r.status==='cancelado'){
      showTripChat(false); state.activeRequestId=null; state.activeRequest=null; lockPoints(false);
      setSearchingUI(false); stopDriverFollower(); if(chatUnsub){ chatUnsub(); chatUnsub=null; }
      alert(r.status==='finalizado'?'¬°Viaje finalizado!':'Solicitud cancelada');
      if(driverOnline && !driverPaused){ renderPendingOverlaySkeleton(); }
    }
    if(r.status!=='finalizado' && r.status!=='cancelado'){ ensureChatListener(id); }
  });
}
function ensureChatListener(reqId){
  if(chatUnsub) return;
  chatUnsub=onSnapshot(query(collection(db,'requests',reqId,'messages'),orderBy('ts','asc'),limit(100)), function(qs){
    const log=$('#chatlog'); if(!log) return; log.innerHTML='';
    const mine=mySide();
    qs.forEach(function(d){ const m=d.data(); const who=(m.from===mine)?'me':''; log.insertAdjacentHTML('beforeend','<div class="msg '+who+'"><b>'+(m.from==='pax'?'Pasajero':'Conductor')+':</b> '+m.text+'</div>'); });
    log.scrollTop=log.scrollHeight;
  });
}

/* -------- Firestore: Solicitudes -------- */
async function solicitarViaje(){
  if(!(state.origen&&state.destino)){ alert('Eleg√≠ origen y destino'); return; }
  const distKm=state.routeKm||km(state.origen,state.destino), precio=calcFare(distKm,state.routeMin||0);
  const pago = (document.getElementById('payMethod')?.value)||'efectivo';
  const ref=await addDoc(collection(db,'requests'),{
    status:'buscando', pasajeroId:state.fbUser.uid,
    pasajeroNombre:(state.profile && state.profile.name) || state.fbUser.email,
    pasajeroFoto:(state.profile && state.profile.photoURL) || '',
    origen:state.origen, destino:state.destino, km:distKm, min:state.routeMin||0, precio, surge:state.surge||1.0,
    pago, createdAt:serverTimestamp()
  });
  state.activeRequestId=ref.id; lockPoints(true); setSearchingUI(true); watchActiveRequest(ref.id);
}
async function cancelarSolicitud(){ if(!state.activeRequestId){ alert('Sin viaje activo'); return; } await updateDoc(doc(db,'requests',state.activeRequestId),{status:'cancelado'}); }

/* ===== Overlay de solicitudes (CONDUCTOR) ===== */
function renderPendingOverlaySkeleton(){
  const box=$('#reqOverlay'); if(!box) return;
  box.style.display = (uiTab==='conductor' && driverOnline)?'block':'none';
  box.innerHTML='<div class="req-title">Solicitudes entrantes</div><div id="reqListO"></div>';
}
function renderPendingItemHtml({id,avatar,name,stars,count,kmv,minv,precio,pago,origen,destino}){
  return `
    <div class="req-item" data-id="${id}">
      <img class="avatar" src="${avatar}" alt="avatar"/>
      <div>
        <div style="font-weight:600">${name}</div>
        <div class="meta">${stars} <span class="chip" style="margin-left:.35rem">${count} ops</span></div>
        <div class="meta" style="margin-top:.25rem">${kmv.toFixed(2)} km ‚Ä¢ ${minv} min ‚Ä¢ <b>${fmt(precio)}</b></div>
        <div class="req-pay">Pago: ${pago==='mp'?'Mercado Pago':'Efectivo'}</div>
      </div>
      <div class="req-actions">
        <button class="btn primary" data-acc="${id}" type="button">Aceptar</button>
      </div>
      <div style="grid-column:1/-1;margin-top:.35rem" class="meta">
        <span class="chip">Ori: ${origen.lat.toFixed(4)}, ${origen.lng.toFixed(4)}</span>
        <span class="chip">Des: ${destino.lat.toFixed(4)}, ${destino.lng.toFixed(4)}</span>
      </div>
    </div>`;
}
function renderActiveOverlayHtml(r){
  const name=r.pasajeroNombre||'Pasajero';
  const avatar = r.pasajeroFoto || ('https://api.dicebear.com/9.x/initials/svg?seed='+encodeURIComponent(name));
  const pagoTxt = r.pago==='mp'?'Mercado Pago':'Efectivo';
  const btn = (r.status==='aceptado') ? 
      `<button class="btn primary" id="btnStartTrip" type="button">Empezar viaje</button>` :
      `<button class="btn primary" id="btnFinishTrip" type="button">Terminar viaje</button>`;
  return `
    <div class="req-compact">
      <div class="head">
        <img src="${avatar}" alt="avatar"/><div>
          <div style="font-weight:700">${name}</div>
          <div class="meta">${(r.km||0).toFixed(2)} km ‚Ä¢ ${r.min||0} min ‚Ä¢ <b>${fmt(r.precio||0)}</b></div>
          <div class="req-pay">Pago: ${pagoTxt}</div>
        </div>
      </div>
      <div class="meta">
        <span class="chip">Ori: ${(r.origen?.lat||0).toFixed(4)}, ${(r.origen?.lng||0).toFixed(4)}</span>
        <span class="chip">Des: ${(r.destino?.lat||0).toFixed(4)}, ${(r.destino?.lng||0).toFixed(4)}</span>
      </div>
      <div class="row" style="justify-content:flex-end">${btn}</div>
    </div>`;
}

/* Subcripci√≥n a pendientes: pinta en overlay sobre el mapa */
function subscribePendientes(){
  renderPendingOverlaySkeleton();
  if(listUnsub) listUnsub();
  const qRef=query(collection(db,'requests'),where('status','==','buscando'),orderBy('createdAt','desc'),limit(20));
  listUnsub=onSnapshot(qRef, async function(qs){
    const cont=$('#reqListO'); if(!cont) return; cont.innerHTML='';
    for(const docu of qs.docs){
      const r=docu.data(); const id=docu.id;
      let rating=0,count=0,name=r.pasajeroNombre||'Pasajero',avatar=r.pasajeroFoto||'';
      try{ const u=await getDoc(doc(db,'users',r.pasajeroId)); if(u.exists()){ const d=u.data(); rating=d.ratingCount?(d.ratingSum||0)/d.ratingCount:0; count=d.ratingCount||0; name=d.name||name; avatar=d.photoURL||avatar; } }catch(_){}
      let stars=''; for(let i=1;i<=5;i++) stars+='<span style="color:#fcd34d;opacity:'+(rating>=i?1:.35)+'">‚òÖ</span>';
      const avatarSrc = avatar || ('https://api.dicebear.com/9.x/initials/svg?seed='+encodeURIComponent(name));
      cont.insertAdjacentHTML('beforeend', renderPendingItemHtml({
        id, avatar:avatarSrc, name, stars, count,
        kmv:r.km||0, minv:r.min||0, precio:r.precio||0, pago:r.pago||'efectivo',
        origen:r.origen, destino:r.destino
      }));
    }
    // Attach accept handlers
    cont.querySelectorAll('button[data-acc]').forEach(btn=>{
      btn.addEventListener('click', ()=> aceptarViaje(btn.getAttribute('data-acc')));
    });
  });
}
function unsubscribePendientes(){ if(listUnsub){ listUnsub(); listUnsub=null; } const cont=$('#reqListO'); if(cont) cont.innerHTML=''; }

/* Aceptar / iniciar / finalizar */
async function aceptarViaje(id){ 
  if(!driverOnline || driverPaused){ alert('Ten√©s que estar Online.'); return; }
  await updateDoc(doc(db,'requests',id),{status:'aceptado',conductorId:state.fbUser.uid,conductorNombre:(state.profile && state.profile.name)||state.fbUser.email});
  state.activeRequestId=id; watchActiveRequest(id);
  const box=$('#reqOverlay'); if(box) box.innerHTML='<div class="req-title">Viaje aceptado</div>'+box.innerHTML;
}
async function iniciarTrayecto(){ if(!state.activeRequestId) { alert('Sin viaje activo'); return; } await updateDoc(doc(db,'requests',state.activeRequestId),{status:'en_curso'}); }
async function finalizarTrayecto(){ if(!state.activeRequestId) { alert('Sin viaje activo'); return; } await updateDoc(doc(db,'requests',state.activeRequestId),{status:'finalizado'}); }

/* Botones del overlay activo */
document.addEventListener('click',(e)=>{
  if(e.target && e.target.id==='btnStartTrip'){ iniciarTrayecto(); }
  if(e.target && e.target.id==='btnFinishTrip'){ finalizarTrayecto(); }
});

/* -------- Bloqueo de puntos -------- */
function lockPoints(lock){
  state.pointsLocked=lock;
  try{
    if(origenMarker?.dragging) (lock? origenMarker.dragging.disable() : origenMarker.dragging.enable());
    if(destinoMarker?.dragging) (lock? destinoMarker.dragging.disable() : destinoMarker.dragging.enable());
  }catch(_){}
}

/* -------- Seguimiento del conductor -------- */
function startDriverShare(){
  if(!navigator.geolocation){ alert('Geolocalizaci√≥n no disponible'); return; }
  if(driverWatchId) return;
  driverWatchId=navigator.geolocation.watchPosition(async function(pos){
    const p={lat:pos.coords.latitude,lng:pos.coords.longitude,ts:Date.now()};
    if(!state.activeRequestId){
      if(!driverMarker){ driverMarker=L.marker([p.lat,p.lng],{icon:L.divIcon({className:'',html:'<div style="background:#111827;border:2px solid #94a3b8;color:#fff;padding:2px 6px;border-radius:6px">üöñ</div>'})}).addTo(map).bindPopup('Conductor'); }
      else driverMarker.setLatLng([p.lat,p.lng]);
      if(followMe) map.setView([p.lat,p.lng],map.getZoom());
      return;
    }
    await setDoc(doc(db,'requests',state.activeRequestId,'driver','pos'),p);
    if(!driverMarker){ driverMarker=L.marker([p.lat,p.lng],{icon:L.divIcon({className:'',html:'<div style="background:#111827;border:2px solid #94a3b8;color:#fff;padding:2px 6px;border-radius:6px">üöñ</div>'})}).addTo(map).bindPopup('Conductor'); }
    else driverMarker.setLatLng([p.lat,p.lng]);
    if(followMe) map.setView([p.lat,p.lng],map.getZoom());
    const r=state.activeRequest;
    if(r){
      if(r.status==='aceptado' && r.origen){ ensureRouting().setWaypoints([L.latLng(p.lat,p.lng),L.latLng(r.origen.lat,r.origen.lng)]); }
      if(r.status==='en_curso' && r.destino){ ensureRouting().setWaypoints([L.latLng(p.lat,p.lng),L.latLng(r.destino.lat,r.destino.lng)]); }
    }
  }, function(err){ console.error(err); }, {enableHighAccuracy:true,maximumAge:2000,timeout:10000});
}
function stopDriverShare(){ if(driverWatchId){ navigator.geolocation.clearWatch(driverWatchId); driverWatchId=null; } }
function startDriverFollower(requestId){
  stopDriverFollower();
  driverUnsub=onSnapshot(doc(db,'requests',requestId,'driver','pos'), function(snap){
    if(!snap.exists()) return; const p=snap.data();
    if(!driverMarker){ driverMarker=L.marker([p.lat,p.lng],{icon:L.divIcon({className:'',html:'<div style="background:#111827;border:2px solid #94a3b8;color:#fff;padding:2px 6px;border-radius:6px">üöñ</div>'})}).addTo(map).bindPopup('Conductor'); }
    else driverMarker.setLatLng([p.lat,p.lng]);
    if(followMe) map.setView([p.lat,p.lng],map.getZoom());
  });
}
function stopDriverFollower(){ if(driverUnsub){ driverUnsub(); driverUnsub=null; } if(driverMarker){ map.removeLayer(driverMarker); driverMarker=null; } }

/* -------- Ganancias -------- */
function attachEarningsListener(){
  if(earningsUnsub) earningsUnsub();
  if(!state.fbUser) return;
  earningsUnsub=onSnapshot(query(collection(db,'requests'),where('conductorId','==',state.fbUser.uid),where('status','==','finalizado')), function(qs){
    let sum=0; qs.forEach(function(d){ sum += Number(d.data().precio||0); });
    const e=$('#drvEarn'); if(e) e.textContent=fmt(sum);
  });
}

/* -------- Auth state -------- */
onAuthStateChanged(auth, async (user)=>{
  state.fbUser=user||null;
  if(user){
    if(userUnsub) userUnsub();
    const uref=doc(db,'users',user.uid);
    userUnsub=onSnapshot(uref,async (snap)=>{
      if(!snap.exists()){
        await setDoc(uref,{name:user.displayName||'',email:user.email||'',photoURL:user.photoURL||'',ratingSum:0,ratingCount:0,createdAt:serverTimestamp()});
        state.profile={name:user.displayName||'',email:user.email||'',photoURL:user.photoURL||'',ratingSum:0,ratingCount:0};
      }else{
        state.profile=snap.data();
      }
      $('#gate').style.display='none';
      $('#app').style.display='grid';
      if(!map) initMap();
      setTimeout(()=>{ if(map) map.invalidateSize(); },200);
      renderTabs(); renderSide(); updateRoleUI();
    });
  }else{
    $('#app').style.display='none';
    $('#gate').style.display='grid';
    state.profile=null; state.activeRequestId=null; state.activeRequest=null; lockPoints(false);
    setSearchingUI(false); stopDriverFollower(); stopDriverShare(); stopDriverTimer();
    driverOnline=false; driverPaused=false; updateDriverHeader();
    if(activeReqUnsub){ activeReqUnsub(); activeReqUnsub=null; }
    if(chatUnsub){ chatUnsub(); chatUnsub=null; }
    if(listUnsub){ listUnsub(); listUnsub=null; }
    if(earningsUnsub){ earningsUnsub(); earningsUnsub=null; }
    if(userUnsub){ userUnsub(); userUnsub=null; }
  }
});

/* -------- Eventos de UI -------- */
function clearRegForm(){ const f=$('#regPhoto'); if(f) f.value=''; const p=$('#regPreview'); if(p) p.src=''; ['regName','regEmail','regPass','regPass2'].forEach(id=>{ const el=$('#'+id); if(el) el.value=''; }); setText($('#regErr'),''); }
document.addEventListener('click', async (e)=>{
  const id = e.target?.id || '';
  if(id==='showReg'){ $('#regCard').style.display='block'; return; }
  if(id==='btnCancelReg'){ $('#regCard').style.display='none'; clearRegForm(); return; }
  if(id==='btnLogin'){
    setText($('#loginErr'),'');
    const email=$('#inEmail')?.value?.trim()||''; const pass=$('#inPass')?.value||'';
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ setText($('#loginErr'),'Email inv√°lido'); return; }
    if(!pass){ setText($('#loginErr'),'Ingres√° tu contrase√±a'); return; }
    e.target.disabled=true; e.target.textContent='Entrando‚Ä¶';
    try{ await setupPersistence(); await signInWithEmailAndPassword(auth,email,pass); }
    catch(err){ setText($('#loginErr'), mapAuthError(err)); e.target.disabled=false; e.target.textContent='Entrar'; }
    return;
  }
  if(id==='btnReg'){
    setText($('#regErr'),'');
    const name=$('#regName')?.value?.trim()||'', email=$('#regEmail')?.value?.trim()||'';
    const pass=$('#regPass')?.value||'', pass2=$('#regPass2')?.value||''; const file=$('#regPhoto')?.files?.[0]||null;
    if(!name){ setText($('#regErr'),'Ingres√° tu nombre'); return; }
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ setText($('#regErr'),'Email inv√°lido'); return; }
    if(pass.length<6){ setText($('#regErr'),'La contrase√±a debe tener al menos 6 caracteres'); return; }
    if(pass!==pass2){ setText($('#regErr'),'Las contrase√±as no coinciden'); return; }
    const btn=e.target; btn.disabled=true; btn.textContent='Creando‚Ä¶';
    try{
      await setupPersistence();
      const cred=await createUserWithEmailAndPassword(auth,email,pass);
      let photoURL='';
      if(file){ try{ const path='avatars/'+cred.user.uid+'.jpg'; await uploadBytes(sRef(storage,path),file); photoURL=await getDownloadURL(sRef(storage,path)); }catch(upErr){ console.warn('Upload avatar fall√≥:', upErr); } }
      try{ await updateProfile(cred.user,{displayName:name,photoURL:photoURL||null}); }catch(_){}
      await setDoc(doc(db,'users',cred.user.uid),{name,email,photoURL:photoURL||'',ratingSum:0,ratingCount:0,createdAt:serverTimestamp()});
      $('#regCard').style.display='none'; clearRegForm();
    }catch(err){ setText($('#regErr'), mapAuthError(err)); btn.disabled=false; btn.textContent='Crear cuenta'; }
    return;
  }

  /* Pasajero */
  if(id==='btnMiUbicacion'){ if(uiTab!=='pasajero') return; miUbicacionComoOrigen(); return; }
  if(id==='btnLimpiar'){ if(uiTab!=='pasajero') return; limpiar(); return; }
  if(id==='btnSolicitar'){ if(uiTab!=='pasajero') return; solicitarViaje(); return; }
  if(id==='btnCancelReqTop'){ if(uiTab!=='pasajero') return; cancelarSolicitud(); return; }
  if(id==='modeOrigen'){ if(uiTab!=='pasajero') return; if(state.pointsLocked){ alert('Bloqueado por viaje activo'); return; } selectMode='origen'; $('#modeOrigen').setAttribute('aria-pressed','true'); $('#modeDestino').setAttribute('aria-pressed','false'); return; }
  if(id==='modeDestino'){ if(uiTab!=='pasajero') return; if(state.pointsLocked){ alert('Bloqueado por viaje activo'); return; } selectMode='destino'; $('#modeDestino').setAttribute('aria-pressed','true'); $('#modeOrigen').setAttribute('aria-pressed','false'); return; }

  /* Conductor */
  if(id==='btnDrvStart'){ if(uiTab!=='conductor') return; driverStart(); return; }
  if(id==='btnDrvPause'){ if(uiTab!=='conductor') return; driverPauseToggle(); return; }
  if(id==='btnDrvFinish'){ if(uiTab!=='conductor') return; driverFinish(); return; }

  /* Chat */
  if(id==='chatSend'){ sendChat(); return; }
});

/* Enter para login/registro */
['inEmail','inPass','regName','regEmail','regPass','regPass2'].forEach(id=>{
  const el=document.getElementById(id);
  if(el){ el.addEventListener('keydown', (ev)=>{
    if(ev.key==='Enter'){
      if(id.startsWith('reg')) document.getElementById('btnReg').click();
      else document.getElementById('btnLogin').click();
    }
  });}
});

/* Preview foto */
document.addEventListener('change',(e)=>{
  if(e.target && e.target.id==='regPhoto'){
    const f=e.target.files && e.target.files[0]; const prev=$('#regPreview');
    if(!prev) return;
    if(!f){ prev.src=''; return; }
    const r=new FileReader(); r.onload=function(){ prev.src=r.result; }; r.readAsDataURL(f);
  }
});

/* -------- Boot simple -------- */
document.addEventListener('DOMContentLoaded', function(){
  const bad=(location.protocol!=='http:' && location.protocol!=='https:');
  const warn=document.getElementById('envWarn'); if(warn) warn.style.display = bad ? 'block':'none';
});
</script>
</body>
</html>
