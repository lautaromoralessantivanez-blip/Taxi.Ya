<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Taxi Ya ‚Äî Firebase</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Routing Machine + OSRM -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{ --bg:#0e1218; --panel:#121923; --ink:#0d1219; --muted:#4b5b6f; --line:#d8dee7; --accent:#ffbf1a; --ok:#22c55e; --danger:#ef4444; --chip:#eef2f7; --card:#f7f9fc; --celeste:#38bdf8;}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#f3f6fb,#eef3f9 60%,#eaf1f9);color:var(--ink);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial}
button,input,select{font-family:inherit}

/* AUTH */
#gate{position:fixed; inset:0; display:grid; place-items:start center; background:radial-gradient(1200px 800px at 50% -10%,#eaf1f9 0%, #eef3f9 60%, #f7f9fc 100%); z-index:100; overflow-y:auto; padding:16px; min-height:100svh;}
.gate-card{ width:min(720px,100%); background:#fff; border:1px solid #e5eaf1; border-radius:16px; padding:1rem; margin:12px 0 24px; box-shadow:0 6px 30px rgba(16,24,40,.06); }
.gate-title{display:flex;align-items:center;gap:.6rem;margin:.25rem 0 .4rem}
.gate-title .dot{width:.9rem;height:.9rem;border-radius:999px;background:var(--accent);box-shadow:0 0 16px rgba(255,191,26,.7)}
.gate-tabs{display:flex;gap:.4rem;margin:.25rem 0 .6rem}
.gate-tab{padding:.35rem .6rem;border:1px solid #e5eaf1;border-radius:999px;background:#fff;cursor:pointer}
.gate-tab[aria-selected="true"]{background:var(--accent);border-color:#e0a600}
.grid{display:grid;gap:.75rem}
.field{display:grid;gap:.35rem}
.label{font-size:.9rem;color:#5b6b7f}
.input, select.input{ width:100%; background:#ffffff; border:1px solid #d8dee7; color:var(--ink); padding:.65rem .75rem; border-radius:12px; font-size:16px; line-height:1.2;}
.btn{ display:inline-flex; align-items:center; gap:.5rem; border:1px solid #d8dee7; background:#ffffff; color:#0f172a; padding:.65rem 1rem; border-radius:12px; cursor:pointer; transition:.2s; text-decoration:none; font-size:16px; }
.btn:hover{box-shadow:0 2px 10px rgba(16,24,40,.06)}
.btn.primary{background:var(--accent);color:#111;border-color:#e0a600}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.err{color:#b42318}
.preview{width:72px;height:72px;border-radius:50%;border:1px solid #d8dee7;object-fit:cover;background:#f1f5f9}

/* APP */
.app{min-height:100dvh;display:grid;grid-template-rows:auto 1fr}
.header{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid #e5eaf1;background:rgba(255,255,255,.7);backdrop-filter:blur(12px);position:sticky;top:0;z-index:20}
.brand{display:flex;align-items:center;gap:.6rem}
.brand .dot{width:.9rem;height:.9rem;border-radius:999px;background:var(--accent);box-shadow:0 0 16px rgba(255,191,26,.7)}
.tabs{display:flex;gap:.35rem;flex-wrap:wrap}
.tab{padding:.45rem .75rem;border:1px solid #d8dee7;border-radius:999px;background:#ffffff;color:#0f172a;opacity:.9;cursor:pointer;transition:.2s;display:inline-flex;gap:.4rem;align-items:center}
.tab[aria-selected="true"]{background:var(--accent);color:#111;opacity:1;border-color:#e0a600}
.badge{min-width:18px;height:18px;border-radius:999px;background:#ef4444;color:#fff;display:inline-grid;place-items:center;font-size:.72rem;padding:0 .35rem}
.container{display:grid;gap:1rem;padding:1rem;max-width:1500px;margin:0 auto}
.aside,.main{background:#ffffff;border:1px solid #e5eaf1;border-radius:16px;overflow:hidden}
.panel-head{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid #e5eaf1;background:#f7f9fc}
.panel-body{padding:1rem;display:flex;flex-direction:column;gap:.75rem;min-height:calc(100dvh - 140px)}
.card{background:#ffffff;border:1px solid #e5eaf1;border-radius:14px;padding:1rem}
.row{display:flex;gap:.6rem;align-items:center}
.row.wrap{flex-wrap:wrap}
.chip{background:#f3f6fb;border:1px solid #e5eaf1;padding:.35rem .6rem;border-radius:999px;font-size:.85rem;color:#334155}
.help{color:#64748b;font-size:.86rem}
.status-bar{order:50;display:none;align-items:center;gap:.6rem;background:#f3f6fb;border:1px solid #e5eaf1;padding:.55rem .75rem;border-radius:10px;font-weight:600}
.map-wrap{order:1;position:relative;display:grid;grid-template-columns:1fr;width:100%}
#map{width:100%;min-width:100%;height:72vh;min-height:520px}
.leaflet-container{background:#eef3f9}

/* Driver */
.dock{order:2; display:none; background:#ffffff; border:1px solid #e5eaf1; border-radius:16px; padding:.75rem; max-height:72vh; overflow:auto;}
.dock .title{font-weight:800;margin:.2rem 0 .6rem 0}

/* Chat */
.chat-mini{order:98}
.chatlog{display:flex;flex-direction:column;gap:.25rem}
.msg{display:inline-block;max-width:70%;background:#f3f6fb;border:1px solid #e5eaf1;padding:.45rem .6rem;border-radius:10px;margin:.05rem 0;font-size:.92rem}
.msg.me{align-self:flex-end;background:#e9f5ff;border-color:#cfe0ff}
.msg.other{align-self:flex-start}

/* O/D */
.od-grid{ display:grid; gap:.75rem; grid-template-columns:1fr auto 1fr; align-items:end; }
@media (max-width:860px){ .od-grid{ grid-template-columns:1fr; } }
.pick-stack{display:flex;align-items:center;gap:.4rem;justify-content:center}
.pick-btn{height:42px;min-width:42px;border-radius:10px;border:1px solid #e5eaf1;background:#fff;font-size:22px;line-height:1;display:grid;place-items:center;cursor:pointer}

.pick-menu{position:absolute;z-index:60;background:#fff;border:1px solid #e5eaf1;border-radius:10px;box-shadow:0 6px 24px rgba(16,24,40,.08);padding:.4rem;display:none}
.pick-menu button{display:block;width:100%;text-align:left;border:0;background:#fff;padding:.45rem .6rem;border-radius:8px;cursor:pointer}
.pick-menu button:hover{background:#f7f9ff}

.mk{width:18px;height:18px;transform:translate(-50%,-50%);border:2px solid #0b1220;box-shadow:0 2px 8px rgba(0,0,0,.25)}
.mk-circle{border-radius:999px;background:var(--celeste)}
.mk-square{border-radius:4px;background:var(--celeste)}

/* Perfil */
.pf-card{ background:#fff; border:1px solid #e5eaf1; border-radius:16px; padding:1rem; }
.pf-grid{ display:grid; grid-template-columns:140px 1fr; gap:1rem; align-items:start; }
@media (max-width:720px){ .pf-grid{ grid-template-columns:1fr; } }
.pf-avatar{ width:120px;height:120px;border-radius:16px;border:1px solid #e5eaf1;object-fit:cover;background:#f1f5f9; }
.pf-head{ display:flex; align-items:center; gap:.6rem; flex-wrap:wrap; }
.pf-name{ margin:.1rem 0 .25rem 0; font-size:1.35rem; font-weight:800; }
.pf-email{ background:#f3f6fb;border:1px solid #e5eaf1;border-radius:999px;padding:.2rem .55rem;font-size:.9rem;color:#334155 }
.stars{ display:inline-flex; gap:2px; vertical-align:middle }
.star{ width:18px;height:18px; display:inline-block; mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.43 8.2 1.192-5.934 5.787 1.401 8.168L12 18.896l-7.335 3.868 1.401-8.168L.132 9.209l8.2-1.192z"/></svg>') center/contain no-repeat; background:#cbd5e1; }
.star.filled{ background:#fbbf24; }
.pf-row{ display:grid; gap:.6rem; grid-template-columns:1fr 1fr; }
@media (max-width:720px){ .pf-row{ grid-template-columns:1fr; } }
.pf-actions{ display:flex; gap:.6rem; flex-wrap:wrap; }
.pf-note{ color:#64748b;font-size:.86rem }
.divider{height:1px;background:#e5eaf1;margin:.9rem 0}

.subtabs{display:flex;gap:.35rem;margin:.25rem 0 .4rem}
.subtab{padding:.4rem .75rem;border:1px solid #e5eaf1;border-radius:999px;background:#fff;cursor:pointer}
.subtab[aria-selected="true"]{background:var(--accent);border-color:#e0a600}
.subpanel{display:none}
.subpanel[aria-hidden="false"]{display:block}

/* Uploader */
.doc-grid{display:grid;grid-template-columns:repeat(2,minmax(220px,1fr));gap:.75rem}
@media (max-width:720px){ .doc-grid{grid-template-columns:1fr} }
.doc{border:1px dashed #cbd5e1;border-radius:12px;padding:.75rem;background:#fafcff;transition:.15s}
.doc.ok{border-style:solid;border-color:#b7e4c7;background:#f0fff4}
.doc .status{font-size:.85rem;color:#475569}
.doc .thumb{width:42px;height:42px;border-radius:8px;border:1px solid #d8dee7;object-fit:cover;background:#f8fafc}

.search-overlay{position:fixed; inset:auto 16px 16px 16px; display:none; z-index:30}
.radar .pulse{border-radius:999px}
@keyframes pulse{0%{transform:scale(.2);opacity:.9}70%{opacity:.25}100%{transform:scale(1);opacity:0}}
.driver-toolbar{display:none}

/* Progress bar calificaci√≥n */
.progress{height:10px;background:#eef2f7;border:1px solid #e5eaf1;border-radius:999px;overflow:hidden}
.progress > span{display:block;height:100%;background:#fbbf24}
</style>
</head>
<body>

<!-- AUTH -->
<div id="gate" aria-hidden="false">
  <div class="gate-card">
    <div class="gate-title"><span class="dot"></span><b>Taxi Ya</b></div>

    <div id="envWarn" class="err" style="display:none;margin-bottom:.75rem">
      ‚ö†Ô∏è Abr√≠ el sitio con <b>http://localhost</b> (no <code>file://</code>).
    </div>

    <div class="gate-tabs">
      <button id="tabLogin"  class="gate-tab" aria-selected="true">Iniciar sesi√≥n</button>
      <button id="tabReg"    class="gate-tab" aria-selected="false">Crear cuenta</button>
      <button id="btnWipe"   class="gate-tab" style="margin-left:auto;background:#fff3f3;border-color:#f3caca">Borrar datos locales</button>
    </div>

    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <div class="grid">
        <div class="field"><label class="label">Email</label><input id="inEmail" type="email" class="input" placeholder="tu@email.com" autocomplete="email"></div>
        <div class="field"><label class="label">Contrase√±a</label><input id="inPass" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
        <div class="row" style="gap:.6rem;flex-wrap:wrap">
          <button class="btn primary" id="btnLogin" type="button">Entrar</button>
        </div>
        <div id="loginErr" class="err" role="alert"></div>
      </div>
    </div>

    <!-- REGISTRO -->
    <div id="regCard" class="card" style="display:none;margin-top:.6rem">
      <h3 style="margin:0 0 .5rem 0">Crear cuenta</h3>
      <div class="row" style="gap:1rem;align-items:flex-end;flex-wrap:wrap">
        <div class="field" style="align-items:center">
          <img id="regPreview" class="preview" src="" alt="foto"/>
          <label class="label" style="margin-top:.35rem">Foto de perfil (opcional)</label>
          <input id="regPhoto" type="file" accept="image/*" class="input" style="padding:.45rem"/>
        </div>
        <div class="field" style="flex:1"><label class="label">Nombre</label><input id="regName" class="input" placeholder="Ana, Mauro‚Ä¶"></div>
      </div>
      <div class="grid">
        <div class="field"><label class="label">Email</label><input id="regEmail" type="email" class="input" placeholder="tu@email.com" autocomplete="email"></div>
        <div class="field"><label class="label">Contrase√±a</label><input id="regPass" type="password" class="input" placeholder="m√≠n. 6 caracteres" autocomplete="new-password"></div>
        <div class="field"><label class="label">Repetir contrase√±a</label><input id="regPass2" type="password" class="input" placeholder="repite la contrase√±a" autocomplete="new-password"></div>
      </div>
      <div class="row" style="margin-top:.6rem;gap:.6rem;flex-wrap:wrap;padding-bottom:8px">
        <button class="btn" id="btnCancelReg" type="button">Volver al login</button>
        <button class="btn primary" id="btnReg" type="button">Crear cuenta</button>
      </div>
      <div id="regErr" class="err" role="alert"></div>
    </div>

    <div id="fatal" class="err" style="display:none;margin-top:10px" role="alert"></div>
  </div>
</div>

<!-- APP -->
<div class="app" id="app" style="display:none">
  <header class="header">
    <div class="brand"><span class="dot"></span><b>Taxi Ya</b><span class="chip" id="statusChip">offline</span></div>
    <nav class="tabs" id="tabs"></nav>
  </header>

  <div class="container" id="container">
    <main class="main">
      <div class="panel-head">
        <strong id="mainTitle">Mapa</strong>
        <div class="row" style="gap:.4rem">
          <span class="chip" id="roleChip">Rol: <b>Pasajero</b></span>
          <button class="btn" id="btnLogout" title="Cerrar sesi√≥n">Salir</button>
        </div>
      </div>

      <div class="panel-body">
        <section id="passengerUI">
          <div class="od-grid">
            <div class="field">
              <label class="label">Origen</label>
              <input id="inOrigin" class="input" placeholder="Eleg√≠ un punto de partida" readonly>
            </div>
            <div class="pick-stack">
              <button class="pick-btn" id="btnPickOrigin" title="Elegir Origen">‚¶ø</button>
              <button class="pick-btn" id="btnLocate" title="Usar mi ubicaci√≥n">üìç</button>
              <button class="pick-btn" id="btnSwap" title="Intercambiar">‚áÑ</button>
            </div>
            <div class="field">
              <label class="label">Destino</label>
              <input id="inDest" class="input" placeholder="Eleg√≠ un destino" readonly>
            </div>
          </div>

          <div class="row wrap" style="justify-content:space-between">
            <div class="row" style="gap:.5rem;flex-wrap:wrap">
              <div class="field">
                <label class="label">M√©todo de pago</label>
                <select id="payMethod" class="input" style="min-width:160px">
                  <option value="efectivo" selected>Efectivo</option>
                  <option value="mp">Mercado Pago</option>
                </select>
              </div>
            </div>
            <div class="row" style="gap:.5rem;flex-wrap:wrap">
              <button class="btn" id="btnClear" type="button">Limpiar</button>
              <button class="btn primary" id="btnRequest" disabled>Solicitar viaje</button>
            </div>
          </div>

          <div id="quoteBar" class="status-bar" style="display:none"></div>
          <div id="passengerStatus" class="status-bar"></div>
        </section>

        <section class="map-wrap"><div id="map"></div></section>

        <section class="card driver-toolbar" id="driverToolbar">
          <div class="row wrap" style="justify-content:space-between;align-items:center">
            <div class="row" style="gap:.5rem">
              <button class="btn primary" id="btnDrvStart" type="button">Iniciar</button>
              <button class="btn" id="btnDrvPause" type="button">Pausar</button>
              <button class="btn" id="btnDrvBegin" type="button" style="display:none">Comenzar viaje</button>
              <button class="btn" id="btnDrvFinish" type="button">Finalizar</button>
              <button class="btn" id="btnUbicarme" type="button">Ubicarme</button>
            </div>
            <div class="row" id="drvStats" style="gap:.5rem">
              <span class="chip">‚è± <b id="drvTime">00:00:00</b></span>
              <span class="chip">üíµ <b id="drvMoney">$ 0</b></span>
            </div>
          </div>
          <div class="help">‚ÄúComenzar viaje‚Äù aparece despu√©s de aceptar un viaje.</div>
        </section>

        <section class="dock" id="driverDock">
          <div class="title">Solicitudes disponibles <span class="badge" id="rqCount">0</span></div>
          <div id="rqList" class="grid"></div>
        </section>

        <section class="chat-mini" id="chatMini" style="display:none">
          <div class="panel-head" style="border-radius:12px"><b>Estado</b></div>
          <div class="panel-body" style="gap:.35rem">
            <div class="chatlog" id="chatLog"></div>
          </div>
        </section>
      </div>
    </main>

    <!-- PERFIL -->
    <aside class="aside" id="profile" style="display:none">
      <div class="panel-head"><strong>Perfil</strong></div>
      <div class="panel-body">
        <div class="pf-card">
          <div class="pf-grid">
            <img id="pfAvatar" class="pf-avatar" alt="avatar">
            <div>
              <div class="pf-head">
                <div class="pf-name" id="pfName">‚Äî</div>
                <span class="pf-email" id="pfEmail">‚Äî</span>
              </div>
              <div>
                <span class="stars" id="pfStars"></span>
                <small class="pf-note">Promedio (demo)</small>
              </div>
              <div class="pf-actions" style="margin-top:.5rem">
                <button class="btn" id="btnSwitchRole">Cambiar a Conductor</button>
                <button class="btn" id="btnEditName">Editar nombre</button>
              </div>
            </div>
          </div>
        </div>

        <div class="subtabs">
          <button class="subtab" data-sub="datos" aria-selected="true">Datos</button>
          <button class="subtab" data-sub="conductor" aria-selected="false">Hacerme conductor</button>
          <button class="subtab" data-sub="calif" aria-selected="false">Calificaci√≥n</button>
        </div>

        <div class="subpanel" id="sub-datos" aria-hidden="false">
          <div class="pf-card">
            <div class="pf-row">
              <div class="field"><label class="label">Nombre</label><input id="pfNameEdit" class="input" placeholder="Tu nombre"></div>
              <div class="field"><label class="label">Tel√©fono</label><input id="pfPhoneEdit" class="input" placeholder="+54 9 ..."></div>
            </div>
            <div class="pf-actions" style="margin-top:.6rem">
              <button class="btn primary" id="btnSaveProfile">Guardar</button>
            </div>
          </div>
        </div>

        <div class="subpanel" id="sub-conductor" aria-hidden="true">
          <div class="pf-card">
            <h3 style="margin:.2rem 0 .6rem 0">Documentaci√≥n</h3>
            <div class="doc-grid" id="docsGrid"></div>
            <div class="pf-actions" style="margin-top:.6rem;gap:.6rem;flex-wrap:wrap">
              <button class="btn primary" id="btnSendReview">Enviar a revisi√≥n</button>
              <button class="btn" id="btnApproveDemo">Habilitarme como conductor (demo)</button>
              <span class="help" id="driverDocHint">Sub√≠ todo para habilitar</span>
            </div>
          </div>
        </div>

        <div class="subpanel" id="sub-calif" aria-hidden="true">
          <div class="pf-card">
            <h3 style="margin:.2rem 0 .6rem 0">Progreso & Trofeos</h3>
            <div class="row wrap" id="trophies"></div>
            <div class="divider"></div>
            <div class="row" style="align-items:center;gap:1rem">
              <div style="min-width:120px">Objetivo 5‚≠ê</div>
              <div class="progress" style="flex:1"><span id="progBar" style="width:0%"></span></div>
              <div id="progPct" style="min-width:44px;text-align:right">0%</div>
            </div>
          </div>
        </div>

      </div>
    </aside>
  </div>
</div>

<!-- MEN√öS flotantes -->
<div id="menuOrigin" class="pick-menu">
  <button data-action="map-origin">Elegir en mapa</button>
  <button data-action="geo">Usar mi ubicaci√≥n</button>
  <button data-action="clear-origin">Limpiar origen</button>
</div>
<div id="menuDest" class="pick-menu">
  <button data-action="map-dest">Elegir en mapa</button>
  <button data-action="swap">Intercambiar O/D</button>
  <button data-action="clear-dest">Limpiar destino</button>
</div>

<!-- Overlay -->
<div id="searchOverlay" class="search-overlay" style="display:none; place-items:center; gap:1rem; padding:1.25rem; background:#fff; border:1px solid #e5eaf1; border-radius:14px;">
  <div class="search-title" style="font-weight:800;font-size:1.05rem">Buscando auto‚Ä¶</div>
  <div class="radar" style="position:relative;width:180px;height:180px;border-radius:999px;display:grid;place-items:center;background:radial-gradient(circle at center, rgba(59,130,246,.08) 0%, rgba(59,130,246,.02) 60%, transparent 70%);border:1px solid #cfe0ff; overflow:hidden;">
    <div class="pulse p1" style="position:absolute;inset:0;border:2px solid rgba(59,130,246,.25);animation:pulse 2.2s linear infinite"></div>
    <div class="pulse p2" style="position:absolute;inset:0;border:2px solid rgba(59,130,246,.25);animation:pulse 2.2s linear .6s infinite"></div>
    <div class="pulse p3" style="position:absolute;inset:0;border:2px solid rgba(59,130,246,.25);animation:pulse 2.2s linear 1.2s infinite"></div>
    <div class="car" style="position:relative; z-index:2; font-size:40px; line-height:1;">üöñ</div>
  </div>
  <div class="wait" style="font-weight:600; display:flex; gap:.5rem; align-items:center; justify-content:center;">Espera: <span id="ovTimer">00:00</span></div>
  <div class="search-actions"><button class="btn" id="btnCancelOverlay" type="button">Cancelar</button></div>
  <div class="help">Avisando a conductores cercanos. No cierres la pesta√±a.</div>
</div>

<!-- Firebase (solo Firestore para requests) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, onSnapshot, query, where, orderBy, serverTimestamp, runTransaction, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBu523IOGnIZGfAkdlLdVLcENwLgv5KU9o",
    authDomain: "taxi-ya-3be33.firebaseapp.com",
    projectId: "taxi-ya-3be33",
    storageBucket: "taxi-ya-3be33.appspot.com",
    messagingSenderId: "31840475169",
    appId: "1:31840475169:web:1485e47b9ebea4a66c6b60",
    measurementId: "G-2RQRP1G2KB"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.__fb = {
    db,
    api: {
      addRequest: async (rq) => {
        const ref = await addDoc(collection(db, "requests"), { ...rq, status:"open", createdAt: serverTimestamp() });
        return ref.id;
      },
      listenOpenRequests: (cb) => {
        const qOpen = query(collection(db, "requests"), where("status","==","open"), orderBy("createdAt","desc"));
        return onSnapshot(qOpen, (snap)=> cb(snap.docs.map(d=>({id:d.id, ...d.data()})))); // lista
      },
      acceptRequestTxn: async (requestId, driverId) => {
        const ref = doc(db, "requests", requestId);
        await runTransaction(db, async (tx)=>{
          const snap = await tx.get(ref);
          if(!snap.exists()) throw new Error("La solicitud no existe");
          const data = snap.data();
          if(data.status !== "open") throw new Error("Ya fue tomada o cerrada");
          tx.update(ref, { status:"taken", driverId, takenAt:serverTimestamp() });
        });
      },
      finishRequest: async (requestId) => {
        await updateDoc(doc(db, "requests", requestId), { status:"finished", finishedAt:serverTimestamp() });
      },
      listenRequest: (id, cb) => {
        const ref = doc(db, "requests", id);
        return onSnapshot(ref, (snap)=>{ if(snap.exists()) cb({id:snap.id, ...snap.data()}); });
      },
      getRequest: async (id) => {
        const ref = doc(db, "requests", id);
        const s = await getDoc(ref);
        return s.exists()? {id:s.id, ...s.data()} : null;
      }
    }
  };
</script>

<!-- APP l√≥gica -->
<script type="module">
/* ===== Utils y storage local (auth local) ===== */
const Storage = {
  get(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } },
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)) },
  setRaw(k, raw){ localStorage.setItem(k, raw) }
};
const $  = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
async function compressDataURL(dataUrl, maxSide=256, quality=0.7){
  try{
    const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataUrl });
    const scale = Math.min(1, maxSide/Math.max(img.width,img.height));
    const w = Math.max(1, Math.round(img.width*scale));
    const h = Math.max(1, Math.round(img.height*scale));
    const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
    canvas.getContext('2d').drawImage(img,0,0,w,h);
    return canvas.toDataURL('image/jpeg', quality);
  }catch{ return dataUrl }
}
async function blobToDataURL(blob){ return await new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(blob); }) }

/* ===== Claves ===== */
const USERS_KEY='taxi_users', SESSION_KEY='taxi_session', DOCS_KEY=uid=>`taxi_driver_docs_${uid}`, PHOTO_KEY=uid=>`taxi_photo_${uid}`;
const DRIVER_STATUS = uid=>`taxi_driver_status_${uid}`; // 'none'|'pending'|'approved'

/* ===== Estado ===== */
let currentUser=null, role='passenger';
function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36) }
function isDriverApproved(){ const st = localStorage.getItem(DRIVER_STATUS(currentUser?.uid||''))||'none'; return st==='approved' }
function setDriverStatus(v){ localStorage.setItem(DRIVER_STATUS(currentUser.uid), v) }

/* ===== Auth local ===== */
function signIn(email, pass){
  const users = Storage.get(USERS_KEY, []);
  const u = users.find(x=>x.email===email && x.pass===pass);
  if(!u) throw new Error('Email o contrase√±a incorrectos.');
  localStorage.setItem(SESSION_KEY, u.uid);
  return u;
}
async function signUp({name,email,pass,photoDataUrl}){
  const users = Storage.get(USERS_KEY, []);
  if(users.some(x=>x.email===email)){ throw new Error('Ese email ya est√° registrado.') }
  const id = uid();
  const user = {uid:id, name:name||'Sin nombre', email, pass, phone:'', photoKey: PHOTO_KEY(id)};
  users.push(user); Storage.set(USERS_KEY, users);
  if(photoDataUrl){ const tiny = await compressDataURL(photoDataUrl,256,.7); Storage.setRaw(PHOTO_KEY(id), tiny) }
  localStorage.setItem(SESSION_KEY, id);
  return user;
}
function getSessionUser(){
  const id=localStorage.getItem(SESSION_KEY); if(!id) return null;
  const users=Storage.get(USERS_KEY,[]); return users.find(u=>u.uid===id)||null;
}
function updateUser(partial){
  const users=Storage.get(USERS_KEY,[]);
  const i=users.findIndex(u=>u.uid===currentUser.uid);
  if(i>=0){ users[i]={...users[i],...partial}; Storage.set(USERS_KEY,users); currentUser=users[i] }
}
function logout(){ localStorage.removeItem(SESSION_KEY); location.reload() }

/* ===== UI b√°sicos ===== */
const tabsEl=$('#tabs'), roleChip=$('#roleChip'), statusChip=$('#statusChip'), mainTitle=$('#mainTitle');
const passengerUI=$('#passengerUI'), driverDock=$('#driverDock'), driverToolbar=$('#driverToolbar');

function renderTabs(){
  tabsEl.innerHTML='';
  const baseTabs=[{id:'tab-pass', label:'Pasajero', onClick:()=>setRole('passenger')}];
  if(isDriverApproved()) baseTabs.push({id:'tab-driver', label:'Conductor', onClick:()=>setRole('driver'), badge:()=>`<span class="badge" id="rqBadge">0</span>`});
  baseTabs.push({id:'tab-profile', label:'Perfil', onClick:()=>showProfile()});
  baseTabs.forEach(t=>{
    const b=document.createElement('button');
    b.className='tab'; b.id=t.id; b.innerHTML=t.label+(t.badge?` ${t.badge()}`:'');
    b.setAttribute('aria-selected', (t.id=== (role==='passenger'?'tab-pass':role==='driver'?'tab-driver':'tab-profile'))?'true':'false');
    b.onclick=()=>{ t.onClick(); highlightTab(t.id) };
    tabsEl.appendChild(b);
  });
}
function highlightTab(id){ $$('#tabs .tab').forEach(b=>b.setAttribute('aria-selected', b.id===id?'true':'false')) }

let __unsubOpen=null;
function setRole(newRole){
  if(newRole==='driver' && !isDriverApproved()){ alert('A√∫n no est√°s habilitado como conductor. Ve a Perfil ‚Üí Hacerme conductor.'); return; }
  role=newRole;
  roleChip.innerHTML=`Rol: <b>${role==='passenger'?'Pasajero':'Conductor'}</b>`;
  mainTitle.textContent= role==='passenger'?'Mapa':'Panel de conductor';
  if(role==='passenger'){
    passengerUI.style.display='block'; driverDock.style.display='none'; driverToolbar.style.display='none';
    if(__unsubOpen){__unsubOpen();__unsubOpen=null;}
  } else {
    passengerUI.style.display='none'; driverDock.style.display='block'; driverToolbar.style.display='block';
    startDriverListener();
  }
  $('.main').style.display='block'; $('#profile').style.display='none';
  renderTabs();
}

/* ===== Mapa / Ruta ===== */
let map, routing, originMarker, destMarker;
let originLatLng=null, destLatLng=null;
let lastQuote=null;

const PRICING={ base:300, perKm:250, perMin:50, minimum:1200, surge:1.0 };
const fmtMoney=n=>'$ '+(Math.round(n)).toLocaleString('es-AR');

function initMap(){
  map=L.map('map').setView([-31.5375,-68.5364],13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
  map.on('click',e=>{ if(pendingPick==='origin') setOrigin(e.latlng); else if(pendingPick==='dest') setDest(e.latlng); pendingPick=null; closeMenus(); });
  statusChip.textContent='online';
}
const mkDiv=cls=>L.divIcon({className:'', html:`<div class="mk ${cls}"></div>`, iconSize:[18,18], iconAnchor:[9,9]});
function setOrigin(latlng){
  originLatLng=latlng;
  if(!originMarker) originMarker=L.marker(latlng,{icon:mkDiv('mk-circle')}).addTo(map);
  originMarker.setLatLng(latlng);
  $('#inOrigin').value=`${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}`;
  tryFit(); checkRequestButton(); planRouteAndQuote();
}
function setDest(latlng){
  destLatLng=latlng;
  if(!destMarker) destMarker=L.marker(latlng,{icon:mkDiv('mk-square')}).addTo(map);
  destMarker.setLatLng(latlng);
  $('#inDest').value=`${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}`;
  tryFit(); checkRequestButton(); planRouteAndQuote();
}
function tryFit(){
  if(originLatLng&&destLatLng){ const g=L.featureGroup([originMarker,destMarker]); map.fitBounds(g.getBounds().pad(0.3)); }
  else if(originLatLng){ map.setView(originLatLng,15) }
  else if(destLatLng){ map.setView(destLatLng,15) }
}
function clearRoute(){ if(routing){ map.removeControl(routing); routing=null } lastQuote=null; showQuote(null); }
function drawRoute(a,b){
  clearRoute();
  routing=L.Routing.control({
    waypoints:[L.latLng(a.lat,a.lng),L.latLng(b.lat,b.lng)],
    router:L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1'}),
    addWaypoints:false, draggableWaypoints:false, fitSelectedRoutes:true, show:false,
    createMarker:()=>null,
    lineOptions:{styles:[{color:'#38bdf8',opacity:0.9,weight:5}]}
  }).addTo(map);
  routing.on('routesfound',e=>{
    const r=e.routes[0];
    const meters=r.summary.totalDistance||0, seconds=r.summary.totalTime||0;
    const fare=estimateFare(meters,seconds);
    lastQuote={meters,seconds,fare}; showQuote(lastQuote); checkRequestButton();
  });
}
function planRouteAndQuote(){ if(originLatLng&&destLatLng) drawRoute(originLatLng,destLatLng); }
function estimateFare(meters,seconds){
  const km=meters/1000, mins=Math.ceil(seconds/60);
  let total=PRICING.base + PRICING.perKm*km + PRICING.perMin*mins;
  total*=PRICING.surge; if(total<PRICING.minimum) total=PRICING.minimum; return total;
}
function showQuote(q){
  const bar=$('#quoteBar');
  if(!q){ bar.style.display='none'; bar.textContent=''; return; }
  const distKm=(q.meters/1000).toFixed(2), mins=Math.round(q.seconds/60);
  bar.style.display='flex';
  bar.innerHTML=`Distancia: <b>${distKm} km</b> ¬∑ Tiempo: <b>${mins} min</b> ¬∑ Estimado: <b>${fmtMoney(q.fare)}</b>`;
}

/* Fallback quote */
function fallbackQuote(a,b){
  const R=6371e3; const toRad=d=>d*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const s1=toRad(a.lat), s2=toRad(b.lat);
  const A=Math.sin(dLat/2)**2 + Math.cos(s1)*Math.cos(s2)*Math.sin(dLng/2)**2;
  const c=2*Math.atan2(Math.sqrt(A), Math.sqrt(1-A));
  const meters=R*c; const avgKmh=30; const seconds=Math.max(300,(meters/1000)/(avgKmh/60)*60);
  return {meters,seconds,fare:estimateFare(meters,seconds)};
}

/* Men√∫s O/D */
let pendingPick=null; const menuOrigin=$('#menuOrigin'), menuDest=$('#menuDest']);
function openMenu(menu, anchor){ const r=anchor.getBoundingClientRect(); menu.style.left=(r.left+window.scrollX)+'px'; menu.style.top=(r.bottom+6+window.scrollY)+'px'; menu.style.display='block'; setTimeout(()=>document.addEventListener('click',onDocClick,{once:true}),0) }
function onDocClick(e){ if(!menuOrigin.contains(e.target)&&!menuDest.contains(e.target)) closeMenus() }
function closeMenus(){ menuOrigin.style.display='none'; menuDest.style.display='none' }
$('#btnPickOrigin').addEventListener('click',e=>openMenu(menuOrigin,e.currentTarget));
$('#inOrigin').addEventListener('click',e=>openMenu(menuOrigin,e.currentTarget));
$('#inDest').addEventListener('click',e=>openMenu(menuDest,e.currentTarget));
menuOrigin.addEventListener('click',e=>{
  if(e.target.tagName!=='BUTTON') return;
  const a=e.target.dataset.action;
  if(a==='map-origin'){ pendingPick='origin'; }
  if(a==='geo'){ doLocate((latlng)=>setOrigin(latlng)); }
  if(a==='clear-origin'){ originLatLng=null; if(originMarker){ map.removeLayer(originMarker); originMarker=null } $('#inOrigin').value=''; clearRoute(); checkRequestButton(); }
  closeMenus();
});
menuDest.addEventListener('click',e=>{
  if(e.target.tagName!=='BUTTON') return;
  const a=e.target.dataset.action;
  if(a==='map-dest'){ pendingPick='dest'; }
  if(a==='swap'){ swapOD(); }
  if(a==='clear-dest'){ destLatLng=null; if(destMarker){ map.removeLayer(destMarker); destMarker=null } $('#inDest').value=''; clearRoute(); checkRequestButton(); }
  closeMenus();
});

/* Botonera pasajero */
$('#btnLocate').addEventListener('click',()=>doLocate((latlng)=>setOrigin(latlng)));
$('#btnSwap').addEventListener('click',()=>swapOD());
$('#btnClear').addEventListener('click',()=>{
  originLatLng=null; destLatLng=null;
  if(originMarker){ map.removeLayer(originMarker); originMarker=null }
  if(destMarker){ map.removeLayer(destMarker); destMarker=null }
  $('#inOrigin').value=''; $('#inDest').value='';
  clearRoute(); checkRequestButton();
});

/* Geo */
function doLocate(cb){
  if(!navigator.geolocation){ alert('Geolocalizaci√≥n no disponible'); return; }
  statusChip.textContent='localizando‚Ä¶';
  navigator.geolocation.getCurrentPosition(
    pos=>{ statusChip.textContent='online'; cb(L.latLng(pos.coords.latitude,pos.coords.longitude)); },
    err=>{ statusChip.textContent='offline'; alert('No pudimos obtener tu ubicaci√≥n'); }
  );
}

/* Swap */
function swapOD(){
  if(!originLatLng && !destLatLng) return;
  const tmp=originLatLng; originLatLng=destLatLng; destLatLng=tmp;
  if(originLatLng){ setOrigin(originLatLng) } else { if(originMarker){ map.removeLayer(originMarker); originMarker=null } $('#inOrigin').value='' }
  if(destLatLng){ setDest(destLatLng) } else { if(destMarker){ map.removeLayer(destMarker); destMarker=null } $('#inDest').value='' }
  planRouteAndQuote();
}

/* Solicitud */
const btnRequest=$('#btnRequest'), passengerStatus=$('#passengerStatus');
function checkRequestButton(){ btnRequest.disabled=!(originLatLng && destLatLng); }
let overlayTimer=null, overlaySecs=0, activeRequestId=null;

btnRequest.addEventListener('click', async ()=>{
  if(!currentUser){ alert('Inicia sesi√≥n'); return; }
  if(!(originLatLng&&destLatLng)){ alert('Eleg√≠ origen y destino'); return; }
  if(!lastQuote && originLatLng && destLatLng){ lastQuote = fallbackQuote(originLatLng, destLatLng); showQuote(lastQuote); }
  try{
    btnRequest.disabled=true;
    const rq = {
      userId: currentUser.uid,
      userName: currentUser.name,
      payMethod: $('#payMethod').value,
      origin: {lat:originLatLng.lat, lng:originLatLng.lng},
      dest:   {lat:destLatLng.lat,   lng:destLatLng.lng},
      meters: lastQuote?.meters||0,
      seconds:lastQuote?.seconds||0,
      fare:   Math.round(lastQuote?.fare||0)
    };
    activeRequestId = await window.__fb.api.addRequest(rq);
    showOverlay(true);
    listenTaken(activeRequestId);
    addMsg('Sistema','Solicitud enviada',false);
  }catch(err){ alert('Error creando solicitud: '+err.message); }
  finally{ btnRequest.disabled=false; }
});

function showOverlay(on){
  const ov=$('#searchOverlay'); const t=$('#ovTimer');
  if(on){ ov.style.display='grid'; overlaySecs=0; t.textContent='00:00'; overlayTimer=setInterval(()=>{ overlaySecs++; t.textContent=fmtMMSS(overlaySecs)}, 1000); }
  else{ ov.style.display='none'; if(overlayTimer) clearInterval(overlayTimer); }
}
function fmtMMSS(s){ const m=String(Math.floor(s/60)).padStart(2,'0'), ss=String(s%60).padStart(2,'0'); return `${m}:${ss}` }
$('#btnCancelOverlay').addEventListener('click', ()=> showOverlay(false));
function listenTaken(id){
  window.__fb.api.listenRequest(id, (r)=>{
    if(r.status==='taken'){ showOverlay(false); passengerStatus.style.display='flex'; passengerStatus.innerHTML=`‚úÖ Conductor asignado. <b>Prepar√° ${fmtMoney(r.fare)}</b>`; addMsg('Sistema','Conductor asignado'); }
    if(r.status==='finished'){ passengerStatus.style.display='flex'; passengerStatus.innerHTML=`üßæ Viaje finalizado. Total: <b>${fmtMoney(r.fare)}</b>`; addMsg('Sistema','Viaje finalizado'); }
  });
}

/* Driver */
function startDriverListener(){
  const listEl=$('#rqList'), badge=$('#rqBadge'), count=$('#rqCount');
  if(__unsubOpen) __unsubOpen();
  __unsubOpen = window.__fb.api.listenOpenRequests((list)=>{
    count.textContent=String(list.length); if(badge) badge.textContent=String(list.length);
    listEl.innerHTML='';
    list.forEach(rq=>{
      const card=document.createElement('div'); card.className='card';
      const km=(rq.meters/1000).toFixed(2), mins=Math.round((rq.seconds||0)/60);
      card.innerHTML=`
        <div class="row wrap" style="justify-content:space-between">
          <div>
            <div><b>${rq.userName||'Pasajero'}</b></div>
            <div class="help">Dist: ${km} km ¬∑ Tiempo: ${mins} min</div>
            <div class="help">Estimado: ${fmtMoney(rq.fare||0)} ‚Äî Pago: ${rq.payMethod||'-'}</div>
          </div>
          <div class="row">
            <button class="btn primary" data-acc="${rq.id}">Aceptar</button>
          </div>
        </div>`;
      listEl.appendChild(card);
    });
  });
  $('#rqList').onclick=async (e)=>{
    const id=e.target?.dataset?.acc; if(!id) return;
    try{
      await window.__fb.api.acceptRequestTxn(id, currentUser.uid);
      $('#btnDrvBegin').style.display='inline-flex';
      addMsg('Sistema','Solicitud aceptada',true);
      alert('Solicitud aceptada. Pod√©s comenzar el viaje.');
      activeRequestId=id;
    }
    catch(err){ alert('No se pudo aceptar: '+err.message) }
  };
}

/* Driver toolbar demo: tiempo y $$ */
let drvTimer=null, drvSecs=0, drvMoney=0, drvRunning=false;
const elDrvTime=$('#drvTime'), elDrvMoney=$('#drvMoney');
function updateDrvUI(){
  const hh=String(Math.floor(drvSecs/3600)).padStart(2,'0');
  const mm=String(Math.floor((drvSecs%3600)/60)).padStart(2,'0');
  const ss=String(drvSecs%60).padStart(2,'0');
  elDrvTime.textContent=`${hh}:${mm}:${ss}`;
  elDrvMoney.textContent=fmtMoney(drvMoney);
}
$('#btnDrvStart').addEventListener('click',()=>{
  if(drvRunning) return;
  drvRunning=true;
  drvTimer=setInterval(()=>{ drvSecs++; if(drvSecs%60===0) drvMoney+=200; updateDrvUI(); },1000);
});
$('#btnDrvPause').addEventListener('click',()=>{
  drvRunning=false; if(drvTimer){ clearInterval(drvTimer); drvTimer=null; }
});
$('#btnUbicarme').addEventListener('click',()=> doLocate(ll=> map.setView(ll,15)));
$('#btnDrvBegin').addEventListener('click',()=>{
  addMsg('Sistema','Iniciaste el viaje',true);
  $('#btnDrvBegin').style.display='none';
  if(!drvRunning) $('#btnDrvStart').click();
});
$('#btnDrvFinish').addEventListener('click', async ()=>{
  if(activeRequestId){ try{ await window.__fb.api.finishRequest(activeRequestId); }catch{} }
  drvRunning=false; if(drvTimer){ clearInterval(drvTimer); drvTimer=null; }
  drvSecs=0; drvMoney=0; updateDrvUI();
  addMsg('Sistema','Finalizaste el viaje',true);
  alert('Viaje finalizado.');
});

/* Chat mini */
function addMsg(who, text, me=false){
  const log=$('#chatLog'), div=document.createElement('div');
  div.className='msg '+(me?'me':'other'); div.innerHTML=`<b>${who}:</b> ${text}`;
  log.appendChild(div); log.scrollTop=log.scrollHeight; $('#chatMini').style.display='block';
}

/* Perfil */
function showProfile(){ $('.main').style.display='none'; $('#profile').style.display='block'; highlightTab('tab-profile'); renderProfile(); }
function renderStars(avg=4.6){
  const el=$('#pfStars'); el.innerHTML='';
  for(let i=1;i<=5;i++){ const s=document.createElement('span'); s.className='star'+(i<=Math.round(avg)?' filled':''); el.appendChild(s) }
}
function renderProfile(){
  $('#pfName').textContent=currentUser.name||'‚Äî'; $('#pfEmail').textContent=currentUser.email||'‚Äî';
  $('#pfNameEdit').value=currentUser.name||''; $('#pfPhoneEdit').value=currentUser.phone||'';
  const photo=localStorage.getItem(PHOTO_KEY(currentUser.uid)); $('#pfAvatar').src=photo||'';
  renderStars(4.6); renderDocs(); renderTrophies(); driverDocProgress();
  $('#btnSwitchRole').textContent= isDriverApproved() ? 'Ir a Conductor' : 'Cambiar a Conductor';
}
$('#btnEditName').addEventListener('click', ()=>{ $('#pfNameEdit').focus() });
$('#btnSaveProfile').addEventListener('click', ()=>{ updateUser({name:$('#pfNameEdit').value.trim(), phone:$('#pfPhoneEdit').value.trim()}); renderProfile(); renderTabs(); alert('Perfil actualizado'); });
$('#btnSwitchRole').addEventListener('click', ()=> setRole('driver'));

/* Subtabs */
const subButtons=$$('.subtab'); const subPanels={datos:$('#sub-datos'), conductor:$('#sub-conductor'), calif:$('#sub-calif')};
subButtons.forEach(b=> b.addEventListener('click', ()=>{ const key=b.dataset.sub; subButtons.forEach(x=>x.setAttribute('aria-selected', x===b?'true':'false')); Object.entries(subPanels).forEach(([k,el])=> el.setAttribute('aria-hidden', k===key?'false':'true')); }));

/* Docs */
const DOCS=['DNI frente','DNI dorso','Licencia conducir','C√©dula verde','Seguro vigente','Foto veh√≠culo'];
function renderDocs(){
  const grid=$('#docsGrid'); grid.innerHTML='';
  const st = Storage.get(DOCS_KEY(currentUser.uid), {});
  DOCS.forEach(name=>{
    const info=st[name];
    const row=document.createElement('div'); row.className='doc '+(info?'ok':'');
    const when = info ? new Date(info.at) : null;
    const whenTxt = info ? `‚úîÔ∏è Subido ¬∑ ${when.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} ¬∑ ${when.toLocaleDateString()}` : 'Pendiente';
    const thumb = info?.data || '';
    row.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center;gap:.75rem">
        <div style="display:flex;align-items:center;gap:.6rem">
          <img class="thumb" src="${thumb}" alt="prev"/>
          <div>
            <div style="font-weight:800">${name}</div>
            <div class="status">${whenTxt}</div>
          </div>
        </div>
        <label class="btn"> Subir<input type="file" accept="image/*" style="display:none" /></label>
      </div>`;
    const input=row.querySelector('input');
    input.addEventListener('change', async ev=>{
      const f=ev.target.files[0]; if(!f) return;
      const base64 = await blobToDataURL(f);
      const tiny=await compressDataURL(base64,512,.75);
      const newSt=Storage.get(DOCS_KEY(currentUser.uid), {}); newSt[name]={data:tiny, at:Date.now()};
      Storage.set(DOCS_KEY(currentUser.uid),newSt);
      row.classList.add('ok'); row.querySelector('.thumb').src=tiny;
      row.querySelector('.status').textContent=`‚úîÔ∏è Subido ¬∑ ${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} ¬∑ ${new Date().toLocaleDateString()}`;
      driverDocProgress();
    });
    grid.appendChild(row);
  });
}

/* Progreso de documentos y habilitaci√≥n */
function driverDocProgress(){
  const st = Storage.get(DOCS_KEY(currentUser.uid), {});
  const uploaded = DOCS.filter(n=> !!st[n]).length;
  const hint=$('#driverDocHint');
  const btnSend=$('#btnSendReview');
  const allReady = uploaded===DOCS.length;
  hint.textContent = allReady ? '‚úÖ Todo listo. Envi√° a revisi√≥n.' : `Faltan ${DOCS.length-uploaded} documentos.`;
  btnSend.disabled = !allReady;
}
$('#btnSendReview').addEventListener('click', ()=>{
  setDriverStatus('pending');
  alert('Enviado a revisi√≥n. (Demo: us√° ‚ÄúHabilitarme como conductor‚Äù para aprobarte)');
});
$('#btnApproveDemo').addEventListener('click', ()=>{
  setDriverStatus('approved');
  alert('¬°Aprobado como conductor (demo)!');
  renderTabs(); // aparece pesta√±a Conductor
});

/* Trofeos / calificaci√≥n (demo) */
function renderTrophies(){
  const box=$('#trophies'); box.innerHTML='';
  const starsAvg=4.6; // demo
  const trofeos=[
    {name:'Bronce 4.0‚≠ê', need:4.0, emoji:'ü•â'},
    {name:'Plata 4.5‚≠ê',  need:4.5, emoji:'ü•à'},
    {name:'Oro 4.8‚≠ê',    need:4.8, emoji:'ü•á'},
    {name:'Elite 5.0‚≠ê',  need:5.0, emoji:'üèÜ'}
  ];
  trofeos.forEach(t=>{
    const ok = starsAvg>=t.need;
    const chip=document.createElement('span');
    chip.className='chip'; chip.style.borderColor=ok?'#b7e4c7':'#e5eaf1'; chip.style.background=ok?'#f0fff4':'#f3f6fb';
    chip.textContent=`${t.emoji} ${t.name}`; box.appendChild(chip);
  });
  const pct=Math.min(100, Math.round((starsAvg/5)*100));
  $('#progBar').style.width=pct+'%'; $('#progPct').textContent=pct+'%';
}

/* ====== AUTH UI (gate) ====== */
function showLogin(){ $('#loginCard').style.display='block'; $('#regCard').style.display='none'; $('#tabLogin').setAttribute('aria-selected','true'); $('#tabReg').setAttribute('aria-selected','false'); }
function showReg(){ $('#loginCard').style.display='none'; $('#regCard').style.display='block'; $('#tabLogin').setAttribute('aria-selected','false'); $('#tabReg').setAttribute('aria-selected','true'); }

$('#tabLogin').addEventListener('click', showLogin);
$('#tabReg').addEventListener('click', showReg);
$('#btnCancelReg').addEventListener('click', showLogin);

$('#btnWipe').addEventListener('click', ()=>{
  if(confirm('Esto borrar√° usuarios locales, sesi√≥n y documentos (solo local). ¬øContinuar?')){
    localStorage.clear(); location.reload();
  }
});

$('#btnLogin').addEventListener('click', ()=>{
  $('#loginErr').textContent='';
  try{
    const u=signIn($('#inEmail').value.trim(), $('#inPass').value);
    enterApp(u);
  }catch(e){ $('#loginErr').textContent=e.message||'Error al iniciar sesi√≥n'; }
});

let regPhotoDataUrl=null;
$('#regPhoto').addEventListener('change', async (ev)=>{
  const f=ev.target.files?.[0]; if(!f) return;
  const base64 = await blobToDataURL(f);
  const tiny = await compressDataURL(base64,256,.8);
  $('#regPreview').src=tiny; regPhotoDataUrl=tiny;
});
$('#btnReg').addEventListener('click', async ()=>{
  $('#regErr').textContent='';
  const name=$('#regName').value.trim();
  const email=$('#regEmail').value.trim();
  const p1=$('#regPass').value; const p2=$('#regPass2').value;
  if(!email || !p1){ $('#regErr').textContent='Complet√° email y contrase√±a.'; return; }
  if(p1.length<6){ $('#regErr').textContent='La contrase√±a debe tener al menos 6 caracteres.'; return; }
  if(p1!==p2){ $('#regErr').textContent='Las contrase√±as no coinciden.'; return; }
  try{
    const u = await signUp({name,email,pass:p1,photoDataUrl:regPhotoDataUrl});
    enterApp(u);
  }catch(e){ $('#regErr').textContent=e.message||'No se pudo crear la cuenta'; }
});

/* Entrar a la app */
function enterApp(u){
  currentUser = u || getSessionUser();
  if(!currentUser){ $('#fatal').style.display='block'; $('#fatal').textContent='No hay sesi√≥n.'; return; }
  $('#gate').style.display='none'; $('#app').style.display='grid';
  $('#btnLogout').addEventListener('click', logout);
  renderTabs(); setRole('passenger'); initMap(); addMsg('Sistema','Sesi√≥n iniciada');
}

/* ===== Inicio ===== */
window.addEventListener('load', ()=>{
  if(location.protocol==='file:'){ $('#envWarn').style.display='block'; }
  const session = getSessionUser();
  if(session){ enterApp(session); } else { $('#gate').style.display='grid'; }
});
</script>
</body>
</html>
