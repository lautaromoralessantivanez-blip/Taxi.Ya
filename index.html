<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Taxi Ya</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0a0a0a; --panel:#121317; --ink:#ffffff; --muted:#b7c2cc; --line:#1e2733;
  --accent:#ffd34d; --accent-2:#7dd3fc; --danger:#ef4444; --ok:#22c55e; --link:#8ee6f4;
  --radius:16px; --shadow:0 16px 40px rgba(0,0,0,.45); --tabH:64px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Poppins,system-ui,Arial}
h2{margin:6px 0 10px;font-size:18px}
label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
input,select,button,textarea{font-family:inherit;font-size:14px}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:12px;background:transparent;color:var(--ink)}
input::placeholder,textarea::placeholder{color:rgba(127,143,159,.7)}
button{border:0;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer;color:var(--ink)}
.btn{background:transparent;border:1px solid var(--line)} .btn:hover{filter:brightness(1.08)}
.btnp{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#0b2d37}.btnp:hover{filter:brightness(1.05)}
.btnd{background:linear-gradient(180deg,#ff6262,#ef4444);color:#fff}
.row{display:flex;gap:8px;align-items:center}.row>*{flex:1}
.small{font-size:12px}.muted{color:var(--muted)}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:transparent;font-size:12px}
.ok{color:#062e25;background:#0f2a22;border-color:#144a3d}
.warn{color:#3b2b06;background:#2a230f;border-color:#4a3d14}
.badge{display:inline-block;background:transparent;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px;color:var(--ink);opacity:.8}
.inline-card{display:flex;align-items:center;gap:10px;border:1px solid var(--line);border-radius:12px;padding:8px;background:transparent}
.avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
.stars{font-size:12px;color:#ffe27a}
.card{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;border:1px solid var(--line);margin-bottom:10px}
.list{display:grid;gap:8px}
.item{border:1px solid var(--line);border-radius:12px;padding:10px;background:transparent}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:90px;z-index:9999;background:rgba(0,0,0,.85);color:#fff;padding:10px 14px;border-radius:12px;border:1px solid #000;box-shadow:0 10px 24px rgba(0,0,0,.35);font-weight:700}
.map{width:100%;height:64vh;min-height:360px;border-radius:16px;border:1px solid var(--line);overflow:hidden;position:relative}
.map-top{position:absolute; left:10px; right:10px; top:10px; z-index:400; display:none; padding:8px 12px; border-radius:12px; font-weight:700; border:1px solid var(--line); background:rgba(0,0,0,.25); backdrop-filter: blur(4px)}
.map-top.show{display:block}

/* Tabs superiores */
header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(0,0,0,.65) 0%, rgba(0,0,0,.35) 70%);border-bottom:1px solid var(--line);
  padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
.brand{font-weight:800}
nav.tabs{position:sticky; top:0; z-index:25; background:var(--panel); border-bottom:1px solid var(--line);
  display:flex; gap:8px; padding:8px; justify-content:center; flex-wrap:wrap}
.tab-btn{flex:0 0 auto; min-width:140px; height:44px; display:flex; align-items:center; justify-content:center; gap:8px;
  padding:10px 14px; border-radius:999px; font-weight:700; cursor:pointer; background:transparent; border:1px solid var(--line); color:var(--ink)}
.tab-btn.active{background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#0b2d37; border-color:transparent}
.tab-btn[disabled]{opacity:.55; cursor:not-allowed}
.hide{display:none!important}
main{max-width:1200px;margin:14px auto;padding:0 10px;display:grid;gap:12px}

/* Subpesta√±as dentro de cada panel */
.subtabs{display:flex;gap:6px;flex-wrap:wrap;margin:-6px -6px 8px -6px}
.subtabs .sub{flex:0 0 auto;min-width:120px;height:38px;display:flex;align-items:center;justify-content:center;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:transparent;font-weight:700}
.subtabs .sub.active{background:rgba(255,255,255,.08);border-color:#2b3946}
.subpanel{display:none}
.subpanel.show{display:block}

/* Bottom tabs on mobile */
@media (max-width:900px){
  nav.tabs{position:fixed; bottom:0; top:auto; left:0; right:0; border-top:1px solid var(--line); border-bottom:0;
    padding:6px max(6px, env(safe-area-inset-left)) calc(6px + env(safe-area-inset-bottom)) max(6px, env(safe-area-inset-right)); background:var(--panel); justify-content:space-between}
  .tab-btn{flex:1 1 0; min-width:0}
  body{padding-bottom:80px}
}
</style>
</head>
<body>
<header>
  <div class="brand">Taxi Ya üöï</div>
  <div id="authPill" class="badge">Sin sesi√≥n</div>
</header>

<nav class="tabs" role="tablist" aria-label="Secciones">
  <button class="tab-btn active" data-tab="access">üîê Acceso</button>
  <button class="tab-btn hide"   data-tab="ride">üöï Viaje</button>
  <button class="tab-btn hide"   data-tab="history">üßæ Historial</button>
  <button class="tab-btn hide"   data-tab="driver">üßë‚Äç‚úàÔ∏è Conductor</button>
  <button class="tab-btn hide"   data-tab="settings">‚öôÔ∏è Ajustes</button>
</nav>

<main>
  <!-- ================== ACCESO ================== -->
  <section id="panel-access" class="card">
    <div class="subtabs">
      <button class="sub active" data-sub="login">Iniciar sesi√≥n</button>
      <button class="sub" data-sub="register">Registrarme</button>
      <button class="sub" data-sub="tools">Herramientas</button>
    </div>

    <div id="sub-login" class="subpanel show">
      <form id="loginBox" autocomplete="on" novalidate>
        <div class="row">
          <div><label for="loginEmail">Correo</label><input id="loginEmail" type="email" placeholder="tucorreo@dominio.com" autocomplete="username" required></div>
          <div><label for="loginPass">Contrase√±a</label><input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" required></div>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btnp" id="btnSignIn" type="submit">Entrar</button>
        </div>
      </form>
    </div>

    <div id="sub-register" class="subpanel">
      <form id="registerBox" autocomplete="on" novalidate>
        <div class="row">
          <div><label for="regName">Nombre</label><input id="regName" placeholder="Tu nombre y apellido" required></div>
          <div><label for="regEmail">Correo</label><input id="regEmail" type="email" placeholder="tucorreo@dominio.com" required></div>
        </div>
        <div class="row">
          <div><label for="regPass">Contrase√±a</label><input id="regPass" type="password" placeholder="m√≠n. 6" minlength="6" required></div>
          <div><label for="regPhoto">Foto de perfil (obligatoria)</label><input id="regPhoto" type="file" accept="image/*" required></div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btnp" id="btnSignUp" type="submit">Crear cuenta</button>
        </div>
      </form>
    </div>

    <div id="sub-tools" class="subpanel">
      <div class="row" style="justify-content:flex-end; gap:8px">
        <button class="btn" id="btnResetAll" type="button">Limpiar datos locales</button>
      </div>
      <div id="msg" class="pill hide" role="status" aria-live="polite"></div>
    </div>
  </section>

  <!-- ================== VIAJE (RIDER) ================== -->
  <section id="panel-ride" class="card hide">
    <div class="subtabs">
      <button class="sub active" data-sub="r-form">Solicitud</button>
      <button class="sub" data-sub="r-map">Mapa</button>
      <button class="sub" data-sub="r-estado">Estado</button>
    </div>

    <div id="sub-r-form" class="subpanel show">
      <div class="row">
        <div>
          <label for="riderOrigin">Origen üìç</label>
          <input id="riderOrigin" placeholder="Calle y altura" autocomplete="off">
        </div>
        <div>
          <label for="riderDest">Destino üéØ</label>
          <input id="riderDest" placeholder="Calle y altura" autocomplete="off">
        </div>
      </div>

      <div class="row" style="margin-top:6px">
        <button class="btn" id="btnGeoRO" type="button">Buscar Origen</button>
        <button class="btn" id="btnGeoRD" type="button">Buscar Destino</button>
        <button class="btn" id="btnLocate" type="button">Ubicarme</button>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label for="reqType">Tipo</label>
          <select id="reqType"><option value="auto">Auto</option><option value="moto">Moto</option></select>
        </div>
        <div>
          <label for="payMethod">Pago (opcional)</label>
          <select id="payMethod">
            <option value="">Elegir‚Ä¶</option>
            <option value="cash">üíµ Efectivo</option>
            <option value="mp">üí≥ Mercado Pago</option>
          </select>
        </div>
      </div>

      <div id="payCashBox" class="row hide" style="margin-top:6px">
        <label><input type="checkbox" id="chkCashConfirm"> Confirmo pago en efectivo</label>
      </div>
      <div id="payMPBox" class="row hide" style="margin-top:6px">
        <button class="btn" id="btnPayMP" type="button">Simular pago con MP</button>
      </div>
      <div id="payStatus" class="pill hide">Pago pendiente</div>

      <div class="row" style="margin-top:10px">
        <div><label for="distance">Distancia</label><input id="distance" readonly value="0.00 km"></div>
        <div><label for="fare">Tarifa estimada</label><input id="fare" readonly value="$0"></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btnp" id="btnUnified" type="button">üöï Pedir viaje</button>
        <button class="btnd hide" id="btnCancel" type="button">Cancelar viaje</button>
      </div>
      <div id="searchStatus" class="small muted hide" style="margin-top:6px"><b>Buscando‚Ä¶</b> <span id="waitSecs">0</span>s</div>
    </div>

    <div id="sub-r-map" class="subpanel">
      <div style="position:relative">
        <div id="mapRide" class="map" aria-label="Mapa de viaje"></div>
        <div id="rideMapTop" class="map-top"></div>
      </div>
    </div>

    <div id="sub-r-estado" class="subpanel">
      <!-- Tarjeta del conductor asignado (para el pasajero) -->
      <div id="driverCard" class="inline-card hide" style="margin-top:10px">
        <img id="driverAvatar" class="avatar" alt="Conductor">
        <div>
          <h4 id="driverName">Conductor</h4>
          <div class="small muted" id="driverExtra">En camino al punto de partida‚Ä¶</div>
        </div>
      </div>
      <div id="riderStatusBox" class="pill hide" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- ================== HISTORIAL ================== -->
  <section id="panel-history" class="card hide">
    <div class="subtabs">
      <button class="sub active" data-sub="h-list">Lista</button>
    </div>
    <div id="sub-h-list" class="subpanel show">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Historial</h2>
        <div class="row" style="justify-content:flex-end; gap:8px">
          <button class="btn" id="btnClearRiderHistory" type="button">Limpiar</button>
        </div>
      </div>
      <div id="riderHistory" class="list"></div>
    </div>
  </section>

  <!-- ================== CONDUCTOR ================== -->
  <section id="panel-driver" class="card hide">
    <div class="subtabs">
      <button class="sub active" data-sub="d-dispo">Disponibles</button>
      <button class="sub" data-sub="d-activos">Activos</button>
      <button class="sub" data-sub="d-mapa">Mapa & Ruta</button>
    </div>

    <div id="sub-d-dispo" class="subpanel show">
      <div class="row" style="margin-top:6px">
        <button class="btnp" id="btnToggleOnline" type="button" disabled>Poner EN L√çNEA</button>
      </div>
      <div id="driverAvailable" class="list" style="margin-top:10px"></div>
    </div>

    <div id="sub-d-activos" class="subpanel">
      <div class="row" style="margin-top:6px">
        <button class="btn" id="btnStartRoute" type="button" disabled>Iniciar</button>
        <button class="btn" id="btnPauseRoute" type="button" disabled>Pausar</button>
        <button class="btnd" id="btnStopRoute" type="button" disabled>Terminar</button>
      </div>
      <div id="driverMyActive" class="list" style="margin-top:10px"></div>
    </div>

    <div id="sub-d-mapa" class="subpanel">
      <div style="position:relative">
        <div id="mapDriver" class="map" aria-label="Mapa del conductor"></div>
        <div id="driverMapTop" class="map-top"></div>
      </div>
      <div id="driverSteps" class="list" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- ================== AJUSTES ================== -->
  <section id="panel-settings" class="card hide">
    <div class="subtabs">
      <button class="sub active" data-sub="s-profile">Perfil</button>
      <button class="sub" data-sub="s-theme">Tema</button>
      <button class="sub" data-sub="s-kyc">Conductor</button>
      <button class="sub" data-sub="s-ratings">Calificaciones</button>
    </div>

    <div id="sub-s-profile" class="subpanel show">
      <div class="inline-card">
        <img id="profileAvatar" class="avatar" alt="Avatar">
        <div class="small" id="profileInfo"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnSignOut" type="button">Cerrar sesi√≥n</button>
      </div>
    </div>

    <div id="sub-s-theme" class="subpanel">
      <h2>Modo de color</h2>
      <div class="row"><label><input type="checkbox" id="themeToggle"> Tema Claro</label></div>
    </div>

    <div id="sub-s-kyc" class="subpanel">
      <h2>Verificaci√≥n para ser conductor</h2>
      <p class="small muted">Se habilita ‚ÄúConductor‚Äù cuando tu verificaci√≥n est√° <b>aprobada</b>.</p>
      <div class="row"><button class="btnp" id="btnVerifySubmit" type="button">Solicitar verificaci√≥n (modo demo)</button><span id="drvKycStatus" class="pill warn">No solicitado</span></div>
      <div id="verifyMsg" class="pill hide" style="margin-top:8px"></div>
    </div>

    <div id="sub-s-ratings" class="subpanel">
      <h2>Mi puntaje</h2>
      <div id="ratingSummary" class="small"></div>
      <div id="ratingList" class="list" style="margin-top:8px"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnAddFakeRating" type="button">A√±adir calificaci√≥n de prueba</button>
        <button class="btn" id="btnClearRatings" type="button">Borrar calificaciones</button>
      </div>
    </div>
  </section>
</main>

<div id="toast" class="toast hide"></div>

<!-- Firebase (Compat) -->
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-storage-compat.js"></script>

<script type="module">
/* ========================= Firebase ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyBu523IOGnIZGfAkdlLdVLcENwLgv5KU9o",
  authDomain: "taxi-ya-3be33.firebaseapp.com",
  projectId: "taxi-ya-3be33",
  storageBucket: "taxi-ya-3be33.appspot.com",
  messagingSenderId: "31840475169",
  appId: "1:31840475169:web:1485e47b9ebea4a66c6b60",
  measurementId: "G-2RQRP1G2KB"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
const storage = firebase.storage();
const usersCol = db.collection("users");
const ridesCol = db.collection("rides");

/* ========================= Utils ========================= */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const money=n=>new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n||0);
const toRad=d=>d*Math.PI/180;
const km2=(a,b)=>{const R=6371,dLat=toRad(b.lat-a.lat),dLon=toRad(b.lng-a.lng);const la1=toRad(a.lat),la2=toRad(b.lat);const h=Math.sin(dLat/2)**2+Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;return 2*R*Math.asin(Math.sqrt(h));};
function toast(msg,ms=1800){ const t=$("#toast"); t.textContent=msg; t.classList.remove("hide"); setTimeout(()=>t.classList.add("hide"),ms); }
function stars(r=5){ r=Math.max(0,Math.min(5,Math.round(r))); return '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ'.slice(5-r,10-r); }
function pill(el, text, cls){ el.textContent=text; el.className=`pill ${cls||''}`; el.classList.remove('hide'); }

/* ========================= Top tabs & subtabs ========================= */
let currentUser=null;
const panels=["access","ride","history","driver","settings"];
const subtabs={
  access:["login","register","tools"],
  ride:["r-form","r-map","r-estado"],
  history:["h-list"],
  driver:["d-dispo","d-activos","d-mapa"],
  settings:["s-profile","s-theme","s-kyc","s-ratings"]
};
function setTab(name){
  panels.forEach(p=>{
    document.getElementById(`panel-${p}`).classList.toggle('hide', p!==name);
    document.querySelector(`.tabs .tab-btn[data-tab="${p}"]`)?.classList.toggle('active', p===name);
  });
}
function setSub(panel, sub){
  subtabs[panel].forEach(s=>{
    document.getElementById(`sub-${s}`).classList.toggle('show', s===sub);
    document.querySelector(`#panel-${panel} .subtabs .sub[data-sub="${s}"]`)?.classList.toggle('active', s===sub);
  });
}
$$('.tabs .tab-btn').forEach(b=> b.addEventListener('click', ()=> setTab(b.dataset.tab)));
$$('.subtabs .sub').forEach(b=> b.addEventListener('click', ()=>{
  const panel=b.closest('section').id.replace('panel-','');
  setSub(panel, b.dataset.sub);
}));

/* ========================= THEME ========================= */
function applyTheme(){ const t=localStorage.getItem("taxiya_theme")||"dark"; document.documentElement.classList.toggle("light", t==="light"); $("#themeToggle").checked=(t==="light"); }
$("#themeToggle").addEventListener("change", e=>{ localStorage.setItem("taxiya_theme", e.target.checked?"light":"dark"); applyTheme(); });
applyTheme();

/* ========================= GEO & MAPS ========================= */
function primaryTileLayer(){
  const tl = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'¬© OpenStreetMap'});
  tl.on('tileerror', ()=>{ try{ if(tl._fallbackAdded) return; tl._fallbackAdded=true; tl._map && L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(tl._map); }catch(_){ } });
  return tl;
}
function resizeMap(map){ try{ map && map.invalidateSize(); }catch(_){} }
async function geocode(text){
  try{ const u=new URL("https://nominatim.openstreetmap.org/search"); u.searchParams.set("q",text); u.searchParams.set("format","json"); u.searchParams.set("limit","1");
    const r=await fetch(u); if(!r.ok) return null; const j=await r.json(); if(!j.length) return null; return {lat:+j[0].lat,lng:+j[0].lon}; }catch(_){ return null; }
}
async function reverseGeocode(lat,lng){
  try{ const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`); const j=await r.json(); return j.display_name||`${lat.toFixed(5)}, ${lng.toFixed(5)}`;}catch(_){return `${lat.toFixed(5)}, ${lng.toFixed(5)}`;}
}

/* ----- OSRM ROUTING (calle a calle) ----- */
async function fetchRoadRoute(a,b){ // a,b: {lat,lng}
  const url=`https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson&steps=true`;
  const r=await fetch(url); if(!r.ok) throw new Error("Ruta no disponible");
  const j=await r.json(); const rt=j.routes?.[0]; if(!rt) throw new Error("Sin ruta");
  const coords=rt.geometry.coordinates.map(([x,y])=>[y,x]);
  const steps=(rt.legs?.[0]?.steps||[]).map(s=>({text:s.name||'Girar', dist:s.distance, dur:s.duration}));
  return {coords, distance:rt.distance, duration:rt.duration, steps};
}

/* ========================= RIDE (Rider side) ========================= */
let mapRide=null, riderMarkers={origin:null,dest:null,driver:null}, riderLines={o2d:null, drv:null};
let origin=null, dest=null;
function ensureRideMap(){
  if(mapRide) return;
  mapRide=L.map('mapRide',{zoomControl:false});
  L.control.zoom({position:'bottomright'}).addTo(mapRide);
  primaryTileLayer().addTo(mapRide);
  mapRide.setView([-31.5375,-68.5364],12);
  window.addEventListener('resize', ()=> resizeMap(mapRide));
}
function setRiderMarker(kind, lat, lng, label){
  const mk = riderMarkers[kind];
  if(!mk){
    riderMarkers[kind] = (kind==='driver')
      ? L.circleMarker([lat,lng],{radius:8,color:'#7dd3fc',weight:3}).addTo(mapRide).bindTooltip(label,{direction:'top'})
      : L.circleMarker([lat,lng],{radius:8,color: kind==='origin' ? '#22c55e' : '#ef4444',weight:3}).addTo(mapRide).bindTooltip(label,{direction:'top'});
  }else{
    mk.setLatLng([lat,lng]);
  }
}
function clearRiderLine(name){ if(riderLines[name]){ mapRide.removeLayer(riderLines[name]); riderLines[name]=null; } }
function drawRiderLine(name, coords){ clearRiderLine(name); riderLines[name]=L.polyline(coords,{weight:5}).addTo(mapRide); }
function fitRideBounds(){
  const bounds=L.latLngBounds([]);
  ['origin','dest','driver'].forEach(k=>{ if(riderMarkers[k]) bounds.extend(riderMarkers[k].getLatLng()); });
  if(bounds.isValid()) mapRide.fitBounds(bounds,{padding:[20,20]});
}

async function setOriginFromField(){
  const txt=$("#riderOrigin").value.trim(); if(!txt) return;
  ensureRideMap();
  const loc=await geocode(txt); if(!loc){ toast("No se encontr√≥ el origen"); return; }
  origin=loc; setRiderMarker('origin', loc.lat, loc.lng, 'Origen'); mapRide.setView([loc.lat,loc.lng],15);
  updateEstimate();
}
async function setDestFromField(){
  const txt=$("#riderDest").value.trim(); if(!txt) return;
  ensureRideMap();
  const loc=await geocode(txt); if(!loc){ toast("No se encontr√≥ el destino"); return; }
  dest=loc; setRiderMarker('dest', loc.lat, loc.lng, 'Destino'); mapRide.setView([loc.lat,loc.lng],15);
  updateEstimate();
  // dibujar ruta calle a calle para que el pasajero vea el recorrido propuesto
  try{
    const road=await fetchRoadRoute(origin, dest);
    drawRiderLine('o2d', road.coords); fitRideBounds();
  }catch(_){}
}

function estimateFareRaw(km){ const base=990, perKm=660, perMin=99; const mins=(km/24)*60; return Math.max(800, Math.round(base + km*perKm + mins*perMin)); }
function updateEstimate(){
  const distEl=$("#distance"), fareEl=$("#fare");
  if(!origin||!dest){ distEl.value="0.00 km"; fareEl.value="$0"; return; }
  const km=km2(origin,dest); distEl.value=`${km.toFixed(2)} km`; fareEl.value=money(estimateFareRaw(km));
}

/* Pago demo */
let payment={method:null,status:"pending"};
function resetPayment(){ payment={method:null,status:"pending"}; const ps=$("#payStatus"); ps.className="pill hide"; ps.textContent="Pago pendiente"; $("#chkCashConfirm").checked=false; }
$("#payMethod").addEventListener("change", e=>{
  resetPayment();
  const m=e.target.value; payment.method=m;
  $("#payCashBox").classList.toggle("hide", m!=="cash");
  $("#payMPBox").classList.toggle("hide", m!=="mp");
  if(m) $("#payStatus").classList.remove("hide");
});
$("#chkCashConfirm").addEventListener("change", e=>{ if($("#payMethod").value!=="cash") return; payment.status=e.target.checked?"cash_confirmed":"pending"; $("#payStatus").className=`pill ${e.target.checked?'ok':''}`; $("#payStatus").textContent=e.target.checked?"Pago en efectivo confirmado":"Pago pendiente"; });
$("#btnPayMP").addEventListener("click", async ()=>{ const b=$("#btnPayMP"); b.disabled=true; b.textContent="Procesando‚Ä¶"; await new Promise(r=>setTimeout(r,900)); payment.status="approved"; $("#payStatus").className="pill ok"; $("#payStatus").textContent="Pago aprobado (MP)"; b.disabled=false; b.textContent="Simular pago con MP"; });

/* Crear/escuchar viaje */
let riderActiveUnsub=null, searching=false, waitTimer=null, waitSeconds=0;
const waitLabel=$("#waitSecs"), searchStatus=$("#searchStatus"), btnUnified=$("#btnUnified"), btnCancel=$("#btnCancel");

function startSearchingUI(){ searching=true; waitSeconds=0; btnUnified.disabled=true; btnUnified.textContent="Buscando‚Ä¶"; btnCancel.classList.remove("hide"); searchStatus.classList.remove("hide"); waitLabel.textContent="0"; waitTimer=setInterval(()=>{ waitSeconds++; waitLabel.textContent=String(waitSeconds); },1000); }
function stopSearchingUI(){ searching=false; btnUnified.disabled=false; btnUnified.textContent="üöï Pedir viaje"; btnCancel.classList.add("hide"); searchStatus.classList.add("hide"); clearInterval(waitTimer); waitTimer=null; }

async function riderCreateRide(){
  if(!currentUser){ toast("Inici√° sesi√≥n"); setTab('access'); return; }
  if(!origin || !dest){ toast("Seleccion√° origen y destino"); return; }
  startSearchingUI();
  const existing = await ridesCol.where("riderId","==", currentUser.uid).where("finished","==", false).limit(1).get().catch(()=>null);
  if(existing && !existing.empty){ toast("Ya ten√©s un viaje activo"); stopSearchingUI(); return; }

  const km=km2(origin,dest), finalFare=estimateFareRaw(km);
  const data={
    riderId: currentUser.uid,
    riderName: currentUser.displayName || currentUser.email,
    riderPhotoURL: currentUser.photoURL || "",
    riderRating: currentUser.rating || 5,
    riderEmail: currentUser.email,
    originText: $("#riderOrigin").value.trim() || `${origin.lat.toFixed(5)}, ${origin.lng.toFixed(5)}`,
    destText: $("#riderDest").value.trim() || `${dest.lat.toFixed(5)}, ${dest.lng.toFixed(5)}`,
    origin, dest, km, fare: finalFare, vehicle: $("#reqType").value || "auto",
    payment, status:"requested", finished:false,
    ts: firebase.firestore.FieldValue.serverTimestamp()
  };
  try{ await ridesCol.add(data); toast("Solicitud enviada"); setSub('ride','r-estado'); }catch(e){ toast("Error: "+e.message); stopSearchingUI(); }
}

function riderAttachActiveRide(){
  if(riderActiveUnsub) riderActiveUnsub();
  riderActiveUnsub = ridesCol.where("riderId","==", currentUser.uid).where("finished","==", false).limit(1)
  .onSnapshot((qs)=>{
    if(qs.empty){ $("#driverCard").classList.add("hide"); $("#riderStatusBox").classList.add("hide"); stopSearchingUI(); return; }
    const doc=qs.docs[0], r=doc.data();

    // Estado visible
    const box=$("#riderStatusBox");
    pill(box, `Estado: ${r.status.toUpperCase()} ‚Äî ${r.originText} ‚Üí ${r.destText} ¬∑ ${ (r.km||0).toFixed(1) } km ¬∑ ${money(r.fare) }`,'');
    setSub('ride','r-estado');

    // Cancelar
    btnCancel.classList.toggle("hide", r.status!=="requested");
    btnCancel.onclick = async ()=>{ try{ await db.runTransaction(async tx=>{ const ref=ridesCol.doc(doc.id); const s=await tx.get(ref); if(s.data().status!=="requested") throw new Error("Ya no se puede cancelar"); tx.update(ref,{status:"cancelled", finished:true}); }); toast("Solicitud cancelada"); }catch(e){ toast(e.message);} };

    // Conductor asignado
    if(r.driverId){
      $("#driverName").textContent = r.driverName || "Conductor";
      $("#driverAvatar").src = r.driverPhotoURL || "https://i.pravatar.cc/100?img=3";
      $("#driverExtra").textContent = r.status==="accepted" ? "En camino al punto de partida‚Ä¶" :
                                      r.status==="arrived"  ? "Conductor lleg√≥ al origen" :
                                      r.status==="in_trip"  ? "En viaje" :
                                      r.status==="completed"? "Viaje finalizado" : "‚Äî";
      $("#driverCard").classList.remove("hide");
      stopSearchingUI();

      // Mapa: mostrar por d√≥nde viene el conductor (driverLoc ‚Üí ruta calle a calle)
      ensureRideMap();
      if(r.origin && !origin){ origin=r.origin; setRiderMarker('origin', origin.lat, origin.lng, 'Origen'); }
      if(r.dest && !dest){ dest=r.dest; setRiderMarker('dest', dest.lat, dest.lng, 'Destino'); }

      if(r.driverLoc){
        setRiderMarker('driver', r.driverLoc.latitude, r.driverLoc.longitude, 'Conductor');

        let a,b;
        if(r.status==="accepted" || r.status==="arrived"){ a={lat:r.driverLoc.latitude,lng:r.driverLoc.longitude}; b=r.origin; }
        else if(r.status==="in_trip"){ a={lat:r.driverLoc.latitude,lng:r.driverLoc.longitude}; b=r.dest; }
        else { a=r.origin; b=r.dest; }

        fetchRoadRoute(a,b).then(rt=>{
          drawRiderLine('drv', rt.coords);
          fitRideBounds();
        }).catch(_=>{ /* ignora */ });
      }
    } else {
      $("#driverCard").classList.add("hide");
    }

    // Overlay en mapa rider
    $("#rideMapTop").textContent = `${r.originText} ‚Üí ${r.destText} ¬∑ ${ (r.km||0).toFixed(1) } km ¬∑ ${ money(r.fare) }`;
    $("#rideMapTop").classList.add("show"); setTimeout(()=> $("#rideMapTop").classList.remove("show"), 1500);
  });
}

/* ========================= CONDUCTOR ========================= */
let driverMap=null, drv={driver:null, pick:null, drop:null, toPick:null, o2d:null}, driverWatchId=null, currentDriverRideId=null, lastPush=0;
function initDriverMapOnce(){
  if(driverMap) return;
  driverMap=L.map('mapDriver',{zoomControl:false});
  L.control.zoom({position:'bottomright'}).addTo(driverMap);
  primaryTileLayer().addTo(driverMap);
  driverMap.setView([-31.5375,-68.5364],13);
  window.addEventListener('resize', ()=> resizeMap(driverMap));

  // Geo del conductor + push a Firestore cuando est√© en viaje
  if(navigator.geolocation){
    driverWatchId = navigator.geolocation.watchPosition(async p=>{
      const lat=p.coords.latitude, lng=p.coords.longitude;
      if(!drv.driver){
        drv.driver = L.circleMarker([lat,lng],{radius:8,color:'#7dd3fc',weight:3}).addTo(driverMap).bindTooltip("Conductor",{direction:'top'});
      }else{ drv.driver.setLatLng([lat,lng]); }
      const now=Date.now();
      if(currentDriverRideId && now-lastPush>2500){
        lastPush=now;
        await ridesCol.doc(currentDriverRideId).set({driverLoc:new firebase.firestore.GeoPoint(lat,lng), driverLocAt: firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
      }
    }, console.warn, {enableHighAccuracy:true, maximumAge:2000, timeout:15000});
  }
}
function clearDrvLines(){ ['toPick','o2d'].forEach(k=>{ if(drv[k]){ driverMap.removeLayer(drv[k]); drv[k]=null; } }); }
function setDrvMarker(kind, lat, lng, label, color){
  if(!drv[kind]) drv[kind] = L.circleMarker([lat,lng],{radius:8,color,weight:3}).addTo(driverMap).bindTooltip(label,{direction:'top'});
  else drv[kind].setLatLng([lat,lng]);
}
async function paintDriverRoad(r){
  initDriverMapOnce(); clearDrvLines();
  if(r.origin) setDrvMarker('pick', r.origin.lat, r.origin.lng, 'Origen', '#22c55e');
  if(r.dest)  setDrvMarker('drop', r.dest.lat, r.dest.lng, 'Destino', '#ef4444');

  const centerBounds=L.latLngBounds([]);
  if(drv.driver) centerBounds.extend(drv.driver.getLatLng());
  if(r.origin) centerBounds.extend([r.origin.lat,r.origin.lng]);
  if(r.dest) centerBounds.extend([r.dest.lat,r.dest.lng]);

  // Ruta al origen (si aceptado) o a destino (si en viaje)
  if(r.driverLoc){
    const from={lat:r.driverLoc.latitude,lng:r.driverLoc.longitude};
    const target=(r.status==="accepted"||r.status==="arrived")? r.origin : r.dest;
    if(target){
      try{
        const rt1=await fetchRoadRoute(from, target);
        drv.toPick = L.polyline(rt1.coords,{weight:5}).addTo(driverMap);
        renderDriverSteps(rt1.steps.slice(0,12));
      }catch(_){}
    }
  }
  // Ruta origen‚Üídestino
  if(r.origin && r.dest){
    try{
      const rt2=await fetchRoadRoute(r.origin, r.dest);
      drv.o2d = L.polyline(rt2.coords,{weight:4, opacity:.6}).addTo(driverMap);
    }catch(_){}
  }
  if(centerBounds.isValid()) driverMap.fitBounds(centerBounds,{padding:[20,20]});
  const top=$("#driverMapTop"); top.textContent=`${r.originText} ‚Üí ${r.destText} ¬∑ ${(r.km||0).toFixed(1)} km ¬∑ ${money(r.fare||0)}`; top.classList.add('show'); setTimeout(()=>top.classList.remove('show'),1500);
}
function renderDriverSteps(steps){
  const box=$("#driverSteps"); box.innerHTML="";
  if(!steps || !steps.length){ box.innerHTML='<div class="small muted">Sin instrucciones de giro.</div>'; return; }
  steps.forEach((s,i)=>{ const d=document.createElement('div'); d.className='item small'; d.textContent=`${i+1}. ${s.text||'Seguir'} ¬∑ ${(s.dist/1000).toFixed(1)} km`; box.appendChild(d); });
}

function paintKycUI(){
  const st=currentUser?.approved ? "Aprobado" : "No solicitado";
  const pillEl=$("#drvKycStatus"); if(pillEl){ pillEl.textContent=st; pillEl.className="pill "+(currentUser.approved?"ok":"warn"); }
  $("#btnToggleOnline").disabled = !currentUser?.approved;
  $("#btnStartRoute").disabled = !currentUser?.approved;
  $("#btnPauseRoute").disabled = !currentUser?.approved;
  $("#btnStopRoute").disabled = !currentUser?.approved;
}

/* Streams del conductor */
let driverAvailUnsub=null, driverMineUnsub=null;
function attachDriverStreams(){
  if(driverAvailUnsub) driverAvailUnsub();
  if(driverMineUnsub)  driverMineUnsub();

  if(!(currentUser?.approved && currentUser?.online)){
    $("#driverAvailable").innerHTML = `<div class="small muted">Ponete EN L√çNEA para ver viajes disponibles.</div>`;
    $("#driverMyActive").innerHTML = `<div class="small muted">Sin viajes activos.</div>`;
    return;
  }

  // Disponibles
  driverAvailUnsub = ridesCol.where("status","==","requested").limit(30).onSnapshot(qs=>{
    const wrap=$("#driverAvailable"); wrap.innerHTML="";
    if(qs.empty){ wrap.innerHTML=`<div class="small muted">Sin viajes por ahora‚Ä¶</div>`; return; }
    qs.forEach(doc=>{
      const r=doc.data();
      const item=document.createElement('div'); item.className='item';
      item.innerHTML=`
        <div class="inline-card">
          <img src="${r.riderPhotoURL||'https://i.pravatar.cc/100?img=12'}" class="avatar" alt="Pasajero">
          <div>
            <b>${r.riderName||'Pasajero'}</b> ¬∑ <span class="stars">${stars(r.riderRating||5)}</span>
            <div class="small">${r.originText} ‚Üí ${r.destText}</div>
            <div class="small muted">${(r.km||0).toFixed(1)} km ¬∑ ${money(r.fare)} ¬∑ ${r.vehicle||'auto'}</div>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn" data-view>Ver ruta</button>
          <button class="btnp" data-accept>Aceptar</button>
        </div>`;
      item.querySelector('[data-view]').onclick=()=> paintDriverRoad(r);
      item.querySelector('[data-accept]').onclick=()=> driverAcceptRide(doc.id).then(()=>{ currentDriverRideId=doc.id; paintDriverRoad({...r,status:'accepted'}); setTab('driver'); setSub('driver','d-mapa'); });
      wrap.appendChild(item);
    });
  });

  // Activos
  driverMineUnsub = ridesCol.where("driverId","==", auth.currentUser.uid).where("finished","==",false)
  .onSnapshot(qs=>{
    const wrap=$("#driverMyActive"); wrap.innerHTML="";
    if(qs.empty){ wrap.innerHTML=`<div class="small muted">Sin viajes activos.</div>`; currentDriverRideId=null; return; }
    qs.forEach((doc,i)=>{
      const r=doc.data(); if(i===0){ currentDriverRideId=doc.id; paintDriverRoad(r); }
      const item=document.createElement('div'); item.className='item';
      const buttons=renderNextButtons(r.status);
      item.innerHTML=`
        <div><b>${r.originText}</b> ‚Üí <b>${r.destText}</b></div>
        <div class="small muted">${(r.km||0).toFixed(1)} km ¬∑ ${money(r.fare)} ¬∑ Pasajero: ${r.riderName||'‚Äî'} ¬∑ Estado: <b>${r.status}</b></div>
        <div class="row" style="margin-top:6px">${buttons}</div>`;
      item.querySelectorAll("button[data-next]").forEach(b=> b.onclick=()=> driverAdvance(doc.id,b.dataset.next));
      const c=item.querySelector("[data-cancel]"); if(c) c.onclick=()=> driverCancel(doc.id);
      wrap.appendChild(item);
    });
  });
}
function renderNextButtons(cur){
  const order=["requested","accepted","arrived","in_trip","completed"];
  const nx=(label,next,en)=>`<button class="btn${en?' btnp':''}" data-next="${next}" ${en?'':'disabled'}>${label}</button>`;
  const can=n=> order.indexOf(n)===order.indexOf(cur)+1;
  const cancelAllowed = cur==="requested"||cur==="accepted";
  return `${nx("Llegu√©","arrived",can("arrived"))}${nx("Iniciar viaje","in_trip",can("in_trip"))}${nx("Finalizar","completed",can("completed"))}${cancelAllowed?`<button class="btnd" data-cancel>Cancelar</button>`:""}`;
}
async function driverAcceptRide(rideId){
  try{
    await db.runTransaction(async tx=>{
      const ref=ridesCol.doc(rideId), snap=await tx.get(ref);
      if(!snap.exists) throw new Error("El viaje ya no existe");
      const r=snap.data(); if(r.status!=="requested") throw new Error("Ya fue tomado");
      tx.update(ref,{status:"accepted", driverId:auth.currentUser.uid, driverName: currentUser.displayName||currentUser.email, driverPhotoURL: currentUser.photoURL||"", driverRating: currentUser.rating||5});
    });
    toast("¬°Viaje aceptado!"); setSub('driver','d-mapa');
  }catch(e){ toast(e.message); }
}
async function driverAdvance(rideId,next){
  const ord=["requested","accepted","arrived","in_trip","completed"];
  try{
    await db.runTransaction(async tx=>{
      const ref=ridesCol.doc(rideId), snap=await tx.get(ref); if(!snap.exists) throw new Error("No existe");
      const r=snap.data(); if(ord.indexOf(next)!==ord.indexOf(r.status)+1) throw new Error("Secuencia inv√°lida");
      const upd={status:next}; if(next==="completed") upd.finished=true; tx.update(ref,upd);
    });
    if(next==="completed"){ currentDriverRideId=null; clearDrvLines(); }
  }catch(e){ toast(e.message); }
}
async function driverCancel(rideId){
  try{
    await db.runTransaction(async tx=>{
      const ref=ridesCol.doc(rideId), snap=await tx.get(ref); if(!snap.exists) throw new Error("No existe");
      const r=snap.data(); if(r.status!=="requested" && r.status!=="accepted") throw new Error("No se puede cancelar ahora");
      tx.update(ref,{status:"cancelled", finished:true});
    });
  }catch(e){ toast(e.message); }
}

/* ========================= Historial local ========================= */
function renderRiderHistory(){
  if(!currentUser) return;
  const key=`taxiya_rider_history_${currentUser.email}`;
  let list=[]; try{ list=JSON.parse(localStorage.getItem(key)||"[]"); }catch(_){}
  const wrap=$("#riderHistory"); wrap.innerHTML="";
  if(!list.length){ wrap.innerHTML=`<div class="muted small">Sin viajes a√∫n.</div>`; return; }
  list.slice().reverse().forEach(t=>{
    const div=document.createElement("div"); div.className="item";
    div.innerHTML=`<b>${new Date(t.ts).toLocaleString()}</b><br>Origen: <b>${t.originText||"‚Äî"}</b> ¬∑ Destino: <b>${t.destText||"‚Äî"}</b><br>Distancia: <b>${t.km?.toFixed?.(2)||"0.00"} km</b> ¬∑ Total: <b>${money(t.finalFare||0)}</b>`;
    wrap.appendChild(div);
  });
}
$("#btnClearRiderHistory").addEventListener("click", ()=>{ if(!currentUser) return; localStorage.setItem(`taxiya_rider_history_${currentUser.email}`,"[]"); renderRiderHistory(); toast("Historial borrado"); });

/* ========================= Perfil / Sesi√≥n ========================= */
function paintProfile(){
  const el=$("#profileInfo"), av=$("#profileAvatar");
  if(!currentUser){ el.innerHTML="No hay sesi√≥n."; av.src=""; return; }
  av.src = currentUser.photoURL || "https://i.pravatar.cc/100?u=placeholder";
  el.innerHTML=`Nombre: <b>${currentUser.displayName||"‚Äî"}</b> ¬∑ Correo: <b>${currentUser.email}</b><br>Rol: <b>${currentUser.role||'rider'}</b> ¬∑ KYC: <b>${currentUser.approved?'Aprobado':'No solicitado'}</b>`;
}
$("#btnSignOut").addEventListener("click", ()=> auth.signOut().catch(e=>toast(e.message)));

/* ---------- Compresi√≥n & subida de foto a Storage (evita >1MB en Firestore) ---------- */
function compressImage(file, maxSide=768, quality=0.82){
  return new Promise((resolve,reject)=>{
    const img=new Image(); const url=URL.createObjectURL(file);
    img.onload=()=>{ const w=img.width, h=img.height, scale=Math.min(1, maxSide/Math.max(w,h));
      const c=document.createElement('canvas'); c.width=Math.round(w*scale); c.height=Math.round(h*scale);
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      c.toBlob(b=>{ URL.revokeObjectURL(url); if(!b) return reject(new Error('blob null')); resolve(b); }, 'image/jpeg', quality);
    };
    img.onerror=reject; img.src=url;
  });
}

/* ========================= Acceso ========================= */
$("#loginBox").addEventListener("submit", async e=>{
  e.preventDefault();
  const email=$("#loginEmail").value.trim(), pass=$("#loginPass").value;
  try{ await auth.signInWithEmailAndPassword(email,pass); toast("Sesi√≥n iniciada"); }
  catch(err){ toast(err.message); }
});
$("#registerBox").addEventListener("submit", e=>{
  e.preventDefault();
  const name=$("#regName").value.trim(), email=$("#regEmail").value.trim(), pass=$("#regPass").value;
  const file=$("#regPhoto").files[0]; if(!file){ toast("La foto es obligatoria"); return; }
  (async ()=>{
    try{
      const {user}=await auth.createUserWithEmailAndPassword(email,pass);
      await user.updateProfile({displayName:name});
      const blob=await compressImage(file,768,.82);
      const ref=storage.ref().child(`users/${user.uid}/avatar.jpg`);
      await ref.put(blob,{contentType:'image/jpeg'});
      const photoURL=await ref.getDownloadURL();
      await usersCol.doc(user.uid).set({uid:user.uid,email:user.email,displayName:name,photoURL,role:"rider",approved:false,online:false,createdAt: firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
      toast("Cuenta creada");
    }catch(err){ toast(err.message); }
  })();
});

/* ========================= Auth state ========================= */
function refreshTabVisibility(){
  const logged=!!currentUser; 
  document.querySelector(`[data-tab="access"]`).classList.toggle("hide", logged);
  document.querySelector(`[data-tab="ride"]`).classList.toggle("hide", !logged);
  document.querySelector(`[data-tab="history"]`).classList.toggle("hide", !logged);
  document.querySelector(`[data-tab="driver"]`).classList.toggle("hide", !(logged&&currentUser.approved));
  document.querySelector(`[data-tab="settings"]`).classList.toggle("hide", !logged);
  if(!logged) setTab("access"); else setTab("ride");
}
auth.onAuthStateChanged(async (u)=>{
  if(!u){
    currentUser=null; $("#authPill").textContent="Sin sesi√≥n"; refreshTabVisibility();
    if(riderActiveUnsub) riderActiveUnsub(); if(driverAvailUnsub) driverAvailUnsub(); if(driverMineUnsub) driverMineUnsub();
    return;
  }
  const ref=usersCol.doc(u.uid); const snap=await ref.get();
  if(!snap.exists){ await ref.set({uid:u.uid,email:u.email,displayName:u.displayName||"",photoURL:u.photoURL||"",role:"rider",approved:false,online:false,createdAt: firebase.firestore.FieldValue.serverTimestamp()},{merge:true}); }
  currentUser=(await ref.get()).data();
  $("#authPill").textContent = `${currentUser.displayName||currentUser.email} ‚Äî ${(currentUser.role||'rider')}${currentUser.approved?' (KYC‚úì)':''}`;
  paintProfile(); refreshTabVisibility();
  // Maps
  ensureRideMap(); initDriverMapOnce();
  // Rider listeners
  riderAttachActiveRide(); renderRiderHistory();
  // Driver UI
  paintKycUI(); attachDriverStreams();
});

/* ========================= Buttons & bindings ========================= */
$("#btnUnified").addEventListener("click", riderCreateRide);
$("#btnCancel").addEventListener("click", ()=>{});
$("#btnLocate").addEventListener("click", ()=>{
  if(!navigator.geolocation) return toast("Sin geolocalizaci√≥n");
  ensureRideMap();
  navigator.geolocation.getCurrentPosition(p=>{
    origin={lat:p.coords.latitude,lng:p.coords.longitude};
    setRiderMarker('origin', origin.lat, origin.lng, 'Origen'); mapRide.setView([origin.lat,origin.lng],15); updateEstimate();
  }, ()=>toast("No se pudo obtener ubicaci√≥n"), {enableHighAccuracy:true,timeout:5000,maximumAge:15000});
});
$("#btnGeoRO").addEventListener("click", setOriginFromField);
$("#btnGeoRD").addEventListener("click", setDestFromField);

$("#btnVerifySubmit").addEventListener("click", async ()=>{
  if(!auth.currentUser){ toast("Inici√° sesi√≥n"); return; }
  await usersCol.doc(auth.currentUser.uid).set({role:"driver", approved:true},{merge:true});
  currentUser.approved=true; currentUser.role="driver"; paintKycUI(); refreshTabVisibility(); setTab('driver'); setSub('driver','d-dispo'); toast("‚úÖ Verificaci√≥n aprobada (demo)");
});
$("#btnToggleOnline").addEventListener("click", async ()=>{
  const online=!currentUser.online; await usersCol.doc(auth.currentUser.uid).set({online},{merge:true}); currentUser.online=online; toast(online?"Conductor en l√≠nea":"Conductor en pausa"); attachDriverStreams();
});
$("#btnStartRoute").addEventListener("click", ()=> toast("Recorrido iniciado"));
$("#btnPauseRoute").addEventListener("click", ()=> toast("Recorrido en pausa"));
$("#btnStopRoute").addEventListener("click", ()=> toast("Recorrido terminado"));

$("#btnResetAll").addEventListener("click", async ()=>{
  localStorage.clear(); try{ await auth.signOut(); }catch(_){}
  currentUser=null; $("#authPill").textContent="Sin sesi√≥n"; refreshTabVisibility(); setTab("access"); setSub("access","login"); toast("Datos locales limpiados");
});

/* Resize maps when subtab changes */
window.addEventListener("focus", ()=>{ resizeMap(mapRide); resizeMap(driverMap); });
</script>
</body>
</html>

