<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Taxi Ya — demo login libre</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase (compat v12) -->
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
/* ====== Base ====== */
:root{
  --bg:#0b0f15; --panel:#0f141d; --ink:#f5f7fb; --muted:#93a6b7; --line:#1c2a3a;
  --accent:#00b3ff; --accent2:#ffd34d; --ok:#17c964; --danger:#ef4444;
  --radius:16px; --shadow:0 16px 40px rgba(0,0,0,.45);
  --safe-bottom: env(safe-area-inset-bottom, 14px);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Poppins,system-ui,Arial;touch-action:manipulation}

/* ====== Header & Tabs ====== */
header{position:sticky;top:0;z-index:60;background:rgba(11,15,21,.88);
  backdrop-filter:blur(6px);padding:12px 16px;border-bottom:1px solid var(--line);
  display:flex;justify-content:space-between;align-items:center}
.brand{font-weight:800;letter-spacing:.2px}
.badge{border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px;opacity:.9}

/* Desktop: tabs arriba (sticky) */
nav.tabs{position:sticky; top:0; background:rgba(15,20,29,.75);
  border:1px solid var(--line); display:flex; gap:8px; padding:8px; border-radius:12px;
  backdrop-filter: blur(6px); z-index:50}
.tab-btn{flex:1 1 0; min-width:110px; height:44px; display:flex; align-items:center;
  justify-content:center; gap:6px; border-radius:999px; font-weight:800; cursor:pointer;
  background:transparent; border:1px solid var(--line); color:var(--ink)}
.tab-btn.active{background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#082532; border-color:transparent}
.hide{display:none!important}

/* ====== Layout ====== */
main{max-width:1100px;margin:16px auto;padding:0 12px;display:grid;gap:12px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
  border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
h2{margin:6px 0 10px;font-size:18px}
h3{margin:14px 0 8px}
label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
input,select,button{font:inherit}
input,select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);
  background:rgba(255,255,255,.02);color:var(--ink)}
input::placeholder{color:#8aa0b3}
button{border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
.btn{background:transparent;border:1px solid var(--line);color:var(--ink)} .btn:hover{filter:brightness(1.08)}
.btnp{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#082532} .btnp:hover{filter:brightness(1.03)}
.btnd{background:linear-gradient(180deg,#ff7a7a,var(--danger));color:#fff}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.row>*{flex:1 1 240px}
.small{font-size:12px}.muted{color:var(--muted)}
.pill{display:inline-block;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);font-size:13px}
.ok{color:#0d3a24;background:#123225;border-color:#256a4b}
.warn{color:#c58b22;background:#2a230f;border-color:#4a3d14}
.error{color:#ffb4b4;background:#2a0f12;border-color:#5d1d24}
.inline-card{display:flex;align-items:center;gap:10px;border:1px solid var(--line);border-radius:12px;padding:8px;background:rgba(255,255,255,.02)}
.avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
.list{display:grid;gap:8px}
.item{border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(255,255,255,.02)}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(72px + var(--safe-bottom));z-index:9999;background:rgba(12,16,22,.96);color:#fff;padding:10px 14px;border-radius:12px;border:1px solid #000;font-weight:700}

/* ====== Mapas ====== */
.map{width:100%;min-height:360px;border-radius:16px;border:1px solid var(--line);overflow:hidden;position:relative}
.map-top{position:absolute; left:10px; right:10px; top:10px; z-index:400; display:none; padding:8px 12px; border-radius:12px; font-weight:800; border:1px solid var(--line); background:rgba(0,0,0,.28); backdrop-filter: blur(4px)}
.map-top.show{display:block}

/* Tema (clases en <body>) */
body.theme-darkblue #mapRide .leaflet-tile,
body.theme-darkblue #mapDriver .leaflet-tile{
  filter: brightness(1.1) contrast(1.15) saturate(1.25) hue-rotate(205deg);
}
body.theme-light #mapRide .leaflet-tile,
body.theme-light #mapDriver .leaflet-tile{ filter:none }

/* Icono auto */
.car-ico{width:38px;height:38px;display:grid;place-items:center;transform: translate(-50%,-50%);}
.car-ico svg{width:32px;height:32px;filter: drop-shadow(0 1px 2px rgba(0,0,0,.6)); transform: rotate(var(--rot,0deg));}

/* ====== Mobile fix: tabs abajo SIEMPRE ====== */
@media (max-width:900px){
  /* Importante: anular el top heredado para que NO quede arriba */
  nav.tabs{
    position:fixed;
    top:auto !important;            /* <- FIX clave */
    bottom:calc(10px + var(--safe-bottom));
    left:12px; right:12px;
    z-index:70;
  }
  body{padding-bottom:calc(110px + var(--safe-bottom))}
  .map{height:calc(100svh - 300px)} /* evita que la barra tape el mapa */
}
@media (min-width:901px){
  .map{height:62vh}
}

/* ====== Subpestañas Ajustes ====== */
.subtabs{display:flex; gap:6px; flex-wrap:wrap; margin:8px 0}
.subtab-btn{flex:1 1 120px; height:40px; display:flex; align-items:center; justify-content:center;
  border-radius:999px; cursor:pointer; font-weight:800; background:transparent; border:1px solid var(--line); color:var(--ink)}
.subtab-btn.active{background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#082532; border-color:transparent}
.settings-pane{display:none}
.settings-pane.active{display:block}
</style>
</head>
<body class="theme-darkblue">
<header>
  <div class="brand">Taxi Ya</div>
  <div id="authPill" class="badge">Sin sesión</div>
</header>

<nav class="tabs" role="tablist">
  <button class="tab-btn active" data-tab="access">Acceso</button>
  <button class="tab-btn hide"   data-tab="ride">Viaje</button>
  <button class="tab-btn hide"   data-tab="history">Historial</button>
  <button class="tab-btn hide"   data-tab="driver">Conductor</button>
  <button class="tab-btn hide"   data-tab="settings">Ajustes</button>
</nav>

<main>
  <!-- ====== ACCESO ====== -->
  <section id="panel-access" class="card">
    <h2>Acceso</h2>
    <div class="row" style="gap:6px;margin-bottom:8px">
      <button class="btnp" id="goLogin">Iniciar sesión</button>
      <button class="btn" id="goRegister">Registrarme</button>
    </div>

    <!-- LOGIN -->
    <div id="loginBox">
      <div class="row">
        <div><label>Correo (o cualquiera para demo)</label><input id="loginEmail" type="email" placeholder="tucorreo@dominio.com" autocomplete="username"></div>
        <div><label>Contraseña</label><input id="loginPass" type="password" placeholder="••••••" autocomplete="current-password"></div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btnp" id="btnSignIn" type="button">Entrar</button>
        <button class="btn"  id="btnResend" type="button">Reenviar verificación</button>
        <button class="btn"  id="btnForgot" type="button">Olvidé mi contraseña</button>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="btnFast" type="button">Entrar rápido (demo)</button>
      </div>
    </div>

    <!-- REGISTRO -->
    <div id="registerBox" class="hide">
      <div class="row">
        <div><label>Nombre</label><input id="regName" placeholder="Tu nombre y apellido"></div>
        <div><label>Correo</label><input id="regEmail" type="email" placeholder="tucorreo@dominio.com"></div>
      </div>
      <div class="row" style="margin-top:6px">
        <div><label>Contraseña</label><input id="regPass" type="password" placeholder="mín. 6" minlength="6"></div>
        <div><label>Foto de perfil (opcional)</label><input id="regPhoto" type="file" accept="image/*"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btnp" id="btnSignUp" type="button">Crear cuenta</button>
      </div>
    </div>

    <div id="msg" class="pill hide" style="margin-top:8px"></div>
  </section>

  <!-- ====== PASAJERO ====== -->
  <section id="panel-ride" class="card hide">
    <h2>Solicitar viaje</h2>

    <div class="row">
      <div><label>Origen</label><input id="riderOrigin" placeholder="Calle y altura o dejar vacío y marcar en mapa"></div>
      <div><label>Destino</label><input id="riderDest" placeholder="Calle y altura o marcar en mapa"></div>
      <div><label>&nbsp;</label><button class="btn" id="btnLocate">Ubicarme</button></div>
    </div>

    <div class="row" style="margin-top:6px">
      <div><label>Tipo</label><select id="reqType"><option value="auto">Auto</option><option value="moto">Moto</option></select></div>
      <div><label>Pago</label><select id="payMethod"><option value="">Elegir…</option><option value="cash">Efectivo</option><option value="mp">Mercado Pago</option></select></div>
      <div><label>Distancia</label><input id="distance" readonly value="0.00 km"></div>
      <div><label>Tarifa</label><input id="fare" readonly value="$0"></div>
    </div>

    <!-- Marcar en mapa -->
    <div class="row" style="margin-top:10px">
      <div style="flex:2 1 320px">
        <label>Marcar en mapa</label>
        <div class="inline-card" role="radiogroup" aria-label="Seleccionar en mapa">
          <label style="display:flex;align-items:center;gap:6px"><input type="radio" name="pick" id="pickNone" value="none" checked/> Ninguno</label>
          <label style="display:flex;align-items:center;gap:6px"><input type="radio" name="pick" id="pickOrigin" value="origin"/> Origen</label>
          <label style="display:flex;align-items:center;gap:6px"><input type="radio" name="pick" id="pickDest" value="dest"/> Destino</label>
        </div>
        <div class="small muted">Tocá el mapa para fijar el punto seleccionado.</div>
      </div>
      <div style="flex:1 1 160px;align-self:flex-end"><button class="btn" id="btnGeoRO">Buscar origen</button></div>
      <div style="flex:1 1 160px;align-self:flex-end"><button class="btn" id="btnGeoRD">Buscar destino</button></div>
      <div style="flex:1 1 160px;align-self:flex-end"><button class="btnp" id="btnUnified" type="button">Pedir viaje</button></div>
      <div style="flex:1 1 120px;align-self:flex-end"><button class="btnd hide" id="btnCancel" type="button">Cancelar</button></div>
    </div>

    <div class="inline-card hide" id="driverCard" style="margin-top:10px">
      <img id="driverAvatar" class="avatar" alt="Conductor">
      <div><b id="driverName">Conductor</b><div class="small muted" id="driverExtra">—</div></div>
    </div>

    <div style="position:relative; margin-top:10px">
      <div id="mapRide" class="map" aria-label="Mapa del pasajero"></div>
      <div id="rideMapTop" class="map-top"></div>
    </div>
  </section>

  <!-- ====== HISTORIAL ====== -->
  <section id="panel-history" class="card hide">
    <h2>Historial</h2>
    <div class="row" style="justify-content:flex-end"><button class="btn" id="btnClearRiderHistory">Limpiar</button></div>
    <div id="riderHistory" class="list" style="margin-top:8px"></div>
  </section>

  <!-- ====== CONDUCTOR ====== -->
  <section id="panel-driver" class="card hide">
    <h2>Conductor</h2>
    <div class="ctrlbar row" style="align-items:center">
      <button class="btnp" id="btnStartRoute" disabled>Iniciar</button>
      <div class="pill" id="onlineTimer">00:00:00</div>
      <div class="row" style="gap:6px;flex:1 1 280px">
        <button class="btn" id="btnPauseRoute" disabled>Pausar</button>
        <button class="btnd" id="btnStopRoute" disabled>Terminar</button>
      </div>
    </div>
    <div style="position:relative">
      <div id="mapDriver" class="map" aria-label="Mapa del conductor"></div>
      <div id="driverMapTop" class="map-top"></div>
    </div>

    <h3>Viajes disponibles</h3>
    <div id="driverAvailable" class="list"></div>

    <h3>Mi viaje activo</h3>
    <div id="driverMyActive" class="list"></div>
  </section>

  <!-- ====== AJUSTES ====== -->
  <section id="panel-settings" class="card hide">
    <h2>Ajustes</h2>
    <div class="subtabs" role="tablist" aria-label="Ajustes">
      <button class="subtab-btn active" data-stab="profile">Perfil</button>
      <button class="subtab-btn" data-stab="prefs">Preferencias</button>
      <button class="subtab-btn" data-stab="roles">Permisos / Roles</button>
      <button class="subtab-btn" data-stab="account">Cuenta</button>
    </div>

    <div id="stab-profile" class="settings-pane active">
      <div class="inline-card">
        <img id="profileAvatar" class="avatar" alt="Avatar">
        <div class="small" id="profileInfo"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label>Nombre para mostrar</label><input id="profileName" placeholder="Tu nombre"/></div>
        <div><label>Foto de perfil</label><input id="profilePhoto" type="file" accept="image/*"/></div>
        <div style="flex:0 0 180px;align-self:flex-end"><button class="btnp" id="btnProfileSave" type="button">Guardar perfil</button></div>
      </div>
    </div>

    <div id="stab-prefs" class="settings-pane">
      <div class="row">
        <div>
          <label>Tema de mapa</label>
          <div class="inline-card">
            <label style="display:flex;align-items:center;gap:6px"><input type="radio" name="mapTheme" value="darkBlue" id="prefThemeDark" checked/> Azul oscuro</label>
            <label style="display:flex;align-items:center;gap:6px;margin-left:14px"><input type="radio" name="mapTheme" value="light" id="prefThemeLight"/> Claro</label>
          </div>
        </div>
      </div>
    </div>

    <div id="stab-roles" class="settings-pane">
      <div class="row" style="gap:6px">
        <button class="btn" id="btnGeoTest" type="button">Probar geolocalización</button>
        <button class="btn" id="btnRiderMode" type="button">Modo Pasajero (demo)</button>
        <button class="btnp" id="btnDriverMode" type="button">Aprobar Conductor (demo)</button>
      </div>
      <div class="row" style="margin-top:8px">
        <span id="drvKycStatus" class="pill warn">No solicitado</span>
      </div>
    </div>

    <div id="stab-account" class="settings-pane">
      <div class="row"><button class="btnd" id="btnSignOut" type="button">Cerrar sesión</button></div>
    </div>
  </section>
</main>

<div id="toast" class="toast hide"></div>

<script type="module">
/* ================= Firebase ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBu523IOGnIZGfAkdlLdVLcENwLgv5KU9o",
  authDomain: "taxi-ya-3be33.firebaseapp.com",
  projectId: "taxi-ya-3be33",
  storageBucket: "taxi-ya-3be33.appspot.com",
  messagingSenderId: "31840475169",
  appId: "1:31840475169:web:1485e47b9ebea4a66c6b60",
  measurementId: "G-2RQRP1G2KB"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
const usersCol = db.collection("users");
const ridesCol = db.collection("rides");

/* ================= Utils ================= */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const normalizeEmail = e => String(e||"").trim().toLowerCase();
const money=n=>new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n||0);
function toast(msg,ms=1700){ const t=$("#toast"); t.textContent=msg; t.classList.remove("hide"); setTimeout(()=>t.classList.add("hide"),ms); }
function pill(el, text, cls){ el.textContent=text; el.className=`pill ${cls||''}`; el.classList.remove('hide'); }
const toRad=d=>d*Math.PI/180;
const km2=(a,b)=>{ const R=6371, dLat=toRad(b.lat-a.lat), dLon=toRad(b.lng-a.lng);
  const la1=toRad(a.lat), la2=toRad(b.lat);
  const h=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(h)); };
const bearing=(a,b)=>{const φ1=toRad(a.lat), φ2=toRad(b.lat), Δλ=toRad(b.lng-a.lng);
  const y=Math.sin(Δλ)*Math.cos(φ2); const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;};
function fmtTime(ms){ const s=Math.floor(ms/1000); const h=String(Math.floor(s/3600)).padStart(2,"0"); const m=String(Math.floor((s%3600)/60)).padStart(2,"0"); const ss=String(s%60).padStart(2,"0"); return `${h}:${m}:${ss}`;}

/* ================= Tabs ================= */
let currentUser=null;
const panels=["access","ride","history","driver","settings"];
function setTab(name){
  panels.forEach(p=>{
    $("#panel-"+p).classList.toggle("hide",p!==name);
    document.querySelector(`[data-tab="${p}"]`).classList.toggle("active",p===name);
  });
  if(name==="ride"){ ensureRideMap(); setTimeout(()=> mapRide.invalidateSize(), 120); }
  if(name==="driver"){ ensureDriverMap(); setTimeout(()=> mapDriver.invalidateSize(), 120); }
  if(name==="settings"){ paintProfile(); }
}
$$('.tabs .tab-btn').forEach(b=> b.addEventListener('click', ()=> setTab(b.dataset.tab)));
$("#goLogin").onclick=()=>{ $("#loginBox").classList.remove("hide"); $("#registerBox").classList.add("hide"); };
$("#goRegister").onclick=()=>{ $("#registerBox").classList.remove("hide"); $("#loginBox").classList.add("hide"); };

/* ===== Subtabs ajustes ===== */
function setSettingsTab(name){
  $$('.subtab-btn').forEach(b=> b.classList.toggle('active', b.dataset.stab===name));
  $$('.settings-pane').forEach(p=> p.classList.toggle('active', p.id==='stab-'+name));
}
$$('.subtab-btn').forEach(b=> b.addEventListener('click', ()=> setSettingsTab(b.dataset.stab)));

/* ================= Tema y Mapas ================= */
let currentTheme = localStorage.getItem("taxiya_theme") || "darkBlue";
document.body.classList.toggle("theme-darkblue", currentTheme==="darkBlue");
document.body.classList.toggle("theme-light", currentTheme==="light");

let mapRide=null, mapDriver=null;
let riderMarkers={origin:null,dest:null,driver:null}, riderLines={o2d:null,drv:null};
let origin=null, dest=null, riderActiveUnsub=null, lastDriverPt=null;

/* Selector de punto en mapa */
let pickMode="none";
$("#pickNone").onchange = e=> { if(e.target.checked) pickMode="none"; };
$("#pickOrigin").onchange= e=> { if(e.target.checked) pickMode="origin"; };
$("#pickDest").onchange  = e=> { if(e.target.checked) pickMode="dest"; };

function tileLayerFor(theme){
  if(theme==="darkBlue"){
    return L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
      {maxZoom:19,subdomains:'abcd',attribution:'© OpenStreetMap © CARTO'});
  }
  return L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
      {maxZoom:19,subdomains:'abcd',attribution:'© OpenStreetMap © CARTO'});
}
function applyMapTheme(map, theme){
  const toRemove=[]; map.eachLayer(l=>{ if(l instanceof L.TileLayer) toRemove.push(l); });
  toRemove.forEach(l=>map.removeLayer(l));
  tileLayerFor(theme).addTo(map);
}
function ensureRideMap(){
  if(mapRide) return;
  mapRide=L.map('mapRide',{zoomControl:false});
  L.control.zoom({position:'bottomright'}).addTo(mapRide);
  applyMapTheme(mapRide, currentTheme);
  mapRide.setView([-31.5375,-68.5364],12);
  mapRide.on('click', async (e)=>{
    if(pickMode==="none") return toast("Elegí Origen o Destino para marcar");
    const pt={lat:e.latlng.lat, lng:e.latlng.lng};
    if(pickMode==="origin"){
      origin=pt; setRideMarker('origin',pt.lat,pt.lng,'Origen');
      $("#riderOrigin").value = `${pt.lat.toFixed(5)}, ${pt.lng.toFixed(5)}`;
    }else{
      dest=pt; setRideMarker('dest',pt.lat,pt.lng,'Destino');
      $("#riderDest").value = `${pt.lat.toFixed(5)}, ${pt.lng.toFixed(5)}`;
    }
    updateEstimate();
    if(origin && dest){
      try{ const c=await routeCoords(origin,dest); drawRideLine('o2d',c); fitRideBounds(); }catch(_){}
    }
  });
}
function ensureDriverMap(){
  if(mapDriver) return;
  mapDriver=L.map('mapDriver',{zoomControl:false});
  L.control.zoom({position:'bottomright'}).addTo(mapDriver);
  applyMapTheme(mapDriver, currentTheme);
  mapDriver.setView([-31.5375,-68.5364],13);
}
window.addEventListener('resize', ()=>{
  mapRide?.invalidateSize();
  mapDriver?.invalidateSize();
}, {passive:true});

/* Rutas */
async function routeCoords(a,b){
  const url=`https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
  const r=await fetch(url); if(!r.ok) throw new Error("OSRM off");
  const j=await r.json(); const rt=j.routes?.[0]; if(!rt) throw new Error("Sin ruta");
  return rt.geometry.coordinates.map(([x,y])=>[y,x]);
}

/* Iconos / helpers */
function carIcon(color="#00b3ff"){
  const svg = `
  <div class="car-ico">
    <svg viewBox="0 0 64 64" aria-hidden="true">
      <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="${color}"/><stop offset="1" stop-color="#5fd2ff"/></linearGradient></defs>
      <rect x="14" y="24" width="36" height="18" rx="6" fill="url(#g)" />
      <path d="M18 24 l7-10 h14 l7 10 z" fill="#0d1b24"/>
      <circle cx="22" cy="44" r="6" fill="#0d1b24"/><circle cx="42" cy="44" r="6" fill="#0d1b24"/>
      <circle cx="22" cy="44" r="2" fill="#9ecbe6"/><circle cx="42" cy="44" r="2" fill="#9ecbe6"/>
      <rect x="20" y="26" width="24" height="8" rx="2" fill="#8ad4ff" opacity=".9"/>
    </svg>
  </div>`;
  return L.divIcon({html:svg, className:'', iconSize:[38,38], iconAnchor:[19,19]});
}
function setCarRotation(marker,deg){ try{ marker.getElement()?.querySelector('.car-ico')?.style.setProperty('--rot', deg+'deg'); }catch(_){ } }
function setRideMarker(kind, lat, lng, label){
  let ico;
  if(kind==='driver'){ ico = carIcon('#ffd34d'); }
  else{
    const bg = kind==='origin' ? '#0f2a22' : '#2a0f12';
    const fg = kind==='origin' ? '#53f0a8' : '#ffb4b4';
    ico = L.divIcon({
      html:`<div class="pill" style="transform:translate(-50%,-50%);background:${bg};color:${fg};border-color:${fg}">${label}</div>`,
      className:'', iconSize:[0,0]
    });
  }
  if(!riderMarkers[kind]) riderMarkers[kind]=L.marker([lat,lng],{icon:ico}).addTo(mapRide);
  else riderMarkers[kind].setLatLng([lat,lng]);
}
function drawRideLine(name, coords){ if(riderLines[name]){ mapRide.removeLayer(riderLines[name]); } riderLines[name]=L.polyline(coords,{weight:5}).addTo(mapRide); }
function fitRideBounds(){ const b=L.latLngBounds([]); Object.values(riderMarkers).forEach(m=>m&&b.extend(m.getLatLng())); if(b.isValid()) mapRide.fitBounds(b,{padding:[24,24]}); }
async function geocode(q){ try{const u=new URL("https://nominatim.openstreetmap.org/search");u.searchParams.set("q",q);u.searchParams.set("format","json");u.searchParams.set("limit","1");const r=await fetch(u,{headers:{'Accept-Language':'es'}}); if(!r.ok) return null; const j=await r.json(); if(!j.length) return null; return {lat:+j[0].lat,lng:+j[0].lon};}catch(_){return null} }
function estimateFareRaw(km){ const base=990, perKm=660, perMin=99; const mins=(km/24)*60; return Math.max(800, Math.round(base + km*perKm + mins*perMin)); }
function updateEstimate(){ const dist=$("#distance"), fare=$("#fare"); if(!origin||!dest){ dist.value="0.00 km"; fare.value="$0"; return; } const km=km2(origin,dest); dist.value=`${km.toFixed(2)} km`; fare.value=money(estimateFareRaw(km)); }

/* Pasajero */
$("#btnGeoRO").addEventListener("click", async ()=>{
  ensureRideMap(); const loc=await geocode($("#riderOrigin").value.trim()); if(!loc) return toast("Origen no encontrado");
  origin=loc; setRideMarker('origin',loc.lat,loc.lng,'Origen'); mapRide.setView([loc.lat,loc.lng],15); updateEstimate();
});
$("#btnGeoRD").addEventListener("click", async ()=>{
  ensureRideMap(); const loc=await geocode($("#riderDest").value.trim()); if(!loc) return toast("Destino no encontrado");
  dest=loc; setRideMarker('dest',loc.lat,loc.lng,'Destino'); mapRide.setView([loc.lat,loc.lng],15); updateEstimate();
  if(origin){ try{ const c=await routeCoords(origin,dest); drawRideLine('o2d',c); fitRideBounds(); }catch(_){ } }
});
$("#btnLocate").addEventListener("click", ()=>{
  if(!navigator.geolocation){ toast("Sin geolocalización"); return; }
  ensureRideMap();
  navigator.geolocation.getCurrentPosition(p=>{
    origin={lat:p.coords.latitude,lng:p.coords.longitude};
    setRideMarker('origin',origin.lat,origin.lng,'Origen'); mapRide.setView([origin.lat,origin.lng],15); updateEstimate();
  }, ()=>toast("No se pudo ubicar (abrí por https)"), {enableHighAccuracy:true,timeout:5000,maximumAge:15000});
});
$("#btnUnified").addEventListener("click", riderCreateRide);
$("#btnCancel").addEventListener("click", ()=>{});
async function riderCreateRide(){
  if(!currentUser) return toast("Iniciá sesión");
  if(!origin||!dest) return toast("Elegí origen y destino");
  const existing = await ridesCol.where("riderId","==", currentUser.uid).where("finished","==", false).limit(1).get().catch(()=>null);
  if(existing && !existing.empty) return toast("Ya tenés un viaje activo");
  const km=km2(origin,dest), fare=estimateFareRaw(km);
  const data={
    riderId: currentUser.uid, riderName: currentUser.displayName || currentUser.email || "Pasajero",
    riderPhotoURL: currentUser.photoURL || "", riderRating: currentUser.rating || 5, riderEmail: currentUser.email || currentUser.emailTyped || "demo@demo",
    originText: $("#riderOrigin").value.trim() || `${origin.lat.toFixed(5)}, ${origin.lng.toFixed(5)}`,
    destText: $("#riderDest").value.trim() || `${dest.lat.toFixed(5)}, ${dest.lng.toFixed(5)}`,
    origin, dest, km, fare, vehicle: $("#reqType").value || "auto",
    payment: {method:$("#payMethod").value||null,status:"pending"},
    driverId: null, reservedBy: null,
    status:"requested", finished:false,
    ts: firebase.firestore.FieldValue.serverTimestamp()
  };
  await ridesCol.add(data);
  toast("Solicitud enviada");
}
function riderAttachActiveRide(){
  if(riderActiveUnsub) riderActiveUnsub();
  riderActiveUnsub = ridesCol.where("riderId","==", auth.currentUser.uid).where("finished","==", false).limit(1)
  .onSnapshot(qs=>{
    if(qs.empty){ $("#driverCard").classList.add("hide"); $("#btnCancel").classList.add("hide"); return; }
    const id=qs.docs[0].id, r=qs.docs[0].data();
    $("#btnCancel").classList.toggle("hide", r.status!=="requested");
    $("#btnCancel").onclick = async()=>{ try{ await ridesCol.doc(id).set({status:"cancelled", finished:true},{merge:true}); }catch(e){ toast(e.message) } };

    $("#rideMapTop").textContent=`${r.originText} → ${r.destText} · ${(r.km||0).toFixed(1)} km · ${money(r.fare||0)}`;
    $("#rideMapTop").classList.add("show"); setTimeout(()=>$("#rideMapTop").classList.remove("show"),1200);

    if(r.driverId){
      $("#driverCard").classList.remove("hide");
      $("#driverName").textContent = `${r.driverName||"Conductor"} — ${money(r.fare)} · ★${(r.driverRating||5).toFixed(1)}`;
      $("#driverAvatar").src = r.driverPhotoURL || "https://i.pravatar.cc/100?img=3";
      $("#driverExtra").textContent = r.status==="accepted"?"En camino al origen": r.status==="arrived"?"Llegó al origen": r.status==="in_trip"?"En viaje": r.status==="completed"?"Finalizado":"—";
    }

    ensureRideMap();
    if(r.origin){ origin=r.origin; setRideMarker('origin',origin.lat,origin.lng,'Origen'); }
    if(r.dest){ dest=r.dest; setRideMarker('dest',dest.lat,dest.lng,'Destino'); }
    (async ()=>{ try{ const c=await routeCoords(origin,dest); drawRideLine('o2d',c); }catch(_){}})();

    if(r.driverLoc){
      const cur={lat:r.driverLoc.latitude,lng:r.driverLoc.longitude};
      setRideMarker('driver',cur.lat,cur.lng,'');
      if(lastDriverPt){ setCarRotation(riderMarkers.driver, bearing(lastDriverPt,cur)); }
      lastDriverPt=cur;
      const target = (r.status==="accepted"||r.status==="arrived")? r.origin : r.dest;
      if(target){
        routeCoords(cur,target).then(coords=>{ drawRideLine('drv',coords); fitRideBounds(); }).catch(()=>{});
      }else{ fitRideBounds(); }
    }
  });
}

/* ================= Conductor ================= */
let driverMarker=null, prevDriverPoint=null;
let activePolylineToPick=null, activePolylineO2D=null;
let driverAvailUnsub=null, driverMineUnsub=null;
let geoWatchId=null, lastPush=0, currentRideId=null;
let online=false, onTimer=null, onStart=null;

function centerOnMeOnce(){
  if(!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(p=>{
    ensureDriverMap();
    const lat=p.coords.latitude,lng=p.coords.longitude;
    if(!driverMarker){
      driverMarker=L.marker([lat,lng],{icon:carIcon('#00b3ff')}).addTo(mapDriver);
    }else driverMarker.setLatLng([lat,lng]);
    mapDriver.setView([lat,lng],14);
  }, ()=>toast("Geo deshabilitada"), {enableHighAccuracy:true,timeout:6000,maximumAge:15000});
}
function startGeoWatch(){
  if(!navigator.geolocation) return;
  if(geoWatchId) navigator.geolocation.clearWatch(geoWatchId);
  geoWatchId = navigator.geolocation.watchPosition(async p=>{
    ensureDriverMap();
    const lat=p.coords.latitude,lng=p.coords.longitude;
    const nowPoint={lat,lng};
    if(!driverMarker){ driverMarker=L.marker([lat,lng],{icon:carIcon('#00b3ff')}).addTo(mapDriver); }
    else{
      if(prevDriverPoint){ setCarRotation(driverMarker, bearing(prevDriverPoint,nowPoint)); }
      driverMarker.setLatLng([lat,lng]);
    }
    prevDriverPoint=nowPoint;
    const now=Date.now();
    if(currentRideId && now-lastPush>2500){
      lastPush=now;
      await ridesCol.doc(currentRideId).set({driverLoc:new firebase.firestore.GeoPoint(lat,lng), driverLocAt: firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
    }
  }, console.warn, {enableHighAccuracy:true, maximumAge:2000, timeout:15000});
}
function stopGeoWatch(){ if(geoWatchId){ navigator.geolocation.clearWatch(geoWatchId); geoWatchId=null; } }

function setOnlineUI(isOnline){
  online=isOnline;
  $("#btnStartRoute").disabled = !currentUser?.approved || online;
  $("#btnPauseRoute").disabled = !currentUser?.approved || !online;
  $("#btnStopRoute").disabled  = !currentUser?.approved || !online;
}
function startTimer(){ onStart=Date.now(); $("#onlineTimer").textContent="00:00:00"; if(onTimer) clearInterval(onTimer); onTimer=setInterval(()=>$("#onlineTimer").textContent=fmtTime(Date.now()-onStart),1000); }
function stopTimer(reset=true){ if(onTimer) clearInterval(onTimer); if(reset) $("#onlineTimer").textContent="00:00:00"; }

async function goOnline(){ await usersCol.doc(auth.currentUser.uid).set({online:true},{merge:true}); setOnlineUI(true); startTimer(); ensureDriverMap(); centerOnMeOnce(); startGeoWatch(); attachDriverStreams(); toast("Conectado"); }
async function pauseOnline(){ await usersCol.doc(auth.currentUser.uid).set({online:false},{merge:true}); setOnlineUI(false); stopTimer(false); stopGeoWatch(); toast("Pausado"); }
async function stopOnline(){ await usersCol.doc(auth.currentUser.uid).set({online:false},{merge:true}); setOnlineUI(false); stopTimer(true); stopGeoWatch(); clearActiveRoute(); $("#driverAvailable").innerHTML=""; $("#driverMyActive").innerHTML=""; toast("Desconectado"); }
$("#btnStartRoute").addEventListener("click", goOnline);
$("#btnPauseRoute").addEventListener("click", pauseOnline);
$("#btnStopRoute").addEventListener("click", stopOnline);

function clearActiveRoute(){ if(activePolylineToPick){ mapDriver.removeLayer(activePolylineToPick); activePolylineToPick=null; } if(activePolylineO2D){ mapDriver.removeLayer(activePolylineO2D); activePolylineO2D=null; } }

/* Vista previa y activo */
async function showRoutePreview(r){
  centerOnMeOnce(); clearActiveRoute();
  if(!driverMarker || !r.origin) return;
  try{
    const cur=driverMarker.getLatLng();
    const toPick = await routeCoords({lat:cur.lat,lng:cur.lng}, r.origin);
    activePolylineToPick = L.polyline(toPick,{weight:5}).addTo(mapDriver);
    if(r.dest){ const o2d = await routeCoords(r.origin, r.dest); activePolylineO2D = L.polyline(o2d,{weight:4,opacity:.6}).addTo(mapDriver); }
    const b=L.latLngBounds([[cur.lat,cur.lng],[r.origin.lat,r.origin.lng]]); if(r.dest) b.extend([r.dest.lat,r.dest.lng]); mapDriver.fitBounds(b,{padding:[24,24]});
    const top=$("#driverMapTop"); top.textContent=`${r.originText} → ${r.destText} · ${(r.km||0).toFixed(1)} km · ${money(r.fare)}`; top.classList.add("show"); setTimeout(()=>top.classList.remove("show"),1600);
  }catch(_){}
}
async function showActiveRoute(r){
  ensureDriverMap(); centerOnMeOnce(); clearActiveRoute();
  if(r.driverLoc){
    const cur={lat:r.driverLoc.latitude,lng:r.driverLoc.longitude};
    if(prevDriverPoint){ setCarRotation(driverMarker, bearing(prevDriverPoint,cur)); }
    driverMarker?.setLatLng([cur.lat,cur.lng]); prevDriverPoint=cur;
  }
  if(r.origin){
    try{
      const from = r.status==="in_trip" ? r.origin : (r.driverLoc? {lat:r.driverLoc.latitude,lng:r.driverLoc.longitude} : null);
      if(from){ const toPick = await routeCoords(from, r.status==="in_trip"? r.dest : r.origin); activePolylineToPick = L.polyline(toPick,{weight:5}).addTo(mapDriver); }
      if(r.dest){ const o2d = await routeCoords(r.origin, r.dest); activePolylineO2D = L.polyline(o2d,{weight:4,opacity:.6}).addTo(mapDriver); }
      const b=L.latLngBounds([]); if(driverMarker) b.extend(driverMarker.getLatLng()); b.extend([r.origin.lat,r.origin.lng]); if(r.dest) b.extend([r.dest.lat,r.dest.lng]); if(b.isValid()) mapDriver.fitBounds(b,{padding:[24,24]});
    }catch(_){}
  }
  const top=$("#driverMapTop"); top.textContent=`${r.originText} → ${r.destText} · ${(r.km||0).toFixed(1)} km · ${money(r.fare||0)}`; top.classList.add("show"); setTimeout(()=>top.classList.remove("show"),1500);
}

/* Aceptar y avanzar */
async function driverAcceptRide(rideId){
  try{
    await db.runTransaction(async tx=>{
      const ref=ridesCol.doc(rideId); const snap=await tx.get(ref);
      if(!snap.exists) throw new Error("El viaje ya no existe");
      const r=snap.data();
      if(r.status!=="requested") throw new Error("Ya fue tomado");
      if(r.reservedBy && r.reservedBy!==auth.currentUser.uid) throw new Error("Reservado por otro conductor");
      tx.update(ref,{
        reservedBy: auth.currentUser.uid,
        reservedAt: firebase.firestore.FieldValue.serverTimestamp(),
        status:"accepted",
        driverId: auth.currentUser.uid,
        driverName: currentUser.displayName || currentUser.email || "Conductor",
        driverPhotoURL: currentUser.photoURL || "",
        driverRating: currentUser.rating || 5
      });
    });
    currentRideId=rideId; toast("Viaje aceptado");
  }catch(e){ toast(e.message); }
}
async function driverAdvance(rideId,next){
  const ord=["requested","accepted","arrived","in_trip","completed"];
  try{
    await db.runTransaction(async tx=>{
      const ref=ridesCol.doc(rideId); const snap=await tx.get(ref); if(!snap.exists) throw new Error("No existe");
      const r=snap.data(); if(ord.indexOf(next)!==ord.indexOf(r.status)+1) throw new Error("Secuencia inválida");
      const upd={status:next}; if(next==="completed") upd.finished=true; tx.update(ref,upd);
    });
    if(next==="completed"){ currentRideId=null; clearActiveRoute(); }
  }catch(e){ toast(e.message); }
}

/* Streams conductor */
function attachDriverStreams(){
  if(driverAvailUnsub) driverAvailUnsub();
  if(driverMineUnsub)  driverMineUnsub();

  if(!online){
    $("#driverAvailable").innerHTML=`<div class="small muted">Presioná “Iniciar”.</div>`;
    $("#driverMyActive").innerHTML=`<div class="small muted">Sin viajes activos.</div>`;
    return;
  }
  ensureDriverMap();

  driverAvailUnsub = ridesCol.where("status","==","requested").limit(60)
  .onSnapshot(qs=>{
    const wrap=$("#driverAvailable"); wrap.innerHTML="";
    if(qs.empty){ wrap.innerHTML=`<div class="small muted">Sin viajes por ahora…</div>`; return; }
    qs.forEach(doc=>{
      const r=doc.data();
      if(r.reservedBy && r.reservedBy!==auth.currentUser.uid) return;
      const item=document.createElement("div"); item.className="item";
      item.innerHTML=`
        <div class="inline-card">
          <img class="avatar" src="${r.riderPhotoURL||'https://i.pravatar.cc/100?img=12'}" alt="Pasajero">
          <div>
            <b>${r.riderName||'Pasajero'}</b> — ${money(r.fare)} · ★${(r.riderRating||5).toFixed(1)}
            <div class="small">${r.originText} → ${r.destText}</div>
            <div class="small muted">${(r.km||0).toFixed(1)} km · ${r.vehicle||'auto'}</div>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn" data-view>Ver ruta</button>
          <button class="btnp" data-accept>Aceptar</button>
        </div>`;
      item.querySelector('[data-view]').onclick=()=> showRoutePreview(r);
      item.querySelector('[data-accept]').onclick=()=> driverAcceptRide(doc.id);
      wrap.appendChild(item);
    });
  });

  driverMineUnsub = ridesCol.where("driverId","==", auth.currentUser.uid).where("finished","==",false)
  .onSnapshot(qs=>{
    const wrap=$("#driverMyActive"); wrap.innerHTML="";
    if(qs.empty){ currentRideId=null; wrap.innerHTML=`<div class="small muted">Sin viajes activos.</div>`; clearActiveRoute(); return; }
    qs.forEach((doc,i)=>{
      const r=doc.data(); if(i===0){ currentRideId=doc.id; showActiveRoute(r); }
      const order=["requested","accepted","arrived","in_trip","completed"];
      const can=n=> order.indexOf(n)===order.indexOf(r.status)+1;
      const item=document.createElement("div"); item.className="item";
      item.innerHTML=`
        <div class="inline-card">
          <img class="avatar" src="${r.riderPhotoURL||'https://i.pravatar.cc/100?img=12'}" alt="Pasajero">
          <div>
            <b>${r.riderName||'Pasajero'}</b> — ${money(r.fare)} · ★${(r.riderRating||5).toFixed(1)}
            <div class="small">${r.originText} → ${r.destText}</div>
            <div class="small muted">${(r.km||0).toFixed(1)} km · Estado: <b>${r.status}</b></div>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn${can('arrived')?' btnp':''}" data-next="arrived" ${can('arrived')?'':'disabled'}>Llegué</button>
          <button class="btn${can('in_trip')?' btnp':''}" data-next="in_trip" ${can('in_trip')?'':'disabled'}>Iniciar</button>
          <button class="btn${can('completed')?' btnp':''}" data-next="completed" ${can('completed')?'':'disabled'}>Finalizar</button>
        </div>`;
      item.querySelectorAll('[data-next]').forEach(b=> b.onclick=()=> driverAdvance(doc.id,b.dataset.next));
      wrap.appendChild(item);
    });
  });
}

/* ================= Ajustes / Sesión ================= */
function paintProfile(){
  const el=$("#profileInfo"), av=$("#profileAvatar"); if(!currentUser){ el.textContent="Sin sesión"; av.src=""; return; }
  av.src=currentUser.photoURL||"https://i.pravatar.cc/100?u="+(currentUser.uid||'placeholder');
  const tagDemo = currentUser.demo ? " (demo)" : "";
  el.innerHTML=`Nombre: <b>${currentUser.displayName||"—"}</b> · Correo: <b>${currentUser.email||currentUser.emailTyped||"—"}</b>${tagDemo}<br>Rol: <b>${currentUser.role||'rider'}</b> · KYC: <b>${currentUser.approved?'Aprobado':'No'}</b>`;
  $("#profileName").value = currentUser.displayName||"";
  $("#prefThemeDark").checked = (currentTheme==="darkBlue");
  $("#prefThemeLight").checked = (currentTheme==="light");
}
function refreshTabs(){
  const logged=!!currentUser;
  document.querySelector(`[data-tab="access"]`).classList.toggle("hide", logged);
  document.querySelector(`[data-tab="ride"]`).classList.toggle("hide", !logged);
  document.querySelector(`[data-tab="history"]`).classList.toggle("hide", !logged);
  document.querySelector(`[data-tab="driver"]`).classList.toggle("hide", !(logged && currentUser.approved));
  document.querySelector(`[data-tab="settings"]`).classList.toggle("hide", !logged);
  $("#btnStartRoute").disabled = !(logged && currentUser.approved);
  $("#drvKycStatus").className = "pill " + (currentUser?.approved?"ok":"warn");
  $("#drvKycStatus").textContent = currentUser?.approved?"Aprobado":"No solicitado";
  const labelEmail = currentUser?.email || currentUser?.emailTyped || "";
  $("#authPill").textContent = logged ? `${currentUser.displayName||labelEmail||'Usuario'} — ${(currentUser.role||'rider')}${currentUser.approved?' (KYC✓)':''}${currentUser.demo?' (demo)':''}` : "Sin sesión";
  setTab(logged ? "ride" : "access");
}
function setTheme(theme){
  currentTheme = theme;
  localStorage.setItem("taxiya_theme", theme);
  document.body.classList.toggle("theme-darkblue", theme==="darkBlue");
  document.body.classList.toggle("theme-light", theme==="light");
  if(mapRide) applyMapTheme(mapRide, theme);
  if(mapDriver) applyMapTheme(mapDriver, theme);
  setTimeout(()=>{ mapRide?.invalidateSize(); mapDriver?.invalidateSize(); }, 80);
}

/* compresión de imagen */
function compressImage(file, maxBytes=900*1024, maxW=512){
  return new Promise((resolve,reject)=>{
    const img=new Image(), rdr=new FileReader();
    rdr.onload=e=>{ img.src=e.target.result; };
    img.onload=()=>{
      const scale=Math.min(1, maxW/img.width);
      const w=Math.round(img.width*scale), h=Math.round(img.height*scale);
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
      let q=0.92, out;
      do{ out=c.toDataURL('image/jpeg', q); q-=0.07; }while(out.length>maxBytes && q>0.35);
      resolve(out);
    };
    img.onerror=reject; rdr.readAsDataURL(file);
  });
}
async function emailExists(email){
  try{ const m=await auth.fetchSignInMethodsForEmail(email); return Array.isArray(m)&&m.length>0; }catch(_){ return false; }
}

/* Registro/Login */
$("#btnSignUp").addEventListener("click", async ()=>{
  const name = $("#regName").value.trim();
  const email = normalizeEmail($("#regEmail").value);
  const pass = $("#regPass").value;
  const file = $("#regPhoto").files[0];

  if(!name || !email || pass.length<6){
    pill($("#msg"), "Completá nombre, correo y contraseña (mín. 6).", "error");
    return;
  }
  try{
    if(await emailExists(email)){
      $("#goLogin").click(); $("#loginEmail").value = email;
      pill($("#msg"), "Ese correo ya está registrado. Iniciá sesión o usá “Entrar rápido (demo)”.", "warn");
      return;
    }
    const { user } = await auth.createUserWithEmailAndPassword(email, pass);
    if(name) await user.updateProfile({ displayName: name });

    let photoURL = "https://i.pravatar.cc/100?u="+user.uid;
    if(file){ try{ photoURL = await compressImage(file); }catch(_){} }

    await usersCol.doc(user.uid).set({
      uid: user.uid, email: user.email, displayName: name || (email.split('@')[0]),
      photoURL, role: "rider", approved: false, online: false, demo: false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    pill($("#msg"), "Cuenta creada y sesión iniciada. ¡Listo!", "ok");
    setTab("ride");
  }catch(e){
    const code=e?.code||"";
    if(code==="auth/invalid-email") pill($("#msg"), "Correo inválido.", "error");
    else if(code==="auth/weak-password") pill($("#msg"), "La contraseña es muy débil.", "error");
    else{ pill($("#msg"), "No se pudo crear la cuenta.", "error"); console.error(e); }
  }
});
$("#btnResend").addEventListener("click", async ()=>{
  const email = normalizeEmail($("#loginEmail").value);
  const pass  = $("#loginPass").value;
  if(!email || !pass){ pill($("#msg"), "Completá email y contraseña para reenviar verificación.", "warn"); return; }
  try{
    const { user } = await auth.signInWithEmailAndPassword(email, pass);
    await user.sendEmailVerification(); await auth.signOut();
    pill($("#msg"), "Verificación reenviada. Revisá tu correo.", "ok");
  }catch(e){
    const code=e?.code||"";
    if(code==="auth/user-not-found") pill($("#msg"), "Ese correo no tiene cuenta. Registrate o usá “Entrar rápido (demo)”.", "warn");
    else if(code==="auth/wrong-password" || code==="auth/invalid-credential") pill($("#msg"), "Correo o contraseña incorrectos.", "error");
    else pill($("#msg"), "No se pudo reenviar la verificación.", "error");
  }
});
$("#btnForgot").addEventListener("click", async ()=>{
  const email = normalizeEmail($("#loginEmail").value);
  if(!email) return pill($("#msg"),"Escribí tu correo para enviar el enlace.","warn");
  try{ await auth.sendPasswordResetEmail(email); pill($("#msg"),"Te envié un correo para restablecer la contraseña.","ok"); }
  catch(_){ pill($("#msg"),"No se pudo enviar el correo. Verificá el email.","error"); }
});
$("#btnSignIn").addEventListener("click", async ()=>{
  const email = normalizeEmail($("#loginEmail").value);
  const pass  = $("#loginPass").value;
  try{ await auth.signInWithEmailAndPassword(email, pass); }
  catch(e){
    const code=e?.code||"";
    if(code==="auth/user-not-found") pill($("#msg"), "No existe una cuenta con ese correo. Registrate o usá “Entrar rápido (demo)”.", "warn");
    else if(code==="auth/wrong-password" || code==="auth/invalid-credential") pill($("#msg"), "Correo o contraseña incorrectos.", "error");
    else pill($("#msg"), "No se pudo iniciar sesión.", "error");
  }
});
$("#btnFast").addEventListener("click", async ()=>{
  const emailTyped = $("#loginEmail").value.trim() || `demo-${Date.now()}@demo.local`;
  try{
    const cred = await auth.signInAnonymously();
    const u = cred.user;
    const displayName = emailTyped.split('@')[0];
    const photoURL = "https://i.pravatar.cc/100?u="+u.uid;
    await usersCol.doc(u.uid).set({
      uid: u.uid, emailTyped, displayName, photoURL, role:"rider", approved:false,
      online:false, demo:true, createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
  }catch(_){ pill($("#msg"), "No se pudo entrar en modo demo.", "error"); }
});

/* Ajustes */
$("#btnProfileSave").addEventListener("click", async ()=>{
  if(!auth.currentUser) return toast("Iniciá sesión");
  const name = $("#profileName").value.trim();
  const file = $("#profilePhoto").files[0];
  let photoURL = currentUser.photoURL || "https://i.pravatar.cc/100?u="+auth.currentUser.uid;
  if(file){ try{ photoURL = await compressImage(file); }catch(_){ } }
  try{
    if(name) await auth.currentUser.updateProfile({displayName:name});
    await usersCol.doc(auth.currentUser.uid).set({displayName:name||currentUser.displayName, photoURL},{merge:true});
    currentUser.displayName = name || currentUser.displayName;
    currentUser.photoURL = photoURL;
    paintProfile();
    toast("Perfil guardado");
  }catch(e){ toast("No se pudo guardar"); }
});
$("#prefThemeDark").addEventListener("change", e=>{ if(e.target.checked) setTheme("darkBlue"); });
$("#prefThemeLight").addEventListener("change", e=>{ if(e.target.checked) setTheme("light"); });

$("#btnGeoTest").addEventListener("click", ()=>{
  if(!navigator.geolocation) return toast("Tu dispositivo no ofrece geolocalización");
  navigator.geolocation.getCurrentPosition(
    p=>toast(`OK: ${p.coords.latitude.toFixed(4)}, ${p.coords.longitude.toFixed(4)}`),
    ()=>toast("Permiso denegado o error"),
    {enableHighAccuracy:true,timeout:6000,maximumAge:0}
  );
});
$("#btnDriverMode").addEventListener("click", async ()=>{
  if(!auth.currentUser) return toast("Iniciá sesión");
  await usersCol.doc(auth.currentUser.uid).set({role:"driver",approved:true},{merge:true});
  currentUser.role="driver"; currentUser.approved=true;
  refreshTabs(); setTab("driver"); toast("Conductor aprobado (demo)");
});
$("#btnRiderMode").addEventListener("click", async ()=>{
  if(!auth.currentUser) return toast("Iniciá sesión");
  await usersCol.doc(auth.currentUser.uid).set({role:"rider",approved:false,online:false},{merge:true});
  currentUser.role="rider"; currentUser.approved=false;
  stopOnline(); refreshTabs(); setTab("ride"); toast("Volviste a Pasajero (demo)");
});
$("#btnSignOut").addEventListener("click", ()=> auth.signOut().catch(e=>toast(e.message)));

auth.onAuthStateChanged(async (u)=>{
  if(!u){
    currentUser=null; paintProfile(); refreshTabs();
    if(riderActiveUnsub) riderActiveUnsub();
    if(driverAvailUnsub) driverAvailUnsub();
    if(driverMineUnsub)  driverMineUnsub();
    return;
  }
  const ref=usersCol.doc(u.uid);
  const snap=await ref.get();
  if(!snap.exists){
    await ref.set({
      uid:u.uid,
      email: u.email || null,
      emailTyped: u.isAnonymous ? ($("#loginEmail").value.trim() || null) : null,
      displayName: u.displayName || (u.email ? u.email.split('@')[0] : 'Invitado'),
      photoURL: "https://i.pravatar.cc/100?u="+u.uid,
      role:"rider", approved:false, online:false,
      demo: u.isAnonymous===true,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
  }
  currentUser=(await ref.get()).data();
  paintProfile(); refreshTabs();
  ensureRideMap(); riderAttachActiveRide();
});

/* Historial local */
function renderHistory(){
  if(!currentUser) return; const key=`taxiya_rider_history_${currentUser.uid}`; let list=[]; try{list=JSON.parse(localStorage.getItem(key)||"[]");}catch(_){}
  const wrap=$("#riderHistory"); wrap.innerHTML=""; if(!list.length) wrap.innerHTML=`<div class="small muted">Sin viajes.</div>`;
}
$("#btnClearRiderHistory").addEventListener("click", ()=>{ if(!currentUser) return; localStorage.setItem(`taxiya_rider_history_${currentUser.uid}`,"[]"); renderHistory(); toast("OK"); });
</script>
</body>
</html>
