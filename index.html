<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Taxi Ya</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0a0a; --panel:#121317; --ink:#ffffff; --muted:#b7c2cc; --line:#1e2733;
  --accent:#ffd34d; --accent-2:#7dd3fc; --danger:#ef4444; --ok:#22c55e; --link:#8ee6f4;
  --radius:16px; --shadow:0 16px 40px rgba(0,0,0,.45); --tabH:64px;
}
:root.light{
  --bg:#ffffff; --panel:#f6f8fb; --ink:#0b0b0b; --muted:#485563; --line:#dfe7ef;
  --accent:#0ea5e9; --accent-2:#22c55e; --danger:#dc2626; --ok:#16a34a; --link:#0ea5e9;
  --shadow:0 16px 40px rgba(0,0,0,.12);
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Poppins,system-ui,Arial}
a{color:var(--link)} .hide{display:none!important}
header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(0,0,0,.65),rgba(0,0,0,.35));border-bottom:1px solid var(--line);
  padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
:root.light header{background:linear-gradient(180deg,#ffffff,#f4f7fb)}
.brand{font-weight:800}
.badge{display:inline-block;background:transparent;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px;opacity:.85}
nav.tabs{position:sticky; top:0; z-index:25; background:var(--panel); border-bottom:1px solid var(--line);
  display:flex; gap:8px; padding:8px; justify-content:center; flex-wrap:wrap}
.tab-btn{flex:0 0 auto; min-width:140px; height:44px; display:flex; align-items:center; justify-content:center; gap:8px;
  padding:10px 14px; border-radius:999px; font-weight:700; cursor:pointer; background:transparent; border:1px solid var(--line)}
.tab-btn.active{background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#0b2d37; border-color:transparent}
@media (max-width:900px){
  nav.tabs{position:fixed; bottom:0; left:0; right:0; border-top:1px solid var(--line); padding:6px env(safe-area-inset-left) calc(6px + env(safe-area-inset-bottom)) env(safe-area-inset-right)}
  body{padding-bottom:calc(var(--tabH) + 8px)}
  .tab-btn{flex:1 1 0; min-width:0}
}
main{max-width:1200px;margin:14px auto;padding:0 10px;display:grid;gap:12px}
.grid{display:grid;grid-template-columns:420px 1fr;gap:12px}
@media (max-width:900px){ .grid{grid-template-columns:1fr} }
.card{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;border:1px solid var(--line)}
h2{margin:6px 0 10px;font-size:18px}
label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
input,select,button,textarea{font-family:inherit;font-size:14px}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:12px;background:transparent;color:var(--ink)}
input::placeholder,textarea::placeholder{color:rgba(127,143,159,.7)}
button{border:0;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer}
.btn{background:transparent;border:1px solid var(--line)} .btn:hover{filter:brightness(1.08)}
.btnp{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#0b2d37}.btnp:hover{filter:brightness(1.05)}
.btnd{background:linear-gradient(180deg,#ff6262,#ef4444);color:#fff}
.row{display:flex;gap:8px;align-items:center}.row>*{flex:1}
.split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:560px){ .split{grid-template-columns:1fr} }
.small{font-size:12px}.muted{color:var(--muted)}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:transparent;font-size:12px}
.ok{color:#062e25;background:#0f2a22;border-color:#144a3d}
.warn{color:#3b2b06;background:#2a230f;border-color:#4a3d14}
.error{color:#ffb4b4;background:#2a0f12;border-color:#5d1d24}
.map{width:100%;height:64vh;min-height:360px;border-radius:16px;border:1px solid var(--line);overflow:hidden;position:relative}
.map-top{position:absolute; left:10px; right:10px; top:10px; z-index:400; display:none; padding:8px 12px; border-radius:12px; font-weight:700; border:1px solid var(--line); background:rgba(0,0,0,.25); backdrop-filter: blur(4px)}
.map-top.show{display:block}
.list{display:grid;gap:8px}
.item{border:1px solid var(--line);border-radius:12px;padding:10px;background:transparent}
.item h4{margin:0 0 6px 0;font-size:14px}
.av{width:32px;height:32px;border-radius:999px;object-fit:cover;border:1px solid var(--line)}
.docgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-top:10px}
</style>
</head>
<body>
<header>
  <div class="brand">Taxi Ya üöï</div>
  <div id="authPill" class="badge">Sin sesi√≥n</div>
</header>

<nav class="tabs" role="tablist">
  <button class="tab-btn active" data-tab="access" id="tab-access">üîê Acceso</button>
  <button class="tab-btn hide"   data-tab="ride"   id="tab-ride">üöï Viaje</button>
  <button class="tab-btn hide"   data-tab="history"id="tab-history">üßæ Historial</button>
  <button class="tab-btn hide"   data-tab="driver" id="tab-driver">üßë‚Äç‚úàÔ∏è Conductor</button>
  <button class="tab-btn hide"   data-tab="settings"id="tab-settings">‚öôÔ∏è Ajustes</button>
</nav>

<main id="appRoot">
  <!-- ACCESO -->
  <section id="panel-access" class="card" role="tabpanel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Acceso</h2>
      <div class="row" style="justify-content:flex-end; gap:8px">
        <button class="btn" id="btnResetAll" type="button">Limpiar datos</button>
      </div>
    </div>
    <div id="msg" class="pill hide" role="status" aria-live="polite"></div>

    <div class="row" style="margin-top:6px">
      <button class="btnp" id="switchToLogin" type="button">Ir a Iniciar sesi√≥n</button>
      <button class="btn"  id="switchToRegister" type="button">Ir a Registrarme</button>
    </div>

    <!-- Login -->
    <form id="loginBox" style="margin-top:10px" autocomplete="on" novalidate>
      <div class="row">
        <div><label for="loginEmail">Correo</label><input id="loginEmail" type="email" placeholder="tucorreo@dominio.com" autocomplete="username" required></div>
        <div><label for="loginPass">Contrase√±a</label><input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" required></div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btnp" id="btnSignIn" type="submit">Entrar</button>
      </div>
    </form>

    <!-- Registro (con FOTO) -->
    <form id="registerBox" class="hide" style="margin-top:10px" autocomplete="on" novalidate>
      <div class="split">
        <div><label for="regName">Nombre</label><input id="regName" placeholder="Tu nombre y apellido" autocomplete="name" required></div>
        <div><label for="regEmail">Correo</label><input id="regEmail" type="email" placeholder="tucorreo@dominio.com" autocomplete="username" required></div>
      </div>
      <div class="split" style="margin-top:6px">
        <div><label for="regPass">Contrase√±a</label><input id="regPass" type="password" placeholder="m√≠n. 6" autocomplete="new-password" minlength="6" required></div>
        <div><label for="regAvatar">Foto de perfil</label><input id="regAvatar" type="file" accept="image/*"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btnp" id="btnSignUp" type="submit">Crear cuenta</button>
      </div>
    </form>
  </section>

  <!-- VIAJE -->
  <section id="panel-ride" class="grid card hide" role="tabpanel">
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Solicitar viaje</h2>
      </div>

      <div class="split">
        <div>
          <label for="riderOrigin">Origen üìç</label>
          <input id="riderOrigin" placeholder="Calle y altura">
        </div>
        <div>
          <label for="riderDest">Destino üéØ</label>
          <input id="riderDest" placeholder="Calle y altura">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnGeoRO" type="button">Buscar Origen</button>
        <button class="btn" id="btnGeoRD" type="button">Buscar Destino</button>
        <button class="btn" id="btnLocate" type="button">Ubicarme</button>
      </div>

      <div class="split" style="margin-top:10px">
        <div><label for="distance">Distancia</label><input id="distance" readonly value="0.00 km"></div>
        <div><label for="fare">Tarifa estimada</label><input id="fare" readonly value="$0"></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btnp" id="btnRequest" type="button">üöï Pedir viaje</button>
        <button class="btnd hide" id="btnCancel" type="button">Cancelar</button>
      </div>

      <div id="searchStatus" class="small muted hide" style="margin-top:6px">
        <b>Esperando conductor‚Ä¶</b> <span id="waitSecs">0</span>s
      </div>

      <div id="riderAssignedBox" class="item hide" style="margin-top:10px">
        <h4>Conductor asignado</h4>
        <div class="row" style="align-items:center">
          <img id="drvAvSmall" class="av" src="" alt="Conductor">
          <div style="flex:4">
            <div class="small">Nombre: <b id="drvNameSmall">‚Äî</b></div>
            <div class="small">Veh√≠culo: <b id="drvCarSmall">‚Äî</b></div>
            <div class="small">Estado: <b id="riderRideState">‚Äî</b></div>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="position:relative">
      <div id="mapRide" class="map" aria-label="Mapa de viaje"></div>
      <div id="rideMapTop" class="map-top"></div>
    </section>
  </section>

  <!-- HISTORIAL -->
  <section id="panel-history" class="card hide" role="tabpanel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Historial</h2>
      <div class="row" style="justify-content:flex-end; gap:8px">
        <button class="btn" id="btnClearRiderHistory" type="button">Limpiar</button>
      </div>
    </div>
    <div id="riderHistory" class="list"></div>
  </section>

  <!-- CONDUCTOR -->
  <section id="panel-driver" class="card hide" role="tabpanel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Panel del conductor</h2>
    </div>

    <div class="item">
      <h4>Viajes disponibles</h4>
      <div id="driverQueue" class="list"></div>
      <div class="small muted">Se listan las solicitudes creadas por pasajeros. (Demo local)</div>
    </div>

    <div class="item" style="margin-top:10px">
      <h4>Mi viaje activo</h4>
      <div id="drvActiveInfo" class="small muted">Sin viaje activo.</div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="btnStartRoute" type="button" disabled>Iniciar</button>
        <button class="btn" id="btnPauseRoute" type="button" disabled>Pausar</button>
        <button class="btnd" id="btnStopRoute" type="button" disabled>Terminar</button>
      </div>
      <div id="mapDriver" class="map" style="margin-top:8px" aria-label="Mapa del conductor"></div>
    </div>
  </section>

  <!-- AJUSTES -->
  <section id="panel-settings" class="card hide" role="tabpanel">
    <h2>Ajustes</h2>
    <div class="list">
      <div class="item">
        <h4>Perfil</h4>
        <div id="profileInfo" class="small"></div>
        <div class="row" style="margin-top:8px"><button class="btn" id="btnSignOut" type="button">Cerrar sesi√≥n</button></div>
      </div>
      <div class="item">
        <h4>Tema</h4>
        <label><input type="checkbox" id="themeToggle"> Tema Claro</label>
      </div>
      <div class="item">
        <h4>Verificaci√≥n para ser conductor</h4>
        <p class="small muted">La pesta√±a ‚ÄúConductor‚Äù se habilita cuando la verificaci√≥n est√° <b>aprobada</b>.</p>
        <div class="row" style="margin-top:6px">
          <button class="btnp" id="btnVerifySubmit" type="button">Solicitar verificaci√≥n</button>
          <span id="drvKycStatus" class="pill warn">No solicitado</span>
        </div>
        <div id="verifyMsg" class="pill hide" style="margin-top:8px"></div>
      </div>
    </div>
  </section>
</main>

<div id="toast" class="pill hide" style="position:fixed;left:50%;transform:translateX(-50%);bottom:90px;z-index:9999;background:rgba(0,0,0,.85);color:#fff"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
/* ===== Helpers & storage ===== */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const money=n=>new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n||0);
const toRad=d=>d*Math.PI/180;
const km2=(a,b)=>{const R=6371,dLat=toRad(b.lat-a.lat),dLon=toRad(b.lng-a.lng);const la1=toRad(a.lat),la2=toRad(b.lat);const h=Math.sin(dLat/2)**2+Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;return 2*R*Math.asin(Math.sqrt(h));};
const storeKey="taxiya_users_by_email", sessionKey="taxiya_session";
const riderHistKey=e=>`taxiya_rider_history_${e}`;
const ridesKey="taxiya_open_rides"; // cola de viajes disponibles
const activeRideKey=e=>`taxiya_active_ride_${e}`; // por usuario/rol
const themeKey="taxiya_theme";

const loadUsers=()=>{ try{return JSON.parse(localStorage.getItem(storeKey)||"{}");}catch(_){return{};} };
const saveUsers=db=>localStorage.setItem(storeKey,JSON.stringify(db));
const saveSession=u=>localStorage.setItem(sessionKey,JSON.stringify(u));
const loadSession=()=>{ try{return JSON.parse(localStorage.getItem(sessionKey)||"null");}catch(_){return null;} };
const clearSession=()=>localStorage.removeItem(sessionKey);
const loadArr=k=>{ try{return JSON.parse(localStorage.getItem(k)||"[]");}catch(_){return[];} };
const saveArr=(k,arr)=>localStorage.setItem(k,JSON.stringify(arr));
const loadObj=k=>{ try{return JSON.parse(localStorage.getItem(k)||"null");}catch(_){return null;} };
const saveObj=(k,o)=>localStorage.setItem(k,JSON.stringify(o));
function toast(msg,ms=1600){ const t=$("#toast"); t.textContent=msg; t.classList.remove("hide"); setTimeout(()=>t.classList.add("hide"),ms); }
function cryptoId(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
function readFileAsDataURL(file){ return new Promise(res=>{ if(!file) return res(""); const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(file); }); }

/* ===== Tema ===== */
function applyTheme(){ const t=localStorage.getItem(themeKey)||"dark"; document.documentElement.classList.toggle("light", t==="light"); $("#themeToggle").checked=(t==="light"); }
$("#themeToggle").addEventListener("change",e=>{ localStorage.setItem(themeKey, e.target.checked?"light":"dark"); applyTheme(); });
applyTheme();

/* ===== Tabs ===== */
let currentUser=null;
const tabs={access:$("#panel-access"), ride:$("#panel-ride"), history:$("#panel-history"), driver:$("#panel-driver"), settings:$("#panel-settings")};
function setActiveTab(name){ for(const [k,p] of Object.entries(tabs)){ p.classList.toggle("hide", k!==name); $(`#tab-${k}`)?.classList.toggle("active", k===name); } if(name==="ride"){ initRideMap(); } if(name==="driver"){ initDriverMap(); paintDriverQueue(); } if(name==="settings"){ paintProfile(); paintKycUI(); } }
["access","ride","history","driver","settings"].forEach(k=> $(`#tab-${k}`).addEventListener("click",()=>setActiveTab(k)));
function refreshTabVisibility(){
  const logged=!!currentUser;
  $("#tab-access").classList.toggle("hide", logged);
  $("#tab-ride").classList.toggle("hide", !logged);
  $("#tab-history").classList.toggle("hide", !logged);
  $("#tab-settings").classList.toggle("hide", !logged);
  const kycOk= logged && currentUser.kyc?.status==="approved";
  $("#tab-driver").classList.toggle("hide", !kycOk);
  if(!logged) setActiveTab("access");
}

/* ===== Mapa Ride (Pasajero) ===== */
let mapRide=null, markersRide={origin:null,dest:null,driver:null}, riderState="sin_conductor";
function initRideMap(){ if(mapRide) return; mapRide=L.map('mapRide',{zoomControl:false}); L.control.zoom({position:'bottomright'}).addTo(mapRide); L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(mapRide); mapRide.setView([-31.5375,-68.5364],12); }
function setMarker(kind, lat, lng, label){
  const icon = undefined; // default marker
  if(!markersRide[kind]){ markersRide[kind]=L.marker([lat,lng],{icon}).addTo(mapRide).bindTooltip(label); }
  markersRide[kind].setLatLng([lat,lng]);
}
function fitRideBounds(){ const pts=[]; ["origin","dest","driver"].forEach(k=>{ if(markersRide[k]) pts.push(markersRide[k].getLatLng()); }); if(pts.length>=2){ mapRide.fitBounds(L.latLngBounds(pts),{padding:[40,40]}); }}

/* ===== Geocoder (Nominatim simple) ===== */
async function geocode(text){
  try{
    const url=new URL("https://nominatim.openstreetmap.org/search");
    url.searchParams.set("q",text); url.searchParams.set("format","json"); url.searchParams.set("limit","1");
    const r=await fetch(url,{headers:{'Accept-Language':'es','User-Agent':'taxiya-demo'}});
    if(!r.ok) return null; const js=await r.json(); if(!js.length) return null;
    return {lat:parseFloat(js[0].lat), lng:parseFloat(js[0].lon)};
  }catch(_){ return null; }
}

/* ===== Estimaci√≥n ===== */
function estimateFareRaw(km){ const base=990, perKm=660, perMin=99; const mins=(km/24)*60; return Math.max(800, Math.round(base + km*perKm + mins*perMin)); }

/* ===== Cola de Viajes (local) ===== */
function listOpenRides(){ return loadArr(ridesKey); }
function pushOpenRide(ride){ const arr=listOpenRides(); arr.push(ride); saveArr(ridesKey, arr); }
function updateOpenRide(r){ const arr=listOpenRides().map(x=>x.id===r.id?r:x); saveArr(ridesKey,arr); }

/* ===== Registro / Login ===== */
function normEmail(e){ return (e||"").trim().toLowerCase(); }
async function signUp({name,email,pass,avatarFile}){
  email=normEmail(email); if(!name) return {ok:false,msg:"Ingres√° tu nombre."};
  if(!email||!pass) return {ok:false,msg:"Correo y contrase√±a requeridos."};
  if(pass.length<6) return {ok:false,msg:"La contrase√±a debe tener al menos 6 caracteres."};
  const db=loadUsers(); if(db[email]) return {ok:false,msg:"El correo ya existe."};
  const avatar = await readFileAsDataURL(avatarFile);
  const user={uid:cryptoId(),name,email,pass,role:"rider",createdAt:Date.now(),kyc:{status:"none"},avatar};
  db[email]=user; saveUsers(db); saveSession(user); currentUser=user; return {ok:true,msg:"Cuenta creada."};
}
function signIn({email,pass}){ email=normEmail(email); if(!email||!pass) return {ok:false,msg:"Ingres√° correo y contrase√±a."};
  const db=loadUsers(); const u=db[email]; if(!u) return {ok:false,msg:"Usuario no encontrado."};
  if(u.pass!==pass) return {ok:false,msg:"Contrase√±a incorrecta."}; saveSession(u); currentUser=u; return {ok:true,msg:"Sesi√≥n iniciada."}; }

function paintAuth(){ $("#authPill").textContent=currentUser ? `${(currentUser.name||currentUser.email)} ‚Äî ${currentUser.role}${currentUser.kyc?.status==="approved"?" (KYC‚úì)":""}` : "Sin sesi√≥n"; }
function paintProfile(){ const el=$("#profileInfo"); if(!currentUser){ el.innerHTML="No hay sesi√≥n."; return; } const av=currentUser.avatar?`<img class="av" src="${currentUser.avatar}" style="width:44px;height:44px;margin-right:8px">`:""; el.innerHTML=`<div style="display:flex;align-items:center;gap:8px">${av}<div>Nombre: <b>${currentUser.name||"‚Äî"}</b> ¬∑ Correo: <b>${currentUser.email}</b><br>Rol: <b>${currentUser.role}</b> ¬∑ KYC: <b>${kycText(currentUser.kyc?.status||"none")}</b></div></div>`; }
function kycText(s){ return s==="approved"?"Aprobado": s==="pending"?"Pendiente":"No solicitado"; }
function paintKycUI(){ const st=currentUser?.kyc?.status||"none"; const pill=$("#drvKycStatus"); pill.textContent=kycText(st); pill.className="pill "+(st==="approved"?"ok":"warn"); }
function signOut(){ clearSession(); currentUser=null; paintAuth(); refreshTabVisibility(); setActiveTab("access"); showLogin(); toast("Sesi√≥n cerrada"); }
$("#btnSignOut").addEventListener("click", signOut);

/* ===== Acceso UI ===== */
function banner(text,type="warn"){ const el=$("#msg"); el.textContent=text; el.className=`pill ${type}`; el.classList.remove("hide"); }
function hideBanner(){ $("#msg").className="pill hide"; }
function showLogin(){ $("#loginBox").classList.remove("hide"); $("#registerBox").classList.add("hide"); }
function showRegister(){ $("#registerBox").classList.remove("hide"); $("#loginBox").classList.add("hide"); }
$("#switchToLogin").addEventListener("click", showLogin);
$("#switchToRegister").addEventListener("click", showRegister);
$("#loginBox").addEventListener("submit", (e)=>{ e.preventDefault(); hideBanner(); const email=$("#loginEmail").value, pass=$("#loginPass").value;
  const r=signIn({email,pass}); if(!r.ok){ banner(r.msg,"error"); return; } banner(r.msg,"ok"); afterAuth(); });
$("#registerBox").addEventListener("submit", async (e)=>{ e.preventDefault(); hideBanner();
  const name=$("#regName").value.trim(), email=$("#regEmail").value, pass=$("#regPass").value, avatarFile=$("#regAvatar").files[0];
  const r=await signUp({name,email,pass,avatarFile}); if(!r.ok){ banner(r.msg,"error"); return; } banner(r.msg,"ok"); afterAuth(); });

$("#btnResetAll").addEventListener("click", ()=>{ localStorage.clear(); currentUser=null; paintAuth(); refreshTabVisibility(); setActiveTab("access"); showLogin(); banner("Datos locales limpiados.","ok"); });

function afterAuth(){ refreshTabVisibility(); paintAuth(); paintProfile(); paintKycUI(); setActiveTab("ride"); renderRiderHistory(); }

/* ===== Verificaci√≥n libre ===== */
$("#btnVerifySubmit").addEventListener("click", ()=>{
  if(!currentUser) return toast("Inici√° sesi√≥n");
  currentUser.role="driver";
  currentUser.kyc={status:"approved", submittedAt:Date.now(), data:{freeApproval:true}};
  const db=loadUsers(); db[normEmail(currentUser.email)]=currentUser; saveUsers(db); saveSession(currentUser);
  paintKycUI(); refreshTabVisibility(); setActiveTab("driver"); initDriverMap();
  $("#verifyMsg").textContent="Aprobado en modo pruebas (sin validaciones)."; $("#verifyMsg").className="pill ok"; $("#verifyMsg").classList.remove("hide");
  toast("‚úÖ Conductor aprobado");
});

/* ===== Historial ===== */
function renderRiderHistory(){
  if(!currentUser) return;
  const list=loadArr(riderHistKey(currentUser.email));
  const wrap=$("#riderHistory"); wrap.innerHTML="";
  if(!list.length){ wrap.innerHTML=`<div class="muted small">Sin viajes a√∫n.</div>`; return; }
  list.slice().reverse().forEach((t)=>{
    const div=document.createElement("div"); div.className="item";
    div.innerHTML=`<h4>${new Date(t.ts).toLocaleString()}</h4>
      <div>Origen: <b>${t.originText||"‚Äî"}</b> ¬∑ Destino: <b>${t.destText||"‚Äî"}</b></div>
      <div>Distancia: <b>${t.km?.toFixed?.(2)||"0.00"} km</b> ¬∑ Total: <b>${money(t.finalFare||0)}</b></div>`;
    wrap.appendChild(div);
  });
}
$("#btnClearRiderHistory").addEventListener("click", ()=>{ if(!currentUser) return; saveArr(riderHistKey(currentUser.email),[]); renderRiderHistory(); toast("Historial borrado"); });

/* ===== Crear solicitud de viaje (Pasajero) ===== */
let rideWaitTimer=null, rideWaitSecs=0, riderActive=null;
const waitLabel=$("#waitSecs"), searchStatus=$("#searchStatus"), btnRequest=$("#btnRequest"), btnCancel=$("#btnCancel");
const riderAssignedBox=$("#riderAssignedBox"), drvAvSmall=$("#drvAvSmall"), drvNameSmall=$("#drvNameSmall"), drvCarSmall=$("#drvCarSmall"), riderRideState=$("#riderRideState");
let riderOrigin=null, riderDest=null;

function estimateAndPaint(){
  const distEl=$("#distance"), fareEl=$("#fare");
  if(!riderOrigin||!riderDest){ distEl.value="0.00 km"; fareEl.value="$0"; return; }
  const km=km2(riderOrigin,riderDest); distEl.value=`${km.toFixed(2)} km`; fareEl.value=money(estimateFareRaw(km));
}

async function geocodeOrigin(){ const t=$("#riderOrigin").value.trim(); if(!t) return; const loc=await geocode(t); if(!loc){ toast("No se encontr√≥ el origen"); return; } riderOrigin=loc; initRideMap(); setMarker("origin",loc.lat,loc.lng,"Origen"); mapRide.setView([loc.lat,loc.lng],14); estimateAndPaint(); fitRideBounds(); }
async function geocodeDest(){ const t=$("#riderDest").value.trim(); if(!t) return; const loc=await geocode(t); if(!loc){ toast("No se encontr√≥ el destino"); return; } riderDest=loc; initRideMap(); setMarker("dest",loc.lat,loc.lng,"Destino"); mapRide.setView([loc.lat,loc.lng],14); estimateAndPaint(); fitRideBounds(); }
$("#btnGeoRO").addEventListener("click", geocodeOrigin);
$("#btnGeoRD").addEventListener("click", geocodeDest);
$("#btnLocate").addEventListener("click", ()=>{ if(!navigator.geolocation) return toast("Sin geolocalizaci√≥n"); initRideMap();
  navigator.geolocation.getCurrentPosition(p=>{ riderOrigin={lat:p.coords.latitude,lng:p.coords.longitude}; setMarker("origin",riderOrigin.lat,riderOrigin.lng,"Origen"); mapRide.setView([riderOrigin.lat,riderOrigin.lng],15); estimateAndPaint(); fitRideBounds(); }, ()=> toast("No se pudo obtener ubicaci√≥n"), {enableHighAccuracy:true,timeout:5000,maximumAge:15000}); });

function startWaitingUI(){ searchStatus.classList.remove("hide"); btnRequest.disabled=true; btnCancel.classList.remove("hide"); rideWaitSecs=0; waitLabel.textContent="0";
  rideWaitTimer=setInterval(()=>{ rideWaitSecs++; waitLabel.textContent=String(rideWaitSecs); },1000); }
function stopWaitingUI(){ searchStatus.classList.add("hide"); btnRequest.disabled=false; btnCancel.classList.add("hide"); clearInterval(rideWaitTimer); rideWaitTimer=null; }

btnRequest.addEventListener("click", ()=>{
  if(!currentUser) return toast("Inici√° sesi√≥n");
  if(!riderOrigin || !riderDest) return toast("Seleccion√° origen y destino");
  // crear solicitud en cola p√∫blica local
  const km=km2(riderOrigin,riderDest), price=estimateFareRaw(km);
  const ride={
    id:cryptoId(),
    state:"pendiente",
    createdAt:Date.now(),
    origin:{...riderOrigin, text:$("#riderOrigin").value.trim()},
    dest:{...riderDest, text:$("#riderDest").value.trim()},
    km, price,
    passenger:{email:currentUser.email, name:currentUser.name, avatar:currentUser.avatar||""},
    driver:null
  };
  pushOpenRide(ride);
  // guardar referencia de activo del pasajero
  riderActive=ride; saveObj(activeRideKey(currentUser.email), ride);
  startWaitingUI();
  toast("Solicitud creada. Esperando conductor‚Ä¶");
  // refrescar cola en UI conductor (si sos vos mismo)
  paintDriverQueue();
});

btnCancel.addEventListener("click", ()=>{
  if(!riderActive) return stopWaitingUI();
  // marcar cancelado
  let rides=listOpenRides();
  rides = rides.filter(r=>r.id!==riderActive.id || r.state!=="pendiente"); // saca de la cola
  saveArr(ridesKey, rides);
  riderActive=null; saveObj(activeRideKey(currentUser.email), null);
  stopWaitingUI();
  toast("Solicitud cancelada");
});

/* ===== Conductor: lista y aceptaci√≥n ===== */
let driverMap=null, drvMarker=null, drvTimer=null, drvPaused=false, drvActive=null;
function initDriverMap(){ if(driverMap) return; driverMap=L.map('mapDriver',{zoomControl:false}); L.control.zoom({position:'bottomright'}).addTo(driverMap); L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(driverMap); driverMap.setView([-31.5375,-68.5364],12); }
function paintDriverQueue(){
  if(!currentUser || currentUser.kyc?.status!=="approved") return;
  const wrap=$("#driverQueue"); wrap.innerHTML="";
  const rides=listOpenRides().filter(r=>r.state==="pendiente");
  if(!rides.length){ wrap.innerHTML=`<div class="muted small">Sin solicitudes por ahora.</div>`; return; }
  rides.forEach(r=>{
    const it=document.createElement("div"); it.className="item";
    it.innerHTML=`
      <h4>${r.origin.text||"Origen"} ‚Üí ${r.dest.text||"Destino"}</h4>
      <div class="row" style="align-items:center">
        <img class="av" src="${r.passenger.avatar||""}" alt="Pasajero" onerror="this.src=''; this.style.background='#333'">
        <div style="flex:4">
          <div class="small">Pasajero: <b>${r.passenger.name}</b></div>
          <div class="small">Tarifa: <b>${money(r.price)}</b> ¬∑ Distancia: <b>${r.km.toFixed(2)} km</b></div>
        </div>
        <button class="btnp" data-acc="${r.id}">Aceptar</button>
      </div>`;
    wrap.appendChild(it);
  });
  wrap.querySelectorAll("[data-acc]").forEach(btn=>{
    btn.addEventListener("click", ()=> acceptRide(btn.dataset.acc));
  });
}

function acceptRide(rideId){
  let rides=listOpenRides();
  let r=rides.find(x=>x.id===rideId); if(!r) return;
  r.state="aceptado";
  r.driver={email:currentUser.email, name:currentUser.name, avatar:currentUser.avatar||"", car:"Auto blanco ‚Ä¢ ABC123"};
  updateOpenRide(r);
  drvActive=r; saveObj(activeRideKey(currentUser.email), r);
  // preparar mapa conductor
  initDriverMap();
  if(drvMarker){ driverMap.removeLayer(drvMarker); drvMarker=null; }
  drvMarker=L.marker([r.origin.lat+0.01, r.origin.lng-0.01]).addTo(driverMap).bindTooltip("Yo (conductor)");
  const o=L.marker([r.origin.lat,r.origin.lng]).addTo(driverMap).bindTooltip("Origen");
  const d=L.marker([r.dest.lat,r.dest.lng]).addTo(driverMap).bindTooltip("Destino");
  driverMap.fitBounds(L.latLngBounds([drvMarker.getLatLng(),o.getLatLng(),d.getLatLng()]),{padding:[40,40]});
  $("#drvActiveInfo").innerHTML=`Atendiendo a <b>${r.passenger.name}</b> ‚Äî Tarifa: <b>${money(r.price)}</b><br>Origen: <b>${r.origin.text}</b> ¬∑ Destino: <b>${r.dest.text}</b>`;

  // habilitar controles
  $("#btnStartRoute").disabled=false; $("#btnPauseRoute").disabled=false; $("#btnStopRoute").disabled=false;

  // avisar al pasajero si es el mismo dispositivo
  if(riderActive && riderActive.id===r.id){
    riderAssignedBox.classList.remove("hide");
    $("#rideMapTop").textContent="‚úÖ Conductor asignado";
    $("#rideMapTop").classList.add("show"); setTimeout(()=>$("#rideMapTop").classList.remove("show"),1800);
    drvAvSmall.src=currentUser.avatar||""; drvNameSmall.textContent=currentUser.name; drvCarSmall.textContent="Auto blanco ‚Ä¢ ABC123";
    riderRideState.textContent="En camino al origen";
    // crear marcador de conductor en mapa del pasajero
    initRideMap();
    if(markersRide.driver){ mapRide.removeLayer(markersRide.driver); markersRide.driver=null; }
    markersRide.driver = L.marker(drvMarker.getLatLng()).addTo(mapRide).bindTooltip("Conductor");
    fitRideBounds();
    // guardar sobre activo del pasajero con driver
    riderActive=r; saveObj(activeRideKey(r.passenger.email), r);
    stopWaitingUI();
  }
  toast("‚úÖ Viaje asignado");
}

/* ===== Animaci√≥n y estado del viaje ===== */
function lerp(a,b,t){ return a+(b-a)*t; }
function moveTowards(latlngA, latlngB, step=0.002){ // paso simple
  const A=latlngA, B=latlngB; const dist=Math.hypot(B.lat-A.lat, B.lng-A.lng);
  if(dist<=step) return {lat:B.lat,lng:B.lng,done:true};
  const t=step/dist; return {lat:lerp(A.lat,B.lat,t), lng:lerp(A.lng,B.lng,t), done:false};
}

function syncRiderDriverMarker(){
  if(!drvMarker || !markersRide.driver) return;
  markersRide.driver.setLatLng(drvMarker.getLatLng());
}

function startDriver(){
  if(!drvActive || !drvMarker) return;
  drvPaused=false;
  const phase = (drvActive.state==="aceptado" || drvActive.state==="hacia_origen") ? "hacia_origen" :
                (drvActive.state==="en_viaje" ? "en_viaje" : "finalizado");
  drvActive.state = phase;
  updateOpenRide(drvActive);
  runDriverTick();
  toast("Ruta iniciada");
}
function pauseDriver(){ drvPaused=!drvPaused; toast(drvPaused?"Ruta en pausa":"Ruta reanudada"); }
function stopDriver(){
  if(drvTimer) { clearInterval(drvTimer); drvTimer=null; }
  if(drvActive){
    drvActive.state="finalizado"; updateOpenRide(drvActive);
    // guardar en historial del pasajero
    const t=drvActive;
    const rec={id:t.id, originText:t.origin.text, destText:t.dest.text, km:t.km, finalFare:t.price, ts:Date.now()};
    const arr=loadArr(riderHistKey(t.passenger.email)); arr.push(rec); saveArr(riderHistKey(t.passenger.email),arr);
  }
  $("#drvActiveInfo").textContent="Sin viaje activo.";
  $("#btnStartRoute").disabled=true; $("#btnPauseRoute").disabled=true; $("#btnStopRoute").disabled=true;
  // limpiar rider UI
  riderAssignedBox.classList.add("hide");
  if(markersRide.driver){ mapRide.removeLayer(markersRide.driver); markersRide.driver=null; }
  renderRiderHistory();
  drvActive=null; saveObj(activeRideKey(currentUser.email), null);
  toast("Viaje finalizado");
}

function runDriverTick(){
  if(drvTimer) clearInterval(drvTimer);
  drvTimer=setInterval(()=>{
    if(drvPaused || !drvActive || !drvMarker) return;
    const here=drvMarker.getLatLng();
    let target = (drvActive.state==="hacia_origen") ? drvActive.origin : drvActive.dest;
    const step=0.002; // velocidad demo
    const nx=moveTowards({lat:here.lat,lng:here.lng}, target, step);
    drvMarker.setLatLng([nx.lat,nx.lng]);
    syncRiderDriverMarker();
    if(nx.done){
      if(drvActive.state==="hacia_origen"){
        drvActive.state="en_viaje"; updateOpenRide(drvActive);
        if(riderActive && riderActive.id===drvActive.id){ riderRideState.textContent="En viaje al destino"; }
      }else if(drvActive.state==="en_viaje"){
        stopDriver();
      }
    }
  }, 200);
}

$("#btnStartRoute").addEventListener("click", startDriver);
$("#btnPauseRoute").addEventListener("click", pauseDriver);
$("#btnStopRoute").addEventListener("click", stopDriver);

/* ===== Inicio ===== */
function paintAuthAndStart(){
  const saved=loadSession(); if(saved){ currentUser=saved; }
  paintAuth(); refreshTabVisibility();
  if(!currentUser){ setActiveTab("access"); showLogin(); }
  else { afterAuth(); }
}
paintAuthAndStart();

// Mantener mapas ajustados
window.addEventListener("focus", ()=>{ mapRide?.invalidateSize(); driverMap?.invalidateSize(); });

</script>
</body>
</html>
