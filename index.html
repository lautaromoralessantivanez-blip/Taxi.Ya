<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Taxi Ya</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0a0a; --panel:#121317; --ink:#ffffff; --muted:#b7c2cc; --line:#1e2733;
  --accent:#ffd34d; --accent-2:#7dd3fc; --danger:#ef4444; --ok:#22c55e; --link:#8ee6f4;
  --radius:16px; --shadow:0 16px 40px rgba(0,0,0,.45); --tabH:64px;
}
:root.light{
  --bg:#ffffff; --panel:#f6f8fb; --ink:#0b0b0b; --muted:#485563; --line:#dfe7ef;
  --accent:#0ea5e9; --accent-2:#22c55e; --danger:#dc2626; --ok:#16a34a; --link:#0ea5e9;
  --shadow:0 16px 40px rgba(0,0,0,.12);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Poppins,system-ui,Arial;transition:background .2s,color .2s}
h1,h2,h3,h4,h5,h6,p,small,label,span,div,input,select,button,textarea{color:var(--ink)}
a,.link{color:var(--link)}
header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(0,0,0,.65) 0%, rgba(0,0,0,.35) 70%);border-bottom:1px solid var(--line);
  padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
:root.light header{background:linear-gradient(180deg,#ffffff 0%, #f4f7fb 70%)}
.brand{font-weight:800}
.badge{display:inline-block;background:transparent;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px;color:var(--ink);opacity:.8}

/* Tabs app */
nav.tabs{position:sticky; top:0; z-index:25; background:var(--panel); border-bottom:1px solid var(--line);
  display:flex; gap:8px; padding:8px; justify-content:center; flex-wrap:wrap}
.tab-btn{flex:0 0 auto; min-width:140px; height:44px; display:flex; align-items:center; justify-content:center; gap:8px;
  padding:10px 14px; border-radius:999px; font-weight:700; cursor:pointer; background:transparent; border:1px solid var(--line); color:var(--ink)}
.tab-btn.active{background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#0b2d37; border-color:transparent}
.tab-btn[disabled]{opacity:.55; cursor:not-allowed}
.hide{display:none!important}
@media (max-width:900px){
  nav.tabs{position:fixed; bottom:0; top:auto; left:0; right:0; border-top:1px solid var(--line); border-bottom:0;
    padding:6px max(6px, env(safe-area-inset-left)) calc(6px + env(safe-area-inset-bottom)) max(6px, env(safe-area-inset-right)); background:var(--panel); justify-content:space-between}
  .tab-btn{flex:1 1 0; min-width:0}
  body{padding-bottom:calc(var(--tabH) + 8px)}
}

main{max-width:1200px;margin:14px auto;padding:0 10px;display:grid;gap:12px}
.grid{display:grid;grid-template-columns:420px 1fr;gap:12px}
@media (max-width:900px){ .grid{grid-template-columns:1fr} }
.card{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;border:1px solid var(--line)}
h2{margin:6px 0 10px;font-size:18px}
label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
input,select,button,textarea{font-family:inherit;font-size:14px}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:12px;background:transparent;color:var(--ink)}
input::placeholder,textarea::placeholder{color:rgba(127,143,159,.7)}
button{border:0;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer;color:var(--ink)}
.btn{background:transparent;border:1px solid var(--line)} .btn:hover{filter:brightness(1.08)}
.btnp{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#0b2d37}.btnp:hover{filter:brightness(1.05)}
.btnd{background:linear-gradient(180deg,#ff6262,#ef4444);color:#fff}
.row{display:flex;gap:8px;align-items:center}.row>*{flex:1}
.split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:560px){ .split{grid-template-columns:1fr} }
.small{font-size:12px}.muted{color:var(--muted)}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:transparent;font-size:12px}
.ok{color:#062e25;background:#0f2a22;border-color:#144a3d}
.warn{color:#3b2b06;background:#2a230f;border-color:#4a3d14}
.error{color:#ffb4b4;background:#2a0f12;border-color:#5d1d24}
.dim{opacity:.6}

/* Autocomplete */
.ac-wrap{position:relative}
.ac-list{position:absolute;left:0;right:0;top:calc(100% + 6px);background:transparent;border:1px solid var(--line);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.35);max-height:240px;overflow:auto;z-index:40}
.ac-item{padding:10px 12px;cursor:pointer;border-bottom:1px solid #101820}
.ac-item:last-child{border-bottom:0}
.ac-item b{color:#bde4f1}
.ac-item:hover,.ac-item.active{background:rgba(255,255,255,.06)}
:root.light .ac-item:hover,:root.light .ac-item.active{background:rgba(0,0,0,.06)}

/* Mapas */
.map{width:100%;height:64vh;min-height:360px;border-radius:16px;border:1px solid var(--line);overflow:hidden;position:relative}
.map-top{position:absolute; left:10px; right:10px; top:10px; z-index:400; display:none; padding:8px 12px; border-radius:12px; font-weight:700; border:1px solid var(--line); background:rgba(0,0,0,.25); backdrop-filter: blur(4px)}
.map-top.show{display:block}

/* Listas y modal */
.list{display:grid;gap:8px}
.item{border:1px solid var(--line);border-radius:12px;padding:10px;background:transparent}
.item h4{margin:0 0 6px 0;font-size:14px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:90px;z-index:9999;background:rgba(0,0,0,.85);color:#fff;padding:10px 14px;border-radius:12px;border:1px solid #000;box-shadow:0 10px 24px rgba(0,0,0,.35);font-weight:700}

/* Avatares y tarjetas inline */
.avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
.inline-card{display:flex;align-items:center;gap:10px;border:1px solid var(--line);border-radius:12px;padding:8px;background:transparent}
.inline-card h4{margin:0;font-size:14px}
</style>
</head>
<body>
<header>
  <div class="brand">Taxi Ya üöï</div>
  <div id="authPill" class="badge">Sin sesi√≥n</div>
</header>

<nav class="tabs" id="tabsBar" role="tablist" aria-label="Secciones">
  <button class="tab-btn active" data-tab="access"    id="tab-access">üîê Acceso</button>
  <button class="tab-btn hide"   data-tab="ride"      id="tab-ride">üöï Viaje</button>
  <button class="tab-btn hide"   data-tab="history"   id="tab-history">üßæ Historial</button>
  <button class="tab-btn hide"   data-tab="driver"    id="tab-driver">üßë‚Äç‚úàÔ∏è Conductor</button>
  <button class="tab-btn hide"   data-tab="settings"  id="tab-settings">‚öôÔ∏è Ajustes</button>
</nav>

<main id="appRoot">
  <!-- ===== ACCESO ===== -->
  <section id="panel-access" class="card" role="tabpanel" aria-labelledby="tab-access">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Acceso</h2>
      <div class="row" style="justify-content:flex-end; gap:8px">
        <button class="btn" id="btnResetAll" type="button">Limpiar datos</button>
      </div>
    </div>
    <div id="msg" class="pill hide" role="status" aria-live="polite"></div>

    <div class="row" style="margin-top:6px">
      <button class="btnp" id="switchToLogin" type="button">Ir a Iniciar sesi√≥n</button>
      <button class="btn"  id="switchToRegister" type="button">Ir a Registrarme</button>
    </div>

    <!-- Login -->
    <form id="loginBox" style="margin-top:10px" autocomplete="on" novalidate>
      <div class="row">
        <div><label for="loginEmail">Correo</label><input id="loginEmail" type="email" placeholder="tucorreo@dominio.com" autocomplete="username" required></div>
        <div><label for="loginPass">Contrase√±a</label><input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" required></div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btnp" id="btnSignIn" type="submit">Entrar</button>
      </div>
    </form>

    <!-- Registro (con foto obligatoria) -->
    <form id="registerBox" class="hide" style="margin-top:10px" autocomplete="on" novalidate>
      <div class="split">
        <div><label for="regName">Nombre</label><input id="regName" placeholder="Tu nombre y apellido" autocomplete="name" required></div>
        <div><label for="regEmail">Correo</label><input id="regEmail" type="email" placeholder="tucorreo@dominio.com" autocomplete="username" required></div>
      </div>
      <div class="split" style="margin-top:6px">
        <div><label for="regPass">Contrase√±a</label><input id="regPass" type="password" placeholder="m√≠n. 6" autocomplete="new-password" minlength="6" required></div>
        <div><label for="regPhoto">Foto de perfil (obligatoria)</label><input id="regPhoto" type="file" accept="image/*" required></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btnp" id="btnSignUp" type="submit">Crear cuenta</button>
      </div>
    </form>
  </section>

  <!-- ===== VIAJE ===== -->
  <section id="panel-ride" class="grid card hide" role="tabpanel" aria-labelledby="tab-ride">
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Solicitar viaje</h2>
      </div>
      <div class="split">
        <div class="ac-wrap">
          <label for="riderOrigin">Origen üìç</label>
          <input id="riderOrigin" placeholder="Calle y altura" autocomplete="off">
          <div id="acOrigin" class="ac-list hide"></div>
        </div>
        <div class="ac-wrap">
          <label for="riderDest">Destino üéØ</label>
          <input id="riderDest" placeholder="Calle y altura" autocomplete="off">
          <div id="acDest" class="ac-list hide"></div>
        </div>
      </div>

      <div class="row" style="margin-top:6px">
        <button class="btn" id="btnGeoRO" type="button">Buscar Origen</button>
        <button class="btn" id="btnGeoRD" type="button">Buscar Destino</button>
        <button class="btn" id="btnLocate" type="button">Ubicarme</button>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label for="reqType">Tipo</label>
          <select id="reqType"><option value="auto">Auto</option><option value="moto">Moto</option></select>
        </div>
        <div>
          <label for="payMethod">Pago (opcional)</label>
          <select id="payMethod">
            <option value="">Elegir‚Ä¶</option>
            <option value="cash">üíµ Efectivo</option>
            <option value="mp">üí≥ Mercado Pago</option>
          </select>
        </div>
      </div>

      <div id="payCashBox" class="row hide" style="margin-top:6px">
        <label><input type="checkbox" id="chkCashConfirm"> Confirmo pago en efectivo</label>
      </div>
      <div id="payMPBox" class="row hide" style="margin-top:6px">
        <button class="btn" id="btnPayMP" type="button">Simular pago con MP</button>
      </div>
      <div id="payStatus" class="pill hide">Pago pendiente</div>

      <div class="split" style="margin-top:10px">
        <div><label for="distance">Distancia</label><input id="distance" readonly value="0.00 km"></div>
        <div><label for="fare">Tarifa estimada</label><input id="fare" readonly value="$0"></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btnp" id="btnUnified" type="button">üöï Pedir viaje</button>
        <button class="btnd hide" id="btnCancel" type="button">Cancelar viaje</button>
      </div>

      <div id="searchStatus" class="small muted hide" style="margin-top:6px">
        <b>Buscando‚Ä¶</b> <span id="waitSecs">0</span>s
      </div>

      <!-- Tarjeta del conductor asignado (visible al pasajero) -->
      <div id="driverCard" class="inline-card hide" style="margin-top:10px">
        <img id="driverAvatar" class="avatar" alt="Conductor">
        <div>
          <h4 id="driverName">Conductor</h4>
          <div class="small muted" id="driverExtra">En camino al punto de partida‚Ä¶</div>
        </div>
      </div>
    </section>

    <section class="card" style="position:relative">
      <div id="mapRide" class="map" aria-label="Mapa de viaje"></div>
      <div id="rideMapTop" class="map-top"></div>
    </section>
  </section>

  <!-- ===== HISTORIAL ===== -->
  <section id="panel-history" class="card hide" role="tabpanel" aria-labelledby="tab-history">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Historial</h2>
      <div class="row" style="justify-content:flex-end; gap:8px">
        <button class="btn" id="btnClearRiderHistory" type="button">Limpiar</button>
      </div>
    </div>
    <div id="riderHistory" class="list"></div>
  </section>

  <!-- ===== CONDUCTOR ===== -->
  <section id="panel-driver" class="card hide" role="tabpanel" aria-labelledby="tab-driver">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Panel del conductor</h2>
    </div>
    <div class="row" style="margin-top:6px">
      <button class="btnp" id="btnToggleOnline" type="button" disabled>Poner EN L√çNEA</button>
      <button class="btn" id="btnStartRoute" type="button" disabled>Iniciar</button>
      <button class="btn" id="btnPauseRoute" type="button" disabled>Pausar</button>
      <button class="btnd" id="btnStopRoute" type="button" disabled>Terminar</button>
    </div>

    <div class="inline-card" id="driverIncoming" style="margin-top:10px; display:none">
      <img id="incomingAvatar" class="avatar" alt="Pasajero">
      <div>
        <h4 id="incomingTitle">Nuevo viaje</h4>
        <div class="small" id="incomingDetail"></div>
      </div>
    </div>

    <div class="item" style="margin-top:10px">
      <h4>Viajes disponibles</h4>
      <div id="driverAvailable" class="list"></div>
    </div>
    <div class="item" style="margin-top:10px">
      <h4>Mis viajes activos</h4>
      <div id="driverMyActive" class="list"></div>
    </div>

    <div id="mapDriver" class="map" style="margin-top:8px" aria-label="Mapa del conductor"></div>
  </section>

  <!-- ===== AJUSTES ===== -->
  <section id="panel-settings" class="card hide" role="tabpanel" aria-labelledby="tab-settings">
    <h2>Ajustes</h2>
    <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <button class="btn" id="btnSubProfile" type="button">üë§ Perfil</button>
      <button class="btn" id="btnSubTheme" type="button">üåì Tema</button>
      <button class="btn" id="btnSubKyc" type="button">üßë‚Äç‚úàÔ∏è Conductor</button>
      <button class="btn" id="btnSubRatings" type="button">‚≠ê Calificaciones</button>
    </div>

    <!-- Perfil -->
    <div class="item" id="boxProfile">
      <h4>Informaci√≥n de la cuenta</h4>
      <div class="inline-card">
        <img id="profileAvatar" class="avatar" alt="Avatar">
        <div class="small" id="profileInfo"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnSignOut" type="button">Cerrar sesi√≥n</button>
      </div>
    </div>

    <!-- Tema -->
    <div class="item" id="boxTheme" style="margin-top:8px">
      <h4>Modo de color</h4>
      <div class="row">
        <label><input type="checkbox" id="themeToggle"> Tema Claro</label>
      </div>
    </div>

    <!-- Conductor (KYC) -->
    <div class="item" id="boxKyc" style="margin-top:8px">
      <h4>Verificaci√≥n para ser conductor</h4>
      <p class="small muted">La pesta√±a ‚ÄúConductor‚Äù se habilita cuando tu verificaci√≥n est√° <b>aprobada</b>.</p>
      <div class="split" style="margin-top:6px">
        <div><label for="vPlate">Patente</label><input id="vPlate" placeholder="AA123BB"></div>
        <div><label for="vYear">A√±o</label><input id="vYear" type="number" min="1995" max="2100" placeholder="2018"></div>
      </div>
      <div class="split" style="margin-top:6px">
        <div><label for="vModel">Modelo</label><input id="vModel" placeholder="Fiat Cronos 1.3"></div>
        <div><label for="vCard">C√©dula verde/azul</label><input id="vCard" placeholder="N¬∞ c√©dula"></div>
      </div>
      <div class="row" style="margin-top:6px">
        <div><label>Licencia de conducir</label><input id="docLicense" type="file" accept="image/*,application/pdf"></div>
        <div><label>Seguro vigente</label><input id="docInsurance" type="file" accept="image/*,application/pdf"></div>
      </div>
      <div id="verifyMsg" class="pill hide" style="margin-top:8px"></div>
      <div class="row" style="margin-top:10px">
        <button class="btnp" id="btnVerifySubmit" type="button">Solicitar verificaci√≥n</button>
        <span id="drvKycStatus" class="pill warn">No solicitado</span>
      </div>
    </div>

    <!-- Calificaciones -->
    <div class="item" id="boxRatings" style="margin-top:8px">
      <h4>Mi puntaje</h4>
      <div id="ratingSummary" class="small"></div>
      <div id="ratingList" class="list" style="margin-top:8px"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnAddFakeRating" type="button">A√±adir calificaci√≥n de prueba</button>
        <button class="btn" id="btnClearRatings" type="button">Borrar calificaciones</button>
      </div>
    </div>
  </section>
</main>

<div id="toast" class="toast hide"></div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase (Compat) -->
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore-compat.js"></script>

<script type="module">
/* ========================= Firebase ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyBu523IOGnIZGfAkdlLdVLcENwLgv5KU9o",
  authDomain: "taxi-ya-3be33.firebaseapp.com",
  projectId: "taxi-ya-3be33",
  storageBucket: "taxi-ya-3be33.appspot.com",
  messagingSenderId: "31840475169",
  appId: "1:31840475169:web:1485e47b9ebea4a66c6b60",
  measurementId: "G-2RQRP1G2KB"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
const usersCol = db.collection("users");
const ridesCol = db.collection("rides");

/* ========================= Helpers & storage (local UI) ========================= */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const money=n=>new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n||0);
const toRad=d=>d*Math.PI/180;
const km2=(a,b)=>{const R=6371,dLat=toRad(b.lat-a.lat),dLon=toRad(b.lng-a.lng);const la1=toRad(a.lat),la2=toRad(b.lat);const h=Math.sin(dLat/2)**2+Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;return 2*R*Math.asin(Math.sqrt(h));};
function toast(msg,ms=1700){ const t=$("#toast"); t.textContent=msg; t.classList.remove("hide"); setTimeout(()=>t.classList.add("hide"),ms); }
function banner(text,type="warn"){ const el=$("#msg"); el.textContent=text; el.className=`pill ${type}`; el.classList.remove("hide"); }
function hideBanner(){ $("#msg").className="pill hide"; }
function showIndexHint(err){ console.error(err); if(err && /index/i.test(err.message||"")) banner("Firestore necesita un √≠ndice para esa consulta. Abr√≠ la consola y segu√≠ el link sugerido. Simplifiqu√© la consulta para que funcione igual.", "warn"); }

/* ========================= Estado global ========================= */
let currentUser=null;
let riderActiveUnsub=null;
let driverAvailUnsub=null;
let driverMineUnsub=null;

/* ========================= Tabs ========================= */
const tabsCfg={
  access:{btn:$("#tab-access"), panel:$("#panel-access")},
  ride:{btn:$("#tab-ride"), panel:$("#panel-ride")},
  history:{btn:$("#tab-history"), panel:$("#panel-history")},
  driver:{btn:$("#tab-driver"), panel:$("#panel-driver")},
  settings:{btn:$("#tab-settings"), panel:$("#panel-settings")}
};
function setActiveTab(name){
  for(const k in tabsCfg){
    const on=k===name;
    tabsCfg[k].btn.classList.toggle("active",on);
    tabsCfg[k].panel.classList.toggle("hide",!on);
  }
  if(name==="ride"){ initRideMapOnce(); requestAnimationFrame(()=> resizeMap(mapRide)); }
  if(name==="driver"){ initDriverMapOnce(); requestAnimationFrame(()=> resizeMap(driverMap)); }
  if(name==="settings"){ paintProfile(); paintKycUI(); renderRatings(); }
}
Object.values(tabsCfg).forEach(({btn})=> btn.addEventListener("click", ()=> setActiveTab(btn.dataset.tab), {passive:true}));
function refreshTabVisibility(){
  const logged=!!currentUser;
  tabsCfg.access.btn.classList.toggle("hide", logged);
  tabsCfg.ride.btn.classList.toggle("hide", !logged);
  tabsCfg.history.btn.classList.toggle("hide", !logged);
  const kycOk = logged && currentUser.approved===true;
  tabsCfg.driver.btn.classList.toggle("hide", !kycOk);
  tabsCfg.settings.btn.classList.toggle("hide", !logged);
  if(!logged) setActiveTab("access");
}
function paintAuth(){ $("#authPill").textContent=currentUser?`${currentUser.displayName||currentUser.email} ‚Äî ${(currentUser.role||'rider')}${currentUser.approved?' (KYC‚úì)':''}`:"Sin sesi√≥n"; }

/* ========================= Tema ========================= */
function applyTheme(){ const t=localStorage.getItem("taxiya_theme")||"dark"; document.documentElement.classList.toggle("light", t==="light"); $("#themeToggle").checked=(t==="light"); }
$("#themeToggle").addEventListener("change", e=>{ localStorage.setItem("taxiya_theme", e.target.checked?"light":"dark"); applyTheme(); });
applyTheme();

/* ========================= Autocomplete ========================= */
const removeDiacritics = s => s.normalize("NFD").replace(/[\u0300-\u036f]/g,"");
const norm = s => removeDiacritics(String(s||"").toLowerCase().trim());
let STREETS = ["Av. Libertador General San Mart√≠n","Av. Ignacio de la Roza","Av. Rawson","Calle Mendoza","Calle Salta","Calle Tucum√°n","Calle Catamarca","Calle Rivadavia","Calle Mitre","Calle Santa Fe","Calle Rioja","Calle San Luis","Calle Urquiza","Calle Sarmiento","Calle Laprida","Calle Entre R√≠os"];
async function tryLoadExternalStreets(){ try{ const r=await fetch("streets.json",{cache:"no-store"}); if(r.ok){ const extra=await r.json(); if(Array.isArray(extra)&&extra.length){ STREETS=[...new Set([...STREETS, ...extra.filter(x=>typeof x==="string")])]; } } }catch(_){} }
tryLoadExternalStreets();
function streetPrefix(t){ const m=String(t||"").trim().match(/^[^\d]+/); return m?m[0].trim():t; }
function buildMatcher(q){ const qn=norm(q); return s=>{ const sn=norm(s); const i=sn.indexOf(qn); return i===-1?null:{s,i,len:qn.length}; }; }
function renderSuggestions(listEl, items, activeIdx){
  listEl.innerHTML="";
  items.forEach((it,idx)=>{ const {s,i,len}=it; const b=s.slice(0,i), m=s.slice(i,i+len), a=s.slice(i+len); const div=document.createElement("div"); div.className="ac-item"+(idx===activeIdx?" active":""); div.innerHTML=`${b}<b>${m}</b>${a}`; div.dataset.value=s; listEl.appendChild(div); });
  listEl.classList.toggle("hide", items.length===0);
}
function createAutocomplete(inputEl, listEl, onEnterNoActive){
  let candidates=[], active=-1;
  function update(){
    const q=streetPrefix(inputEl.value).trim();
    if(q.length<2){ candidates=[]; active=-1; renderSuggestions(listEl,candidates,active); return; }
    const match=buildMatcher(q);
    candidates=STREETS.map(s=>match(s)).filter(Boolean).sort((a,b)=>a.i-b.i||a.s.localeCompare(b.s)).slice(0,12);
    active=-1; renderSuggestions(listEl,candidates,active);
  }
  function choose(idx){
    if(idx<0||idx>=candidates.length) return;
    inputEl.value=candidates[idx].s+" ";
    listEl.classList.add("hide"); inputEl.focus();
  }
  inputEl.addEventListener("input", update, {passive:true});
  inputEl.addEventListener("focus", update, {passive:true});
  inputEl.addEventListener("blur", ()=> setTimeout(()=>listEl.classList.add("hide"), 120), {passive:true});
  listEl.addEventListener("mousedown", e=>{ const d=e.target.closest(".ac-item"); if(!d) return; choose(Array.from(listEl.children).indexOf(d)); });
  inputEl.addEventListener("keydown", e=>{
    const key=e.key||""; const listOpen=!listEl.classList.contains("hide"); const max=candidates.length;
    if(key==="ArrowDown" && listOpen && max>0){ e.preventDefault(); active=(active+1)%max; renderSuggestions(listEl,candidates,active); }
    else if(key==="ArrowUp" && listOpen && max>0){ e.preventDefault(); active=(active-1+max)%max; renderSuggestions(listEl,candidates,active); }
    else if(key==="Enter"){
      if(listOpen && active>=0){ e.preventDefault(); choose(active); }
      else if(typeof onEnterNoActive==="function"){ e.preventDefault(); onEnterNoActive(); }
    } else if(key==="Escape"){ listEl.classList.add("hide"); }
  });
}

/* ========================= Map utils ========================= */
function resizeMap(map){ try{ map && map.invalidateSize(); }catch(_){} }
function fallbackTileLayer(){ return L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'¬© OpenStreetMap'}); }
function primaryTileLayer(){
  const tl = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'¬© OpenStreetMap'});
  tl.on('tileerror', ()=>{ try{ if(tl._fallbackAdded) return; tl._fallbackAdded=true; tl._map && fallbackTileLayer().addTo(tl._map); }catch(_){ } });
  return tl;
}

/* ========================= Map Ride ========================= */
let mapRide=null, origin=null, dest=null, markers={origin:null,dest:null,driver:null};
function ensureRideMap(){
  if(mapRide) return;
  mapRide=L.map('mapRide',{zoomControl:false});
  L.control.zoom({position:'bottomright'}).addTo(mapRide);
  primaryTileLayer().addTo(mapRide);
  mapRide.setView([-31.5375,-68.5364],12);
  window.addEventListener('resize', ()=> resizeMap(mapRide));
}
function initRideMapOnce(){
  ensureRideMap();
  if(markers._initialized) return;
  markers._initialized=true;

  function setOriginMarker(o){
    origin=o;
    if(!markers.origin) markers.origin=L.marker([o.lat,o.lng]).addTo(mapRide).bindTooltip("Origen");
    markers.origin.setLatLng([o.lat,o.lng]);
  }
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p=>{
      const o={lat:p.coords.latitude,lng:p.coords.longitude};
      mapRide.setView([o.lat,o.lng],14); setOriginMarker(o); resizeMap(mapRide);
    }, _=>{
      const fallback={lat:-31.5375,lng:-68.5364}; mapRide.setView([fallback.lat,fallback.lng],12); setOriginMarker(fallback); resizeMap(mapRide);
    }, {enableHighAccuracy:true, timeout:5000, maximumAge:15000});
  }
  mapRide.on('click', e=>{
    if(!currentUser) return;
    dest={lat:e.latlng.lat,lng:e.latlng.lng};
    if(!markers.dest) markers.dest=L.marker([dest.lat,dest.lng]).addTo(mapRide).bindTooltip("Destino");
    markers.dest.setLatLng([dest.lat,dest.lng]);
    updateEstimate();
  });
}

/* ========================= Geocoder (Nominatim) ========================= */
async function geocode(text){
  try{
    const url=new URL("https://nominatim.openstreetmap.org/search");
    url.searchParams.set("q",text); url.searchParams.set("format","json"); url.searchParams.set("limit","1");
    const r=await fetch(url,{headers:{'Accept-Language':'es','User-Agent':'taxiya-demo'}});
    if(!r.ok) return null;
    const js=await r.json(); if(!js.length) return null;
    return {lat:parseFloat(js[0].lat), lng:parseFloat(js[0].lon)};
  }catch(_){ return null; }
}
async function setOriginFromField(){
  const txt=$("#riderOrigin").value.trim(); if(!txt) return;
  ensureRideMap();
  const loc=await geocode(txt); if(!loc){ toast("No se encontr√≥ el origen"); return; }
  origin=loc; if(markers.origin) markers.origin.setLatLng([loc.lat,loc.lng]); else markers.origin=L.marker([loc.lat,loc.lng]).addTo(mapRide).bindTooltip("Origen");
  mapRide.setView([loc.lat,loc.lng],15); updateEstimate(); resizeMap(mapRide);
}
async function setDestFromField(){
  const txt=$("#riderDest").value.trim(); if(!txt) return;
  ensureRideMap();
  const loc=await geocode(txt); if(!loc){ toast("No se encontr√≥ el destino"); return; }
  dest=loc; if(markers.dest) markers.dest.setLatLng([loc.lat,loc.lng]); else markers.dest=L.marker([loc.lat,loc.lng]).addTo(mapRide).bindTooltip("Destino");
  mapRide.setView([loc.lat,loc.lng],15); updateEstimate(); resizeMap(mapRide);
}

/* ========================= Estimaci√≥n ========================= */
function estimateFareRaw(km){ const base=990, perKm=660, perMin=99; const mins=(km/24)*60; return Math.max(800, Math.round(base + km*perKm + mins*perMin)); }
function updateEstimate(){
  const distEl=$("#distance"), fareEl=$("#fare");
  if(!origin||!dest){ distEl.value="0.00 km"; fareEl.value="$0"; return; }
  const km=km2(origin,dest); distEl.value=`${km.toFixed(2)} km`; fareEl.value=money(estimateFareRaw(km));
}

/* ========================= Pago (demo local UI) ========================= */
let payConfirmed=false, payment={method:null,status:"pending"};
function resetPayment(){
  payConfirmed=false; payment={method:null,status:"pending"};
  const ps=$("#payStatus"); ps.className="pill hide"; ps.textContent="Pago pendiente";
  $("#chkCashConfirm").checked=false;
}
$("#payMethod").addEventListener("change", e=>{
  resetPayment();
  const m=e.target.value; payment.method=m;
  $("#payCashBox").classList.toggle("hide", m!=="cash");
  $("#payMPBox").classList.toggle("hide", m!=="mp");
  if(!m) return; $("#payStatus").classList.remove("hide");
});
$("#chkCashConfirm").addEventListener("change", e=>{
  if($("#payMethod").value!=="cash") return;
  payConfirmed=e.target.checked; payment.status=payConfirmed?"cash_confirmed":"pending";
  $("#payStatus").className=`pill ${payConfirmed?'ok':''}`;
  $("#payStatus").textContent= payConfirmed ? "Pago en efectivo confirmado" : "Pago pendiente";
});
$("#btnPayMP").addEventListener("click", async ()=>{
  const b=$("#btnPayMP"); b.disabled=true; b.textContent="Procesando...";
  await new Promise(r=>setTimeout(r,900));
  payConfirmed=true; payment.status="approved";
  $("#payStatus").className="pill ok"; $("#payStatus").textContent="Pago aprobado (MP)";
  b.disabled=false; b.textContent="Simular pago con MP";
});

/* ========================= RIDE FLOW con Firestore ========================= */
let searching=false, waitTimer=null, waitSeconds=0;
const waitLabel=$("#waitSecs"), searchStatus=$("#searchStatus"), btnUnified=$("#btnUnified"), btnCancel=$("#btnCancel");

function startSearchingUI(){
  searching=true; waitSeconds=0;
  btnUnified.disabled=true; btnUnified.textContent="Buscando‚Ä¶";
  btnCancel.classList.remove("hide");
  searchStatus.classList.remove("hide");
  waitLabel.textContent="0";
  waitTimer=setInterval(()=>{ waitSeconds++; waitLabel.textContent=String(waitSeconds); },1000);
}
function stopSearchingUI(){
  searching=false;
  btnUnified.disabled=false; btnUnified.textContent="üöï Pedir viaje";
  btnCancel.classList.add("hide");
  searchStatus.classList.add("hide");
  clearInterval(waitTimer); waitTimer=null;
}

async function riderCreateRide(){
  if(!currentUser){ toast("Inici√° sesi√≥n"); return; }
  if(!origin || !dest){ toast("Seleccion√° origen y destino"); return; }
  startSearchingUI();

  // Evitar 2 viajes activos por pasajero (sin orderBy ‚Üí no √≠ndice)
  const existing = await ridesCol.where("riderId","==", currentUser.uid).where("finished","==", false).limit(1).get().catch(()=>null);
  if(existing && !existing.empty){ toast("Ya ten√©s un viaje activo"); stopSearchingUI(); return; }

  const km=km2(origin,dest);
  const finalFare=estimateFareRaw(km);
  const data={
    riderId: currentUser.uid,
    riderName: currentUser.displayName || currentUser.email,
    riderPhoto: currentUser.photo || "",
    riderEmail: currentUser.email,
    originText: $("#riderOrigin").value.trim() || `${origin.lat.toFixed(5)}, ${origin.lng.toFixed(5)}`,
    destText: $("#riderDest").value.trim() || `${dest.lat.toFixed(5)}, ${dest.lng.toFixed(5)}`,
    origin, dest,
    km, fare: finalFare, vehicle: $("#reqType").value || "auto",
    payment,
    status:"requested", finished:false,
    ts: firebase.firestore.FieldValue.serverTimestamp()
  };
  try{
    await ridesCol.add(data);
    toast("Solicitud enviada");
  }catch(e){
    toast("Error al crear viaje: "+e.message);
    stopSearchingUI();
  }
}

function riderAttachActiveRide(){
  if(riderActiveUnsub) riderActiveUnsub();
  // Sin orderBy para evitar √≠ndice; asumimos 0 o 1 activo
  riderActiveUnsub = ridesCol
    .where("riderId","==", currentUser.uid)
    .where("finished","==", false)
    .limit(1)
    .onSnapshot((qs)=>{
      if(qs.empty){
        $("#driverCard").classList.add("hide");
        stopSearchingUI();
        return;
      }
      const doc = qs.docs[0];
      const r = doc.data();

      $("#rideMapTop").textContent = `Estado: ${r.status.toUpperCase()} ‚Äî ${r.originText} ‚Üí ${r.destText} ¬∑ ${r.km?.toFixed?.(2)||0} km ¬∑ ${money(r.fare)}`;
      $("#rideMapTop").classList.add("show");
      setTimeout(()=> $("#rideMapTop").classList.remove("show"), 1600);

      btnCancel.classList.toggle("hide", r.status!=="requested");
      btnCancel.onclick = async ()=>{
        try{
          await db.runTransaction(async (tx)=>{
            const ref=ridesCol.doc(doc.id);
            const snap=await tx.get(ref);
            const cur=snap.data();
            if(cur.status!=="requested") throw new Error("Ya no se puede cancelar");
            tx.update(ref,{status:"cancelled", finished:true});
          });
          toast("Solicitud cancelada");
        }catch(e){ toast(e.message); }
      };

      if(r.driverId){
        $("#driverName").textContent = r.driverName || "Conductor";
        $("#driverAvatar").src = r.driverPhoto || "https://i.pravatar.cc/100?img=3";
        $("#driverExtra").textContent = r.status==="accepted" ? "En camino al punto de partida‚Ä¶" :
                                        r.status==="arrived"  ? "Conductor lleg√≥ al origen" :
                                        r.status==="in_trip"  ? "En viaje" :
                                        r.status==="completed"? "Viaje finalizado" : "‚Äî";
        $("#driverCard").classList.remove("hide");
        stopSearchingUI();
      } else {
        $("#driverCard").classList.add("hide");
      }

      if(r.finished){
        stopSearchingUI();
        const key = `taxiya_rider_history_${currentUser.email}`;
        const arr = (()=>{try{return JSON.parse(localStorage.getItem(key)||"[]");}catch(_){return[];}})();
        arr.push({ts: Date.now(), originText:r.originText, destText:r.destText, km:r.km, finalFare:r.fare});
        localStorage.setItem(key, JSON.stringify(arr));
        renderRiderHistory();
      }
    }, showIndexHint);
}

/* ========================= CONDUCTOR ‚Äî estado y matching ========================= */
let driverMap=null;
function initDriverMapOnce(){
  if(driverMap || !currentUser || currentUser.approved!==true) return;
  driverMap=L.map('mapDriver',{zoomControl:false});
  L.control.zoom({position:'bottomright'}).addTo(driverMap);
  primaryTileLayer().addTo(driverMap);
  driverMap.setView([-31.5375,-68.5364],13);
  window.addEventListener('resize', ()=> resizeMap(driverMap));
}

function paintKycUI(){
  const st=currentUser?.approved ? "Aprobado" : "No solicitado";
  const pill=$("#drvKycStatus");
  if(pill){ pill.textContent=st; pill.className="pill "+(currentUser.approved?"ok":"warn"); }
  $("#btnToggleOnline").disabled = !currentUser?.approved;
  $("#btnStartRoute").disabled = !currentUser?.approved;
  $("#btnPauseRoute").disabled = !currentUser?.approved;
  $("#btnStopRoute").disabled = !currentUser?.approved;
}

$("#btnVerifySubmit").addEventListener("click", async ()=>{
  if(!auth.currentUser){ toast("Inici√° sesi√≥n"); return; }
  await usersCol.doc(auth.currentUser.uid).set({role:"driver", approved:true},{merge:true});
  currentUser.approved = true; currentUser.role="driver";
  refreshTabVisibility(); setActiveTab("driver"); initDriverMapOnce(); paintKycUI();
  $("#verifyMsg").textContent="Aprobado en modo pruebas (sin validaciones).";
  $("#verifyMsg").className="pill ok"; $("#verifyMsg").classList.remove("hide");
  toast("‚úÖ Verificaci√≥n aprobada");
});

$("#btnToggleOnline").addEventListener("click", async ()=>{
  if(!auth.currentUser) return;
  const online = !currentUser.online;
  await usersCol.doc(auth.currentUser.uid).set({online},{merge:true});
  currentUser.online = online;
  toast(online?"Conductor en l√≠nea":"Conductor en pausa");
  attachDriverStreams();
});

/* Listeners en vivo para el conductor */
function attachDriverStreams(){
  if(driverAvailUnsub) driverAvailUnsub();
  if(driverMineUnsub) driverMineUnsub();

  if(!(currentUser?.approved && currentUser?.online)){
    $("#driverAvailable").innerHTML = `<div class="small muted">Ponete EN L√çNEA para ver viajes disponibles.</div>`;
    $("#driverMyActive").innerHTML = `<div class="small muted">Sin viajes activos.</div>`;
    return;
  }

  // Viajes disponibles (sin orderBy para evitar √≠ndice)
  driverAvailUnsub = ridesCol.where("status","==","requested").limit(30)
    .onSnapshot((qs)=>{
      const wrap=$("#driverAvailable"); wrap.innerHTML="";
      if(qs.empty){ wrap.innerHTML=`<div class="small muted">Sin viajes por ahora‚Ä¶</div>`; return; }
      qs.forEach(doc=>{
        const r=doc.data();
        const item=document.createElement("div"); item.className="item";
        item.innerHTML=`
          <div><b>${r.originText}</b> ‚Üí <b>${r.destText}</b></div>
          <div class="small muted">${(r.km||0).toFixed(1)} km ¬∑ ${money(r.fare)} ¬∑ Pasajero: ${r.riderName||"‚Äî"}</div>
          <div class="row" style="margin-top:6px">
            <button class="btnp">Aceptar</button>
          </div>`;
        item.querySelector(".btnp").onclick = ()=> driverAcceptRide(doc.id);
        wrap.appendChild(item);
      });
    }, showIndexHint);

  // Mis viajes activos (sin orderBy para evitar √≠ndice)
  driverMineUnsub = ridesCol.where("driverId","==", auth.currentUser.uid).where("finished","==",false)
    .onSnapshot((qs)=>{
      const wrap=$("#driverMyActive"); wrap.innerHTML="";
      if(qs.empty){ wrap.innerHTML=`<div class="small muted">Sin viajes activos.</div>`; return; }
      qs.forEach(doc=>{
        const r=doc.data();
        const item=document.createElement("div"); item.className="item";
        const nextButtons = renderNextButtons(r.status);
        item.innerHTML=`
          <div><b>${r.originText}</b> ‚Üí <b>${r.destText}</b></div>
          <div class="small muted">${(r.km||0).toFixed(1)} km ¬∑ ${money(r.fare)} ¬∑ Pasajero: ${r.riderName||"‚Äî"} ¬∑ Estado: <b>${r.status}</b></div>
          <div class="row" style="margin-top:6px">${nextButtons}</div>`;
        item.querySelectorAll("button[data-next]").forEach(b=>{
          b.onclick = ()=> driverAdvance(doc.id, b.dataset.next);
        });
        const c=item.querySelector("[data-cancel]");
        if(c) c.onclick = ()=> driverCancel(doc.id);
        wrap.appendChild(item);
      });
    }, showIndexHint);
}
function renderNextButtons(cur){
  const order=["requested","accepted","arrived","in_trip","completed"];
  const nx = (label,next,enabled)=>`<button class="btn${enabled?' btnp':''}" data-next="${next}" ${enabled?'':'disabled'}>${label}</button>`;
  const can = n=> order.indexOf(n)===order.indexOf(cur)+1;
  const cancelAllowed = cur==="requested"||cur==="accepted";
  return `
    ${nx("Llegu√©","arrived", can("arrived"))}
    ${nx("Iniciar viaje","in_trip", can("in_trip"))}
    ${nx("Finalizar","completed", can("completed"))}
    ${cancelAllowed?`<button class="btnd" data-cancel>Cancelar</button>`:""}
  `;
}
async function driverAcceptRide(rideId){
  try{
    await db.runTransaction(async (tx)=>{
      const ref=ridesCol.doc(rideId);
      const snap=await tx.get(ref);
      if(!snap.exists) throw new Error("El viaje ya no existe");
      const r=snap.data();
      if(r.status!=="requested") throw new Error("El viaje ya fue tomado");
      tx.update(ref,{
        status:"accepted",
        driverId: auth.currentUser.uid,
        driverName: currentUser.displayName || currentUser.email,
        driverPhoto: currentUser.photo || "",
      });
    });
    toast("¬°Viaje aceptado!");
  }catch(e){ toast(e.message); }
}
async function driverAdvance(rideId,next){
  const ord=["requested","accepted","arrived","in_trip","completed"];
  try{
    await db.runTransaction(async (tx)=>{
      const ref=ridesCol.doc(rideId);
      const snap=await tx.get(ref);
      if(!snap.exists) throw new Error("No existe");
      const r=snap.data();
      if(ord.indexOf(next)!==ord.indexOf(r.status)+1) throw new Error("Secuencia inv√°lida");
      const upd={status:next};
      if(next==="completed") upd.finished=true;
      tx.update(ref,upd);
    });
  }catch(e){ toast(e.message); }
}
async function driverCancel(rideId){
  try{
    await db.runTransaction(async (tx)=>{
      const ref=ridesCol.doc(rideId);
      const snap=await tx.get(ref);
      if(!snap.exists) throw new Error("No existe");
      const r=snap.data();
      if(r.status!=="requested" && r.status!=="accepted") throw new Error("No se puede cancelar ahora");
      tx.update(ref,{status:"cancelled", finished:true});
    });
  }catch(e){ toast(e.message); }
}

/* ========================= Historial (local UI) ========================= */
function renderRiderHistory(){
  if(!currentUser) return;
  const key=`taxiya_rider_history_${currentUser.email}`;
  let list=[]; try{ list=JSON.parse(localStorage.getItem(key)||"[]"); }catch(_){}
  const wrap=$("#riderHistory"); wrap.innerHTML="";
  if(!list.length){ wrap.innerHTML=`<div class="muted small">Sin viajes a√∫n.</div>`; return; }
  list.slice().reverse().forEach((t)=>{
    const div=document.createElement("div"); div.className="item";
    div.innerHTML=`<h4>${new Date(t.ts).toLocaleString()}</h4>
      <div>Origen: <b>${t.originText||"‚Äî"}</b> ¬∑ Destino: <b>${t.destText||"‚Äî"}</b></div>
      <div>Distancia: <b>${t.km?.toFixed?.(2)||"0.00"} km</b> ¬∑ Total: <b>${money(t.finalFare||0)}</b></div>`;
    wrap.appendChild(div);
  });
}
$("#btnClearRiderHistory").addEventListener("click", ()=>{
  if(!currentUser) return;
  localStorage.setItem(`taxiya_rider_history_${currentUser.email}`,"[]");
  renderRiderHistory(); toast("Historial borrado");
});

/* ========================= Perfil / Sesi√≥n ========================= */
function paintProfile(){
  const el=$("#profileInfo"), av=$("#profileAvatar"); if(!el||!av) return;
  if(!currentUser){ el.innerHTML="No hay sesi√≥n."; av.src=""; return; }
  const {displayName,email,role,approved,photo} = currentUser;
  av.src = photo || "https://i.pravatar.cc/100?u=placeholder";
  el.innerHTML=`Nombre: <b>${displayName||"‚Äî"}</b> ¬∑ Correo: <b>${email}</b><br>Rol: <b>${role||'rider'}</b> ¬∑ KYC: <b>${approved?'Aprobado':'No solicitado'}</b>`;
}
$("#btnSignOut").addEventListener("click", ()=> auth.signOut().catch(e=>toast(e.message)));

/* ========================= Acceso (Firebase Auth) ========================= */
function showLogin(){ $("#loginBox").classList.remove("hide"); $("#registerBox").classList.add("hide"); setTimeout(()=>$("#loginEmail").focus(),0); }
function showRegister(){ $("#registerBox").classList.remove("hide"); $("#loginBox").classList.add("hide"); setTimeout(()=>$("#regName").focus(),0); }
$("#switchToLogin").addEventListener("click", showLogin);
$("#switchToRegister").addEventListener("click", showRegister);

$("#loginBox").addEventListener("submit", async (e)=>{
  e.preventDefault(); hideBanner();
  const email=$("#loginEmail").value.trim(), pass=$("#loginPass").value;
  try{
    await auth.signInWithEmailAndPassword(email,pass);
    banner("Sesi√≥n iniciada.","ok");
  }catch(err){ banner(err.message,"error"); }
});

$("#registerBox").addEventListener("submit", (e)=>{
  e.preventDefault(); hideBanner();
  const name=$("#regName").value.trim(), email=$("#regEmail").value.trim(), pass=$("#regPass").value;
  const file=$("#regPhoto").files[0];
  if(!file){ banner("La foto de perfil es obligatoria.","error"); return; }
  const reader=new FileReader();
  reader.onload=async ()=>{
    const photo=reader.result;
    try{
      const {user}=await auth.createUserWithEmailAndPassword(email,pass);
      await user.updateProfile({displayName:name});
      await usersCol.doc(user.uid).set({
        uid:user.uid, email:user.email, displayName:name, photo,
        role:"rider", approved:false, online:false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      },{merge:true});
      banner("Cuenta creada.","ok");
    }catch(err){ banner(err.message,"error"); }
  };
  reader.readAsDataURL(file);
});

auth.onAuthStateChanged(async (u)=>{
  if(!u){
    currentUser=null; paintAuth(); refreshTabVisibility(); setActiveTab("access"); showLogin();
    if(riderActiveUnsub) riderActiveUnsub(); if(driverAvailUnsub) driverAvailUnsub(); if(driverMineUnsub) driverMineUnsub();
    return;
  }
  const ref=usersCol.doc(u.uid);
  const snap=await ref.get();
  if(!snap.exists){
    await ref.set({uid:u.uid, email:u.email, displayName:u.displayName||"", photo:u.photoURL||"", role:"rider", approved:false, online:false, createdAt: firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
  }
  currentUser=(await ref.get()).data();
  paintAuth(); refreshTabVisibility(); paintProfile();
  setActiveTab("ride");
  initRideMapOnce();
  renderRiderHistory();
  paintKycUI();
  riderAttachActiveRide();
  attachDriverStreams();
});

/* ========================= Driver panel extras ========================= */
$("#btnStartRoute").addEventListener("click", ()=> toast("Recorrido iniciado"));
$("#btnPauseRoute").addEventListener("click", ()=> toast("Recorrido en pausa"));
$("#btnStopRoute").addEventListener("click", ()=> toast("Recorrido terminado"));

/* ========================= Inputs Ride bindings ========================= */
createAutocomplete($("#riderOrigin"), $("#acOrigin"), setOriginFromField);
createAutocomplete($("#riderDest"), $("#acDest"), setDestFromField);
$("#btnGeoRO").addEventListener("click", setOriginFromField);
$("#btnGeoRD").addEventListener("click", setDestFromField);
$("#btnLocate").addEventListener("click", ()=>{
  if(!navigator.geolocation) return toast("El navegador no soporta geolocalizaci√≥n");
  ensureRideMap();
  navigator.geolocation.getCurrentPosition(p=>{
    const o={lat:p.coords.latitude,lng:p.coords.longitude}; origin=o;
    if(!markers.origin) markers.origin=L.marker([o.lat,o.lng]).addTo(mapRide).bindTooltip("Origen");
    markers.origin.setLatLng([o.lat,o.lng]); mapRide.setView([o.lat,o.lng],15); resizeMap(mapRide);
    updateEstimate();
  }, ()=> toast("No se pudo obtener tu ubicaci√≥n"), {enableHighAccuracy:true,timeout:5000,maximumAge:15000});
});

$("#btnUnified").addEventListener("click", riderCreateRide);
$("#btnCancel").addEventListener("click", ()=>{}); // se asigna al escuchar el ride

/* ========================= Reset demo local ========================= */
$("#btnResetAll").addEventListener("click", async ()=>{
  localStorage.clear();
  try{ await auth.signOut(); }catch(_){}
  currentUser=null; paintAuth(); refreshTabVisibility(); setActiveTab("access"); showLogin(); banner("Datos locales limpiados.","ok");
});

/* ========================= Map resize on focus ========================= */
window.addEventListener("focus", ()=>{ resizeMap(mapRide); resizeMap(driverMap); });
</script>
</body>
</html>
