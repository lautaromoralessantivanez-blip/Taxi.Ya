<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Taxi Ya ‚Äî Firebase</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Routing Machine + OSRM -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0f15; --panel:#0f141d; --ink:#f5f7fb; --muted:#a9b4c2; --line:#1b2430;
  --accent:#ffd34d; --ok:#22c55e; --danger:#ef4444; --chip:#17202a; --card:#0d131b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0f15,#0b0f15 60%,#0a0f19);color:var(--ink);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial}
button,input,select{font-family:inherit}

/* ===== AUTH ===== */
#gate{
  position:fixed; inset:0; display:grid; place-items:start center;
  background:radial-gradient(1200px 800px at 50% -10%,#13202e 0%, #0b0f15 60%, #0a0f19 100%);
  z-index:100; overflow-y:auto; -webkit-overflow-scrolling:touch;
  padding:16px; min-height:100svh;
}
.gate-card{ width:min(720px,100%); background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:1rem; margin:12px 0 24px 0; }
.gate-title{display:flex;align-items:center;gap:.6rem;margin:.25rem 0 1rem}
.gate-title .dot{width:.9rem;height:.9rem;border-radius:999px;background:var(--accent);box-shadow:0 0 16px rgba(255,211,77,.7)}
.grid{display:grid;gap:.75rem}
.field{display:grid;gap:.35rem}
.label{font-size:.9rem;color:var(--muted)}
.input, select.input{
  width:100%; background:#0e1620; border:1px solid var(--line); color:var(--ink);
  padding:.65rem .75rem; border-radius:12px; font-size:16px; line-height:1.2;
}
.btn{ display:inline-flex; align-items:center; gap:.5rem; border:1px solid var(--line); background:#12202e; color:var(--ink);
  padding:.65rem 1rem; border-radius:12px; cursor:pointer; transition:.2s; text-decoration:none; font-size:16px; }
.btn.primary{background:var(--accent);color:#111;border-color:#e6b800}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.link{color:#a7c7ff;text-decoration:underline;cursor:pointer}
.err{color:#fecaca}
.preview{width:72px;height:72px;border-radius:50%;border:1px solid var(--line);object-fit:cover;background:#0d131b}

/* ===== APP ===== */
.app{min-height:100dvh;display:grid;grid-template-rows:auto 1fr}
.header{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--line);background:rgba(13,19,27,.7);backdrop-filter:blur(12px);position:sticky;top:0;z-index:20}
.brand{display:flex;align-items:center;gap:.6rem}
.brand .dot{width:.9rem;height:.9rem;border-radius:999px;background:var(--accent);box-shadow:0 0 16px rgba(255,211,77,.7)}
.tabs{display:flex;gap:.35rem;flex-wrap:wrap}
.tab{padding:.45rem .75rem;border:1px solid var(--line);border-radius:999px;background:#17202a;color:#fff;opacity:.85;cursor:pointer;transition:.2s}
.tab[aria-selected="true"]{background:var(--accent);color:#111;opacity:1;border-color:#e6b800}

/* ===== Layouts ===== */
.container{display:grid;gap:1rem;padding:1rem;max-width:1500px;margin:0 auto}
.aside,.main{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden}
.panel-head{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--line);background:var(--card)}
.panel-body{padding:1rem;display:flex;flex-direction:column;gap:.75rem;min-height:calc(100dvh - 140px)}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:1rem}
.row{display:flex;gap:.6rem;align-items:center}
.row.wrap{flex-wrap:wrap}
.chip{background:#121a24;border:1px solid var(--line);padding:.35rem .6rem;border-radius:999px;font-size:.85rem;color:#a9b4c2}
.badge{padding:.3rem .5rem;border-radius:8px;border:1px solid var(--line);font-size:.78rem}
.badge.ok{background:rgba(34,197,94,.12);color:#86efac;border-color:rgba(34,197,94,.35)}
.help{color:var(--muted);font-size:.86rem}

/* Estado */
.status-bar{order:50;display:none;align-items:center;gap:.6rem;background:#0f172a;border:1px solid #243045;padding:.55rem .75rem;border-radius:10px;font-weight:600}

/* Mapa */
.map-wrap{order:1;position:relative;display:grid;grid-template-columns:1fr}
#map{width:100%;height:72vh;min-height:520px}
.leaflet-container{background:#0b0f15}

/* Dock solicitudes (Conductor) */
.dock{
  order:2; display:none;
  background:#0e1620; border:1px solid var(--line); border-radius:16px;
  padding:.75rem; max-height:72vh; overflow:auto;
}
.dock .title{font-weight:800;margin:.2rem 0 .6rem 0}
.req-item{display:grid;grid-template-columns:48px 1fr auto;gap:.6rem;align-items:center;border:1px solid var(--line);background:#0d131b;border-radius:12px;padding:.6rem;margin:.55rem 0}
.req-item .avatar{width:48px;height:48px;border-radius:10px;border:1px solid var(--line);object-fit:cover}
.req-item .meta{font-size:.85rem;color:#a9b4c2}
.req-pay{font-size:.78rem;border:1px dashed #334155;padding:.15rem .4rem;border-radius:8px;color:#a9b4c2}
.req-actions{display:flex;gap:.4rem}
.req-item:hover{outline:1px solid #334155;background:#0f172a}

/* Chat compacto */
.chat-mini{order:98}
.chat-mini summary{cursor:pointer;list-style:none;display:flex;align-items:center;gap:.5rem;background:#0f172a;border:1px solid #243045;padding:.55rem .75rem;border-radius:10px;font-weight:600}
.chat-mini .chatbox{display:grid;grid-template-rows:1fr auto;height:180px;background:#0d131b;border:1px solid var(--line);border-radius:12px;overflow:hidden;margin-top:.6rem}
.chatlog{overflow:auto;padding:.6rem}
.msg{display:inline-block;background:#12202e;border:1px solid var(--line);padding:.45rem .6rem;border-radius:10px;margin:.25rem 0;font-size:.92rem}
.msg.me{background:#1f2a37}

/* Variantes por rol */
.container.layout-passenger{grid-template-columns:1fr}
.container.layout-driver{
  grid-template-columns: minmax(480px,1fr) 420px;
  align-items:start;
}
.container.layout-profile{grid-template-columns:1fr}
.container.layout-driver #aside{display:none}
.container.layout-driver .main{display:block; order:1}
.container.layout-driver .dock{display:block; order:2}

/* === Overlay de b√∫squeda === */
.search-overlay{
  display:none;
  place-items:center;
  gap:1rem;
  padding:1.25rem;
  background:#0d131b;
  border:1px solid var(--line);
  border-radius:14px;
}
.search-title{font-weight:800;font-size:1.05rem}
.radar{
  position:relative;
  width:180px;height:180px;border-radius:999px;
  display:grid;place-items:center;
  background:radial-gradient( circle at center, rgba(147,197,253,.08) 0%, rgba(147,197,253,.02) 60%, transparent 70%);
  border:1px solid #223043;
  overflow:hidden;
}
.pulse{position:absolute;inset:0;border-radius:999px;border:2px solid rgba(147,197,253,.25);opacity:.8}
.p1{animation:pulse 2.2s linear infinite}
.p2{animation:pulse 2.2s linear 0.6s infinite}
.p3{animation:pulse 2.2s linear 1.2s infinite}
@keyframes pulse{
  0%{transform:scale(.3);opacity:.8}
  70%{transform:scale(1);opacity:0}
  100%{transform:scale(1.1);opacity:0}
}
.car{
  position:relative; z-index:2;
  font-size:40px; line-height:1; 
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.45));
}
.wait{
  font-weight:600; 
  display:flex; gap:.5rem; align-items:center; justify-content:center;
}
.search-actions{display:flex;justify-content:center}
.search-actions .btn{min-width:160px}

/* Responsive */
@media (max-width:980px){
  .container.layout-driver{grid-template-columns:1fr}
  .container.layout-driver .dock{order:3; max-height:unset}
  #map{height:64vh;min-height:420px}
}
@media (max-width:680px){
  .tabs{position:fixed;bottom:10px;left:0;right:0;justify-content:center;z-index:40}
  .tab{background:#131c28;border-color:#223043}
}
</style>
</head>
<body>

<!-- =========== AUTH =========== -->
<div id="gate" aria-hidden="false">
  <div class="gate-card">
    <div class="gate-title">
      <span class="dot"></span><b>Taxi Ya</b>
      <span class="chip" style="margin-left:.5rem;background:#121a24;border:1px solid var(--line);padding:.2rem .5rem;border-radius:999px;color:#a9b4c2">Inicio de sesi√≥n</span>
    </div>

    <div id="envWarn" class="err" style="display:none;margin-bottom:.75rem">
      ‚ö†Ô∏è Abr√≠ el sitio con <b>http://localhost</b> (no <code>file://</code>).
    </div>

    <!-- LOGIN -->
    <div class="card" style="background:#0d131b">
      <div class="grid">
        <div class="field"><label class="label">Email</label><input id="inEmail" type="email" class="input" placeholder="tu@email.com" autocomplete="email"></div>
        <div class="field"><label class="label">Contrase√±a</label><input id="inPass" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
        <div class="row" style="gap:.6rem;flex-wrap:wrap">
          <button class="btn primary" id="btnLogin" type="button">Entrar</button>
          <button class="btn" id="btnShowReg" type="button">Crear cuenta</button>
        </div>
        <div id="loginErr" class="err" role="alert"></div>
      </div>
    </div>

    <!-- REGISTRO -->
    <div id="regCard" class="card" style="display:none;margin-top:.6rem;background:#0d131b">
      <h3 style="margin:0 0 .5rem 0">Crear cuenta</h3>
      <div class="row" style="gap:1rem;align-items:flex-end;flex-wrap:wrap">
        <div class="field" style="align-items:center">
          <img id="regPreview" class="preview" src="" alt="foto"/>
          <label class="label" style="margin-top:.35rem">Foto de perfil (opcional)</label>
          <input id="regPhoto" type="file" accept="image/*" class="input" style="padding:.45rem"/>
        </div>
        <div class="field" style="flex:1"><label class="label">Nombre</label><input id="regName" class="input" placeholder="Ana, Mauro‚Ä¶"></div>
      </div>
      <div class="grid">
        <div class="field"><label class="label">Email</label><input id="regEmail" type="email" class="input" placeholder="tu@email.com" autocomplete="email"></div>
        <div class="field"><label class="label">Contrase√±a</label><input id="regPass" type="password" class="input" placeholder="m√≠n. 6 caracteres" autocomplete="new-password"></div>
        <div class="field"><label class="label">Repetir contrase√±a</label><input id="regPass2" type="password" class="input" placeholder="repite la contrase√±a" autocomplete="new-password"></div>
      </div>
      <div class="row" style="margin-top:.6rem;gap:.6rem;flex-wrap:wrap;padding-bottom:8px">
        <button class="btn" id="btnCancelReg" type="button">Volver al login</button>
        <button class="btn primary" id="btnReg" type="button">Crear cuenta</button>
      </div>
      <div id="regErr" class="err" role="alert"></div>
    </div>

    <p class="help" style="margin-top:.5rem">Inici√° sesi√≥n para continuar al mapa.</p>
    <div id="fatal" class="err" style="display:none;margin-top:10px" role="alert"></div>
  </div>
</div>

<!-- ==================== APP ==================== -->
<div class="app" id="app" style="display:none">
  <header class="header">
    <div class="brand"><span class="dot"></span><b>Taxi Ya</b><span class="chip" id="statusChip">offline</span></div>
    <nav class="tabs" id="tabs"></nav>
  </header>

  <div class="container layout-passenger" id="container">
    <main class="main">
      <div class="panel-head"><strong id="mainTitle">Mapa</strong></div>
      <div class="panel-body">

        <!-- Controles PASAJERO -->
        <div class="card" id="controlsCard">
          <div class="grid" style="gap:.9rem">
            <div class="field" style="width:min(520px,100%)">
              <label class="label">Buscar direcci√≥n</label>
              <input id="addrSearch" class="input" placeholder="Ej: Av. Corrientes 1234, CABA" autocomplete="off">
              <div id="addrResults" class="ac-results" style="display:none"></div>
            </div>

            <div class="row wrap" style="justify-content:space-between;gap:.75rem">
              <div class="row" style="gap:.5rem">
                <div class="label">Seleccionar en mapa:</div>
                <div class="seg" id="modeSeg" style="display:inline-flex;border:1px solid var(--line);border-radius:999px;overflow:hidden">
                  <button id="modeOrigen" type="button" aria-pressed="true" style="border:0;background:#0e1620;color:#fff;padding:.45rem .8rem;cursor:pointer">Origen</button>
                  <button id="modeDestino" type="button" aria-pressed="false" style="border:0;background:#0e1620;color:#fff;padding:.45rem .8rem;cursor:pointer">Destino</button>
                </div>
              </div>

              <div class="row" style="gap:.5rem;flex-wrap:wrap;justify-content:flex-start">
                <div class="field">
                  <label class="label">M√©todo de pago</label>
                  <select id="payMethod" class="input" style="min-width:160px">
                    <option value="efectivo" selected>Efectivo</option>
                    <option value="mp">Mercado Pago</option>
                  </select>
                </div>
                <button class="btn" id="btnMiUbicacion" type="button">Usar mi ubicaci√≥n</button>
                <button class="btn" id="btnLimpiar" type="button">Limpiar</button>
                <button class="btn" id="btnCancelReqTop" type="button">Cancelar</button>
                <button class="btn primary" id="btnSolicitar" type="button">Solicitar viaje</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Overlay Buscando -->
        <div id="searchOverlay" class="search-overlay">
          <div class="search-title">Buscando auto‚Ä¶</div>
          <div class="radar">
            <div class="pulse p1"></div>
            <div class="pulse p2"></div>
            <div class="pulse p3"></div>
            <div class="car">üöñ</div>
          </div>
          <div class="wait">Espera: <span id="ovTimer">00:00</span></div>
          <div class="search-actions">
            <button class="btn" id="btnCancelReqOverlay" type="button">Cancelar</button>
          </div>
          <div class="help">Avisando a conductores cercanos. No cierres la pesta√±a.</div>
        </div>

        <!-- Info PASAJERO -->
        <div class="card" id="infoCard">
          <div class="row wrap" style="justify-content:space-between">
            <div><div class="label">Origen</div><div id="origenTxt" class="chip">‚Äî</div></div>
            <div><div class="label">Destino</div><div id="destinoTxt" class="chip">‚Äî</div></div>
            <div><div class="label">Distancia (km)</div><div id="kmTxt" class="chip">0.00</div></div>
            <div><div class="label">Duraci√≥n (min)</div><div id="minTxt" class="chip">0</div></div>
            <div><div class="label">Tarifa estimada</div><div id="fareTxt" class="chip">$ 0</div></div>
            <div><div class="label">Surge</div><div id="surgeTxt" class="chip">x1.0</div></div>
          </div>
          <p class="help" id="actividad">Toc√° el mapa para fijar Origen/Destino.</p>
        </div>

        <!-- Barra de estado -->
        <div id="statusBar" class="status-bar">
          <span id="statusText">BUSCANDO CONDUCTOR‚Ä¶</span>
          <span class="chip" id="searchTimer">00:00</span>
        </div>

        <!-- ===== Toolbar CONDUCTOR ===== -->
        <div class="card" id="driverControls" style="display:none">
          <div class="row wrap" style="justify-content:space-between;align-items:center">
            <div class="row" style="gap:.5rem">
              <button class="btn primary" id="btnDrvStart" type="button">Iniciar</button>
              <button class="btn" id="btnDrvPause" type="button">Pausar</button>
              <button class="btn" id="btnDrvFinish" type="button">Finalizar</button>
              <button class="btn" id="btnUbicarme" type="button">Ubicarme</button>
            </div>
            <div class="row" style="gap:.5rem">
              <span class="chip">‚è± <b id="drvTime">00:00:00</b></span>
              <span class="chip">üíµ <b id="drvMoney">$ 0</b></span>
            </div>
          </div>
          <div class="help">‚ÄúIniciar‚Äù comparte tu ubicaci√≥n y te muestra solicitudes. El contador suma solo mientras est√°s iniciado (no en pausa).</div>
        </div>

        <!-- Mapa + Dock -->
        <div class="map-wrap">
          <div id="map"></div>
        </div>

        <!-- Chat compacto -->
        <details id="chatMini" class="chat-mini" style="display:none">
          <summary>üí¨ Chat del viaje (opcional)</summary>
          <div class="chatbox">
            <div id="chatlog" class="chatlog"></div>
            <div class="chatinput" style="display:flex;gap:.5rem;padding:.6rem;border-top:1px solid var(--line)">
              <input id="chatInput" class="input" placeholder="Escrib√≠ un mensaje respetuoso‚Ä¶"/>
              <button class="btn" id="chatSend" type="button">Enviar</button>
            </div>
          </div>
          <div class="help">Visible en ‚Äúaceptado / en curso‚Äù.</div>
        </details>

      </div>
    </main>

    <!-- DOCK DERECHA (solo Conductor) -->
    <aside id="reqDock" class="dock">
      <div class="title">Solicitudes cercanas</div>
      <div id="reqListDock"></div>
    </aside>
  </div>
</div>

<!-- ===== AVISO ENTORNO ===== -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  var warn = document.getElementById('envWarn');
  if(!warn) return;
  warn.style.display = (location.protocol!=='http:' && location.protocol!=='https:') ? 'block' : 'none';
});
window.addEventListener('error', function(e){
  var f = document.getElementById('fatal');
  if(f){ f.style.display='block'; f.textContent='Error de carga: ' + (e.message || 'desconocido') + '. Mir√° la consola.'; }
});
</script>

<!-- ================= Firebase + App (M√≥dulos) ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth, setPersistence, browserLocalPersistence, browserSessionPersistence, inMemoryPersistence,
  onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc, updateDoc, addDoc, collection,
  serverTimestamp, onSnapshot, query, where, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

/* -------- Config -------- */
const firebaseConfig = {
  apiKey: "AIzaSyBu523IOGnIZGfAkdlLdVLcENwLgv5KU9o",
  authDomain: "taxi-ya-3be33.firebaseapp.com",
  projectId: "taxi-ya-3be33",
  storageBucket: "taxi-ya-3be33.appspot.com",
  messagingSenderId: "31840475169",
  appId: "1:31840475169:web:1485e47b9ebea4a66c6b60",
  measurementId: "G-2RQRP1G2KB"
};

/* -------- Helpers -------- */
const $ = (sel)=>document.querySelector(sel);
const setText=(el,v)=>{ if(el) el.textContent=v; };
const fmt=(n)=> new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n);
function km(a,b){
  if(!a||!b) return 0;
  const R=6371, dLat=(b.lat-a.lat)*Math.PI/180, dLon=(b.lng-a.lng)*Math.PI/180;
  const la1=a.lat*Math.PI/180, la2=b.lat*Math.PI/180;
  const h=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(Math.PI*(b.lng-a.lng)/360)**2;
  return 2*R*Math.asin(Math.sqrt(h));
}
const bannedWords=['puta','puto','cagar','mierda','hdp','concha','pija','forro','insulto','boludo'];
const mapAuthError=(err)=>{ const c=String(err?.code||''); const M={'auth/invalid-email':'Email inv√°lido.','auth/missing-email':'Ingres√° tu email.','auth/missing-password':'Ingres√° tu contrase√±a.','auth/weak-password':'La contrase√±a es muy d√©bil (m√≠nimo 6 caracteres).','auth/email-already-in-use':'Ese email ya est√° registrado.','auth/user-not-found':'Usuario no encontrado.','auth/wrong-password':'Contrase√±a incorrecta.','auth/too-many-requests':'Demasiados intentos. Prob√° m√°s tarde.','auth/network-request-failed':'Fallo de red. Verific√° tu conexi√≥n.','auth/operation-not-allowed':'Habilit√° Email/Password en Firebase Console.','auth/unauthorized-domain':'Dominio no autorizado (agreg√° localhost).'}; return M[c] || err?.message || 'Error desconocido'; };
async function setupPersistence(){ try{ await setPersistence(auth,browserLocalPersistence);}catch(_){ try{await setPersistence(auth,browserSessionPersistence);}catch(_2){await setPersistence(auth,inMemoryPersistence);} } }
function setLoading(btn, on, txtIdle, txtBusy){ if(!btn) return; btn.disabled=!!on; btn.textContent=on?(txtBusy||'Procesando‚Ä¶'):(txtIdle||'Aceptar'); }
function withTimeout(promise, ms, label){
  return Promise.race([
    promise,
    new Promise((_,rej)=>setTimeout(()=>rej(new Error((label||'Operaci√≥n')+' tard√≥ demasiado')), ms))
  ]);
}

/* -------- Estado global -------- */
let appFB, auth, db, storage;
let map, origenMarker, destinoMarker, meMarker, routing, driverMarker, previewA, previewB;
let activeReqUnsub=null, chatUnsub=null, listUnsub=null, userUnsub=null, timerInt=null, driverUnsub=null, earningsUnsub=null;
let driverWatchId=null;
let uiTab='pasajero', selectMode='origen';
let driverOnline=false, driverPaused=false;
let driverSessionStart=null;
let driverAccumMs=0;
let driverTimer=null;
let driverEarnings=0;
let myLastPos=null;

const state = {
  fbUser:null, profile:null, pointsLocked:false,
  surge:1.0,
  pricing:Object.freeze({ base:800, perKm:350, perMin:120, serviceFee:150, minimum:1200 }),
  origen:null, destino:null, routeKm:0, routeMin:0,
  activeRequestId:null, activeRequest:null, requestCreatedAt:null
};

/* -------- Firebase init -------- */
try{
  appFB = initializeApp(firebaseConfig);
  auth = getAuth(appFB);
  db = getFirestore(appFB);
  storage = getStorage(appFB);
}catch(e){
  const fatal=$('#fatal'); if(fatal){ fatal.style.display='block'; fatal.textContent='No se pudo inicializar Firebase: '+(e.message||e); }
}

/* =================== UI por ROL =================== */
function setContainerMode(mode){
  const c=$('#container');
  c.classList.remove('layout-passenger','layout-driver','layout-profile');
  c.classList.add(mode);
}
function updateRoleUI(){
  const controlsCard=$('#controlsCard'), infoCard=$('#infoCard');
  const statusBar=$('#statusBar'), chatMini=$('#chatMini');
  const drvControls=$('#driverControls');

  if(uiTab==='pasajero'){
    setContainerMode('layout-passenger');
    controlsCard.style.display='block';
    infoCard.style.display='block';
    drvControls.style.display='none';
    $('#reqDock').style.display='none';
  }else if(uiTab==='conductor'){
    setContainerMode('layout-driver');
    controlsCard.style.display='none';
    infoCard.style.display='none';
    drvControls.style.display='block';
    $('#reqDock').style.display = driverOnline ? 'block' : 'none';
  }else{
    setContainerMode('layout-profile');
    controlsCard.style.display='none';
    infoCard.style.display='none';
    statusBar.style.display='none';
    chatMini.style.display='none';
    drvControls.style.display='none';
    $('#reqDock').style.display='none';
  }
  setTimeout(()=>{ if(map) map.invalidateSize(); },120);
}

/* -------- Tabs y Panel -------- */
function tabsForState(){ if(!state.fbUser) return []; return [{id:'pasajero',label:'Pasajero'},{id:'conductor',label:'Conductor'},{id:'perfil',label:'Perfil'}]; }
function renderTabs(){
  const nav=$('#tabs'); nav.innerHTML='';
  for(const t of tabsForState()){
    const b=document.createElement('button'); b.className='tab'; b.textContent=t.label;
    b.setAttribute('aria-selected', uiTab===t.id ? 'true':'false');
    b.onclick=function(){ uiTab=t.id; handleTabChange(); };
    nav.appendChild(b);
  }
  const sc=$('#statusChip'); if(sc) sc.textContent=state.fbUser ? ((state.profile && state.profile.name) || 'online') : 'offline';
}
function renderSide(){}

/* -------- Conductor: Timer + Ganancias -------- */
function fmtTime(ms){
  const s=Math.floor(ms/1000), hh=String(Math.floor(s/3600)).padStart(2,'0');
  const mm=String(Math.floor((s%3600)/60)).padStart(2,'0');
  const ss=String(s%60).padStart(2,'0');
  return `${hh}:${mm}:${ss}`;
}
function updateDriverTimerUI(){
  const base=driverAccumMs + (driverOnline && !driverPaused && driverSessionStart ? (Date.now()-driverSessionStart) : 0);
  setText($('#drvTime'), fmtTime(base));
  setText($('#drvMoney'), fmt(driverEarnings));
}
function startDriverTimer(){
  if(driverTimer) clearInterval(driverTimer);
  driverTimer=setInterval(updateDriverTimerUI, 500);
}
function stopDriverTimer(){
  if(driverTimer){ clearInterval(driverTimer); driverTimer=null; }
  updateDriverTimerUI();
}
function resetDriverSession(){
  driverAccumMs=0;
  driverSessionStart=null;
  driverEarnings=0;
  updateDriverTimerUI();
}
function subscribeEarnings(){
  if(earningsUnsub) earningsUnsub();
  const qRef=query(
    collection(db,'viajes'),
    where('conductorId','==',state.fbUser.uid),
    where('status','==','finalizado'),
    orderBy('createdAt','desc'),
    limit(200)
  );
  earningsUnsub = onSnapshot(qRef, (qs)=>{
    let sum=0;
    const since = driverSessionStart ? new Date(Math.min(driverSessionStart, Date.now())) : new Date();
    qs.forEach(d=>{
      const r=d.data();
      const ts=r.createdAt?.toDate?.() || r.createdAt || null;
      if(!ts) return;
      if(ts >= since) sum += Number(r.precio||0);
    });
    driverEarnings = sum;
    updateDriverTimerUI();
  });
}
function unsubscribeEarnings(){ if(earningsUnsub){ earningsUnsub(); earningsUnsub=null; } }

/* -------- Conductor: estado -------- */
function requestGeoPermission(){
  if(!navigator.geolocation){ alert('Geolocalizaci√≥n no disponible'); return; }
  navigator.geolocation.getCurrentPosition(()=>{}, ()=>{}, {enableHighAccuracy:true,timeout:3000});
}
function driverStart(){
  if(driverOnline && !driverPaused) return;
  if(!driverOnline){
    resetDriverSession();
    driverOnline=true; driverPaused=false;
    driverSessionStart=Date.now();
    startDriverTimer();
    subscribeEarnings();
  }else{
    driverPaused=false;
    driverSessionStart=Date.now();
    startDriverTimer();
  }
  startDriverShare();
  subscribePendientes();
  updateRoleUI();
}
function driverPauseToggle(){
  if(!driverOnline) return;
  if(!driverPaused){
    driverAccumMs += (Date.now()-driverSessionStart);
    driverSessionStart=null;
    driverPaused=true;
    stopDriverShare();
    unsubscribePendientes();
    stopDriverTimer();
  }else{
    driverPaused=false;
    driverSessionStart=Date.now();
    startDriverShare();
    subscribePendientes();
    startDriverTimer();
  }
  updateRoleUI();
}
function driverFinish(){
  if(!driverOnline) return;
  if(!driverPaused && driverSessionStart){
    driverAccumMs += (Date.now()-driverSessionStart);
  }
  driverOnline=false; driverPaused=false;
  stopDriverShare(); unsubscribePendientes(); stopDriverTimer(); unsubscribeEarnings();
  updateRoleUI();
}

/* -------- Mapa + ruteo -------- */
function initMap(){
  map=L.map('map',{zoomControl:true,preferCanvas:true}).setView([-34.6037,-58.3816],12);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(map);
  setTimeout(()=>{ if(map) map.invalidateSize(); },200);
  window.addEventListener('resize', ()=>{ if(map) map.invalidateSize(); });
  const pb=document.querySelector('.main .panel-body');
  if(window.ResizeObserver){ new ResizeObserver(()=>{ if(map) map.invalidateSize(); }).observe(pb); }
  map.on('click', function(e){
    if(state.pointsLocked || uiTab!=='pasajero'){ return; }
    const p={lat:e.latlng.lat,lng:e.latlng.lng};
    if(selectMode==='origen'){ setOrigen(p,true); } else { setDestino(p,true); }
  });
}
function ensureRouting(){
  if(routing) return routing;
  routing=L.Routing.control({
    waypoints:[],
    router:L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1',profile:'driving'}),
    lineOptions:{addWaypoints:false,extendToWaypoints:true,missingRouteTolerance:20},
    show:false, collapsible:true, fitSelectedRoutes:true
  }).on('routesfound',function(e){
    const r=e.routes && e.routes[0]; if(!r) return;
    const kmv=(r.summary.totalDistance||0)/1000; const minv=Math.round((r.summary.totalTime||0)/60);
    state.routeKm=kmv; state.routeMin=minv;
    setText($('#kmTxt'), kmv.toFixed(2));
    setText($('#minTxt'), String(minv));
    updateFareUI();
    try{ map.fitBounds(r.bounds,{padding:[30,30]}); }catch(_){}
    const act=$('#actividad'); if(act) act.textContent='Ruta: '+kmv.toFixed(2)+' km ‚Ä¢ ~'+minv+' min';
  }).on('routingerror',function(){ updateInfoHaversine(); }).addTo(map);
  return routing;
}
function setOrigen(p,recalc){ if(origenMarker) map.removeLayer(origenMarker); origenMarker=L.marker([p.lat,p.lng],{draggable:!state.pointsLocked}).addTo(map).bindPopup('Origen'); origenMarker.on('dragend',function(){ if(state.pointsLocked) return; const ll=origenMarker.getLatLng(); setOrigen({lat:ll.lat,lng:ll.lng},true); }); state.origen=p; setText($('#origenTxt'), p.lat.toFixed(4)+', '+p.lng.toFixed(4)); if(recalc) recalcRoute(); }
function setDestino(p,recalc){ if(destinoMarker) map.removeLayer(destinoMarker); destinoMarker=L.marker([p.lat,p.lng],{draggable:!state.pointsLocked}).addTo(map).bindPopup('Destino'); destinoMarker.on('dragend',function(){ if(state.pointsLocked) return; const ll=destinoMarker.getLatLng(); setDestino({lat:ll.lat,lng:ll.lng},true); }); state.destino=p; setText($('#destinoTxt'), p.lat.toFixed(4)+', '+p.lng.toFixed(4)); if(recalc) recalcRoute(); }
function recalcRoute(){ if(!(state.origen&&state.destino)){ updateInfoHaversine(); return; } ensureRouting().setWaypoints([L.latLng(state.origen.lat,state.origen.lng),L.latLng(state.destino.lat,state.destino.lng)]); }
function miUbicacionComoOrigen(){
  if(!navigator.geolocation){ alert('Geolocalizaci√≥n no disponible'); return; }
  navigator.geolocation.getCurrentPosition(function(pos){
    if(state.pointsLocked || uiTab!=='pasajero'){ return; }
    const p={lat:pos.coords.latitude,lng:pos.coords.longitude};
    if(meMarker) map.removeLayer(meMarker);
    meMarker=L.circleMarker([p.lat,p.lng],{radius:7,color:'#34d399'}).addTo(map).bindPopup('Mi ubicaci√≥n');
    map.setView([p.lat,p.lng],14); setOrigen(p,true);
  },function(){ alert('No se pudo obtener ubicaci√≥n'); });
}
function limpiar(){
  if(state.pointsLocked){ alert('No se puede limpiar con un viaje activo. Cancel√° primero.'); return; }
  [origenMarker,destinoMarker,meMarker,driverMarker,previewA,previewB].forEach(m=>{ if(m){ try{map.removeLayer(m);}catch(_){}}});
  origenMarker=destinoMarker=meMarker=driverMarker=previewA=previewB=null;
  if(routing){ routing.setWaypoints([]); } state.routeKm=0; state.routeMin=0;
  setText($('#origenTxt'),'‚Äî'); setText($('#destinoTxt'),'‚Äî'); setText($('#kmTxt'),'0.00'); setText($('#minTxt'),'0'); setText($('#fareTxt'), fmt(0));
  const a=$('#actividad'); if(a) a.textContent='Toc√° el mapa para fijar Origen/Destino.';
}
function calcFare(distKm,durMin){ const p=state.pricing; const bruto=p.base+(distKm*p.perKm)+(durMin*p.perMin)+p.serviceFee; const surged=bruto*(state.surge||1.0); return Math.max(p.minimum,Math.round(surged)); }
function updateFareUI(){ const f=calcFare(state.routeKm||0,state.routeMin||0); const ft=$('#fareTxt'); if(ft) ft.textContent=fmt(f); const st=$('#surgeTxt'); if(st) st.textContent='x'+(state.surge||1).toFixed(1); }
function updateInfoHaversine(){ const d=km(state.origen,state.destino); state.routeKm=d; state.routeMin=Math.round((d/25)*60); setText($('#kmTxt'), d.toFixed(2)); setText($('#minTxt'), String(state.routeMin)); updateFareUI(); }

/* -------- Autocomplete -------- */
const addrInput=document.getElementById('addrSearch'), addrBox=document.getElementById('addrResults');
function debounce(fn,ms){ let t=null; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a),ms||350); }; }
async function geocodeSearch(q){ const url='https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=6&q='+encodeURIComponent(q); const r=await fetch(url,{headers:{'Accept-Language':'es-AR,es;q=0.9'}}); return r.ok? r.json() : []; }
function renderAddrResults(list){
  if(!(list && list.length)){ addrBox.style.display='none'; addrBox.innerHTML=''; return; }
  let html='<div>';
  for(const it of list){
    const parts=it.display_name.split(','), t=parts.slice(0,2).join(', '), s=parts.slice(2).join(', ').trim();
    html+=`<div class="ac-item" data-lat="${it.lat}" data-lon="${it.lon}" data-name="${encodeURIComponent(it.display_name)}"><div class="ac-title">${t}</div><div class="ac-sub">${s}</div></div>`;
  }
  html+='</div>'; addrBox.innerHTML=html; addrBox.style.display='block';
  addrBox.querySelectorAll('.ac-item').forEach(node=>{
    node.addEventListener('click', function(){
      const lat=parseFloat(this.getAttribute('data-lat')), lon=parseFloat(this.getAttribute('data-lon')), name=decodeURIComponent(this.getAttribute('data-name'));
      addrInput.value=name; addrBox.style.display='none'; const p={lat:lat,lng:lon};
      if(selectMode==='origen'){ setOrigen(p,true); } else { setDestino(p,true); }
      map.setView([lat,lon],15);
    });
  });
}
if(addrInput){
  addrInput.addEventListener('input', debounce(async function(e){
    if(state.pointsLocked) return;
    const q=(e.target.value||'').trim();
    if(q.length<3){ addrBox.style.display='none'; addrBox.innerHTML=''; return; }
    try{ renderAddrResults(await geocodeSearch(q)); }catch(_){ addrBox.style.display='none'; addrBox.innerHTML=''; }
  },380));
}
document.addEventListener('click', function(e){ if(addrBox && addrBox.style.display!=='none' && !addrBox.contains(e.target) && e.target!==addrInput){ addrBox.style.display='none'; }});

/* -------- Chat + Viaje activo -------- */
function sanitizeMsg(t){ let x=(t||'').trim(); for(const w of bannedWords){ x=x.replace(new RegExp('\\b'+w+'\\b','gi'),'***'); } return x; }
function mySide(){ const r=state.activeRequest; if(!r||!state.fbUser) return 'pax'; if(r.pasajeroId===state.fbUser.uid) return 'pax'; if(r.conductorId===state.fbUser.uid) return 'drv'; return 'pax'; }
async function sendChat(){
  if(!state.activeRequestId) { alert('Sin viaje activo'); return; }
  const input=$('#chatInput'); const text=(input && input.value)||''; if(!text.trim()) return;
  const s=sanitizeMsg(text); if(/^\*{3,}$/.test(s)) { alert('Mensaje bloqueado'); return; }
  await addDoc(collection(db,'viajes',state.activeRequestId,'mensajes'),{from:mySide(),text:s,ts:serverTimestamp()});
  if(input) input.value='';
}
function showTripChat(show){ const d=document.getElementById('chatMini'); if(d) d.style.display = show ? 'block' : 'none'; }

/* === overlay helpers === */
function showSearchUI(show){
  const cc=document.getElementById('controlsCard');
  const ov=document.getElementById('searchOverlay');
  if(cc) cc.style.display = show ? 'none' : 'block';
  if(ov) ov.style.display = show ? 'grid' : 'none';
}
function setSearchingUI(on){
  const t=document.getElementById('searchTimer');
  const t2=document.getElementById('ovTimer');
  if(on){
    if(!state.requestCreatedAt) state.requestCreatedAt=Date.now();
    if(timerInt) clearInterval(timerInt);
    timerInt=setInterval(function(){
      const s=Math.floor((Date.now()-state.requestCreatedAt)/1000);
      const mm=String(Math.floor(s/60)).padStart(2,'0');
      const ss=String(s%60).padStart(2,'0');
      if(t) t.textContent=mm+':'+ss;
      if(t2) t2.textContent=mm+':'+ss;
    },500);
    showSearchUI(true);
  }else{
    if(timerInt) clearInterval(timerInt);
    timerInt=null; state.requestCreatedAt=null;
    if(t) t.textContent='00:00';
    if(t2) t2.textContent='00:00';
    showSearchUI(false);
  }
}

function watchActiveRequest(id){
  if(activeReqUnsub) activeReqUnsub();
  activeReqUnsub=onSnapshot(doc(db,'viajes',id), function(snap){
    if(!snap.exists()) return;
    const r=snap.data(); state.activeRequest={id:snap.id, ...r};
    const act=$('#actividad'); if(act) act.textContent='#'+id.slice(0,6)+' ‚Äî '+r.status.toUpperCase()+' ‚Äî '+fmt(r.precio)+' ('+(r.km||0).toFixed(2)+' km, '+(r.min||0)+' min)';
    const bar=$('#statusBar'), txt=$('#statusText');
    if(bar){ bar.style.display='flex'; }

    if(r.status==='buscando'){ if(txt) txt.textContent='BUSCANDO CONDUCTOR‚Ä¶'; setSearchingUI(true); showTripChat(false); stopDriverFollower(); }
    if(r.status==='aceptado'){ if(txt) txt.textContent='CONDUCTOR ACEPT√ì ‚Äî EN CAMINO'; setSearchingUI(false); showTripChat(true); startDriverFollower(id); }
    if(r.status==='en_curso'){ if(txt) txt.textContent='VIAJE EN CURSO'; setSearchingUI(false); showTripChat(true); startDriverFollower(id); }
    if(r.status==='finalizado' || r.status==='cancelado'){
      showTripChat(false); state.activeRequestId=null; state.activeRequest=null; lockPoints(false);
      setSearchingUI(false); stopDriverFollower(); if(chatUnsub){ chatUnsub(); chatUnsub=null; }
      alert(r.status==='finalizado'?'¬°Viaje finalizado!':'Solicitud cancelada');
      if(driverOnline && !driverPaused){ renderPendingDockSkeleton(); }
    }
    if(r.status!=='finalizado' && r.status!=='cancelado'){ ensureChatListener(id); }
  });
}
function ensureChatListener(reqId){
  if(chatUnsub) return;
  chatUnsub=onSnapshot(query(collection(db,'viajes',reqId,'mensajes'),orderBy('ts','asc'),limit(100)), function(qs){
    const log=$('#chatlog'); if(!log) return; log.innerHTML='';
    const mine=mySide();
    qs.forEach(function(d){ const m=d.data(); const who=(m.from===mine)?'me':''; log.insertAdjacentHTML('beforeend','<div class="msg '+who+'"><b>'+(m.from==='pax'?'Pasajero':'Conductor')+':</b> '+m.text+'</div>'); });
    log.scrollTop=log.scrollHeight;
  });
}

/* -------- Firestore: Solicitudes / Viajes -------- */
async function solicitarViaje(){
  if(!(state.origen&&state.destino)){ alert('Eleg√≠ origen y destino'); return; }
  const distKm=state.routeKm||km(state.origen,state.destino), precio=calcFare(distKm,state.routeMin||0);
  const pago = (document.getElementById('payMethod')?.value)||'efectivo';
  const ref=await addDoc(collection(db,'viajes'),{
    status:'buscando', pasajeroId:state.fbUser.uid,
    pasajeroNombre:(state.profile && state.profile.name) || state.fbUser.email,
    pasajeroFoto:(state.profile && state.profile.photoURL) || '',
    origen:state.origen, destino:state.destino, km:distKm, min:state.routeMin||0, precio, surge:state.surge||1.0,
    pago, createdAt:serverTimestamp()
  });
  state.activeRequestId=ref.id; lockPoints(true); setSearchingUI(true); watchActiveRequest(ref.id);
}
async function cancelarSolicitud(){
  if(!state.activeRequestId){ setSearchingUI(false); return; }
  await updateDoc(doc(db,'viajes',state.activeRequestId),{status:'cancelado'});
}

/* ===== Dock de solicitudes (CONDUCTOR) ===== */
function renderPendingDockSkeleton(){
  const cont=$('#reqListDock'); if(!cont) return;
  cont.innerHTML='<div class="chip" style="display:inline-flex;align-items:center;gap:.4rem">Esperando solicitudes‚Ä¶</div>';
}
function pendingItemHtml({id,avatar,name,stars,count,kmv,minv,precio,pago,origen,destino}){
  return `
    <div class="req-item" data-id="${id}">
      <img class="avatar" src="${avatar}" alt="avatar"/>
      <div>
        <div style="font-weight:600">${name}</div>
        <div class="meta">${stars} <span class="chip" style="margin-left:.35rem">${count} ops</span></div>
        <div class="meta" style="margin-top:.25rem">${kmv.toFixed(2)} km ‚Ä¢ ${minv} min ‚Ä¢ <b>${fmt(precio)}</b></div>
        <div class="req-pay">Pago: ${pago==='mp'?'Mercado Pago':'Efectivo'}</div>
        <div class="meta" style="margin-top:.35rem">
          <span class="chip">Ori: ${origen.lat.toFixed(4)}, ${origen.lng.toFixed(4)}</span>
          <span class="chip">Des: ${destino.lat.toFixed(4)}, ${destino.lng.toFixed(4)}</span>
        </div>
      </div>
      <div class="req-actions"><button class="btn primary" data-acc="${id}" type="button">Aceptar</button></div>
    </div>`;
}
let notifAudio=null;
function playPing(){ try{ if(!notifAudio){ notifAudio=new Audio('data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA'); } notifAudio.currentTime=0; notifAudio.play().catch(()=>{}); }catch(_){ } }

function subscribePendientes(){
  renderPendingDockSkeleton();
  if(listUnsub) listUnsub();
  const qRef=query(collection(db,'viajes'),where('status','==','buscando'),orderBy('createdAt','desc'),limit(30));
  listUnsub=onSnapshot(qRef, async function(qs){
    const cont=$('#reqListDock'); if(!cont) return; cont.innerHTML='';
    const near=[]
    for(const docu of qs.docs){
      const r=docu.data(); const id=docu.id;
      if(myLastPos){
        const d=km(myLastPos,{lat:r.origen.lat,lng:r.origen.lng});
        if(d>7) continue;
      }
      let rating=0,count=0,name=r.pasajeroNombre||'Pasajero',avatar=r.pasajeroFoto||'';
      try{ const u=await getDoc(doc(db,'users',r.pasajeroId)); if(u.exists()){ const d=u.data(); rating=d.ratingCount?(d.ratingSum||0)/d.ratingCount:0; count=d.ratingCount||0; name=d.name||name; avatar=d.photoURL||avatar; } }catch(_){}
      let stars=''; for(let i=1;i<=5;i++) stars+='<span style="color:#fcd34d;opacity:'+(rating>=i?1:.35)+'">‚òÖ</span>';
      const avatarSrc = avatar || ('https://api.dicebear.com/9.x/initials/svg?seed='+encodeURIComponent(name));
      near.push({html: pendingItemHtml({
        id, avatar:avatarSrc, name, stars, count,
        kmv:r.km||0, minv:r.min||0, precio:r.precio||0, pago:r.pago||'efectivo',
        origen:r.origen, destino:r.destino
      }), data:{id, ...r}});
    }
    if(!near.length){ renderPendingDockSkeleton(); return; }
    playPing();
    cont.innerHTML = near.map(n=>n.html).join('');
    cont.querySelectorAll('button[data-acc]').forEach(btn=>{
      btn.addEventListener('click', ()=> aceptarViaje(btn.getAttribute('data-acc')));
    });
    cont.querySelectorAll('.req-item').forEach(item=>{
      const id=item.getAttribute('data-id');
      const r=near.find(n=>n.data.id===id).data;
      item.addEventListener('mouseenter', ()=> previewRequest(r));
      item.addEventListener('mouseleave', ()=> clearPreview());
      item.addEventListener('click', ()=> previewRequest(r));
    });
  });
}
function unsubscribePendientes(){ if(listUnsub){ listUnsub(); listUnsub=null; } const cont=$('#reqListDock'); if(cont) cont.innerHTML=''; clearPreview(); }

/* Preview en mapa desde el dock */
function previewRequest(r){
  clearPreview();
  previewA=L.marker([r.origen.lat,r.origen.lng],{title:'Origen'}).addTo(map);
  previewB=L.marker([r.destino.lat,r.destino.lng],{title:'Destino'}).addTo(map);
  const pts=[]
  if(myLastPos){ pts.push(L.latLng(myLastPos.lat,myLastPos.lng)); }
  pts.push(L.latLng(r.origen.lat,r.origen.lng), L.latLng(r.destino.lat,r.destino.lng));
  try{ ensureRouting().setWaypoints(pts); }catch(_){}
  try{ map.fitBounds(L.latLngBounds([[r.origen.lat,r.origen.lng],[r.destino.lat,r.destino.lng]]),{padding:[24,24]}); }catch(_){}
}
function clearPreview(){
  if(previewA){ map.removeLayer(previewA); previewA=null; }
  if(previewB){ map.removeLayer(previewB); previewB=null; }
}

/* Aceptar / iniciar / finalizar viaje */
async function aceptarViaje(id){
  if(!driverOnline || driverPaused){ alert('Ten√©s que estar Iniciado.'); return; }
  await updateDoc(doc(db,'viajes',id),{status:'aceptado',conductorId:state.fbUser.uid,conductorNombre:(state.profile && state.profile.name)||state.fbUser.email});
  state.activeRequestId=id; watchActiveRequest(id);
}
async function iniciarTrayecto(){ if(!state.activeRequestId) { alert('Sin viaje activo'); return; } await updateDoc(doc(db,'viajes',state.activeRequestId),{status:'en_curso'}); }
async function finalizarTrayecto(){ if(!state.activeRequestId) { alert('Sin viaje activo'); return; } await updateDoc(doc(db,'viajes',state.activeRequestId),{status:'finalizado'}); }
document.addEventListener('click',(e)=>{ if(e.target && e.target.id==='btnStartTrip'){ iniciarTrayecto(); } if(e.target && e.target.id==='btnFinishTrip'){ finalizarTrayecto(); }});

/* -------- Bloqueo de puntos -------- */
function lockPoints(lock){
  state.pointsLocked=lock;
  try{
    if(origenMarker?.dragging) (lock? origenMarker.dragging.disable() : origenMarker.dragging.enable());
    if(destinoMarker?.dragging) (lock? destinoMarker.dragging.disable() : destinoMarker.dragging.enable());
  }catch(_){}
}

/* -------- Seguimiento del conductor -------- */
function startDriverShare(){
  if(!navigator.geolocation){ alert('Geolocalizaci√≥n no disponible'); return; }
  if(driverWatchId) return;
  driverWatchId=navigator.geolocation.watchPosition(async function(pos){
    myLastPos = { lat: pos.coords.latitude, lng: pos.coords.longitude, ts: Date.now() };
    if(!driverMarker){
      driverMarker = L.marker([myLastPos.lat,myLastPos.lng],{
        icon:L.divIcon({className:'',html:'<div style="background:#111827;border:2px solid #94a3b8;color:#fff;padding:2px 6px;border-radius:6px">üöñ</div>'})
      }).addTo(map).bindPopup('Conductor');
    } else {
      driverMarker.setLatLng([myLastPos.lat,myLastPos.lng]);
    }
    try{ if(driverOnline){ map.setView([myLastPos.lat,myLastPos.lng], Math.max(map.getZoom(), 14), {animate:false}); } }catch(_){}

    if(state.activeRequestId){
      await setDoc(doc(db,'viajes',state.activeRequestId,'conductor','pos'), myLastPos);
      const r=state.activeRequest;
      if(r){
        const dOri=r.origen?km(myLastPos,r.origen):999;
        const dDes=r.destino?km(myLastPos,r.destino):999;
        try{
          if(r.status==='aceptado' && dOri<=0.2) await updateDoc(doc(db,'viajes',state.activeRequestId),{status:'en_curso'});
          if(r.status==='en_curso' && dDes<=0.2) await updateDoc(doc(db,'viajes',state.activeRequestId),{status:'finalizado'});
        }catch(_){}
      }
    }
  }, err=>console.error(err), {enableHighAccuracy:true,maximumAge:2000,timeout:10000});
}
function stopDriverShare(){
  if(driverWatchId){ navigator.geolocation.clearWatch(driverWatchId); driverWatchId=null; }
}

/* -------- Seguimiento para pasajero -------- */
function startDriverFollower(requestId){
  stopDriverFollower();
  driverUnsub = onSnapshot(doc(db,'viajes',requestId,'conductor','pos'), snap=>{
    if(!snap.exists()) return;
    const p=snap.data();
    if(!driverMarker){
      driverMarker=L.marker([p.lat,p.lng],{
        icon:L.divIcon({className:'',html:'<div style="background:#111827;border:2px solid #94a3b8;color:#fff;padding:2px 6px;border-radius:6px">üöñ</div>'})
      }).addTo(map).bindPopup('Conductor');
    } else {
      driverMarker.setLatLng([p.lat,p.lng]);
    }
  });
}
function stopDriverFollower(){
  if(driverUnsub){ driverUnsub(); driverUnsub=null; }
  if(driverMarker){ try{map.removeLayer(driverMarker);}catch(_){ } driverMarker=null; }
}

/* ================= AUTH ‚Äì registro/login robusto ================= */
async function doLogin(){
  setText($('#loginErr'),'');
  const email=$('#inEmail')?.value?.trim()||'';
  const pass=$('#inPass')?.value||'';
  if(!email || !pass){ setText($('#loginErr'),'Complet√° tus datos'); return; }
  const btn=$('#btnLogin'); setLoading(btn,true,'Entrar','Entrando‚Ä¶');
  try{
    await setupPersistence();
    await withTimeout(signInWithEmailAndPassword(auth,email,pass), 15000, 'Login');
  }catch(err){
    setText($('#loginErr'), mapAuthError(err));
  }finally{
    setLoading(btn,false,'Entrar');
  }
}

async function doRegister(){
  setText($('#regErr'),'');
  const name=$('#regName')?.value?.trim()||'';
  const email=$('#regEmail')?.value?.trim()||'';
  const pass=$('#regPass')?.value||'';
  const pass2=$('#regPass2')?.value||'';
  const file=$('#regPhoto')?.files?.[0]||null;

  if(!name || !email || !pass){ setText($('#regErr'),'Complet√° los campos'); return; }
  if(pass!==pass2){ setText($('#regErr'),'Las contrase√±as no coinciden'); return; }

  const btn=$('#btnReg'); setLoading(btn,true,'Crear cuenta','Creando‚Ä¶');
  let photoURL='';

  try{
    await setupPersistence();
    const cred = await withTimeout(createUserWithEmailAndPassword(auth,email,pass), 15000, 'Creaci√≥n de usuario');

    if(file){
      try{
        const path='avatars/'+cred.user.uid+'.jpg';
        await withTimeout(uploadBytes(sRef(storage,path),file), 15000, 'Subida de foto');
        photoURL = await withTimeout(getDownloadURL(sRef(storage,path)), 15000, 'URL de foto');
      }catch(upErr){
        console.warn('Subida de foto fall√≥:', upErr);
        setText($('#regErr'), 'La foto no se pudo subir ahora, pod√©s agregarla m√°s tarde.');
        photoURL='';
      }
    }

        try{
      // Actualiza el perfil de Auth con nombre y foto (si hubo)
      await withTimeout(updateProfile(cred.user,{displayName:name,photoURL}), 15000, 'Actualizaci√≥n de perfil');

      // Crea/actualiza documento del usuario
      await withTimeout(setDoc(doc(db,'users',cred.user.uid),{
        name,
        email,
        photoURL,
        ratingSum:0,
        ratingCount:0,
        createdAt:serverTimestamp()
      }), 15000, 'Creaci√≥n de perfil');

      // Cierra el formulario de registro
      document.getElementById('regCard').style.display='none';
      clearRegForm();
    }catch(docErr){
      console.warn('Error guardando perfil:', docErr);
      setText($('#regErr'),'Se cre√≥ tu cuenta, pero no se pudo guardar el perfil. Prob√° recargar.');
    }
  }catch(err){
    setText($('#regErr'), mapAuthError(err));
  }finally{
    setLoading(btn,false,'Crear cuenta');
  }
}

/* -------- Estado de sesi√≥n -------- */
onAuthStateChanged(auth, async (user)=>{
  state.fbUser=user||null;
  if(user){
    if(userUnsub) userUnsub();
    const ref=doc(db,'users',user.uid);
    userUnsub=onSnapshot(ref, async (snap)=>{
      if(!snap.exists()){
        try{
          await setDoc(ref,{
            name:user.displayName||'',
            email:user.email||'',
            photoURL:user.photoURL||'',
            ratingSum:0,
            ratingCount:0,
            createdAt:serverTimestamp()
          });
        }catch(_){}
      }
      state.profile=snap.data()||{};
      // Si falta el nombre, quedate en el gate para completar
      if(!(state.profile.name && state.profile.name.trim())){
        document.getElementById('gate').style.display='grid';
        document.getElementById('regCard').style.display='block';
        document.getElementById('app').style.display='none';
        return;
      }
      // Mostrar app
      document.getElementById('gate').style.display='none';
      document.getElementById('app').style.display='grid';
      if(!map) initMap();
      setTimeout(()=>{ map.invalidateSize(); },200);
      renderTabs(); updateRoleUI();
    });
  } else {
    // Sesi√≥n cerrada
    document.getElementById('app').style.display='none';
    document.getElementById('gate').style.display='grid';
    stopDriverShare(); stopDriverFollower();
    driverOnline=false; driverPaused=false;
    resetDriverSession(); unsubscribeEarnings();
  }
});

/* -------- UI util -------- */
function clearRegForm(){
  ['regName','regEmail','regPass','regPass2'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.value='';
  });
  const ph=document.getElementById('regPhoto'); if(ph) ph.value='';
  const pv=document.getElementById('regPreview'); if(pv) pv.src='';
}

// Preview de foto
const phInput=document.getElementById('regPhoto');
if(phInput){
  phInput.addEventListener('change', e=>{
    const f=e.target.files?.[0];
    if(!f) return;
    const url=URL.createObjectURL(f);
    const img=document.getElementById('regPreview');
    if(img) img.src=url;
  });
}

/* ‚úÖ Cambio de pesta√±as */
function handleTabChange(){
  if(uiTab==='conductor'){
    requestGeoPermission();
    driverStart(); // entra iniciado
  }else{
    if(driverOnline) driverFinish();
  }
  if(uiTab!=='conductor') unsubscribePendientes();
  updateRoleUI();
}

/* -------- Eventos -------- */
document.addEventListener('click', e=>{
  const id=e.target?.id;

  // Auth
  if(id==='btnLogin') doLogin();
  if(id==='btnReg') doRegister();
  if(id==='btnShowReg') document.getElementById('regCard').style.display='block';
  if(id==='btnCancelReg'){ document.getElementById('regCard').style.display='none'; clearRegForm(); }

  // Pasajero
  if(id==='btnMiUbicacion') miUbicacionComoOrigen();
  if(id==='btnLimpiar') limpiar();
  if(id==='btnSolicitar') solicitarViaje();
  if(id==='btnCancelReqTop') cancelarSolicitud();
  if(id==='btnCancelReqOverlay') cancelarSolicitud(); // bot√≥n del overlay

  if(id==='modeOrigen'){
    selectMode='origen';
    document.getElementById('modeOrigen').setAttribute('aria-pressed','true');
    document.getElementById('modeDestino').setAttribute('aria-pressed','false');
  }
  if(id==='modeDestino'){
    selectMode='destino';
    document.getElementById('modeDestino').setAttribute('aria-pressed','true');
    document.getElementById('modeOrigen').setAttribute('aria-pressed','false');
  }

  // Conductor
  if(id==='btnDrvStart') driverStart();
  if(id==='btnDrvPause') driverPauseToggle();
  if(id==='btnDrvFinish') driverFinish();
  if(id==='btnUbicarme'){
    if(myLastPos && map){
      try{ map.setView([myLastPos.lat,myLastPos.lng], Math.max(map.getZoom(), 15)); }catch(_){}
    }
  }

  // Chat
  if(id==='chatSend') sendChat();
});

/* -------- Boot simple -------- */
document.addEventListener('DOMContentLoaded', ()=>{
  const bad=(location.protocol!=='http:' && location.protocol!=='https:');
  const warn=document.getElementById('envWarn');
  if(warn) warn.style.display = bad ? 'block' : 'none';
});
</script>
</body>
</html>
