<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Taxi Ya ‚Äî Firebase</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0f15; --panel:#0f141d; --ink:#f5f7fb; --muted:#a9b4c2; --line:#1b2430;
  --accent:#ffd34d; --ok:#22c55e; --danger:#ef4444; --chip:#17202a; --card:#0d131b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0f15,#0b0f15 60%,#0a0f19);color:var(--ink);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial}
button,input,select{font-family:inherit}

/* Gate (login/registro previo) */
#gate{position:fixed;inset:0;display:grid;place-items:center;background:radial-gradient(1200px 800px at 50% -10%,#13202e 0%, #0b0f15 60%, #0a0f19 100%);z-index:100}
.gate-card{width:min(920px,92vw);background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:1rem}
.gate-title{display:flex;align-items:center;gap:.6rem;margin:.25rem 0 1rem}
.gate-title .dot{width:.9rem;height:.9rem;border-radius:999px;background:var(--accent);box-shadow:0 0 16px rgba(255,211,77,.7)}
.grid{display:grid;gap:.75rem}
.grid.cols-2{grid-template-columns:1fr 1fr}
.field{display:grid;gap:.35rem}
.label{font-size:.9rem;color:var(--muted)}
.input{width:100%;background:#0e1620;border:1px solid var(--line);color:var(--ink);padding:.65rem .75rem;border-radius:12px}
.btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--line);background:#12202e;color:var(--ink);padding:.6rem .9rem;border-radius:12px;cursor:pointer;transition:.2s;text-decoration:none}
.btn.primary{background:var(--accent);color:#111;border-color:#e6b800}
.err{color:#fecaca}

/* App */
.app{min-height:100dvh;display:grid;grid-template-rows:auto 1fr}
.header{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--line);background:rgba(13,19,27,.7);backdrop-filter:blur(12px);position:sticky;top:0;z-index:20}
.brand{display:flex;align-items:center;gap:.6rem}
.brand .dot{width:.9rem;height:.9rem;border-radius:999px;background:var(--accent);box-shadow:0 0 16px rgba(255,211,77,.7)}
.brand b{letter-spacing:.5px}
.tabs{display:flex;gap:.35rem;flex-wrap:wrap}
.tab{padding:.45rem .75rem;border:1px solid var(--line);border-radius:999px;background:#17202a;color:var(--ink);opacity:.85;cursor:pointer;transition:.2s}
.tab[aria-selected="true"]{background:var(--accent);color:#111;opacity:1;border-color:#e6b800}

.container{display:grid;grid-template-columns:360px 1fr;gap:1rem;padding:1rem;max-width:1300px;margin:0 auto}
.aside,.main{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden}
.panel-head{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--line);background:var(--card)}
.panel-body{padding:1rem}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:1rem}
.row{display:flex;gap:.6rem;align-items:center}
.row.wrap{flex-wrap:wrap}
.chip{background:#121a24;border:1px solid var(--line);padding:.35rem .6rem;border-radius:999px;font-size:.85rem;color:var(--muted)}
.badge{padding:.3rem .5rem;border-radius:8px;border:1px solid var(--line);font-size:.78rem}
.badge.ok{background:rgba(34,197,94,.12);color:#86efac;border-color:rgba(34,197,94,.35)}
.help{color:var(--muted);font-size:.86rem}

/* Map */
#map{width:100%;min-height:520px;height:520px}
.map-banner{position:absolute;top:18px;left:50%;transform:translateX(-50%);background:#0f172a;opacity:.96;border:1px solid #243045;padding:.4rem .8rem;border-radius:10px;font-weight:600}

/* Chat */
.chatbox{display:grid;grid-template-rows:1fr auto;height:240px;background:#0d131b;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.chatlog{overflow:auto;padding:.6rem}
.msg{display:inline-block;background:#12202e;border:1px solid var(--line);padding:.5rem .65rem;border-radius:10px;margin:.25rem 0}
.msg.me{background:#1f2a37}

/* Mobile tweaks */
@media (max-width: 1080px){
  .container{grid-template-columns:1fr}
  .aside{order:2}
  .main{order:1}
}
@media (max-width: 680px){
  .tabs{position:fixed;bottom:10px;left:0;right:0;justify-content:center;z-index:40}
  .tab{background:#131c28;border-color:#223043}
}
</style>
</head>
<body>

<!-- ==================== AUTH GATE (antes de entrar) ==================== -->
<div id="gate">
  <div class="gate-card">
    <div class="gate-title"><span class="dot"></span><b>Taxi Ya</b> <span class="chip" style="margin-left:.5rem;background:#121a24;border:1px solid var(--line);padding:.2rem .5rem;border-radius:999px;color:#a9b4c2">Registraci√≥n</span></div>
    <div class="grid cols-2">
      <div class="card" style="background:#0d131b">
        <h3 style="margin:0 0 .5rem 0">Crear cuenta</h3>
        <div class="grid cols-2">
          <div class="field"><label class="label">Nombre</label><input id="regName" class="input" placeholder="Ana, Mauro‚Ä¶"></div>
          <div class="field"><label class="label">Email</label><input id="regEmail" type="email" class="input" placeholder="nombre@mail.com"></div>
        </div>
        <div class="grid cols-2">
          <div class="field"><label class="label">Contrase√±a</label><input id="regPass" type="password" class="input" placeholder="m√≠n. 6 caracteres"></div>
          <div class="field"><label class="label">Repetir contrase√±a</label><input id="regPass2" type="password" class="input" placeholder="repite la contrase√±a"></div>
        </div>
        <div class="row" style="margin-top:.8rem;gap:.5rem;flex-wrap:wrap">
          <button class="btn primary" id="btnReg">Registrarme</button>
        </div>
        <div id="regErr" class="err"></div>
      </div>
      <div class="card" style="background:#0d131b">
        <h3 style="margin:0 0 .5rem 0">Ya tengo cuenta</h3>
        <div class="grid cols-2">
          <div class="field"><label class="label">Email</label><input id="inEmail" type="email" class="input"></div>
          <div class="field"><label class="label">Contrase√±a</label><input id="inPass" type="password" class="input"></div>
        </div>
        <div class="row" style="margin-top:.8rem;gap:.5rem;flex-wrap:wrap">
          <button class="btn" id="btnLogin">Entrar</button>
        </div>
        <div id="loginErr" class="err"></div>
      </div>
    </div>
    <p class="help" style="margin-top:.5rem">Ingres√° para continuar al mapa.</p>
  </div>
</div>

<!-- ==================== APP ==================== -->
<div class="app" id="app" style="display:none">
  <header class="header">
    <div class="brand">
      <span class="dot"></span>
      <b>Taxi Ya</b>
      <span class="chip" id="statusChip">offline</span>
    </div>
    <nav class="tabs" id="tabs"></nav>
  </header>

  <div class="container">
    <aside class="aside">
      <div class="panel-head">
        <strong id="sideTitle">Panel</strong>
        <span class="badge ok" id="authBadge">Conectado</span>
      </div>
      <div class="panel-body" id="sideBody"><!-- lateral din√°mico --></div>
    </aside>

    <main class="main">
      <div class="panel-head"><strong id="mainTitle">Mapa</strong></div>
      <div class="panel-body" style="position:relative">
        <div id="mapBanner" class="map-banner" style="display:none">BUSCANDO CONDUCTOR‚Ä¶ <span id="searchTimer" style="opacity:.8;margin-left:.4rem">00:00</span></div>

        <div class="card" style="margin-bottom:.75rem">
          <div class="row wrap" style="justify-content:space-between;gap:.75rem">
            <div class="row" style="gap:.5rem">
              <div class="label">Seleccionar en mapa:</div>
              <div class="seg" id="modeSeg">
                <button id="modeOrigen" aria-pressed="true">Origen</button>
                <button id="modeDestino" aria-pressed="false">Destino</button>
              </div>
            </div>
            <div class="row" style="gap:.5rem;flex-wrap:wrap">
              <button class="btn" id="btnMiUbicacion">Usar mi ubicaci√≥n</button>
              <button class="btn" id="btnLimpiar">Limpiar</button>
              <button class="btn primary" id="btnSolicitar">Solicitar viaje</button>
            </div>
          </div>
        </div>

        <div id="map" style="position:relative"></div>

        <div class="card" style="margin-top:.75rem">
          <div class="row wrap" style="justify-content:space-between">
            <div><div class="label">Origen</div><div id="origenTxt" class="chip">‚Äî</div></div>
            <div><div class="label">Destino</div><div id="destinoTxt" class="chip">‚Äî</div></div>
            <div><div class="label">Distancia (km)</div><div id="kmTxt" class="chip">0.00</div></div>
            <div><div class="label">Tarifa estimada</div><div id="fareTxt" class="chip">$ 0</div></div>
          </div>
          <p class="help" id="actividad">Toca el mapa para fijar Origen/Destino.</p>
        </div>

        <div class="card" style="margin-top:.75rem">
          <div class="label">Chat del viaje</div>
          <div class="chatbox">
            <div id="chatlog" class="chatlog"></div>
            <div class="chatinput">
              <input id="chatInput" class="input" placeholder="Escribe un mensaje respetuoso‚Ä¶"/>
              <button class="btn" id="chatSend">Enviar</button>
            </div>
          </div>
          <div class="help">El chat se habilita al tener un viaje activo.</div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- ================= Firebase + App (M√≥dulos) ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, addDoc, collection, serverTimestamp, onSnapshot, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// *** Config de tu proyecto ***
const firebaseConfig = {
  apiKey: "AIzaSyBu523IOGnIZGfAkdlLdVLcENwLgv5KU9o",
  authDomain: "taxi-ya-3be33.firebaseapp.com",
  projectId: "taxi-ya-3be33",
  storageBucket: "taxi-ya-3be33.firebasestorage.app",
  messagingSenderId: "31840475169",
  appId: "1:31840475169:web:1485e47b9ebea4a66c6b60",
  measurementId: "G-2RQRP1G2KB"
};

const appFB = initializeApp(firebaseConfig);
try{ getAnalytics(appFB); }catch(e){}
const auth = getAuth(appFB);
const db = getFirestore(appFB);

// ======= Estado/constantes =======
const $ = s => document.querySelector(s);
let map, origenMarker, destinoMarker, meMarker, line;
let activeReqUnsub=null, chatUnsub=null, listUnsub=null, userUnsub=null, timerInt=null;

let uiTab = 'pasajero'; // pesta√±a activa define ‚Äúmodo‚Äù
let selectMode = 'origen'; // selector de puntos en el mapa
let state = {
  fbUser: null,
  profile: null,
  // Tarifa "estilo Uber" FIJA (no editable en UI)
  tarifa: Object.freeze({
    base: 800,     // cargo base
    porKm: 350,    // por kil√≥metro
    minima: 1200   // m√≠nimo cobrable
    // (pod√©s ajustar estos n√∫meros en c√≥digo si quer√©s)
  }),
  descuento: 0.10,         // descuento de la app
  origen: null, destino: null,
  activeRequestId: null,
  activeRequest: null,
  requestCreatedAt: null    // para el timer ‚Äúbuscando‚Äù
};

// ======= Tabs =======
function tabsForState(){
  if(!state.fbUser) return [];
  return [
    {id:'pasajero', label:'Pasajero'},
    {id:'conductor', label:'Conductor'},
    {id:'perfil',    label:'Perfil'}
  ];
}
function renderTabs(){
  const nav = $('#tabs'); nav.innerHTML='';
  for(const t of tabsForState()){
    const el = document.createElement('button');
    el.className='tab';
    el.textContent=t.label;
    el.setAttribute('aria-selected', uiTab===t.id);
    el.onclick = ()=>{ uiTab=t.id; onTabChange(); };
    nav.appendChild(el);
  }
  setStatusChip();
}
function onTabChange(){
  // Cambiamos autom√°ticamente el modo de mapa en funci√≥n de la pesta√±a, si hace falta algo espec√≠fico
  // (por ahora, solo actualizamos lateral)
  renderSide();
  if(map) setTimeout(()=>map.invalidateSize(), 120);
}

// ======= UI Aux =======
function setStatusChip(){
  const sc = $('#statusChip');
  sc.textContent = state.fbUser? (state.profile?.name || 'online') : 'offline';
}
function renderSide(){
  const body = $('#sideBody'); const title = $('#sideTitle');
  const titles = { pasajero:'Pasajero', conductor:'Conductor', perfil:'Perfil' };
  title.textContent = titles[uiTab]||'Panel';
  body.innerHTML='';

  if(uiTab==='pasajero') return body.appendChild(cardPasajero());
  if(uiTab==='conductor') return body.appendChild(cardConductor());
  if(uiTab==='perfil')    return body.appendChild(cardPerfil());
}

// ======= Componentes =======
function cardPasajero(){
  const el = document.createElement('div'); el.className='grid';
  el.innerHTML = `
    <div class="card">
      <div class="label">Solicitud</div>
      <p id="solicitudTxt" class="help">Eleg√≠ origen y destino en el mapa y solicit√° tu viaje.</p>
      <div class="row" style="gap:.5rem;flex-wrap:wrap">
        <button class="btn primary" id="btnReq">Solicitar viaje</button>
        <button class="btn" id="btnCancelReq">Cancelar</button>
      </div>
    </div>`;
  setTimeout(()=>{
    $('#btnReq').onclick = solicitarViaje;
    $('#btnCancelReq').onclick = cancelarSolicitud;
  },0);
  return el;
}
function cardConductor(){
  const el = document.createElement('div'); el.className='grid';
  el.innerHTML = `
    <div class="card">
      <div class="label">Solicitudes pendientes</div>
      <div id="reqList" class="grid"></div>
    </div>
    <div class="card">
      <div class="label">Acciones del viaje</div>
      <div class="row" style="gap:.5rem;flex-wrap:wrap">
        <button class="btn" id="btnStart">Iniciar</button>
        <button class="btn" id="btnFinish">Finalizar</button>
      </div>
    </div>`;
  setTimeout(()=>{
    $('#btnStart').onclick = iniciarTrayecto;
    $('#btnFinish').onclick = finalizarTrayecto;
    suscribeListaPendientes();
  },0);
  return el;
}
function cardPerfil(){
  const p = state.profile || {ratingSum:0, ratingCount:0};
  const avg = p.ratingCount? (p.ratingSum/p.ratingCount):0;
  const stars = [1,2,3,4,5].map(i=>`<span style="color:#fcd34d;opacity:${avg>=i?1:.35}">‚òÖ</span>`).join('');
  const el = document.createElement('div'); el.className='grid';
  el.innerHTML = `
    <div class="card">
      <div class="row wrap" style="gap:.75rem;align-items:flex-start">
        <img src="https://api.dicebear.com/9.x/initials/svg?seed=${encodeURIComponent(p.name||state.fbUser?.email||'U')}" alt="avatar" width="64" height="64" style="border-radius:12px;border:1px solid var(--line)"/>
        <div>
          <div style="font-weight:600">${p.name||'Usuario'}</div>
          <div class="chip">${state.fbUser?.email||''}</div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="label">Sesi√≥n</div>
      <div class="row" style="gap:.5rem;flex-wrap:wrap">
        <button class="btn" id="btnLogout">Cerrar sesi√≥n</button>
      </div>
    </div>
    <div class="card">
      <div class="label">Calificaci√≥n</div>
      <div class="row" style="gap:.35rem">${stars}</div>
      <div class="row" style="gap:.5rem;margin-top:.4rem">
        <div class="chip">${p.ratingCount||0} opiniones</div>
        <div class="chip">${avg.toFixed(2)} / 5.00</div>
      </div>
    </div>`;
  setTimeout(()=>{ $('#btnLogout').onclick = ()=> signOut(auth); },0);
  return el;
}

// ======= Mapa =======
function initMap(){
  map = L.map('map', { zoomControl:true }).setView([-34.6037,-58.3816], 12);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'¬© OpenStreetMap' }).addTo(map);
  setTimeout(()=>map.invalidateSize(), 250);
  map.on('click', (e)=>{
    const p = { lat: e.latlng.lat, lng: e.latlng.lng };
    if(selectMode==='origen'){ setOrigen(p); } else { setDestino(p); }
  });
}
function drawLine(){
  if(line){ map.removeLayer(line); line=null; }
  if(state.origen && state.destino){
    line = L.polyline([[state.origen.lat,state.origen.lng],[state.destino.lat,state.destino.lng]], {color:'#ffd34d'}).addTo(map);
  }
}
function setOrigen(p){
  if(origenMarker) map.removeLayer(origenMarker);
  origenMarker = L.marker([p.lat, p.lng], { draggable:true }).addTo(map).bindPopup('Origen');
  origenMarker.on('dragend',()=>{ const ll=origenMarker.getLatLng(); setOrigen({lat:ll.lat,lng:ll.lng}); });
  state.origen=p; updateInfo(); drawLine();
}
function setDestino(p){
  if(destinoMarker) map.removeLayer(destinoMarker);
  destinoMarker = L.marker([p.lat, p.lng], { draggable:true, icon: L.divIcon({className:'', html:'<div style="background:#1e293b;border:2px solid #334155;color:#fff;padding:2px 6px;border-radius:6px">üéØ</div>'}) }).addTo(map).bindPopup('Destino');
  destinoMarker.on('dragend',()=>{ const ll=destinoMarker.getLatLng(); setDestino({lat:ll.lat,lng:ll.lng}); });
  state.destino=p; updateInfo(); drawLine();
}
function miUbicacionComoOrigen(){
  if(!navigator.geolocation){ alert('Geolocalizaci√≥n no disponible'); return; }
  navigator.geolocation.getCurrentPosition((pos)=>{
    const p={lat:pos.coords.latitude,lng:pos.coords.longitude};
    if(meMarker) map.removeLayer(meMarker);
    meMarker = L.circleMarker([p.lat,p.lng], {radius:7, color:'#34d399'}).addTo(map).bindPopup('Mi ubicaci√≥n');
    map.setView([p.lat,p.lng], 14);
    setOrigen(p);
  }, ()=> alert('No se pudo obtener ubicaci√≥n'));
}
function limpiar(){
  if(origenMarker) map.removeLayer(origenMarker); origenMarker=null; state.origen=null;
  if(destinoMarker) map.removeLayer(destinoMarker); destinoMarker=null; state.destino=null;
  if(line) map.removeLayer(line); line=null;
  updateInfo();
}
function fmt(n){ return new Intl.NumberFormat('es-AR', {style:'currency', currency:'ARS', maximumFractionDigits:0}).format(n); }
function km(a,b){
  if(!a||!b) return 0;
  const R=6371;
  const dLat=(b.lat-a.lat)*Math.PI/180, dLon=(b.lng-a.lng)*Math.PI/180;
  const la1=a.lat*Math.PI/180, la2=b.lat*Math.PI/180;
  const h=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(h));
}
function calcularTarifa(distKm){
  const t = state.tarifa;
  const bruto = t.base + distKm * t.porKm;
  const conDesc = bruto * (1 - state.descuento);
  return Math.max(t.minima, Math.round(conDesc));
}
function updateInfo(){
  const o = state.origen, d=state.destino; const dist = km(o,d);
  $('#origenTxt').textContent = o? `${o.lat.toFixed(4)}, ${o.lng.toFixed(4)}` : '‚Äî';
  $('#destinoTxt').textContent = d? `${d.lat.toFixed(4)}, ${d.lng.toFixed(4)}` : '‚Äî';
  $('#kmTxt').textContent = dist.toFixed(2);
  $('#fareTxt').textContent = fmt(calcularTarifa(dist));
}

// ======= Chat =======
const bannedWords = ['puta','puto','cagar','mierda','hdp','concha','pija','forro','insulto','boludo'];
function sanitizeMsg(text){
  let t = text.trim();
  for(const w of bannedWords){ t = t.replace(new RegExp('\\b'+w+'\\b','gi'), '***'); }
  return t;
}
function mySide(){
  const r = state.activeRequest;
  if(!r || !state.fbUser) return 'pax';
  if(r.pasajeroId === state.fbUser.uid) return 'pax';
  if(r.conductorId === state.fbUser.uid) return 'drv';
  return uiTab==='conductor' ? 'drv' : 'pax';
}
$('#chatSend').addEventListener('click', async ()=>{
  if(!state.activeRequestId) return alert('Sin viaje activo');
  const input = $('#chatInput'); const text = (input.value||'').trim(); if(!text) return;
  const sanitized = sanitizeMsg(text); if(/^\*{3,}$/.test(sanitized)) return alert('Mensaje bloqueado');
  await addDoc(collection(db,'requests',state.activeRequestId,'messages'),{
    from: mySide(), text: sanitized, ts: serverTimestamp()
  });
  input.value='';
});

// ======= Firestore: Solicitudes =======
async function solicitarViaje(){
  if(!state.origen || !state.destino) return alert('Eleg√≠ origen y destino');
  const dist = km(state.origen,state.destino);
  const precio = calcularTarifa(dist);
  const docRef = await addDoc(collection(db,'requests'),{
    status:'buscando',
    pasajeroId: state.fbUser.uid,
    pasajeroNombre: state.profile?.name || state.fbUser.email,
    origen: state.origen, destino: state.destino,
    km: dist, precio,
    createdAt: serverTimestamp()
  });
  state.activeRequestId = docRef.id;
  startSearchingUI(true);
  watchActiveRequest(docRef.id);
  uiTab='pasajero'; renderTabs(); renderSide();
}
async function cancelarSolicitud(){
  if(!state.activeRequestId) return;
  await updateDoc(doc(db,'requests',state.activeRequestId), { status:'cancelado' });
}
function suscribeListaPendientes(){
  if(listUnsub) listUnsub();
  listUnsub = onSnapshot(
    query(collection(db,'requests'), where('status','==','buscando'), orderBy('createdAt','desc'), limit(20)),
    qs=>{
      const cont = $('#reqList'); if(!cont) return; cont.innerHTML='';
      qs.forEach(docu=>{
        const r = docu.data(); const id=docu.id;
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `
          <div class="row wrap" style="justify-content:space-between">
            <div><div class="chip">#${id.slice(0,6)}</div><div class="chip">Pasajero: ${r.pasajeroNombre}</div></div>
            <div><div class="chip">${(r.km||0).toFixed(2)} km</div><div class="chip">${fmt(r.precio||0)}</div></div>
          </div>
          <div class="row" style="margin-top:.5rem;gap:.5rem"><button class="btn primary" data-id="${id}">Aceptar</button></div>`;
        card.querySelector('button').onclick = ()=> aceptarViaje(id);
        cont.appendChild(card);
      });
    }
  );
}
async function aceptarViaje(id){
  await updateDoc(doc(db,'requests',id), {
    status:'aceptado',
    conductorId: state.fbUser.uid,
    conductorNombre: state.profile?.name || state.fbUser.email
  });
  state.activeRequestId = id; watchActiveRequest(id);
}
async function iniciarTrayecto(){
  if(!state.activeRequestId) return alert('Sin viaje activo');
  await updateDoc(doc(db,'requests',state.activeRequestId), { status:'en_curso' });
}
async function finalizarTrayecto(){
  if(!state.activeRequestId) return alert('Sin viaje activo');
  await updateDoc(doc(db,'requests',state.activeRequestId), { status:'finalizado' });
}

// ======= Watch request + UI de ‚Äúbuscando‚Äù =======
function watchActiveRequest(id){
  if(activeReqUnsub) activeReqUnsub();
  activeReqUnsub = onSnapshot(doc(db,'requests',id), async (snap)=>{
    if(!snap.exists()) return;
    const r = snap.data();
    state.activeRequest = { id: snap.id, ...r };
    $('#actividad').textContent = `#${id.slice(0,6)} ‚Äî ${r.status.toUpperCase()} ‚Äî ${fmt(r.precio)} (${(r.km||0).toFixed(2)} km)`;

    if(r.status==='buscando'){ startSearchingUI(true); }
    else { startSearchingUI(false); }

    if(r.status==='finalizado' || r.status==='cancelado'){
      state.activeRequestId=null; state.activeRequest=null;
      if(chatUnsub){ chatUnsub(); chatUnsub=null; }
      alert(r.status==='finalizado' ? '¬°Viaje finalizado!' : 'Solicitud cancelada');
    }else{
      ensureChatListener(id);
    }
  });
}
function ensureChatListener(reqId){
  if(chatUnsub) return;
  const msgsRef = collection(db,'requests',reqId,'messages');
  chatUnsub = onSnapshot(query(msgsRef, orderBy('ts','asc'), limit(100)), (qs)=>{
    const log = $('#chatlog'); log.innerHTML='';
    const mine = mySide();
    qs.forEach(d=>{
      const m=d.data();
      const who = (m.from===mine)? 'me':'';
      log.insertAdjacentHTML('beforeend', `<div class="msg ${who}"><b>${m.from==='pax'?'Pasajero':'Conductor'}:</b> ${m.text}</div>`);
    });
    log.scrollTop = log.scrollHeight;
  });
}

// Timer + Banner ‚ÄúBUSCANDO‚Ä¶‚Äù
function startSearchingUI(on){
  const banner = $('#mapBanner');
  if(on){
    banner.style.display='block';
    if(!state.requestCreatedAt) state.requestCreatedAt = Date.now();
    if(timerInt) clearInterval(timerInt);
    timerInt = setInterval(()=>{
      const elapsed = Math.floor((Date.now()-state.requestCreatedAt)/1000);
      const mm = String(Math.floor(elapsed/60)).padStart(2,'0');
      const ss = String(elapsed%60).padStart(2,'0');
      $('#searchTimer').textContent = `${mm}:${ss}`;
    }, 500);
  }else{
    banner.style.display='none';
    if(timerInt) clearInterval(timerInt);
    timerInt=null; state.requestCreatedAt=null;
    $('#searchTimer').textContent = '00:00';
  }
}

// ======= Auth + Gate =======
onAuthStateChanged(auth, async (user)=>{
  state.fbUser = user;
  if(user){
    if(userUnsub) userUnsub();
    const uref = doc(db,'users',user.uid);
    userUnsub = onSnapshot(uref, async (snap)=>{
      if(!snap.exists()){
        await setDoc(uref, { name: user.displayName||'', email:user.email||'', ratingSum:0, ratingCount:0, createdAt: serverTimestamp() });
        state.profile = { name:user.displayName||'', email:user.email||'', ratingSum:0, ratingCount:0 };
      }else{
        state.profile = snap.data();
      }
      $('#gate').style.display='none';
      $('#app').style.display='grid';
      renderTabs(); renderSide();
    });
  } else {
    // Mostrar gate, esconder app
    $('#app').style.display='none';
    $('#gate').style.display='grid';
    state.profile=null; state.activeRequestId=null; state.activeRequest=null;
    if(activeReqUnsub){ activeReqUnsub(); activeReqUnsub=null; }
    if(chatUnsub){ chatUnsub(); chatUnsub=null; }
    if(listUnsub){ listUnsub(); listUnsub=null; }
    if(userUnsub){ userUnsub(); userUnsub=null; }
  }
});

// ======= Gate handlers =======
$('#btnReg').onclick = async ()=>{
  const name=$('#regName').value.trim();
  const email=$('#regEmail').value.trim();
  const pass=$('#regPass').value; const pass2=$('#regPass2').value;
  $('#regErr').textContent='';
  if(pass!==pass2) return $('#regErr').textContent='Las contrase√±as no coinciden';
  try{
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    await updateProfile(cred.user, { displayName: name });
    await setDoc(doc(db,'users',cred.user.uid), { name, email, ratingSum:0, ratingCount:0, createdAt: serverTimestamp() });
  }catch(e){ $('#regErr').textContent = e.message; }
};
$('#btnLogin').onclick = async ()=>{
  $('#loginErr').textContent='';
  try{ await signInWithEmailAndPassword(auth, $('#inEmail').value.trim(), $('#inPass').value); }
  catch(e){ $('#loginErr').textContent = e.message; }
};

// ======= Bootstrap =======
function bootstrap(){
  initMap();
  $('#btnMiUbicacion').onclick = miUbicacionComoOrigen;
  $('#btnLimpiar').onclick = limpiar;
  $('#btnSolicitar').onclick = solicitarViaje;
  const bO = $('#modeOrigen'), bD = $('#modeDestino');
  bO.onclick = ()=>{ selectMode='origen'; bO.setAttribute('aria-pressed','true'); bD.setAttribute('aria-pressed','false'); };
  bD.onclick = ()=>{ selectMode='destino'; bD.setAttribute('aria-pressed','true'); bO.setAttribute('aria-pressed','false'); };
}
bootstrap();
</script>
</body>
</html>
